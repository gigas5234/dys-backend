<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ë°ì—°ì†Œ Â· Love Glass UI (í”¼ë“œë°± ê³ ë„í™”)</title>
    <link rel="stylesheet" href="styles/studio_calibration.css?v=20241223-24">
<!-- MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<!-- ê¸°ë³¸ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì„¤ì • ëª¨ë“ˆ -->
<script src="js/default-calibration.js?v=20241223"></script>
<!-- ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ -->
<script src="js/calibration.js?v=20241222"></script>
<!-- ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ (ê°œë°œìš©) -->
<script src="js/performance-monitor.js?v=20241222"></script>
<!-- MediaPipe ì§ì ‘ ëª¨ë“ˆ -->
<script src="js/mediapipe-direct.js?v=20241223"></script>
<!-- ì¹´ë©”ë¼ ë¶„ì„ê¸° ëª¨ë“ˆ -->
<script src="js/camera-analyzer.js?v=20241222-2"></script>
    <!-- ìŒì„± ì…ë ¥ ëª¨ë“ˆ -->
    <script src="js/voice-input.js?v=20241222-2"></script>
    <!-- TTS ê´€ë¦¬ ëª¨ë“ˆ -->
    <script src="js/tts-manager.js?v=20241223-2"></script>
    <!-- íŒì—… ê´€ë¦¬ ëª¨ë“ˆ -->
    <script src="js/popup-manager.js?v=20241223-2"></script>
    <!-- ëŒ€í™” ì£¼ë„ê¶Œ ë¶„ì„ ëª¨ë“ˆ -->
    <script src="js/conversation-analyzer.js?v=20241223"></script>
    <!-- ì¢…í•© ì ìˆ˜ ê³„ì‚° ëª¨ë“ˆ -->
    <script src="js/comprehensive-score-calculator.js?v=20241223"></script>
    
    <script>
    // ì „ì—­ ë³€ìˆ˜ë“¤
    let lastExpressionScore = 60;
    let lastExpressionText = 'ì¤‘ë¦½ì ';
    let lastExpressionUpdate = 0;
    const EXPRESSION_UPDATE_INTERVAL = 2000; // 2ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
    </script>
</head>
<body>



<div id="calibration-overlay" class="calibration-overlay">
    <div class="calibration-popup">
        <div id="initial-view">
            <div class="icon">
                <img src="" alt="ì¹´ë©”ë¼" id="cameraIcon">
            </div>
            <h2>ìì„¸ ê¸°ì¤€ ì¸¡ì •</h2>
            <p class="sub">ì •í™•í•œ ì¸¡ì •ì„ ìœ„í•´ ì•„ë˜ ì‚¬í•­ì„ ë¨¼ì € í™•ì¸í•´ ì£¼ì„¸ìš”.</p>

            <ul>
                <li><span class="dot"></span><span>ëª¨ë‹ˆí„°ë¥¼ <strong>ì •ë©´ìœ¼ë¡œ ì‘ì‹œ</strong>í•©ë‹ˆë‹¤.</span></li>
                <li><span class="dot"></span><span><strong>ì–´ê¹¨ë¥¼ ê³§ê²Œ í´ê³  ì˜¬ë°”ë¥¸ ìì„¸</strong>ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.</span></li>
                <li><span class="dot"></span><span>ì¹´ë©”ë¼ê°€ êº¼ì ¸ ìˆê±°ë‚˜ ì—°ê²°ë˜ì§€ ì•Šìœ¼ë©´ ì¸¡ì •ì´ ì–´ë µìŠµë‹ˆë‹¤.</span></li>
            </ul>

            <p class="note">
                <span>ì •í™•í•œ í”¼ë“œë°± ì œê³µì„ ìœ„í•´ <strong>ì¹´ë©”ë¼ ê¸°ë°˜ ìì„¸ ì¸¡ì •</strong>ì´ í•„ìš”í•©ë‹ˆë‹¤.</span>
            </p>

            <div class="button-group">
                <button id="skip-calibration-btn" class="btn btn-secondary">ê±´ë„ˆë›°ê¸°</button>
                <button id="start-calibration-btn" class="btn btn-primary">ìì„¸ ì¸¡ì • ì‹œì‘</button>
            </div>
        </div>
        <div id="progress-view" class="hidden">
            <div class="icon">ğŸ‘¤</div>
            <h2>ìì„¸ ì¸¡ì • ì¤‘</h2>
            <p id="instruction-text">ì¹´ë©”ë¼ ì •ë©´ì—ì„œ ì •ìì„¸ë¥¼ ìœ ì§€í•´ ì£¼ì„¸ìš”.<br>(ëª¨ë‹ˆí„° ì •ê°€ìš´ë°ë¥¼ ì£¼ì‹œ)</p>
            <div class="progress-bar-container">
                <div id="progress-bar-fill" class="progress-bar-fill"></div>
            </div>
            <div id="countdown-text" class="countdown-text">ì¸¡ì • ì™„ë£Œê¹Œì§€ 5ì´ˆ...</div>
        </div>
    </div>
</div>

   <!-- ì´ˆê¸° ì•ˆë‚´ íŒì—… -->
  <div id="initial-guide-overlay" class="initial-guide-overlay">
      <div class="initial-guide-popup">
          <h3>â¤ï¸ ë°ì´íŠ¸ ì‹œì‘!</h3>
          <p>AI íŒŒíŠ¸ë„ˆì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•´ ë³´ì„¸ìš”.<br>ë§ˆì´í¬ ë²„íŠ¼ì´ë‚˜ í…ìŠ¤íŠ¸ ì…ë ¥ìœ¼ë¡œ<br>ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ì–´ ë³´ì„¸ìš”.</p>
          <button id="close-guide-btn" class="btn">ì‹œì‘í•˜ê¸°</button>
      </div>
  </div>
 
 <!-- í™•ì¸ íŒì—… -->
 <div id="confirm-overlay" class="confirm-overlay">
     <div class="confirm-popup">
         <h3>ë°ì´íŠ¸ ì¢…ë£Œ</h3>
         <p>ì •ë§ë¡œ ë°ì´íŠ¸ë¥¼ ëë‚´ì‹œê² ìŠµë‹ˆê¹Œ?</p>
         <div class="button-group">
             <button id="cancel-end-btn" class="btn btn-secondary">ì•„ë‹ˆì˜¤</button>
             <button id="confirm-end-btn" class="btn btn-primary">ì˜ˆ</button>
         </div>
     </div>
 </div>

       <!-- ì¹´ë©”ë¼ ê²½ê³  ë©”ì‹œì§€ (ìƒë‹¨ ë°”) -->
   <div id="camera-warning" class="camera-warning hidden">
     <span class="warning-icon">âš ï¸</span>
     <span class="warning-text">ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. í”¼ë“œë°± ë¶„ì„ì„ ìœ„í•´ ì¹´ë©”ë¼ë¥¼ í—ˆìš©í•´ ì£¼ì„¸ìš”.</span>
     <button class="warning-close" onclick="hideCameraWarning()">Ã—</button>
   </div>
   
   <!-- ì¹´ë©”ë¼ í† ìŠ¤íŠ¸ ê²½ê³  ë©”ì‹œì§€ (ìš°ì¸¡ ìƒë‹¨) -->
   <div id="camera-toast" class="camera-toast hidden">
     <span class="toast-icon">âš ï¸</span>
     <span class="toast-text">ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</span>
     <button class="toast-close" onclick="hideCameraToast()">Ã—</button>
   </div>
 
 <!-- ìƒë‹¨ í—¤ë” -->
 <header class="top-header">
   <div class="logo">
     <div class="logo-icon">ğŸ¬</div>
     <span>ë°ì—°ì†Œ ìŠ¤íŠœë””ì˜¤</span>
   </div>
   <div class="user-info">
     <div class="action-buttons">
       <button id="recalibrate-btn" class="action-btn">ìì„¸ ë‹¤ì‹œ ì¸¡ì •í•˜ê¸°</button>
       <button id="end-session-btn" class="action-btn primary">ë°ì´íŠ¸ ëë‚´ê¸°</button>
     </div>
   </div>
 </header>

<div class="main-content" id="main-content">
  <!-- ì¹´ë©”ë¼ ê²½ê³  ì•Œë¦¼ (ì¸ë¼ì¸) -->
  <div id="camera-warning-inline" class="camera-warning-inline" style="display: none;">
    <div class="camera-warning-content">
      <div class="camera-warning-icon">ğŸ“¹</div>
      <div class="camera-warning-text">
        <h3>ì¹´ë©”ë¼ ì¸ì‹ ë¶ˆì•ˆì •</h3>
        <p>ìì„¸ë¥¼ ê³ ì •í•˜ê³  í”¼ë“œë°±ì„ ë°›ìœ¼ì„¸ìš”</p>
      </div>
      <button class="camera-warning-close" onclick="this.parentElement.parentElement.style.display='none'">Ã—</button>
    </div>
  </div>

  <div id="feedbackPanel" class="feedback-panel">
      <div class="card">
        <header>
          <span>ğŸ’¡ AI ì¢…í•© í”¼ë“œë°±</span>
          <button id="closeBtn" class="close-btn">&times;</button>
        </header>
        <section class="body">
          <!-- í˜¸ê°ë„ ì„¹ì…˜ (ê°œì„ ëœ ë©”ì¸) -->
          <div class="likability-section-enhanced">
            <div class="likability-header">
              <h3 class="likability-main-title">ğŸ’ í˜¸ê°ë„</h3>
              <div class="likability-subtitle">AIê°€ ëŠë¼ëŠ” ë‹¹ì‹ ì˜ ë§¤ë ¥</div>
            </div>
            <div class="likability-content">
              <div class="likability-circle-enhanced">
                <svg viewBox="0 0 120 120">
                  <defs>
                    <linearGradient id="likability-gradient-enhanced" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" stop-color="#667eea" />
                      <stop offset="50%" stop-color="#764ba2" />
                      <stop offset="100%" stop-color="#f093fb" />
                    </linearGradient>
                    <filter id="glow">
                      <fegaussianblur stdDeviation="3" result="coloredBlur"/>
                      <femerge> 
                        <femergenode in="coloredBlur"/>
                        <femergenode in="SourceGraphic"/>
                      </femerge>
                    </filter>
                  </defs>
                  <circle class="circle-bg-enhanced" cx="60" cy="60" r="50" stroke="rgba(255,255,255,0.1)" stroke-width="8" fill="none"/>
                  <circle id="likability-progress-enhanced" class="circle-progress-enhanced" cx="60" cy="60" r="50" stroke="url(#likability-gradient-enhanced)" stroke-width="8" fill="none" stroke-linecap="round" filter="url(#glow)" transform="rotate(-90 60 60)"/>
                </svg>
                <div class="likability-inner">
                  <div id="likability-score-enhanced" class="likability-score-enhanced">-<span class="score-unit">%</span></div>
                  <div class="likability-status" id="likability-status">ì¸¡ì • ì¤‘</div>
                </div>
              </div>
              <div class="likability-factors">
                <div class="factor-item">
                  <span class="factor-icon">ğŸ˜Š</span>
                  <span class="factor-text">í‘œì •</span>
                  <span class="factor-score" id="factor-expression">-</span>
                </div>
                <div class="factor-item">
                  <span class="factor-icon">ğŸµ</span>
                  <span class="factor-text">ìŒì„±</span>
                  <span class="factor-score" id="factor-voice">-</span>
                </div>
                <div class="factor-item">
                  <span class="factor-icon">ğŸ’¬</span>
                  <span class="factor-text">ëŒ€í™”</span>
                  <span class="factor-score" id="factor-conversation">-</span>
                </div>
              </div>
            </div>
          </div>

          <!-- ëŒ€í™” í’ˆì§ˆ ì„¹ì…˜ -->
          <div class="feedback-section">
            <h3 class="section-title">ğŸ’¬ ëŒ€í™” í’ˆì§ˆ</h3>
            <div class="metrics-grid">
              <div class="metric-card" onclick="showInitiativeDetails()" style="cursor: pointer;">
                <div class="metric-icon">ğŸ­</div>
                <div class="metric-content">
                  <div class="metric-title">ëŒ€í™” ì£¼ë„ê¶Œ</div>
                  <div class="initiative-container">
                    <div class="initiative-labels">
                      <span class="user-label">ë‚˜</span>
                      <span class="ai-label">AI</span>
                    </div>
                    <div class="initiative-bar">
                      <div id="user-initiative-bar" class="user-bar" style="width: 50%;"></div>
                      <div id="ai-initiative-bar" class="ai-bar" style="width: 50%;"></div>
                    </div>
                    <div id="initiative-status" class="initiative-status">ê· í˜•ì </div>
                  </div>
                </div>
              </div>
              
              <div class="metric-card" onclick="showExpressionDetails()" style="cursor: pointer;">
                <div class="metric-icon">ğŸ˜Š</div>
                <div class="metric-content">
                  <div class="metric-title">í‘œì •</div>
                  <div id="expression-score" class="metric-value">-%</div>
                  <div id="expression-status" class="metric-status" style="font-size: 10px; color: #6b7280; margin-top: 2px;">ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
                </div>
              </div>
              
              <div class="metric-card">
                <div class="metric-icon">ğŸ—£ï¸</div>
                <div class="metric-content">
                  <div class="metric-title">ë§íˆ¬</div>
                  <div id="tone-score" class="metric-value">-%</div>
                </div>
              </div>
            </div>
          </div>

          <!-- ì‹ ì²´ ì–¸ì–´ ì„¹ì…˜ -->
          <div class="feedback-section">
            <h3 class="section-title">ğŸ¯ ì‹ ì²´ ì–¸ì–´</h3>
            <div class="metrics-grid">
              <div class="metric-card" onclick="showGazeDetails()" style="cursor: pointer;">
                <div class="metric-icon">ğŸ‘ï¸</div>
                <div class="metric-content">
                  <div class="metric-title">ì‹œì„  ì•ˆì •ì„±</div>
                  <div id="gaze-score" class="metric-value">-%</div>
                  <div id="gaze-status" class="metric-status" style="font-size: 10px; color: #6b7280; margin-top: 2px;">ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
                </div>
              </div>
              
              <div class="metric-card" onclick="showConcentrationDetails()" style="cursor: pointer;">
                <div class="metric-icon">ğŸ¯</div>
                <div class="metric-content">
                  <div class="metric-title">ì§‘ì¤‘ë„</div>
                  <div id="concentration-score" class="metric-value">-%</div>
                  <div id="concentration-status" class="metric-status" style="font-size: 10px; color: #6b7280; margin-top: 2px;">ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
                </div>
              </div>
              
              <div class="metric-card" onclick="showPostureDetails()" style="cursor: pointer;">
                <div class="metric-icon">âœ¨</div>
                <div class="metric-content">
                  <div class="metric-title">ìì„¸</div>
                  <div id="posture-score" class="metric-value">-%</div>
                  <div id="posture-status" class="metric-status" style="font-size: 10px; color: #6b7280; margin-top: 2px;">ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
                </div>
              </div>
              
              <div class="metric-card" onclick="showBlinkingDetails()" style="cursor: pointer;">
                <div class="metric-icon">ğŸ˜‰</div>
                <div class="metric-content">
                  <div class="metric-title">ê¹œë¹¡ì„</div>
                  <div id="blinking-score" class="metric-value">-%</div>
                  <div id="blinking-status" class="metric-status" style="font-size: 10px; color: #6b7280; margin-top: 2px;">ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
                </div>
              </div>
            </div>
          </div>

          <!-- ì¢…í•© ì ìˆ˜ ì„¹ì…˜ -->
          <div class="total-score-section">
            <div class="total-score-card" onclick="showComprehensiveScoreDetails()" style="cursor: pointer;">
              <div class="total-score-icon">ğŸ†</div>
              <div class="total-score-content">
                <div class="total-score-title">ì¢…í•© ì ìˆ˜</div>
                <div id="total-score" class="total-score-value">-%</div>
                <div class="total-score-subtitle">ì‹œê° 55% + ì²­ê° 38% + ëŒ€í™” 7%</div>
              </div>
            </div>
          </div>
          
          <!-- AI í”¼ë“œë°± ì„¹ì…˜ -->
          <div id="ai-feedback-summary" class="ai-feedback-section">
            <div class="ai-feedback-header">
              <span class="ai-feedback-icon">ğŸ¯</span>
              <span class="ai-feedback-title">ì‹¤ì‹œê°„ ê¿€íŒ!</span>
            </div>
            <ol class="ai-feedback-list">
                <li>ìƒëŒ€ë°©ì˜ ë§ì— ê¸ì •ì ìœ¼ë¡œ ë°˜ì‘í•´ë³´ì„¸ìš”.</li>
                <li>ëŒ€í™”ê°€ ëŠê¸°ì§€ ì•Šê²Œ ì§ˆë¬¸ì„ ë˜ì ¸ë³´ì„¸ìš”.</li>
                <li>ìì‹ ê° ìˆëŠ” ëª©ì†Œë¦¬ë¡œ ë§í•˜ëŠ” ê²ƒì„ ìŠì§€ ë§ˆì„¸ìš”!</li>
            </ol>
          </div>
        </section>
      </div>
    </div>

    <!-- ê¹œë¹¡ì„ ìƒì„¸ ì •ë³´ íŒì—… -->
    <div id="blinking-details-popup" class="details-popup">
      <div class="details-popup-content">
        <div class="details-popup-header">
          <h3>ğŸ˜‰ ê¹œë¹¡ì„ ë¶„ì„ ìƒì„¸</h3>
          <button class="details-popup-close" onclick="closeBlinkingDetails()">Ã—</button>
        </div>
        <div class="details-popup-body">
          <div class="blinking-summary">
            <div class="blinking-main">
              <div class="blinking-label">ê¹œë¹¡ì„ ìƒíƒœ</div>
              <div id="blinking-main-value" class="blinking-main-value">-</div>
            </div>
            <div class="blinking-rate">
              <div class="blinking-label">ê¹œë¹¡ì„ ë¹ˆë„</div>
              <div id="blinking-rate-value" class="blinking-rate-value">-</div>
            </div>
          </div>
          <div class="blinking-breakdown">
            <div class="blinking-label">ë¶„ì„ ìš”ì†Œ</div>
            <div id="blinking-factors" class="blinking-factors">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>
          <div class="blinking-criteria">
            <div class="blinking-label">í‰ê°€ ê¸°ì¤€</div>
            <div id="blinking-criteria-text" class="blinking-criteria-text">
              ê¹œë¹¡ì„ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
          </div>
          <div class="blinking-explanation">
            <div class="blinking-label">ì ìˆ˜ ê³„ì‚° ê·¼ê±°</div>
            <div id="blinking-explanation-text" class="blinking-explanation-text">
              ê¹œë¹¡ì„ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </div>
    </div>

    <button id="feedbackToggleBtn" class="feedback-toggle-btn">í”¼ë“œë°±</button>

    <!-- ëŒ€í™” ì£¼ë„ê¶Œ ìƒì„¸ ì •ë³´ íŒì—… -->
    <div id="initiative-details-popup" class="details-popup">
      <div class="details-popup-content">
        <div class="details-popup-header">
          <h3>ğŸ­ ëŒ€í™” ì£¼ë„ê¶Œ ë¶„ì„ ìƒì„¸</h3>
          <button class="details-popup-close" onclick="closeInitiativeDetails()">Ã—</button>
        </div>
        <div class="details-popup-body">
          <div class="initiative-summary">
            <div class="initiative-main">
              <div class="initiative-label">ì£¼ë„ê¶Œ ì ìˆ˜</div>
              <div id="initiative-main-value" class="initiative-main-value">50%</div>
            </div>
            <div class="initiative-status">
              <div class="initiative-label">ìƒíƒœ</div>
              <div id="initiative-status-text" class="initiative-status-text">ê· í˜•ì </div>
            </div>
          </div>
          <div class="initiative-visual">
            <div class="initiative-label">ì£¼ë„ê¶Œ ë¶„ë°°</div>
            <div class="initiative-bar-large">
              <div id="initiative-user-bar-large" class="user-bar-large" style="width: 50%;">
                <span class="bar-label">ë‚˜</span>
              </div>
              <div id="initiative-ai-bar-large" class="ai-bar-large" style="width: 50%;">
                <span class="bar-label">AI</span>
              </div>
            </div>
          </div>
          <div class="initiative-breakdown">
            <div class="initiative-label">ìƒì„¸ í†µê³„</div>
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-label">ë©”ì‹œì§€ ìˆ˜</div>
                <div class="stat-value">
                  <span id="user-message-count" class="user-stat">0</span> : 
                  <span id="ai-message-count" class="ai-stat">0</span>
                </div>
              </div>
              <div class="stat-item">
                <div class="stat-label">ë©”ì‹œì§€ ê¸¸ì´</div>
                <div class="stat-value">
                  <span id="user-length" class="user-stat">0</span> : 
                  <span id="ai-length" class="ai-stat">0</span>
                </div>
              </div>
              <div class="stat-item">
                <div class="stat-label">ì§ˆë¬¸ ìˆ˜</div>
                <div class="stat-value">
                  <span id="user-questions" class="user-stat">0</span> : 
                  <span id="ai-questions" class="ai-stat">0</span>
                </div>
              </div>
            </div>
          </div>
          <div class="initiative-criteria">
            <div class="initiative-label">í‰ê°€ ê¸°ì¤€</div>
            <div class="criteria-list">
              <div class="criteria-item">
                <span class="criteria-weight">30%</span>
                <span class="criteria-text">ë©”ì‹œì§€ ìˆ˜ ë¹„ìœ¨</span>
              </div>
              <div class="criteria-item">
                <span class="criteria-weight">25%</span>
                <span class="criteria-text">ë©”ì‹œì§€ ê¸¸ì´ ë¹„ìœ¨</span>
              </div>
              <div class="criteria-item">
                <span class="criteria-weight">25%</span>
                <span class="criteria-text">ì§ˆë¬¸ ë¹„ìœ¨</span>
              </div>
              <div class="criteria-item">
                <span class="criteria-weight">20%</span>
                <span class="criteria-text">ëŒ€í™” ì‹œì‘ íŒ¨í„´</span>
              </div>
            </div>
          </div>
          <div class="initiative-explanation">
            <div class="initiative-label">ì£¼ë„ê¶Œ í•´ì„</div>
            <div id="initiative-explanation-text" class="initiative-explanation-text">
              ëŒ€í™” ì£¼ë„ê¶Œì€ ë©”ì‹œì§€ ìˆ˜, ê¸¸ì´, ì§ˆë¬¸ ë¹ˆë„ ë“±ì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ê³„ì‚°ë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ì¢…í•© ì ìˆ˜ ìƒì„¸ ì •ë³´ íŒì—… -->
    <div id="comprehensive-score-details-popup" class="details-popup">
      <div class="details-popup-content">
        <div class="details-popup-header">
          <h3>ğŸ† ì¢…í•© ì ìˆ˜ ë¶„ì„</h3>
          <button class="details-popup-close" onclick="closeComprehensiveScoreDetails()">Ã—</button>
        </div>
        <div class="details-popup-body">
          <div class="main-metric-container">
            <div class="main-metric-icon">ğŸ†</div>
            <div class="main-metric-value" id="comprehensive-main-value">0%</div>
            <div class="main-metric-label">ì¢…í•© ì ìˆ˜</div>
            <div class="main-metric-status" id="comprehensive-status-text">ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
          </div>
          
          <div class="tabs-container">
            <div class="tabs">
              <button class="tab-btn active" onclick="showComprehensiveTab('breakdown')">ì ìˆ˜ ë¶„ì„</button>
              <button class="tab-btn" onclick="showComprehensiveTab('criteria')">í‰ê°€ ê¸°ì¤€</button>
              <button class="tab-btn" onclick="showComprehensiveTab('explanation')">ìƒì„¸ ì„¤ëª…</button>
            </div>
          </div>
          
          <div class="tab-content">
            <div id="comprehensive-breakdown-tab" class="tab-pane active">
              <div class="comprehensive-breakdown">
            <div class="comprehensive-label">ì¹´í…Œê³ ë¦¬ë³„ ì ìˆ˜</div>
            <div class="category-scores">
              <div class="category-item visual">
                <div class="category-header">
                  <span class="category-icon">ğŸ‘ï¸</span>
                  <span class="category-name">ì‹œê°ì  ìš”ì†Œ</span>
                  <span class="category-weight">55%</span>
                </div>
                <div class="category-score">
                  <div id="visual-average" class="category-average">0%</div>
                  <div class="category-contribution">ê¸°ì—¬ë„: <span id="visual-contribution">0%</span></div>
                </div>
                <div class="category-details">
                  <div class="detail-item">
                    <span class="detail-label">í‘œì •</span>
                    <span id="visual-expression" class="detail-value">0%</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">ì‹œì„  ì•ˆì •ì„±</span>
                    <span id="visual-gaze" class="detail-value">0%</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">ìì„¸</span>
                    <span id="visual-posture" class="detail-value">0%</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">ê¹œë¹¡ì„</span>
                    <span id="visual-blinking" class="detail-value">0%</span>
                  </div>
                </div>
              </div>
              <div class="category-item auditory">
                <div class="category-header">
                  <span class="category-icon">ğŸµ</span>
                  <span class="category-name">ì²­ê°ì  ìš”ì†Œ</span>
                  <span class="category-weight">38%</span>
                </div>
                <div class="category-score">
                  <div id="auditory-average" class="category-average">0%</div>
                  <div class="category-contribution">ê¸°ì—¬ë„: <span id="auditory-contribution">0%</span></div>
                </div>
                <div class="category-details">
                  <div class="detail-item">
                    <span class="detail-label">ìŒì„± í†¤</span>
                    <span id="auditory-tone" class="detail-value">0%</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">ì§‘ì¤‘ë„</span>
                    <span id="auditory-concentration" class="detail-value">0%</span>
                  </div>
                </div>
              </div>
              <div class="category-item conversation">
                <div class="category-header">
                  <span class="category-icon">ğŸ’¬</span>
                  <span class="category-name">ëŒ€í™” ìš”ì†Œ</span>
                  <span class="category-weight">7%</span>
                </div>
                <div class="category-score">
                  <div id="conversation-score" class="category-average">0%</div>
                  <div class="category-contribution">ê¸°ì—¬ë„: <span id="conversation-contribution">0%</span></div>
                </div>
                <div class="category-details">
                  <div class="detail-item">
                    <span class="detail-label">ëŒ€í™” ì£¼ë„ê¶Œ</span>
                    <span id="conversation-initiative" class="detail-value">0%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="comprehensive-explanation">
            <div class="comprehensive-label">ì ìˆ˜ í•´ì„</div>
            <div id="comprehensive-explanation-text" class="comprehensive-explanation-text">
              ì¢…í•© ì ìˆ˜ëŠ” ì‹œê°ì , ì²­ê°ì , ëŒ€í™” ìš”ì†Œë¥¼ ê°€ì¤‘ í‰ê· í•˜ì—¬ ê³„ì‚°ë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- í‘œì • ìƒì„¸ ì •ë³´ íŒì—… -->
    <div id="expression-details-popup" class="details-popup">
      <div class="details-popup-content">
        <div class="details-popup-header">
          <h3>ğŸ˜Š í‘œì • ë¶„ì„ ìƒì„¸</h3>
          <button class="details-popup-close" onclick="closeExpressionDetails()">Ã—</button>
        </div>
        <div class="details-popup-body">
          <div class="expression-summary">
            <div class="expression-main">
              <div class="expression-label">ì£¼ìš” í‘œì •</div>
              <div id="expression-main-value" class="expression-main-value">-</div>
            </div>
            <div class="expression-confidence">
              <div class="expression-label">ì‹ ë¢°ë„</div>
              <div id="expression-confidence-value" class="expression-confidence-value">-%</div>
            </div>
          </div>
          <div class="expression-breakdown">
            <div class="expression-label">í‘œì •ë³„ í™•ë¥ </div>
            <div id="expression-probabilities" class="expression-probabilities">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>
          <div class="expression-explanation">
            <div class="expression-label">ì ìˆ˜ ê³„ì‚° ê·¼ê±°</div>
            <div id="expression-explanation-text" class="expression-explanation-text">
              í‘œì • ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
          </div>
        </div>
          </div>
  </div>

    <!-- ì‹œì„  ì•ˆì •ì„± ìƒì„¸ ì •ë³´ íŒì—… -->
    <div id="gaze-details-popup" class="details-popup">
      <div class="details-popup-content">
        <div class="details-popup-header">
          <h3>ğŸ‘ï¸ ì‹œì„  ì•ˆì •ì„± ë¶„ì„ ìƒì„¸</h3>
          <button class="details-popup-close" onclick="closeGazeDetails()">Ã—</button>
        </div>
        <div class="details-popup-body">
          <div class="gaze-summary">
            <div class="gaze-main">
              <div class="gaze-label">ì‹œì„  ìƒíƒœ</div>
              <div id="gaze-main-value" class="gaze-main-value">-</div>
            </div>
            <div class="gaze-stability">
              <div class="gaze-label">ì•ˆì •ì„± ì ìˆ˜</div>
              <div id="gaze-stability-value" class="gaze-stability-value">-%</div>
            </div>
          </div>
          <div class="gaze-breakdown">
            <div class="gaze-label">ëœë“œë§ˆí¬ ì •ë³´</div>
            <div id="gaze-landmarks" class="gaze-landmarks">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>
          <div class="gaze-criteria">
            <div class="gaze-label">í‰ê°€ ê¸°ì¤€</div>
            <div id="gaze-criteria-text" class="gaze-criteria-text">
              ì‹œì„  ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
          </div>
          <div class="gaze-explanation">
            <div class="gaze-label">ì ìˆ˜ ê³„ì‚° ê·¼ê±°</div>
            <div id="gaze-explanation-text" class="gaze-explanation-text">
              ì‹œì„  ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
          </div>
        </div>
          </div>
  </div>

    <!-- ì§‘ì¤‘ë„ ìƒì„¸ ì •ë³´ íŒì—… -->
    <div id="concentration-details-popup" class="details-popup">
      <div class="details-popup-content">
        <div class="details-popup-header">
          <h3>ğŸ¯ ì§‘ì¤‘ë„ ë¶„ì„ ìƒì„¸</h3>
          <button class="details-popup-close" onclick="closeConcentrationDetails()">Ã—</button>
        </div>
        <div class="details-popup-body">
          <div class="concentration-summary">
            <div class="concentration-main">
              <div class="concentration-label">ì§‘ì¤‘ ìƒíƒœ</div>
              <div id="concentration-main-value" class="concentration-main-value">-</div>
            </div>
            <div class="concentration-score">
              <div class="concentration-label">ì§‘ì¤‘ë„ ì ìˆ˜</div>
              <div id="concentration-score-value" class="concentration-score-value">-%</div>
            </div>
          </div>
          <div class="concentration-breakdown">
            <div class="concentration-label">ë¶„ì„ ìš”ì†Œ</div>
            <div id="concentration-factors" class="concentration-factors">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>
          <div class="concentration-criteria">
            <div class="concentration-label">í‰ê°€ ê¸°ì¤€</div>
            <div id="concentration-criteria-text" class="concentration-criteria-text">
              ì§‘ì¤‘ë„ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
          </div>
          <div class="concentration-explanation">
            <div class="concentration-label">ì ìˆ˜ ê³„ì‚° ê·¼ê±°</div>
            <div id="concentration-explanation-text" class="concentration-explanation-text">
              ì§‘ì¤‘ë„ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
          </div>
        </div>
          </div>
  </div>

    <!-- ìì„¸ ìƒì„¸ ì •ë³´ íŒì—… -->
    <div id="posture-details-popup" class="details-popup">
      <div class="details-popup-content">
        <div class="details-popup-header">
          <h3>âœ¨ ìì„¸ ë¶„ì„ ìƒì„¸</h3>
          <button class="details-popup-close" onclick="closePostureDetails()">Ã—</button>
        </div>
        <div class="details-popup-body">
          <div class="posture-summary">
            <div class="posture-main">
              <div class="posture-label">ìì„¸ ìƒíƒœ</div>
              <div id="posture-main-value" class="posture-main-value">-</div>
            </div>
            <div class="posture-score">
              <div class="posture-label">ìì„¸ ì ìˆ˜</div>
              <div id="posture-score-value" class="posture-score-value">-%</div>
            </div>
          </div>
          <div class="posture-breakdown">
            <div class="posture-label">ë¶„ì„ ìš”ì†Œ</div>
            <div id="posture-factors" class="posture-factors">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>
          <div class="posture-criteria">
            <div class="posture-label">í‰ê°€ ê¸°ì¤€</div>
            <div id="posture-criteria-text" class="posture-criteria-text">
              ìì„¸ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
          </div>
          <div class="posture-explanation">
            <div class="posture-label">ì ìˆ˜ ê³„ì‚° ê·¼ê±°</div>
            <div id="posture-explanation-text" class="posture-explanation-text">
              ìì„¸ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </div>
    </div>

         <div class="card video-container">
       <header>â¤ï¸ ë°ì´íŠ¸ ì¤‘</header>
               <div class="video-wrapper">
           <div id="video-loading" class="video-loading">
             <div class="loading-spinner"></div>
             <p>ë¹„ë””ì˜¤ ë¡œë”© ì¤‘...</p>
           </div>
           <video id="video" poster="https://placehold.co/1280x720/e0e8ff/ffffff?text=Video+Stream" playsinline loop></video>
        </div>
       <section class="body">
         <div class="suggestion-container">
             <h4>ì´ëŸ° ì£¼ì œë¡œ ë¬¼ì–´ë³´ì„¸ìš”</h4>
             <div class="suggestion-tags">
                 <button class="tag">ìµœê·¼ì— ë³¸ ì˜í™”</button>
                 <button class="tag">ì£¼ë§ ê³„íš</button>
                 <button class="tag">ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ìŒì‹</button>
                 <button class="tag">ìš”ì¦˜ ì¦ê²¨ë“£ëŠ” ë…¸ë˜</button>
             </div>
         </div>
       </section>
     </div>

     <div class="card">
       <header>ğŸ’¬ ëŒ€í™” ì¤‘</header>
       <div class="chat-log" id="chatLog"></div>
                      <div class="chat-input">
           <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
           <button id="inputBtn" class="input-btn" title="ë©”ì‹œì§€ ì „ì†¡">
                               <img src="" alt="ì „ì†¡" id="inputIcon">
           </button>
         </div>
    </div>
</div>

<script>
// --- ì„œë²„/ì—”ë“œí¬ì¸íŠ¸ ì„¤ì • (Vercel í”„ë¡ì‹œ ì‚¬ìš©) ---
const serverUrl = window.__API_BASE__ || "https://dys-phi.vercel.app/api/gke";
const apiEndpoints = {
  chat: `${serverUrl}/api/chat`,
  feedback: `${serverUrl}/api/feedback`,
  calibration: `${serverUrl}/api/calibration`,
  user_check: `${serverUrl}/api/user/check`,
  frame: `${serverUrl}/api/frame`,          // í”„ë ˆì„ ì—…ë¡œë“œ
  landmarks: `${serverUrl}/api/landmarks`,
};
// ê°œë°œ í™˜ê²½ì—ì„œëŠ” í•­ìƒ WS í”„ë¡œí† ì½œ ì‚¬ìš© (HTTP ê¸°ë°˜)
const wsProto = "ws";

// WebSocket ì„¤ì • - ì„œë²„ì—ì„œ ë™ì ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
let wsEndpoints = {};

async function initializeWebSocketConfig() {
  try {
    console.log('[WEBSOCKET] ì„œë²„ì—ì„œ WebSocket ì„¤ì • ê°€ì ¸ì˜¤ëŠ” ì¤‘...');
    const wsConfigResponse = await fetch(`${serverUrl}/api/websocket/config`);
    
    if (wsConfigResponse.ok) {
      const wsConfig = await wsConfigResponse.json();
      const wsProtocol = wsConfig.protocol || 'wss';
      const wsHost = `${wsConfig.host}:${wsConfig.port}`;
      
      wsEndpoints = {
        landmarks: `${wsProtocol}://${wsHost}/ws/landmarks`,
      };
      
      console.log('[WEBSOCKET] âœ… ì„œë²„ì—ì„œ WebSocket ì„¤ì • ë¡œë“œ ì™„ë£Œ:', wsConfig);
      console.log('[WEBSOCKET] ì‚¬ìš©í•  WebSocket URL:', wsEndpoints.landmarks);
      return true;
    } else {
      throw new Error(`WebSocket config fetch failed: ${wsConfigResponse.status}`);
    }
  } catch (error) {
    console.warn('[WEBSOCKET] âš ï¸ ì„œë²„ WebSocket ì„¤ì • ë¡œë“œ ì‹¤íŒ¨, fallback ì‚¬ìš©:', error);
    
    // Fallback ë¡œì§
    const isGKE = location.hostname.includes('vercel.app') || location.hostname.includes('dys-phi');
    const isDev = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    
    let wsHost, wsProtocol;
    
    if (isGKE) {
      // í”„ë¡œë•ì…˜ í™˜ê²½ - í™˜ê²½ë³€ìˆ˜ë‚˜ ë™ì  ì„¤ì • ì‚¬ìš©
      wsHost = window.__WS_HOST__ || '34.64.136.237'; // í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì • ê°€ëŠ¥
      wsProtocol = 'wss';
    } else if (isDev) {
      // ê°œë°œ í™˜ê²½
      wsHost = location.hostname;
      wsProtocol = 'ws';
    } else {
      // ê¸°íƒ€ í™˜ê²½
      wsHost = location.hostname;
      wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';
    }
    
    wsEndpoints = {
      landmarks: `${wsProtocol}://${wsHost}:8001/ws/landmarks`,
    };
    
    console.log('[WEBSOCKET] Fallback WebSocket ì„œë²„ ì‚¬ìš©:', `${wsProtocol}://${wsHost}:8001`);
    console.log('[WEBSOCKET] í™˜ê²½ ê°ì§€:', { isGKE, isDev, wsHost, wsProtocol });
    return false;
  }
}

// WebSocket ì„¤ì • ì´ˆê¸°í™”ë¥¼ ì¦‰ì‹œ ì‹¤í–‰
initializeWebSocketConfig().then(success => {
  console.log('[WEBSOCKET] WebSocket ì„¤ì • ì´ˆê¸°í™” ì™„ë£Œ:', success ? 'ì„œë²„ ì„¤ì • ì‚¬ìš©' : 'Fallback ì„¤ì • ì‚¬ìš©');
}).catch(error => {
  console.error('[WEBSOCKET] WebSocket ì„¤ì • ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
});

// ì „ì—­ ìŠ¤ì½”í”„ì— ë…¸ì¶œí•˜ì—¬ ëª¨ë“ˆì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
window.serverUrl = serverUrl;
window.wsEndpoints = wsEndpoints;
window.apiEndpoints = apiEndpoints;

// ì´ë¯¸ì§€ ê²½ë¡œ ë™ì  ì„¤ì •
document.addEventListener('DOMContentLoaded', function() {
    const cameraIcon = document.getElementById('cameraIcon');
    const inputIcon = document.getElementById('inputIcon');
    
    if (cameraIcon) {
        cameraIcon.src = `${window.serverUrl}/dys_studio/img/icon/camera.webp`;
    }
    
    if (inputIcon) {
        inputIcon.src = `${window.serverUrl}/dys_studio/img/icon/enter_icon.webp`;
    }
});

// --- ëœë“œë§ˆí¬ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ ---
let suggestedHz = 10; // ì›Œì»¤ì—ì„œ ì‚¬ìš©í•  FPS

// --- ë³´ì•ˆ ê°•í™”: URL íŒŒë¼ë¯¸í„°ë¥¼ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•˜ê³  URL ì •ë¦¬ ---
function secureUserData() {
    // URLì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
const urlParams = new URLSearchParams(window.location.search);
    const userData = {
        user_id: urlParams.get('user_id'),
        email: urlParams.get('email'),
        token: urlParams.get('token'),
        persona_name: urlParams.get('persona_name'),
        persona_age: urlParams.get('persona_age'),
        persona_mbti: urlParams.get('persona_mbti'),
        persona_job: urlParams.get('persona_job'),
        persona_personality: urlParams.get('persona_personality'),
        persona_image: urlParams.get('persona_image')
    };

    // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì•ˆì „í•˜ê²Œ ì €ì¥
    sessionStorage.setItem('userData', JSON.stringify(userData));

    // URLì—ì„œ ë¯¼ê°í•œ ì •ë³´ ì œê±° (íˆìŠ¤í† ë¦¬ ë³€ê²½ ì—†ì´)
    const cleanUrl = new URL(window.location.href);
    cleanUrl.search = '';
    window.history.replaceState({}, document.title, cleanUrl.pathname);
}

// --- ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ---
function getUserData() {
    const userDataStr = sessionStorage.getItem('userData');
    if (!userDataStr) {
        console.error('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return null;
    }
    return JSON.parse(userDataStr);
}

// --- ì „ì—­ ë³€ìˆ˜ë¡œ ì‚¬ìš©ì ì •ë³´ ì„¤ì • ---
let userId, email, token, personaName, personaAge, personaMbti, personaJob, personaPersonality, personaImage;

// ì „ì—­ ìŠ¤ì½”í”„ì— ë…¸ì¶œí•˜ì—¬ ëª¨ë“ˆì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
window.userId = userId;
window.email = email;
window.token = token;
window.personaName = personaName;
window.personaAge = personaAge;
window.personaMbti = personaMbti;
window.personaJob = personaJob;
window.personaPersonality = personaPersonality;
window.personaImage = personaImage;

// --- ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™” ---
function initializeUserData() {
    const userData = getUserData();
    if (userData) {
        userId = userData.user_id;
        email = userData.email;
        token = userData.token;
        personaName = userData.persona_name;
        personaAge = userData.persona_age;
        personaMbti = userData.persona_mbti;
        personaJob = userData.persona_job;
        personaPersonality = userData.persona_personality;
        personaImage = userData.persona_image;
        
        // ì „ì—­ ìŠ¤ì½”í”„ì— ì—…ë°ì´íŠ¸
        window.userId = userId;
        window.email = email;
        window.token = token;
        window.personaName = personaName;
        window.personaAge = personaAge;
        window.personaMbti = personaMbti;
        window.personaJob = personaJob;
        window.personaPersonality = personaPersonality;
        window.personaImage = personaImage;
        
        console.log('âœ… ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™” ì™„ë£Œ');
        return true;
    } else {
        console.error('âŒ ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return false;
    }
}

// --- í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œ ì‚¬ìš©ì ì •ë³´ ë³µêµ¬ ---
function restoreUserDataOnRefresh() {
    // URLì— íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('user_id')) {
        secureUserData();
        
        // ì—ëŸ¬ íŒŒë¼ë¯¸í„° ì²´í¬ ë° ì²˜ë¦¬
        const error = urlParams.get('error');
        if (error) {
            handlePageError(error);
            return false; // ì—ëŸ¬ê°€ ìˆìœ¼ë©´ ì´ˆê¸°í™” ì¤‘ë‹¨
        }
        
        // ì„¸ì…˜ ì¢…ë£Œ ì„±ê³µ íŒŒë¼ë¯¸í„° ì²´í¬ ë° ì²˜ë¦¬
        const sessionEnded = urlParams.get('session_ended');
        if (sessionEnded === 'true') {
            handleSessionEnded();
        }
        
        // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ê±´ë„ˆë›°ê¸° íŒŒë¼ë¯¸í„° ì²´í¬
        const skipCalibration = urlParams.get('skip_calibration');
        if (skipCalibration === 'true') {
            // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ê±´ë„ˆë›°ê¸° í”Œë˜ê·¸ë¥¼ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            sessionStorage.setItem('skipCalibration', 'true');
        }
        
        return true;
    }
    
    // URLì— íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë³µêµ¬ ì‹œë„
    const userData = getUserData();
    if (userData) {
        initializeUserData();
        return true;
    }
    
    return false;
}

// --- í˜ì´ì§€ ì—ëŸ¬ ì²˜ë¦¬ ---
function handlePageError(error) {
    console.error('âŒ í˜ì´ì§€ ì—ëŸ¬ ë°œìƒ:', error);
    
    let errorMessage = '';
    let errorTitle = '';
    
    switch (error) {
        case 'session_end_failed':
            errorTitle = 'ì„¸ì…˜ ì¢…ë£Œ ì‹¤íŒ¨';
            errorMessage = 'ë°ì´íŠ¸ ì„¸ì…˜ì„ ì¢…ë£Œí•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            break;
        case 'user_not_found':
            errorTitle = 'ì‚¬ìš©ì ì •ë³´ ì—†ìŒ';
            errorMessage = 'ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
            break;
        default:
            errorTitle = 'ì˜¤ë¥˜ ë°œìƒ';
            errorMessage = 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.';
    }
    
    // ì—ëŸ¬ íŒì—… í‘œì‹œ
    showErrorPopup(errorTitle, errorMessage);
}

// --- ì—ëŸ¬ íŒì—… í‘œì‹œ ---
function showErrorPopup(title, message) {
    // ê¸°ì¡´ ì—ëŸ¬ íŒì—…ì´ ìˆìœ¼ë©´ ì œê±°
    const existingError = document.getElementById('error-popup');
    if (existingError) {
        existingError.remove();
    }
    
    // ì—ëŸ¬ íŒì—… ìƒì„±
    const errorPopup = document.createElement('div');
    errorPopup.id = 'error-popup';
    errorPopup.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 5000;
        display: flex;
        justify-content: center;
        align-items: center;
    `;
    
    errorPopup.innerHTML = `
        <div style="
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        ">
            <div style="
                width: 60px;
                height: 60px;
                background: #ef4444;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 20px;
                font-size: 24px;
                color: white;
            ">âš ï¸</div>
            <h3 style="margin: 0 0 16px; color: #1f2937; font-size: 20px;">${title}</h3>
            <p style="margin: 0 0 24px; color: #6b7280; line-height: 1.5;">${message}</p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button onclick="retrySession()" style="
                    padding: 12px 24px;
                    background: #6c7cff;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                ">ë‹¤ì‹œ ì‹œë„</button>
                <button onclick="goToHome()" style="
                    padding: 12px 24px;
                    background: #e5e7eb;
                    color: #374151;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                ">í™ˆìœ¼ë¡œ</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(errorPopup);
}

// --- ë‹¤ì‹œ ì‹œë„ í•¨ìˆ˜ ---
function retrySession() {
    const errorPopup = document.getElementById('error-popup');
    if (errorPopup) {
        errorPopup.remove();
    }
    
    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    window.location.reload();
}

// --- í™ˆìœ¼ë¡œ ì´ë™ í•¨ìˆ˜ ---
function goToHome() {
    // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬
    sessionStorage.clear();
    
    // í™ˆí˜ì´ì§€ë¡œ ì´ë™ (ì‹¤ì œ í™ˆí˜ì´ì§€ URLë¡œ ë³€ê²½ í•„ìš”)
    window.location.href = '/';
}

// --- ì„¸ì…˜ ì¢…ë£Œ ì„±ê³µ ì²˜ë¦¬ ---
function handleSessionEnded() {
    console.log('âœ… ì„¸ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    
    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
    showSuccessMessage();
    
    // URLì—ì„œ session_ended íŒŒë¼ë¯¸í„° ì œê±°
    const url = new URL(window.location.href);
    url.searchParams.delete('session_ended');
    url.searchParams.delete('session_id');
    window.history.replaceState({}, document.title, url.toString());
}

// --- ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ ---
function showSuccessMessage() {
    // ê¸°ì¡´ ì„±ê³µ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì œê±°
    const existingSuccess = document.getElementById('success-message');
    if (existingSuccess) {
        existingSuccess.remove();
    }
    
    // ì„±ê³µ ë©”ì‹œì§€ ìƒì„±
    const successMessage = document.createElement('div');
    successMessage.id = 'success-message';
    successMessage.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        z-index: 4000;
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideInRight 0.3s ease-out;
        max-width: 300px;
    `;
    
    successMessage.innerHTML = `
        <div style="font-size: 20px;">âœ…</div>
        <div>
            <div style="font-weight: 600; margin-bottom: 4px;">ë°ì´íŠ¸ ì™„ë£Œ!</div>
            <div style="font-size: 14px; opacity: 0.9;">ì„¸ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</div>
        </div>
        <button onclick="closeSuccessMessage()" style="
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.7;
            padding: 4px;
            border-radius: 4px;
        ">Ã—</button>
    `;
    
    document.body.appendChild(successMessage);
    
    // 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¸°ê¸°
    setTimeout(() => {
        closeSuccessMessage();
    }, 5000);
}

// --- ì„±ê³µ ë©”ì‹œì§€ ë‹«ê¸° ---
function closeSuccessMessage() {
    const successMessage = document.getElementById('success-message');
    if (successMessage) {
        successMessage.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
            successMessage.remove();
        }, 300);
    }
}

// --- ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ ì¶”ê°€ ---
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

// --- ëª¨ë“ˆ ë¡œë”© ìœ í‹¸ë¦¬í‹° ---
/**
 * ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆì´ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
 * @param {number} timeout - íƒ€ì„ì•„ì›ƒ (ms)
 * @returns {Promise<void>}
 */
async function waitForCalibrationModule(timeout = 5000) {
    const startTime = Date.now();
    
    while (typeof window.CalibrationModule === 'undefined') {
        if (Date.now() - startTime > timeout) {
            console.error('[CALIBRATION] ëª¨ë“ˆ ë¡œë”© íƒ€ì„ì•„ì›ƒ');
            throw new Error('ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ë¡œë”© ì‹¤íŒ¨');
        }
        // 10msë§ˆë‹¤ ì²´í¬ (non-blocking)
        await new Promise(resolve => setTimeout(resolve, 10));
    }
}

// --- ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ë¡œì§ (ë³„ë„ íŒŒì¼ë¡œ ë¶„ë¦¬ë¨) ---
document.addEventListener('DOMContentLoaded', async () => {
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë“  ë©”íŠ¸ë¦­ ì´ˆê¸°í™”
    setTimeout(() => {
        resetAllMetrics();
    }, 100);
    
    // ì‚¬ìš©ì ë°ì´í„° ë³´ì•ˆ ì²˜ë¦¬ ë° ì´ˆê¸°í™”
    const userDataRestored = restoreUserDataOnRefresh();
    if (!userDataRestored) {
        console.error('ì‚¬ìš©ì ì •ë³´ë¥¼ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë‹¤ì‹œ ë¡œë“œí•´ì£¼ì„¸ìš”.');
        // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ í‘œì‹œ
        alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ì „ í˜ì´ì§€ë¡œ ëŒì•„ê°€ì„œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        window.history.back();
        return;
    }
    
    // ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™” (ì´ ë¶€ë¶„ì´ ëˆ„ë½ë˜ì–´ ìˆì—ˆìŒ)
    const userDataInitialized = initializeUserData();
    if (!userDataInitialized) {
        console.error('ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        alert('ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        window.location.reload();
        return;
    }
    
    // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ë¡œë”© ëŒ€ê¸° ë° ì´ˆê¸°í™”
    await waitForCalibrationModule();
    console.log('[CALIBRATION] ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ - ì´ˆê¸°í™” ì‹œì‘');
    
    // ì‚¬ìš©ì ì •ë³´ê°€ ì´ˆê¸°í™”ëœ í›„ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™”
    if (window.CalibrationModule && typeof window.CalibrationModule.initializeCalibration === 'function') {
        console.log('[CALIBRATION] ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™” ì™„ë£Œ - ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™” ì‹œì‘');
        
        // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™” (ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • í¬í•¨)
        if (typeof window.initializeCalibrationModule === 'function') {
            window.initializeCalibrationModule();
        }
        
        // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ìƒíƒœ í™•ì¸ ë° ì´ˆê¸°í™”
        window.CalibrationModule.initializeCalibration();
        
        // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™” ì™„ë£Œ - ì‚¬ìš©ì ì„ íƒ ëŒ€ê¸°
        console.log('[APP] ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™” ì™„ë£Œ - ì‚¬ìš©ì ì„ íƒ ëŒ€ê¸° ì¤‘');
        // ì‚¬ìš©ìê°€ "ê±´ë„ˆë›°ê¸°"ë¥¼ ëˆ„ë¥´ê±°ë‚˜ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ì„ ì™„ë£Œí•œ í›„ì—ë§Œ ì•± ì‹œì‘ë¨
        
        // ì•± ì‹œì‘ í”Œë˜ê·¸ ê°ì§€
        const checkAppStart = () => {
            if (window.__readyToStartApp) {
                console.log('[APP] ì‚¬ìš©ì ì„ íƒ ê°ì§€ - ì•± ì‹œì‘');
                initializeApp();
            } else {
                setTimeout(checkAppStart, 100); // 100msë§ˆë‹¤ í™•ì¸
            }
        };
        checkAppStart();
    } else {
        console.error('[CALIBRATION] ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™” í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆì´ ì—†ì–´ë„ ì‚¬ìš©ì ì„ íƒì„ ê¸°ë‹¤ë¦¼
        console.log('[APP] ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì—†ìŒ - ì‚¬ìš©ì ì„ íƒ ëŒ€ê¸° ì¤‘');
    }
    
    // ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìƒì„± (ê°œë°œ ëª¨ë“œì—ì„œë§Œ)
    if (window.PerformanceMonitor && window.location.hostname === 'localhost') {
        window.PerformanceMonitor.generateReport();
    }
    
    // ìŒì„± ì…ë ¥ ê´€ë¦¬ì ì´ˆê¸°í™” (ì§€ì—° ì‹¤í–‰)
    setTimeout(() => {
        if (window.VoiceInputManager) {
            window.voiceManager = new VoiceInputManager();
            console.log('[VOICE] ìŒì„± ì…ë ¥ ê´€ë¦¬ì ì´ˆê¸°í™” ì™„ë£Œ');
        } else {
            console.warn('[VOICE] VoiceInputManagerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // TTS ê´€ë¦¬ì ì´ˆê¸°í™”
        if (window.TTSManager) {
            window.ttsManager = new TTSManager();
            console.log('[TTS] TTS ê´€ë¦¬ì ì´ˆê¸°í™” ì™„ë£Œ');
        } else {
            console.warn('[TTS] TTSManagerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
    }, 500);
});


// --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
const feedbackPanel = document.getElementById('feedbackPanel');
const feedbackToggleBtn = document.getElementById('feedbackToggleBtn');
const closeBtn = document.getElementById('closeBtn');
const chatLog = document.getElementById('chatLog');
const chatInput = document.getElementById('chatInput');
const inputBtn = document.getElementById('inputBtn');
const inputIcon = document.getElementById('inputIcon');

// --- ì¹´ë©”ë¼ ë¶„ì„ê¸° (ë³„ë„ íŒŒì¼ë¡œ ë¶„ë¦¬ë¨) ---
// js/camera-analyzer.jsì—ì„œ CameraAnalyzer í´ë˜ìŠ¤ì™€ ê´€ë ¨ í•¨ìˆ˜ë“¤ì´ ë¡œë“œë¨

// ëª¨ë“  ë©”íŠ¸ë¦­ ì´ˆê¸°í™” í•¨ìˆ˜
function resetAllMetrics() {
  console.log('[UI] ğŸ”„ ëª¨ë“  ë©”íŠ¸ë¦­ ì´ˆê¸°í™” ì‹œì‘');
  
  // DOM ìš”ì†Œë“¤ ì´ˆê¸°í™”
  const elements = {
    posture: document.getElementById('posture-score'),
    gaze: document.getElementById('gaze-score'),
    concentration: document.getElementById('concentration-score'),
    blink: document.getElementById('blinking-score'),
    expression: document.getElementById('expression-score'),
    total: document.getElementById('total-score')
  };
  
  // ì ìˆ˜ ì´ˆê¸°í™”
  Object.values(elements).forEach(element => {
    if (element) {
      element.textContent = '0%';
      element.style.color = '#6b7280'; // íšŒìƒ‰ìœ¼ë¡œ ë³€ê²½
    }
  });
  
  // ìƒíƒœ í‘œì‹œ ì´ˆê¸°í™”
  const statusElements = {
    expression: document.getElementById('expression-status'),
    gaze: document.getElementById('gaze-status'),
    concentration: document.getElementById('concentration-status'),
    posture: document.getElementById('posture-status'),
    blinking: document.getElementById('blinking-status')
  };
  
  Object.values(statusElements).forEach(element => {
    if (element) {
      element.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
      element.style.color = '#6b7280';
    }
  });
  
  // ì „ì—­ ë°ì´í„° ì´ˆê¸°í™” (now managed by popup-manager.js)
  if (window.PopupManager) {
      window.PopupManager.currentExpressionData = null;
      window.PopupManager.currentGazeData = null;
      window.PopupManager.currentConcentrationData = null;
      window.PopupManager.currentPostureData = null;
      window.PopupManager.currentBlinkingData = null;
  }
  
  // í‘œì • ë¶„ì„ ë°ì´í„° ì´ˆê¸°í™”
  lastExpressionScore = 60;
  lastExpressionText = 'ì¤‘ë¦½ì ';
  lastExpressionUpdate = 0;
  
  // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸° ì´ˆê¸°í™”
  if (window.ComprehensiveScoreCalculator) {
      window.ComprehensiveScoreCalculator.resetAllScores();
  }
  
  // ëŒ€í™” ì£¼ë„ê¶Œ ë¶„ì„ê¸° ì´ˆê¸°í™”
  if (window.ConversationAnalyzer) {
      window.ConversationAnalyzer.chatHistory = [];
      window.ConversationAnalyzer.analyzeConversation();
  }
  
  console.log('[UI] âœ… ëª¨ë“  ë©”íŠ¸ë¦­ ì´ˆê¸°í™” ì™„ë£Œ');
}

function updateCameraMetrics(metrics) {
  // ìŠ¤ë¡œí‹€ë§: 500msë§ˆë‹¤ í•œ ë²ˆì”©ë§Œ ì—…ë°ì´íŠ¸
  const now = Date.now();
  if (window.__lastUIUpdate__ && (now - window.__lastUIUpdate__) < 500) {
    return; // ë„ˆë¬´ ë¹ ë¥¸ ì—…ë°ì´íŠ¸ ë°©ì§€
  }
  window.__lastUIUpdate__ = now;
  
  // ì¹´ë©”ë¼ ì—°ê²° ìƒíƒœ í™•ì¸
  const isCameraConnected = metrics && Object.keys(metrics).length > 0;
  if (!isCameraConnected) {
    console.log('[UI] âš ï¸ ì¹´ë©”ë¼ ë°ì´í„° ì—†ìŒ - UI ì´ˆê¸°í™”');
    resetAllMetrics();
    return;
  }
  
  // metrics: {scores:{attention, stability, blink, posture}, labels:{expression}}
      const isWorkerMode = metrics?._isWorkerMode || false;
    const isMediaPipeDirect = metrics?._source === 'mediapipe-direct';
    const dataSource = isMediaPipeDirect ? 'MEDIAPIPE' : (isWorkerMode ? 'WORKER' : 'HTTP');
  console.log(`[UI] ğŸ–¥ï¸ updateCameraMetrics í˜¸ì¶œë¨ (${dataSource}):`, {
    hasNeckAnalysis: !!metrics?.neckAnalysis,
    hasShoulderAnalysis: !!metrics?.shoulderAnalysis,
    hasGazeAnalysis: !!metrics?.gazeAnalysis,
    ear: metrics?.ear,
    smileIntensity: metrics?.smileIntensity,
    neckScore: metrics?.neckAnalysis?.postureScore,
    shoulderScore: metrics?.shoulderAnalysis?.shoulderPostureScore,
    gazeScore: metrics?.gazeAnalysis?.stabilityScore,
    timestamp: new Date().toISOString()
  });
  
      try {
      // DOM ìš”ì†Œ ì¡´ì¬ í™•ì¸
      const postureElement = document.getElementById('posture-score');
      const gazeElement = document.getElementById('gaze-score');
      const concentrationElement = document.getElementById('concentration-score');
      const blinkElement = document.getElementById('blinking-score');
      const expressionElement = document.getElementById('expression-score');
      
      console.log('[UI] ğŸ” DOM ìš”ì†Œ í™•ì¸:', {
        postureElement: !!postureElement,
        gazeElement: !!gazeElement,
        concentrationElement: !!concentrationElement,
        blinkElement: !!blinkElement,
        expressionElement: !!expressionElement
      });
      
      if (!postureElement || !gazeElement || !concentrationElement || !blinkElement || !expressionElement) {
        console.warn('[UI] âš ï¸ í•„ìš”í•œ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
    
    // ì–¼êµ´ ì¸ì‹ ìƒíƒœ í™•ì¸ (ì™„í™”)
    const cameraBlocked = metrics?.coaching_message === 'ì¹´ë©”ë¼ê°€ ë³´ì´ì§€ ì•Šì•„ì„œ í”¼ë“œë°±ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    const noFace = metrics?.status === 'no-face';
    const isFaceDetected = !(cameraBlocked || noFace);
    
    console.log('[UI] ğŸ‘¤ ì–¼êµ´ ì¸ì‹ ìƒíƒœ:', {
      cameraBlocked,
      noFace,
      isFaceDetected,
      coaching_message: metrics?.coaching_message,
      status: metrics?.status
    });
    
    if (!isFaceDetected) {
      console.log('[UI] âš ï¸ ì–¼êµ´ì´ ê°ì§€ë˜ì§€ ì•ŠìŒ - UI ì´ˆê¸°í™”');
      postureElement.textContent = '0%';
      gazeElement.textContent = '0%';
      concentrationElement.textContent = '0%';
      blinkElement.textContent = '0%';
      expressionElement.textContent = '0%';
      
      // ìƒíƒœ í‘œì‹œë„ ì´ˆê¸°í™”
      const expressionStatusElement = document.getElementById('expression-status');
      const gazeStatusElement = document.getElementById('gaze-status');
      const concentrationStatusElement = document.getElementById('concentration-status');
      
      if (expressionStatusElement) {
        expressionStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        expressionStatusElement.style.color = '#6b7280';
      }
      if (gazeStatusElement) {
        gazeStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        gazeStatusElement.style.color = '#6b7280';
      }
      if (concentrationStatusElement) {
        concentrationStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        concentrationStatusElement.style.color = '#6b7280';
      }
      
      // ì „ì—­ ë°ì´í„°ë„ ì´ˆê¸°í™”
      currentExpressionData = null;
      currentGazeData = null;
      currentConcentrationData = null;
      
      // í‘œì • ë¶„ì„ ë°ì´í„° ì´ˆê¸°í™”
      lastExpressionScore = 60;
      lastExpressionText = 'ì¤‘ë¦½ì ';
      lastExpressionUpdate = 0;
      
      return;
    }
    
    // ìì„¸ ì ìˆ˜ (í†µì¼ëœ ë°ì´í„° êµ¬ì¡° ì²˜ë¦¬)
    let postureScore = 60; // ê¸°ë³¸ê°’
    
    // í†µì¼ëœ ë¶„ì„ ë°ì´í„° êµ¬ì¡° ì²˜ë¦¬
    if (metrics?.neckAnalysis && metrics?.shoulderAnalysis) {
        console.log('[UI] ë¶„ì„ ë°ì´í„° ë°œê²¬:', {
            neckAnalysis: metrics.neckAnalysis,
            shoulderAnalysis: metrics.shoulderAnalysis
        });
        
        const neckScore = metrics.neckAnalysis.postureScore || 0;
        const shoulderScore = metrics.shoulderAnalysis.shoulderPostureScore || 0;
        const shoulderTilt = Math.abs(metrics.shoulderAnalysis.shoulderTilt || 0);
        const forwardHeadRatio = metrics.neckAnalysis.forwardHeadRatio || 0.05;
        
        // í†µì¼ëœ ìì„¸ ì ìˆ˜ ê³„ì‚° ë¡œì§
        postureScore = 60; // ê¸°ë³¸ê°’
        
        // ì–´ê¹¨ ê¸°ìš¸ê¸° í˜ë„í‹°
        if (shoulderTilt > 20) postureScore -= 8;
        else if (shoulderTilt > 8) postureScore -= 4;
        else postureScore += 8;
        
        // ê±°ë¶ëª© í˜ë„í‹°
        if (forwardHeadRatio > 0.08) postureScore -= 8;
        else if (forwardHeadRatio > 0.035) postureScore -= 4;
        else postureScore += 8;
        
        // ëª©ìì„¸ ë³´ë„ˆìŠ¤/í˜ë„í‹°
        if (neckScore > 70) postureScore += 5;
        else if (neckScore < 40) postureScore -= 3;
        
        // ì–´ê¹¨ìì„¸ ë³´ë„ˆìŠ¤/í˜ë„í‹°
        if (shoulderScore > 70) postureScore += 3;
        else if (shoulderScore < 40) postureScore -= 2;
        
        // ì •ë©´ ìì„¸ ë³´ë„ˆìŠ¤
        if (shoulderTilt <= 8 && forwardHeadRatio <= 0.035) postureScore += 15;
        else if (shoulderTilt <= 12 && forwardHeadRatio <= 0.05) postureScore += 10;
        else if (shoulderTilt <= 15 && forwardHeadRatio <= 0.06) postureScore += 5;
        
        console.log('[UI] ìì„¸ ì ìˆ˜ ê³„ì‚°:', { neckScore, shoulderScore, shoulderTilt, forwardHeadRatio, postureScore });
    } else if (metrics?.neckScore !== undefined && metrics?.shoulderScore !== undefined) {
        // ì›Œì»¤ ë°ì´í„° êµ¬ì¡° (ì§ì ‘ ì ìˆ˜)
        const neckScore = metrics.neckScore || 0;
        const shoulderScore = metrics.shoulderScore || 0;
        postureScore = Math.round((neckScore + shoulderScore) / 2);
        console.log('[UI] ì›Œì»¤ ë°ì´í„° ìì„¸ ì ìˆ˜ ê³„ì‚°:', { neckScore, shoulderScore, postureScore });
    } else if (metrics?.neckAnalysis) {
        postureScore = metrics.neckAnalysis.postureScore || 60;
        console.log('[UI] ëª© ë¶„ì„ë§Œ ì‚¬ìš©:', postureScore);
    } else if (metrics?.scores?.posture != null) {
        postureScore = Math.round(metrics.scores.posture);
        console.log('[UI] scores.posture ì‚¬ìš©:', postureScore);
    } else {
        postureScore = 60;
        console.log('[UI] ë¶„ì„ ë°ì´í„° ì—†ìŒ, ê¸°ë³¸ê°’ ì‚¬ìš©:', postureScore);
    }
    
    postureScore = Math.min(100, Math.max(0, Math.round(postureScore)));
    postureElement.textContent = `${postureScore}%`;
    
    // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ìì„¸ ì ìˆ˜ ì—…ë°ì´íŠ¸
    if (window.ComprehensiveScoreCalculator) {
      window.ComprehensiveScoreCalculator.updateVisualScore('posture', postureScore);
    }
    
    // ìì„¸ ë¶„ì„ ë°ì´í„° ì €ì¥ (íŒì—…ìš©)
    if (metrics?.neckAnalysis || metrics?.shoulderAnalysis) {
      currentPostureData = {
        neckAnalysis: metrics.neckAnalysis,
        shoulderAnalysis: metrics.shoulderAnalysis,
        score: postureScore,
        timestamp: Date.now()
      };
      console.log('[UI] ìì„¸ ë°ì´í„° ì €ì¥:', currentPostureData);
    } else {
      console.warn('[UI] âš ï¸ ìì„¸ ë¶„ì„ ë°ì´í„° ì—†ìŒ:', { 
        hasNeckAnalysis: !!metrics?.neckAnalysis,
        hasShoulderAnalysis: !!metrics?.shoulderAnalysis 
      });
    }
    
    // ìì„¸ ë¶„ì„ ìƒíƒœ ì—…ë°ì´íŠ¸
    const postureStatusElement = document.getElementById('posture-status');
    if (postureStatusElement) {
      if (postureScore >= 80) {
        postureStatusElement.textContent = 'ìš°ìˆ˜';
        postureStatusElement.style.color = '#10b981';
      } else if (postureScore >= 60) {
        postureStatusElement.textContent = 'ì–‘í˜¸';
        postureStatusElement.style.color = '#3b82f6';
      } else if (postureScore >= 40) {
        postureStatusElement.textContent = 'ë³´í†µ';
        postureStatusElement.style.color = '#f59e0b';
      } else {
        postureStatusElement.textContent = 'ê°œì„  í•„ìš”';
        postureStatusElement.style.color = '#ef4444';
      }
    }
    
    console.log(`[UI] ğŸ’ª ìì„¸ ì ìˆ˜ ì—…ë°ì´íŠ¸ (${dataSource}):`, { 
      rawScore: postureScore, 
      isWorkerMode,
      timestamp: new Date().toISOString()
    });
    
    if (metrics?.gazeAnalysis) {
      gazeElement.textContent = `${metrics.gazeAnalysis.stabilityScore}%`;
      
      // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ì‹œì„  ì•ˆì •ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸
      if (window.ComprehensiveScoreCalculator) {
        window.ComprehensiveScoreCalculator.updateVisualScore('gaze_stability', metrics.gazeAnalysis.stabilityScore);
      }
    } else if (metrics?.scores?.stability != null) {
      const stabilityScore = Math.round(metrics.scores.stability);
      gazeElement.textContent = `${stabilityScore}%`;
      
      // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ì‹œì„  ì•ˆì •ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸
      if (window.ComprehensiveScoreCalculator) {
        window.ComprehensiveScoreCalculator.updateVisualScore('gaze_stability', stabilityScore);
      }
    }
    
    // ì§‘ì¤‘ë„ ì ìˆ˜ (í†µì¼ëœ ë°ì´í„° êµ¬ì¡° ì²˜ë¦¬)
    let concentrationScore = 60; // ê¸°ë³¸ê°’
    
    if (metrics?.gazeAnalysis) {
      // í†µì¼ëœ ë¶„ì„ ë°ì´í„° êµ¬ì¡°
      const stabilityScore = metrics.gazeAnalysis.stabilityScore || 60;
      const isFocused = metrics.gazeAnalysis.isFocused || false;
      const gazeDirection = metrics.gazeAnalysis.gazeDirection || 'center';
      const jumpDistance = metrics.gazeAnalysis.jumpDistance || 0.03;
      const velocity = metrics.gazeAnalysis.velocity || 0.02;
      
      // MediaPipe ì§‘ì¤‘ë„ ì ìˆ˜ ê³„ì‚° ë¡œì§ (ë” ê´€ëŒ€í•œ ê¸°ì¤€)
      concentrationScore = 70; // ê¸°ë³¸ê°’ì„ ë†’ì„
      
      // ì í”„ ê±°ë¦¬ í˜ë„í‹° (ë” ê´€ëŒ€í•œ ê¸°ì¤€)
      if (jumpDistance > 0.15) concentrationScore -= 30;
      else if (jumpDistance > 0.12) concentrationScore -= 20;
      else if (jumpDistance > 0.08) concentrationScore -= 15;
      else if (jumpDistance > 0.05) concentrationScore -= 10;
      else concentrationScore += 10; // ì¢‹ì€ ì í”„ ê±°ë¦¬ ë³´ë„ˆìŠ¤
      
      // ì†ë„ í˜ë„í‹° (ë” ê´€ëŒ€í•œ ê¸°ì¤€)
      if (velocity > 0.1) concentrationScore -= 20;
      else if (velocity > 0.08) concentrationScore -= 15;
      else if (velocity > 0.05) concentrationScore -= 10;
      else concentrationScore += 5; // ì¢‹ì€ ì†ë„ ë³´ë„ˆìŠ¤
      
      // ì‹œì„  ë°©í–¥ ë³´ë„ˆìŠ¤/í˜ë„í‹°
      if (gazeDirection === 'center') concentrationScore += 15;
      else if (gazeDirection === 'mid') concentrationScore += 5;
      else concentrationScore -= 10;
      
      // ì§‘ì¤‘ ìƒíƒœ ë³´ë„ˆìŠ¤
      if (isFocused) concentrationScore += 10;
      
      // ì•ˆì •ì„± ì ìˆ˜ì™€ í‰ê·  ê³„ì‚°
      concentrationScore = Math.round((concentrationScore + stabilityScore) / 2);
      
      console.log('[UI] MediaPipe ì§‘ì¤‘ë„ ì ìˆ˜ ê³„ì‚°:', { stabilityScore, isFocused, gazeDirection, jumpDistance, velocity, concentrationScore });
    } else if (metrics?.gazeScore !== undefined) {
      // ì›Œì»¤ ë°ì´í„° êµ¬ì¡° (ì§ì ‘ ì ìˆ˜)
      concentrationScore = metrics.gazeScore || 60;
      
      console.log('[UI] ì›Œì»¤ ë°ì´í„° ì§‘ì¤‘ë„ ì ìˆ˜ ê³„ì‚°:', { gazeScore: metrics.gazeScore, concentrationScore });
    } else if (metrics?.scores?.attention != null) {
      concentrationScore = Math.round(metrics.scores.attention);
    }
    
    concentrationScore = Math.min(100, Math.max(0, Math.round(concentrationScore)));
    concentrationElement.textContent = `${concentrationScore}%`;
    updateScoreColor(concentrationElement, concentrationScore);
    
    // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ì§‘ì¤‘ë„ ì ìˆ˜ ì—…ë°ì´íŠ¸
    if (window.ComprehensiveScoreCalculator) {
      window.ComprehensiveScoreCalculator.updateAuditoryScore('concentration', concentrationScore);
    }
    
    // ì§‘ì¤‘ë„ ë¶„ì„ ë°ì´í„° ì €ì¥ (íŒì—…ìš©)
    if (metrics?.gazeAnalysis) {
      currentConcentrationData = {
        ...metrics.gazeAnalysis,
        score: concentrationScore,
        timestamp: Date.now()
      };
      console.log('[UI] ì§‘ì¤‘ë„ ë°ì´í„° ì €ì¥:', currentConcentrationData);
    } else {
      console.warn('[UI] âš ï¸ ì§‘ì¤‘ë„ ë¶„ì„ ë°ì´í„°(gazeAnalysis) ì—†ìŒ:', metrics);
    }
    
    // ì§‘ì¤‘ë„ ë¶„ì„ ìƒíƒœ ì—…ë°ì´íŠ¸
    const concentrationStatusElement = document.getElementById('concentration-status');
    if (concentrationStatusElement) {
      if (metrics?.gazeAnalysis) {
        const isFocused = metrics.gazeAnalysis.isFocused;
        concentrationStatusElement.textContent = isFocused ? 'ì§‘ì¤‘ ì¤‘' : 'ë¶„ì‚°ë¨';
        concentrationStatusElement.style.color = isFocused ? '#10b981' : '#f59e0b';
      } else {
        concentrationStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        concentrationStatusElement.style.color = '#6b7280';
      }
    }
    
    console.log(`[UI] ì§‘ì¤‘ë„ ì ìˆ˜ ì—…ë°ì´íŠ¸ (${dataSource}):`, concentrationScore);
    
    // ì‹œì„  ì•ˆì •ì„± ì ìˆ˜ (ì›Œì»¤ ë°ì´í„°ì™€ HTTP ë¶„ì„ ë°ì´í„° ëª¨ë‘ ì§€ì›)
    let gazeScore = 60; // ê¸°ë³¸ê°’
    
    if (metrics?.gazeAnalysis) {
      // HTTP ë¶„ì„ ë°ì´í„° êµ¬ì¡°
      const stabilityScore = metrics.gazeAnalysis.stabilityScore || 60;
      const jumpDistance = metrics.gazeAnalysis.jumpDistance || 0.03;
      const velocity = metrics.gazeAnalysis.velocity || 0.02;
      
      // ê¸°ì¡´ ê¸°ì¤€: ì í”„ ê±°ë¦¬ 40%, ì†ë„ 30%, í™ì±„ ì†ë„ 20%, í™ì±„ ë¶€ë“œëŸ¬ì›€ 10%
      let jumpScore = 100;
      if (jumpDistance > 0.10) jumpScore = 0;
      else if (jumpDistance > 0.08) jumpScore = 30;
      else if (jumpDistance > 0.06) jumpScore = 60;
      else if (jumpDistance > 0.04) jumpScore = 80;
      else if (jumpDistance > 0.02) jumpScore = 90;
      
      let velocityScore = 100;
      if (velocity > 0.08) velocityScore = 0;
      else if (velocity > 0.06) velocityScore = 40;
      else if (velocity > 0.04) velocityScore = 70;
      else if (velocity > 0.02) velocityScore = 90;
      
      // ê°€ì¤‘ í‰ê·  ê³„ì‚°
      gazeScore = (jumpScore * 0.4) + (velocityScore * 0.3) + (stabilityScore * 0.3);
      
      console.log('[UI] HTTP ë¶„ì„ ì‹œì„  ì•ˆì •ì„± ì ìˆ˜ ê³„ì‚°:', { stabilityScore, jumpDistance, velocity, gazeScore });
    } else if (metrics?.gazeScore !== undefined) {
      // ì›Œì»¤ ë°ì´í„° êµ¬ì¡° (ì§ì ‘ ì ìˆ˜)
      gazeScore = metrics.gazeScore || 60;
      
      console.log('[UI] ì›Œì»¤ ë°ì´í„° ì‹œì„  ì•ˆì •ì„± ì ìˆ˜ ê³„ì‚°:', { gazeScore: metrics.gazeScore });
    } else if (metrics?.scores?.stability != null) {
      gazeScore = Math.round(metrics.scores.stability);
    }
    
    gazeScore = Math.min(100, Math.max(0, Math.round(gazeScore)));
    gazeElement.textContent = `${gazeScore}%`;
    updateScoreColor(gazeElement, gazeScore);
    
    // ì‹œì„  ë¶„ì„ ë°ì´í„° ì €ì¥ (íŒì—…ìš©)
    if (metrics?.gazeAnalysis) {
      currentGazeData = {
        ...metrics.gazeAnalysis,
        score: gazeScore,
        timestamp: Date.now()
      };
      console.log('[UI] ì‹œì„  ì•ˆì •ì„± ë°ì´í„° ì €ì¥:', currentGazeData);
    } else {
      console.warn('[UI] âš ï¸ ì‹œì„  ì•ˆì •ì„± ë°ì´í„°(gazeAnalysis) ì—†ìŒ:', metrics);
    }
    
    // ì‹œì„  ë¶„ì„ ìƒíƒœ ì—…ë°ì´íŠ¸
    const gazeStatusElement = document.getElementById('gaze-status');
    if (gazeStatusElement) {
      if (metrics?.gazeAnalysis) {
        const isFocused = metrics.gazeAnalysis.isFocused;
        gazeStatusElement.textContent = isFocused ? 'ì§‘ì¤‘ ì¤‘' : 'ë¶„ì‚°ë¨';
        gazeStatusElement.style.color = isFocused ? '#10b981' : '#f59e0b';
      } else {
        gazeStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        gazeStatusElement.style.color = '#6b7280';
      }
    }
    
    console.log(`[UI] ì‹œì„  ì•ˆì •ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸ (${dataSource}):`, gazeScore);
    
    // ê¹œë¹¡ì„ ì ìˆ˜ (MediaPipe earResult ê¸°ë°˜)
    let blinkScore = 80; // ê¸°ë³¸ê°’
    
    if (metrics?.earResult?.blinkStatus) {
      // MediaPipeì—ì„œ ë°›ì€ blinkStatus ì‚¬ìš©
      const blinkStatus = metrics.earResult.blinkStatus;
      
      if (blinkStatus === 'closed') {
        blinkScore = 0; // ëˆˆì„ ê°ê³  ìˆìŒ
      } else if (blinkStatus === 'blinking') {
        blinkScore = 60; // ê¹œë¹¡ì´ëŠ” ì¤‘
      } else if (blinkStatus === 'open') {
        blinkScore = 100; // ëˆˆì„ ëœ¨ê³  ìˆìŒ
      }
      
      console.log('[UI] MediaPipe ê¹œë¹¡ì„ ìƒíƒœ:', { blinkStatus, blinkScore });
    } else if (metrics?.ear !== undefined) {
      // ê°œì¸ë³„ ê¸°ì¤€ EAR ì‚¬ìš© (ì›Œì»¤ì—ì„œ ê³„ì‚°ëœ ê°’)
      const ear = metrics.ear;
      const personalBaseEAR = metrics.personalBaseEAR || 0.22; // ê°œì¸ë³„ ê¸°ì¤€
      
      // ê°œì¸ ê¸°ì¤€ ëŒ€ë¹„ ì°¨ì´ ê³„ì‚° (ë¹„ìœ¨ë¡œ ê³„ì‚°)
      const earRatio = ear / personalBaseEAR;
      
      // ë¹„ìœ¨ ê¸°ë°˜ ì ìˆ˜ ê³„ì‚° (ë” ì •í™•í•œ ê°œì¸ë³„ í‰ê°€)
      if (earRatio < 0.7) blinkScore = 0;      // ê¸°ì¤€ì˜ 70% ë¯¸ë§Œ (ë§¤ìš° ë‚˜ì¨)
      else if (earRatio < 0.8) blinkScore = 30; // ê¸°ì¤€ì˜ 80% ë¯¸ë§Œ (ë‚˜ì¨)
      else if (earRatio < 0.9) blinkScore = 60; // ê¸°ì¤€ì˜ 90% ë¯¸ë§Œ (ë³´í†µ)
      else if (earRatio < 1.1) blinkScore = 100; // ê¸°ì¤€ì˜ 90-110% (ì¢‹ìŒ)
      else if (earRatio < 1.2) blinkScore = 80;  // ê¸°ì¤€ì˜ 110-120% (ì•½ê°„ ë‚˜ì¨)
      else blinkScore = 60;                       // ê¸°ì¤€ì˜ 120% ì´ìƒ (ë‚˜ì¨)
    } else if (metrics?.blinkRate !== undefined) {
      // ë¶„ë‹¹ ê¹œë¹¡ì„ ìˆ˜ ê¸°ë°˜ (ê¸°ì¡´ ê¸°ì¤€: 6~35íšŒ/ë¶„ ì •ìƒ)
      if (metrics.blinkRate < 4) blinkScore = 30;
      else if (metrics.blinkRate < 6) blinkScore = 70;
      else if (metrics.blinkRate >= 6 && metrics.blinkRate <= 35) blinkScore = 100;
      else if (metrics.blinkRate <= 40) blinkScore = 70;
      else blinkScore = 55;
    } else if (metrics?.scores?.blink != null) {
      blinkScore = Math.round(metrics.scores.blink);
    } else {
      // ë¶„ì„ ë°ì´í„°ê°€ ì—†ì„ ë•Œ ê¸°ë³¸ê°’ ì‚¬ìš©
      blinkScore = 80;
      console.log('[UI] ê¹œë¹¡ì„ ë¶„ì„ ë°ì´í„° ì—†ìŒ, ê¸°ë³¸ê°’ ì‚¬ìš©:', blinkScore);
    }
    
    blinkScore = Math.min(100, Math.max(0, Math.round(blinkScore)));
    blinkElement.textContent = `${blinkScore}%`;
    updateScoreColor(blinkElement, blinkScore);
    
    // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ê¹œë¹¡ì„ ì ìˆ˜ ì—…ë°ì´íŠ¸
    if (window.ComprehensiveScoreCalculator) {
      window.ComprehensiveScoreCalculator.updateVisualScore('blinking', blinkScore);
    }
    
    // ê¹œë¹¡ì„ ë¶„ì„ ë°ì´í„° ì €ì¥ (íŒì—…ìš©)
    if (metrics?.earResult) {
      currentBlinkingData = {
        earResult: metrics.earResult,
        score: blinkScore,
        timestamp: Date.now()
      };
      console.log('[UI] ê¹œë¹¡ì„ ë°ì´í„° ì €ì¥:', currentBlinkingData);
    } else {
      console.warn('[UI] âš ï¸ earResult ë°ì´í„° ì—†ìŒ:', metrics);
    }
    
    // ê¹œë¹¡ì„ ë¶„ì„ ìƒíƒœ ì—…ë°ì´íŠ¸
    const blinkingStatusElement = document.getElementById('blinking-status');
    if (blinkingStatusElement) {
      if (metrics?.earResult?.blinkStatus) {
        const blinkStatus = metrics.earResult.blinkStatus;
        if (blinkStatus === 'open') {
          blinkingStatusElement.textContent = 'ëˆˆ ëœ¸';
          blinkingStatusElement.style.color = '#10b981';
        } else if (blinkStatus === 'blinking') {
          blinkingStatusElement.textContent = 'ê¹œë¹¡ì„';
          blinkingStatusElement.style.color = '#f59e0b';
        } else if (blinkStatus === 'closed') {
          blinkingStatusElement.textContent = 'ëˆˆ ê°ìŒ';
          blinkingStatusElement.style.color = '#ef4444';
        }
      } else {
        blinkingStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        blinkingStatusElement.style.color = '#6b7280';
      }
    }
    
    console.log(`[UI] ê¹œë¹¡ì„ ì ìˆ˜ ì—…ë°ì´íŠ¸ (${dataSource}):`, blinkScore);
    
    // í‘œì • ë¶„ì„ ê²°ê³¼ ì²˜ë¦¬ (PyTorch ëª¨ë¸ ê¸°ë°˜)
    let expressionScore = lastExpressionScore; // ì´ì „ ê°’ ìœ ì§€
    let expressionText = lastExpressionText; // ì´ì „ ê°’ ìœ ì§€
    const currentTime = Date.now();
    
    if (metrics?.expressionAnalysis?.success) {
      // PyTorch ëª¨ë¸ ë¶„ì„ ê²°ê³¼ ì‚¬ìš©
      const expressionResult = metrics.expressionAnalysis;
      const scoreResult = expressionResult.score;
      
      if (scoreResult && typeof scoreResult.score === 'number') {
        // 2ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜ ì‹ ë¢°ë„ê°€ ë†’ì„ ë•Œë§Œ ì—…ë°ì´íŠ¸
        if (currentTime - lastExpressionUpdate > EXPRESSION_UPDATE_INTERVAL || 
            expressionResult.confidence > 0.6) {
          expressionScore = scoreResult.score;
          expressionText = scoreResult.label || 'ì¤‘ë¦½ì ';
          lastExpressionScore = expressionScore;
          lastExpressionText = expressionText;
          lastExpressionUpdate = currentTime;
        }
        
        // í‘œì • ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (íŒì—…ìš©)
        currentExpressionData = {
          expression: expressionResult.expression,
          confidence: expressionResult.confidence,
          probabilities: expressionResult.probabilities,
          score: scoreResult,
          timestamp: Date.now()
        };
        console.log('[UI] í‘œì • ë°ì´í„° ì €ì¥:', currentExpressionData);
        
        console.log('[UI] ğŸ­ PyTorch í‘œì • ë¶„ì„ ê²°ê³¼:', {
          expression: expressionResult.expression,
          confidence: expressionResult.confidence,
          score: expressionScore,
          label: expressionText,
          base_score: scoreResult.base_score,
          confidence_bonus: scoreResult.confidence_bonus
        });
      }
    } else if (metrics?.smileIntensity !== undefined) {
      // ê¸°ì¡´ MediaPipe ë¯¸ì†Œ ë¶„ì„ ì‚¬ìš© (ë°±ì—…)
      const smileIntensity = metrics.smileIntensity;
      const personalBaseSmile = metrics.personalBaseSmile || 30;
      
      // ê°œì¸ë³„ ê¸°ì¤€ ëŒ€ë¹„ ìƒëŒ€ì  í‰ê°€
      const smileRatio = smileIntensity / personalBaseSmile;
      
      // ì ìˆ˜ ê³„ì‚°
      if (smileRatio > 1.3) {
        expressionScore = 90;
        expressionText = 'ë§¤ìš° ë”°ëœ»í•¨';
      } else if (smileRatio > 1.1) {
        expressionScore = 80;
        expressionText = 'ë”°ëœ»í•¨';
      } else if (smileRatio > 0.9) {
        expressionScore = 70;
        expressionText = 'ê¸ì •ì ';
      } else if (smileRatio > 0.7) {
        expressionScore = 60;
        expressionText = 'ì¤‘ë¦½ì ';
      } else {
        expressionScore = 40;
        expressionText = 'ê°œì„  í•„ìš”';
      }
      
      console.log('[UI] MediaPipe ë¯¸ì†Œ ë¶„ì„ ê²°ê³¼:', {
        smileIntensity,
        smileRatio,
        expressionScore,
        expressionText
      });
    } else if (metrics?.labels?.expression) {
      expressionText = metrics.labels.expression;
      expressionScore = 60; // ê¸°ë³¸ê°’
    }
    
    // í‘œì • ì ìˆ˜ ì—…ë°ì´íŠ¸
    const expressionScoreElement = document.getElementById('expression-score');
    if (expressionScoreElement) {
      expressionScoreElement.textContent = `${expressionScore}%`;
      updateScoreColor(expressionScoreElement, expressionScore);
      
      // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— í‘œì • ì ìˆ˜ ì—…ë°ì´íŠ¸
      if (window.ComprehensiveScoreCalculator) {
        window.ComprehensiveScoreCalculator.updateVisualScore('expression', expressionScore);
      }
    }
    
    // í‘œì • ë¶„ì„ ìƒíƒœ ì—…ë°ì´íŠ¸ (í‰ê°€ ë¼ë²¨ í‘œì‹œ)
    const expressionStatusElement = document.getElementById('expression-status');
    if (expressionStatusElement) {
      if (metrics?.expressionAnalysis?.success) {
        const scoreResult = metrics.expressionAnalysis.score;
        if (scoreResult && scoreResult.label) {
          expressionStatusElement.textContent = scoreResult.label;
          // ë¼ë²¨ì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
          if (scoreResult.label.includes('ê¸ì •ì ')) {
            expressionStatusElement.style.color = '#10b981'; // ì´ˆë¡ìƒ‰
          } else if (scoreResult.label.includes('ì¤‘ë¦½ì ')) {
            expressionStatusElement.style.color = '#f59e0b'; // ì£¼í™©ìƒ‰
          } else {
            expressionStatusElement.style.color = '#ef4444'; // ë¹¨ê°„ìƒ‰
          }
        } else {
          expressionStatusElement.textContent = 'ë¶„ì„ ì¤‘';
          expressionStatusElement.style.color = '#6b7280';
        }
      } else {
        expressionStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        expressionStatusElement.style.color = '#6b7280';
      }
    }
    
    console.log(`[UI] í‘œì • ì ìˆ˜ ì—…ë°ì´íŠ¸ (${dataSource}):`, { expressionScore, expressionText });
    
    // ì ìˆ˜ ìƒ‰ìƒ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateScoreColor(element, score) {
      // ê¸°ì¡´ ìƒ‰ìƒ í´ë˜ìŠ¤ ì œê±°
      element.classList.remove('excellent', 'good', 'fair', 'poor');
      
      // ì ìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ í´ë˜ìŠ¤ ì¶”ê°€
      if (score >= 80) {
        element.classList.add('excellent');
        element.setAttribute('data-score', 'excellent');
      } else if (score >= 60) {
        element.classList.add('good');
        element.setAttribute('data-score', 'good');
      } else if (score >= 40) {
        element.classList.add('fair');
        element.setAttribute('data-score', 'fair');
      } else {
        element.classList.add('poor');
        element.setAttribute('data-score', 'poor');
      }
      
      // ì—…ë°ì´íŠ¸ ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
      element.classList.add('updating');
      setTimeout(() => {
        element.classList.remove('updating');
      }, 300);
    }
    
    // ê°œì¸í™”ëœ ê¿€íŒ ì—…ë°ì´íŠ¸
    const tips = generatePersonalizedTips(metrics);
    const tipsContainer = document.getElementById('ai-feedback-summary');
    if (tipsContainer && tips.length > 0) {
      tipsContainer.innerHTML = `
        <div style="font-weight: 700; margin-bottom: 8px; color: #1a1a1a; font-size: 14px;">ğŸ¯ ì‹¤ì‹œê°„ ê¿€íŒ!</div>
        <ol style="padding-left: 20px; margin: 0; font-size: 13px; line-height: 1.7; color: #2d2d2d; font-weight: 500;">
          ${tips.map(tip => `<li>${tip}</li>`).join('')}
        </ol>
      `;
    }
    
  } catch (e) {
    console.warn('[ANALYZER] UI update error', e);
  }
}







function clamp01To100(v) {
  if (v == null || isNaN(v)) return null;
  if (v <= 1) return Math.round(v * 100);
  return Math.round(Math.max(0, Math.min(100, v)));
}

function mapFrameResultToMetrics(result) {
  // ì–¼êµ´ ì¸ì‹ ìƒíƒœ í™•ì¸ (ì™„í™”: ear_value ì¡°ê±´ ì œê±°)
  const cameraBlocked = result?.coaching_message === 'ì¹´ë©”ë¼ê°€ ë³´ì´ì§€ ì•Šì•„ì„œ í”¼ë“œë°±ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
  const noFace = result?.status === 'no-face';
  const isFaceDetected = !(cameraBlocked || noFace);
  
  // ì–¼êµ´ì´ ì „í˜€ ê°ì§€ë˜ì§€ ì•ŠëŠ” ëª…ì‹œì  ê²½ìš°ë§Œ 0ìœ¼ë¡œ
  if (!isFaceDetected) {
    return {
      scores: { attention: 0, stability: 0, blink: 0, posture: 0 },
      labels: { expression: '-' },
      status: result?.status || 'no-face',
      coaching_message: result?.coaching_message,
      ear_value: result?.ear_value,
      frame_processed: result?.frame_processed === true
    };
  }
  
  // ë‹¤ì–‘í•œ ê²°ê³¼ í¬ë§·ì„ 5ê°œ ì§€í‘œë¡œ ì ì‘ ë§¤í•‘
  const scores = {};
  const labels = {};

  // ìš°ì„ ìˆœìœ„ 1: result.scoresì— A,S,R,P,W ë“±ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°
  const s = result?.scores || {};
  if (typeof s.A !== 'undefined') scores.attention = clamp01To100(s.A);
  if (typeof s.S !== 'undefined') scores.stability = clamp01To100(s.S);
  if (typeof s.R !== 'undefined') scores.blink = clamp01To100(s.R); // Relaxâ‰ˆBlink proxy
  // PëŠ” ë°±ì—…ìœ¼ë¡œë§Œ ì‚¬ìš© (ê°œë³„ ì ìˆ˜ë“¤ì´ ìš°ì„ )
  if (typeof s.P !== 'undefined' && s.P > 0) {
    scores.posture_backup = clamp01To100(s.P);
  }
  if (typeof s.W !== 'undefined') {
    const w = clamp01To100(s.W);
    labels.expression = w != null ? (w >= 66 ? 'ê¸ì •ì ' : w >= 40 ? 'ì¤‘ë¦½ì ' : 'ê°œì„  í•„ìš”') : undefined;
  }

  // ìš°ì„ ìˆœìœ„ 2: ê°œë³„ í•„ë“œ ëª…ì‹œì  ê°’
  if (scores.attention == null && typeof result.attention === 'number') scores.attention = clamp01To100(result.attention);
  if (scores.stability == null && typeof result.stability_score === 'number') scores.stability = clamp01To100(result.stability_score);
  if (scores.stability == null && typeof result.stability === 'number') scores.stability = clamp01To100(result.stability);
  if (scores.blink == null && typeof result.blink === 'number') scores.blink = clamp01To100(result.blink);
  
  // ìì„¸ ì ìˆ˜ ìš°ì„ ìˆœìœ„: ê°œë³„ ì ìˆ˜ë“¤ > enhanced_posture_score > posture_score > posture > scores.P ë°±ì—…
  
  // 1. ê°œë³„ ìì„¸ ì ìˆ˜ë“¤ì„ ìš°ì„ ì ìœ¼ë¡œ ê³„ì‚°
  const individualScores = [];
  if (typeof result.chin_forward_score === 'number') individualScores.push(result.chin_forward_score);
  if (typeof result.neck_tilt_score === 'number') individualScores.push(result.neck_tilt_score);
  if (typeof result.neck_score === 'number') individualScores.push(result.neck_score);
  if (typeof result.back_score === 'number') individualScores.push(result.back_score);
  if (typeof result.shoulder_blade_score === 'number') individualScores.push(result.shoulder_blade_score);
  if (typeof result.shoulder_width_score === 'number') individualScores.push(result.shoulder_width_score);
  if (typeof result.torso_height_score === 'number') individualScores.push(result.torso_height_score);
  if (typeof result.neck_length_score === 'number') individualScores.push(result.neck_length_score);
  if (typeof result.neck_angle_score === 'number') individualScores.push(result.neck_angle_score);
  
  if (individualScores.length > 0) {
    const avgIndividualScore = individualScores.reduce((a, b) => a + b, 0) / individualScores.length;
    scores.posture = clamp01To100(avgIndividualScore);
  }
  
  // 2. ë°±ì—… ì ìˆ˜ë“¤
  if (scores.posture == null && typeof result.enhanced_posture_score === 'number') {
    scores.posture = clamp01To100(result.enhanced_posture_score);
  }
  if (scores.posture == null && typeof result.posture_score === 'number') {
    scores.posture = clamp01To100(result.posture_score);
  }
  if (scores.posture == null && typeof result.posture === 'number') {
    scores.posture = clamp01To100(result.posture);
  }

  // ì¶”ê°€ í›„ë³´ í‚¤ë“¤
  if (scores.attention == null && typeof result.attention_score === 'number') scores.attention = clamp01To100(result.attention_score);
  if (scores.attention == null && typeof result.focus === 'number') scores.attention = clamp01To100(result.focus);
  if (scores.attention == null && typeof result.focus_score === 'number') scores.attention = clamp01To100(result.focus_score);
  if (scores.attention == null && typeof result.gaze_attention === 'number') scores.attention = clamp01To100(result.gaze_attention);
  if (scores.blink == null && typeof result.blink_score === 'number') scores.blink = clamp01To100(result.blink_score);
  if (scores.blink == null && typeof result.blinking === 'number') scores.blink = clamp01To100(result.blinking);

  // 3. ê¸°í•˜í•™ì  ì¸¡ì •ê°’ ê¸°ë°˜ ì ìˆ˜ (ê°œë³„ ì ìˆ˜ë³´ë‹¤ ìš°ì„ )
  if (scores.posture == null) {
    // 3a. ìƒíƒœ ë¬¸ìì—´ ê¸°ë°˜ ì ìˆ˜ (ê°œë³„ ì ìˆ˜ë“¤ì´ ì—†ì„ ë•Œë§Œ ì‚¬ìš©)
    const hasIndividualScores = individualScores.length > 0;
    
    if (!hasIndividualScores) {
      const status = typeof result.posture_status === 'string' ? result.posture_status.toLowerCase() : '';
      const enhancedStatus = typeof result.enhanced_posture_status === 'string' ? result.enhanced_posture_status.toLowerCase() : '';
      const backStatus = typeof result.back_status === 'string' ? result.back_status.toLowerCase() : '';
      const neckStatus = typeof result.neck_status === 'string' ? result.neck_status.toLowerCase() : '';
      
      if (status || enhancedStatus || backStatus || neckStatus) {
        const allStatuses = [status, enhancedStatus, backStatus, neckStatus].filter(s => s);
        let maxScore = 0;
        
        for (const s of allStatuses) {
          if (s.includes('ë§¤ìš° ì¢‹') || s.includes('excellent') || s.includes('best')) maxScore = Math.max(maxScore, 95);
          else if (s.includes('ì¢‹') || s.includes('good')) maxScore = Math.max(maxScore, 85);
          else if (s.includes('ë³´í†µ') || s.includes('ok') || s.includes('neutral')) maxScore = Math.max(maxScore, 70);
          else if (s.includes('ê°œì„ ') || s.includes('ë‚˜ì¨') || s.includes('bad')) maxScore = Math.max(maxScore, 50); // 35 â†’ 50ìœ¼ë¡œ ì™„í™”
          else if (s.includes('ë°ì´í„°ì—†ìŒ') || s.includes('no data')) maxScore = Math.max(maxScore, 0);
        }
        
        if (maxScore > 0) scores.posture = maxScore;
      }
    }
    
    // 3b. ê¸°í•˜í•™ì  ì¸¡ì •ê°’ ê¸°ë°˜ ì ìˆ˜ (ë” ì •êµí•œ ê³„ì‚°)
    if (scores.posture == null) {
      const fwd = typeof result.forward_head === 'number' ? Math.abs(result.forward_head) : null;
      const tilt = typeof result.shoulder_tilt === 'number' ? Math.abs(result.shoulder_tilt) : null;
      const fwdRatio = typeof result.forward_head_ratio === 'number' ? Math.abs(result.forward_head_ratio) : null;
      const shoulderOpen = typeof result.shoulder_open_deg === 'number' ? result.shoulder_open_deg : null;
      const torsoLean = typeof result.torso_lean_deg === 'number' ? result.torso_lean_deg : null;
      // ê³¨ë°˜ ê°ë„ ì œê±° ìš”ì²­ì— ë”°ë¼ ì œì™¸
      const pelvisOpen = null;
      
      if (fwd != null || tilt != null || fwdRatio != null || shoulderOpen != null || torsoLean != null) {
        let totalPenalty = 0;
        let factorCount = 0;
        
        // ì „ë°©ë‘ í˜ë„í‹° (0.35 ì´í•˜ê°€ ì¢‹ìŒ)
        if (fwd != null) {
          const nf = Math.min(1, fwd / 0.35);
          totalPenalty += nf * 30;
          factorCount++;
        }
        
        // ì–´ê¹¨ ê¸°ìš¸ì„ í˜ë„í‹° (ê°€ì¤‘ì¹˜ ìƒí–¥)
        if (tilt != null) {
          const nt = Math.min(1, tilt / 0.25);
          totalPenalty += nt * 35; // 25 â†’ 35
          factorCount++;
        }
        
        // ì „ë°©ë‘ ë¹„ìœ¨ í˜ë„í‹° (0.5 ì´í•˜ê°€ ì¢‹ìŒ)
        if (fwdRatio != null) {
          const nfr = Math.min(1, fwdRatio / 0.5);
          totalPenalty += nfr * 20;
          factorCount++;
        }
        
        // ì–´ê¹¨ ê°ë„ í˜ë„í‹° (ê°€ì¤‘ì¹˜ ìƒí–¥, 170-180ë„ê°€ ì¢‹ìŒ)
        if (shoulderOpen != null) {
          const so = Math.abs(shoulderOpen - 175) / 10; // 175ë„ ê¸°ì¤€
          const nso = Math.min(1, so);
          totalPenalty += nso * 25; // 15 â†’ 25
          factorCount++;
        }
        
        // ëª¸í†µ ê¸°ìš¸ì„ í˜ë„í‹° (175-185ë„ê°€ ì¢‹ìŒ)
        if (torsoLean != null) {
          const tl = Math.abs(torsoLean - 180) / 10; // 180ë„ ê¸°ì¤€
          const ntl = Math.min(1, tl);
          totalPenalty += ntl * 10;
          factorCount++;
        }
        
        // ê³¨ë°˜ ê°ë„ëŠ” í‰ê°€ì—ì„œ ì œì™¸
        
        // í‰ê·  í˜ë„í‹° ê³„ì‚°
        const avgPenalty = factorCount > 0 ? totalPenalty / factorCount : 0;
        const base = 100;
        scores.posture = Math.round(Math.max(0, Math.min(100, base - avgPenalty)));
      }
    }
    
    // 4. ë°±ì—… ì ìˆ˜ë“¤ (scores.P ë“±)
    if (scores.posture == null && scores.posture_backup != null) {
      scores.posture = scores.posture_backup;
    }
  }

  // ìì„¸ ë””ë²„ê·¸ ë¡œê¹… í™œì„±í™”
  if (window.__ANALYZER_DEBUG_POSTURE__ && window.__ANALYZER_DEBUG_POSTURE__ < 20) {
    console.log('[ANALYZER][POSTURE]', {
      // ì§ì ‘ ì ìˆ˜
      from_scores_P: result?.scores?.P,
      enhanced_posture_score: result?.enhanced_posture_score,
      posture_score: result?.posture_score,
      posture: result?.posture,
      
      // ìƒíƒœ ë¬¸ìì—´
      posture_status: result?.posture_status,
      enhanced_posture_status: result?.enhanced_posture_status,
      back_status: result?.back_status,
      neck_status: result?.neck_status,
      
      // ê¸°í•˜í•™ì  ì¸¡ì •ê°’
      forward_head: result?.forward_head,
      forward_head_ratio: result?.forward_head_ratio,
      shoulder_tilt: result?.shoulder_tilt,
      shoulder_open_deg: result?.shoulder_open_deg,
      torso_lean_deg: result?.torso_lean_deg,
      pelvis_open_deg: result?.pelvis_open_deg,
      
      // ê°œë³„ ì ìˆ˜
      back_score: result?.back_score,
      neck_score: result?.neck_score,
      chin_forward_score: result?.chin_forward_score,
      neck_tilt_score: result?.neck_tilt_score,
      shoulder_blade_score: result?.shoulder_blade_score,
      shoulder_width_score: result?.shoulder_width_score,
      torso_height_score: result?.torso_height_score,
      neck_length_score: result?.neck_length_score,
      neck_angle_score: result?.neck_angle_score,
      
      // ìµœì¢… ê²°ê³¼
      mapped: scores.posture,
      individual_scores_count: individualScores.length,
      individual_scores_avg: individualScores.length > 0 ? individualScores.reduce((a, b) => a + b, 0) / individualScores.length : null,
      
      // ê³„ì‚° ë°©ì‹
      calculation: {
        direct_score: (result?.scores?.P != null || result?.enhanced_posture_score != null || result?.posture_score != null || result?.posture != null) ? 'yes' : 'no',
        status_based: (result?.posture_status || result?.enhanced_posture_status || result?.back_status || result?.neck_status) ? 'yes' : 'no',
        geometry_based: (result?.forward_head != null || result?.shoulder_tilt != null || result?.forward_head_ratio != null || result?.shoulder_open_deg != null || result?.torso_lean_deg != null || result?.pelvis_open_deg != null) ? 'yes' : 'no',
        individual_scores: (result?.back_score != null || result?.neck_score != null) ? 'yes' : 'no'
      }
    });
    window.__ANALYZER_DEBUG_POSTURE__ += 1;
  }

  // ìš°ì„ ìˆœìœ„ 3: ì„œë²„ì—ì„œ ê¸°ì¡´ í”¼ë“œë°± ìŠ¤íƒ€ì¼ í‚¤ ì‚¬ìš© ì‹œ
  if (scores.stability == null && typeof result.gaze_stability === 'number') scores.stability = clamp01To100(result.gaze_stability);
  if (scores.attention == null && typeof result.concentration === 'number') scores.attention = clamp01To100(result.concentration);
  if (scores.posture == null && typeof result.posture === 'number') scores.posture = clamp01To100(result.posture);
  if (scores.blink == null && typeof result.blinking === 'number') scores.blink = clamp01To100(result.blinking);

  // ë³´ì¡°: blink_rate(Hz/min)ë¥¼ 0-100ìœ¼ë¡œ ê·¼ì‚¬ ë§µí•‘
  if (scores.blink == null && typeof result.blink_rate === 'number') {
    // 10~25 ë²”ìœ„ë¥¼ 70~30ìœ¼ë¡œ ë’¤ì§‘ì–´ ë§µí•‘ (ë‚®ì„ìˆ˜ë¡ ì•ˆì •)
    const br = result.blink_rate;
    const norm = 100 - Math.max(0, Math.min(100, (br - 10) * 5));
    scores.blink = Math.round(norm);
  }

  // í‘œì •/ë¯¸ì†Œ
  if (!labels.expression) {
    if (typeof result.smile_score === 'number') {
      const w = clamp01To100(result.smile_score);
      labels.expression = w != null ? (w >= 66 ? 'ê¸ì •ì ' : w >= 40 ? 'ì¤‘ë¦½ì ' : 'ê°œì„  í•„ìš”') : undefined;
    } else if (typeof result.warmth_label === 'string') {
      labels.expression = result.warmth_label;
    } else if (typeof result.expression === 'string') {
      labels.expression = result.expression;
    }
  }

  // ìµœì¢… ë³´ì •: null ì±„ìš°ê¸° + ì›ë³¸ ìƒíƒœ ì „ë‹¬
  const out = {
    scores: {
      attention: scores.attention ?? 0,
      stability: scores.stability ?? 0,
      blink: scores.blink ?? 0,
      posture: scores.posture ?? 0
    },
    labels: { expression: labels.expression ?? '-' },
    status: result?.status,
    coaching_message: result?.coaching_message,
    ear_value: result?.ear_value,
    frame_processed: result?.frame_processed === true
  };
  return out;
}

// scheduleAnalyzerStart í•¨ìˆ˜ëŠ” js/camera-analyzer.jsì—ì„œ ì œê³µë¨

// --- AI APIëŠ” ì„œë²„ì—ì„œ ì²˜ë¦¬ë¨ (OpenAI GPT-4o-mini ì‚¬ìš©) ---

 // --- ì´ˆê¸° ì•ˆë‚´ íŒì—… ì œì–´ í•¨ìˆ˜ ---
 function showInitialGuidePopup() {
     document.getElementById('initial-guide-overlay').classList.add('visible');
 }
 
   function hideInitialGuidePopup() {
      document.getElementById('initial-guide-overlay').classList.remove('visible');

  }
 

 
   // --- ì¹´ë©”ë¼ ê²½ê³  ë©”ì‹œì§€ ì œì–´ í•¨ìˆ˜ ---
  function showCameraWarning() {
      // ìƒë‹¨ ë°” ìŠ¤íƒ€ì¼ ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
      document.getElementById('camera-warning').classList.remove('hidden');
      document.getElementById('main-content').classList.add('with-warning');
  }
  
  function hideCameraWarning() {
      document.getElementById('camera-warning').classList.add('hidden');
      document.getElementById('main-content').classList.remove('with-warning');
  }
  
  // --- ì¸ë¼ì¸ ì¹´ë©”ë¼ ê²½ê³  ë©”ì‹œì§€ ì œì–´ í•¨ìˆ˜ ---
  function showCameraWarningInline() {
      document.getElementById('camera-warning-inline').style.display = 'block';
  }
  
  function hideCameraWarningInline() {
      document.getElementById('camera-warning-inline').style.display = 'none';
  }
  
  // --- ì¹´ë©”ë¼ í† ìŠ¤íŠ¸ ê²½ê³  ë©”ì‹œì§€ ì œì–´ í•¨ìˆ˜ ---
  function showCameraToast() {
      document.getElementById('camera-toast').classList.remove('hidden');
      // 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¸°ê¸°
      setTimeout(() => {
          hideCameraToast();
      }, 5000);
  }
  
  function hideCameraToast() {
      document.getElementById('camera-toast').classList.add('hidden');
  }
  
  // --- í™•ì¸ íŒì—… ì œì–´ í•¨ìˆ˜ ---
  function showConfirmDialog() {
      document.getElementById('confirm-overlay').classList.add('visible');
  }
  
  function hideConfirmDialog() {
      document.getElementById('confirm-overlay').classList.remove('visible');
  }

// --- ì±„íŒ… ê´€ë ¨ ë³€ìˆ˜ ---
let chatHistory = [];
let currentSessionId = null; // MongoDB ì„¸ì…˜ ID

// --- í”¼ë“œë°± íŒ¨ë„ ì œì–´ ---
function toggleFeedbackPanel() { 
    feedbackPanel.classList.toggle('visible'); 
}

// --- ì±„íŒ… ê¸°ëŠ¥ ---
function addPersonaCard() {
    if (!personaName) return;
    
    const personaCard = document.createElement('div');
    personaCard.className = 'persona-card';
    
    // ì„±ë³„ì— ë”°ë¥¸ í´ë˜ìŠ¤ ì¶”ê°€ (ì´ë¯¸ì§€ íŒŒì¼ëª…ìœ¼ë¡œ íŒë‹¨)
    const imageFileName = personaImage ? personaImage.split('/').pop() : '';
    if (imageFileName.includes('woman') || imageFileName.includes('female')) {
        personaCard.classList.add('female');
    } else if (imageFileName.includes('man') || imageFileName.includes('male')) {
        personaCard.classList.add('male');
    }
    
    const personalityArray = personaPersonality ? personaPersonality.split(',') : [];
    
    // ì´ë¯¸ì§€ ê²½ë¡œ ìˆ˜ì •
            const imagePath = personaImage ? `${window.serverUrl || 'https://dys-phi.vercel.app/api/gke'}/dys_studio/img/persona/${personaImage.split('/').pop()}` : '/img/default-avatar.png';
    
    personaCard.innerHTML = `
        <div class="persona-header">
            <img src="${imagePath}" alt="${personaName}" class="persona-avatar">
            <div class="persona-info">
                <h4>${personaName}</h4>
                <p>${personaAge}ì„¸ Â· ${personaJob}</p>
            </div>
        </div>
        <div class="persona-details">
            <span class="persona-tag">${personaMbti}</span>
            ${personalityArray.map(trait => `<span class="persona-tag">${trait.trim()}</span>`).join('')}
        </div>
    `;
    
    chatLog.appendChild(personaCard);
    chatLog.scrollTop = chatLog.scrollHeight;
}

function addBubble(text, role) {
    const bubble = document.createElement('div');
    bubble.className = `bubble ${role}`;
    bubble.innerHTML = text;
    chatLog.appendChild(bubble);
    chatLog.scrollTop = chatLog.scrollHeight;
}

function showTypingIndicator() {
    const typingBubble = document.createElement('div');
    typingBubble.className = 'bubble typing';
    typingBubble.innerHTML = '<span></span><span></span><span></span>';
    chatLog.appendChild(typingBubble);
    chatLog.scrollTop = chatLog.scrollHeight;
}

function removeTypingIndicator() {
    const typingBubble = chatLog.querySelector('.typing');
    if (typingBubble) chatLog.removeChild(typingBubble);
}

   async function sendMessage() {
    const text = chatInput.value.trim();
    if(!text) return;
  
    // ì¤‘ë³µ ì „ì†¡ ë°©ì§€
    if (window._sendingMessage) {
        console.log('[CHAT] ì´ë¯¸ ë©”ì‹œì§€ ì „ì†¡ ì¤‘, ì¤‘ë³µ ë°©ì§€');
        return;
    }
    window._sendingMessage = true;
  
    try {
        addBubble(text, 'me');
        chatHistory.push({ role: "user", content: text });
        
        // ëŒ€í™” ì£¼ë„ê¶Œ ë¶„ì„ ì—…ë°ì´íŠ¸
        if (window.ConversationAnalyzer) {
            window.ConversationAnalyzer.addMessage("user", text);
        }
        
        chatInput.value = '';
        chatInput.focus();
        showTypingIndicator();
      
        // ì„œë²„ APIë¡œ ë©”ì‹œì§€ ì „ì†¡ (MongoDB ì €ì¥ + AI ì‘ë‹µ ìƒì„±)
        const response = await fetch(`${window.serverUrl || 'https://dys-phi.vercel.app/api/gke'}/api/chat/sessions/${currentSessionId}/messages`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                content: text,
                role: 'user',
                user_id: userId,
                email: email
            })
        });

        if (response.ok) {
            const result = await response.json();
            console.log('âœ… [CHAT] ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ:', result);
            
            removeTypingIndicator();
            
            // AI ì‘ë‹µì´ ìˆìœ¼ë©´ í‘œì‹œ
            if (result.ai_response) {
                addBubble(result.ai_response, 'ai');
                chatHistory.push({ role: "assistant", content: result.ai_response });
                
                // AI ì‘ë‹µë„ ëŒ€í™” ì£¼ë„ê¶Œ ë¶„ì„ì— ì¶”ê°€
                if (window.ConversationAnalyzer) {
                    window.ConversationAnalyzer.addMessage("assistant", result.ai_response);
                }
                
                // TTSë¡œ AI ì‘ë‹µ ì½ì–´ì£¼ê¸° (ëŒ€í™” ë‚´ìš©ë§Œ ì •ë¦¬)
                if (window.ttsManager && window.ttsManager.isEnabled) {
                    setTimeout(() => {
                        console.log('[TTS] ì›ë³¸ AI ì‘ë‹µ:', result.ai_response);
                        const cleanText = cleanTextForTTS(result.ai_response);
                        if (cleanText && cleanText.trim().length > 0) {
                            console.log('[TTS] ì •ë¦¬ëœ í…ìŠ¤íŠ¸ë¡œ TTS í˜¸ì¶œ:', cleanText);
                            window.ttsManager.speak(cleanText);
                        } else {
                            console.warn('[TTS] ì •ë¦¬ í›„ í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆì–´ TTS í˜¸ì¶œí•˜ì§€ ì•ŠìŒ');
                        }
                    }, 500); // 0.5ì´ˆ í›„ ìŒì„± ì¬ìƒ (ì±„íŒ… ë²„ë¸” ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„)
                }
            }
        } else {
            throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
        }
        
    } catch (error) {
        console.error('[CHAT] ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
        removeTypingIndicator();
        const errorMessage = "ì£„ì†¡í•´ìš”, ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
        addBubble(errorMessage, 'ai');
        chatHistory.push({ role: "assistant", content: errorMessage });
    } finally {
        window._sendingMessage = false;
    }
}

// --- TTSìš© í…ìŠ¤íŠ¸ ì •ë¦¬ í•¨ìˆ˜ ---
function cleanTextForTTS(text) {
    if (!text || typeof text !== 'string') {
        console.warn('[TTS] ìœ íš¨í•˜ì§€ ì•Šì€ í…ìŠ¤íŠ¸:', text);
        return null;
    }
    
    console.log('[TTS] ì›ë³¸ í…ìŠ¤íŠ¸:', text);
    
    // 1. HTML íƒœê·¸ ë° SSML íƒœê·¸ ì œê±°
    let cleanText = text
        .replace(/<[^>]*>/g, '') // HTML íƒœê·¸ ì œê±°
        .replace(/<speak[^>]*>/gi, '') // SSML speak íƒœê·¸ ì œê±°
        .replace(/<\/speak>/gi, '') // SSML speak ë‹«ê¸° íƒœê·¸ ì œê±°
        .replace(/<prosody[^>]*>/gi, '') // SSML prosody íƒœê·¸ ì œê±°
        .replace(/<\/prosody>/gi, '') // SSML prosody ë‹«ê¸° íƒœê·¸ ì œê±°
        .replace(/<voice[^>]*>/gi, '') // SSML voice íƒœê·¸ ì œê±°
        .replace(/<\/voice>/gi, '') // SSML voice ë‹«ê¸° íƒœê·¸ ì œê±°
        .replace(/<break[^>]*>/gi, '') // SSML break íƒœê·¸ ì œê±°
        .replace(/<emphasis[^>]*>/gi, '') // SSML emphasis íƒœê·¸ ì œê±°
        .replace(/<\/emphasis>/gi, '') // SSML emphasis ë‹«ê¸° íƒœê·¸ ì œê±°
        .replace(/<say-as[^>]*>/gi, '') // SSML say-as íƒœê·¸ ì œê±°
        .replace(/<\/say-as>/gi, '') // SSML say-as ë‹«ê¸° íƒœê·¸ ì œê±°
        .replace(/<phoneme[^>]*>/gi, '') // SSML phoneme íƒœê·¸ ì œê±°
        .replace(/<\/phoneme>/gi, '') // SSML phoneme ë‹«ê¸° íƒœê·¸ ì œê±°
        .replace(/<sub[^>]*>/gi, '') // SSML sub íƒœê·¸ ì œê±°
        .replace(/<\/sub>/gi, '') // SSML sub ë‹«ê¸° íƒœê·¸ ì œê±°
        .replace(/<audio[^>]*>/gi, '') // SSML audio íƒœê·¸ ì œê±°
        .replace(/<mark[^>]*>/gi, '') // SSML mark íƒœê·¸ ì œê±°
        .replace(/<bookmark[^>]*>/gi, '') // SSML bookmark íƒœê·¸ ì œê±°
        .replace(/<p[^>]*>/gi, '') // SSML p íƒœê·¸ ì œê±°
        .replace(/<\/p>/gi, '') // SSML p ë‹«ê¸° íƒœê·¸ ì œê±°
        .replace(/<s[^>]*>/gi, '') // SSML s íƒœê·¸ ì œê±°
        .replace(/<\/s>/gi, '') // SSML s ë‹«ê¸° íƒœê·¸ ì œê±°
        .replace(/<w[^>]*>/gi, '') // SSML w íƒœê·¸ ì œê±°
        .replace(/<\/w>/gi, '') // SSML w ë‹«ê¸° íƒœê·¸ ì œê±°
        .replace(/<m[^>]*>/gi, '') // SSML m íƒœê·¸ ì œê±°
        .replace(/<\/m>/gi, '') // SSML m ë‹«ê¸° íƒœê·¸ ì œê±°
        .replace(/<t[^>]*>/gi, '') // SSML t íƒœê·¸ ì œê±°
        .replace(/<\/t>/gi, '') // SSML t ë‹«ê¸° íƒœê·¸ ì œê±°
        .replace(/xmlns="[^"]*"/gi, '') // XML ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì œê±°
        .replace(/xml:lang="[^"]*"/gi, '') // XML ì–¸ì–´ ì†ì„± ì œê±°
        .replace(/version="[^"]*"/gi, ''); // XML ë²„ì „ ì†ì„± ì œê±°
    
    // 2. íŠ¹ìˆ˜ ë¬¸ì ë° ì´ëª¨ì§€ ì •ë¦¬
    cleanText = cleanText
        .replace(/[ğŸ¤ğŸ¬ğŸ“¹ğŸ¥ğŸ­ğŸªğŸ¨ğŸ¯ğŸ²ğŸ®ğŸ°ğŸ±ğŸ³ğŸ´ğŸµğŸ¶ğŸ·ğŸ¸ğŸ¹ğŸºğŸ»ğŸ¼ğŸ½ğŸ¾ğŸ¿ğŸ€ğŸğŸ‚ğŸƒğŸ„ğŸ…ğŸ†ğŸ‡ğŸˆğŸ‰ğŸŠğŸ‹ğŸŒğŸğŸğŸğŸğŸ‘ğŸ’ğŸ“ğŸ”ğŸ•ğŸ–ğŸ—ğŸ˜ğŸ™ğŸšğŸ›ğŸœğŸğŸğŸŸğŸ ğŸ¡ğŸ¢ğŸ£ğŸ¤ğŸ¥ğŸ¦ğŸ§ğŸ¨ğŸ©ğŸªğŸ«ğŸ¬ğŸ­ğŸ®ğŸ¯ğŸ°ğŸ±ğŸ²ğŸ³ğŸ´ğŸµğŸ¶ğŸ·ğŸ¸ğŸ¹ğŸºğŸ»ğŸ¼ğŸ½ğŸ¾ğŸ¿]/g, '') // ì´ëª¨ì§€ ì œê±°
        .replace(/[ğŸ”´ğŸŸ ğŸŸ¡ğŸŸ¢ğŸ”µğŸŸ£âš«âšªğŸŸ¤ğŸ”ºğŸ”»ğŸ”¸ğŸ”¹ğŸ”¶ğŸ”·ğŸ”³ğŸ”²â–ªï¸â–«ï¸â—¾â—½â—¼ï¸â—»ï¸ğŸŸ¥ğŸŸ§ğŸŸ¨ğŸŸ©ğŸŸ¦ğŸŸªâ¬›â¬œğŸŸ«]/g, '') // ìƒ‰ìƒ ì´ëª¨ì§€ ì œê±°
        .replace(/[ğŸ“±ğŸ“²ğŸ“³ğŸ“´ğŸ“µğŸ“¶ğŸ“·ğŸ“¸ğŸ“¹ğŸ“ºğŸ“»ğŸ“¼ğŸ“½ğŸ“¾ğŸ“¿ğŸ”€ğŸ”ğŸ”‚ğŸ”„ğŸ”ƒâ©âªâ«â¬â­â®â¯â°â±â²â³â¸â¹âºâ»]/g, '') // ê¸°íƒ€ ì´ëª¨ì§€ ì œê±°
        .replace(/[ğŸ’»ğŸ’¼ğŸ’½ğŸ’¾ğŸ’¿ğŸ“€ğŸ“ğŸ“‚ğŸ“ƒğŸ“„ğŸ“…ğŸ“†ğŸ“‡ğŸ“ˆğŸ“‰ğŸ“ŠğŸ“‹ğŸ“ŒğŸ“ğŸ“ğŸ“ğŸ“ğŸ“‘ğŸ“’ğŸ““ğŸ“”ğŸ“•ğŸ“–ğŸ“—ğŸ“˜ğŸ“™ğŸ“šğŸ“›ğŸ“œğŸ“ğŸ“ğŸ“ŸğŸ“ ğŸ“¡ğŸ“¢ğŸ“£ğŸ“¤ğŸ“¥ğŸ“¦ğŸ“§ğŸ“¨ğŸ“©ğŸ“ªğŸ“«ğŸ“¬ğŸ“­ğŸ“®ğŸ“¯ğŸ“°ğŸ“±ğŸ“²ğŸ“³ğŸ“´ğŸ“µğŸ“¶ğŸ“·ğŸ“¸ğŸ“¹ğŸ“ºğŸ“»ğŸ“¼ğŸ“½ğŸ“¾ğŸ“¿]/g, '') // ë” ë§ì€ ì´ëª¨ì§€ ì œê±°
        .replace(/[ğŸ˜€ğŸ˜ƒğŸ˜„ğŸ˜ğŸ˜†ğŸ˜…ğŸ˜‚ğŸ¤£ğŸ˜ŠğŸ˜‡ğŸ™‚ğŸ™ƒğŸ˜‰ğŸ˜ŒğŸ˜ğŸ¥°ğŸ˜˜ğŸ˜—ğŸ˜™ğŸ˜šğŸ˜‹ğŸ˜›ğŸ˜ğŸ˜œğŸ¤ªğŸ¤¨ğŸ§ğŸ¤“ğŸ˜ğŸ¤©ğŸ¥³ğŸ˜ğŸ˜’ğŸ˜ğŸ˜”ğŸ˜ŸğŸ˜•ğŸ™â˜¹ï¸ğŸ˜£ğŸ˜–ğŸ˜«ğŸ˜©ğŸ¥ºğŸ˜¢ğŸ˜­ğŸ˜¤ğŸ˜ ğŸ˜¡ğŸ¤¬ğŸ¤¯ğŸ˜³ğŸ¥µğŸ¥¶ğŸ˜±ğŸ˜¨ğŸ˜°ğŸ˜¥ğŸ˜“ğŸ¤—ğŸ¤”ğŸ¤­ğŸ¤«ğŸ¤¥ğŸ˜¶ğŸ˜ğŸ˜‘ğŸ˜¯ğŸ˜¦ğŸ˜§ğŸ˜®ğŸ˜²ğŸ¥±ğŸ˜´ğŸ¤¤ğŸ˜ªğŸ˜µğŸ¤ğŸ¥´ğŸ¤¢ğŸ¤®ğŸ¤§ğŸ˜·ğŸ¤’ğŸ¤•ğŸ¤‘ğŸ¤ ]/g, '') // ê°ì • ì´ëª¨ì§€ ì œê±°
        .replace(/[ğŸ‘‹ğŸ¤šğŸ–ï¸âœ‹ğŸ––ğŸ‘ŒğŸ¤ŒğŸ¤âœŒï¸ğŸ¤ğŸ¤ŸğŸ¤˜ğŸ¤™ğŸ‘ˆğŸ‘‰ğŸ‘†ğŸ–•ğŸ‘‡â˜ï¸ğŸ‘ğŸ‘âœŠğŸ‘ŠğŸ‘‹ğŸ‘ŒâœŒï¸ğŸ¤ğŸ¤ŸğŸ¤˜ğŸ¤™ğŸ‘ˆğŸ‘‰ğŸ‘†ğŸ–•ğŸ‘‡â˜ï¸ğŸ‘ğŸ‘âœŠğŸ‘Š]/g, '') // ì† ì´ëª¨ì§€ ì œê±°
        .replace(/[ğŸ‘¶ğŸ‘§ğŸ§’ğŸ‘¦ğŸ‘©ğŸ§‘ğŸ‘¨ğŸ‘µğŸ§“ğŸ‘´ğŸ‘²ğŸ‘³ğŸ§•ğŸ‘®ğŸ•µï¸ğŸ‘·ğŸ‘¸ğŸ¤´ğŸ‘³ğŸ‘²ğŸ§•ğŸ‘®ğŸ•µï¸ğŸ‘·ğŸ‘¸ğŸ¤´]/g, '') // ì‚¬ëŒ ì´ëª¨ì§€ ì œê±°
        .replace(/[ğŸ¶ğŸ±ğŸ­ğŸ¹ğŸ°ğŸ¦ŠğŸ»ğŸ¼ğŸ»â€â„ï¸ğŸ¨ğŸ¯ğŸ¦ğŸ®ğŸ·ğŸ½ğŸ¸ğŸµğŸ™ˆğŸ™‰ğŸ™ŠğŸ’ğŸ”ğŸ§ğŸ¦ğŸ¤ğŸ£ğŸ¥ğŸ¦†ğŸ¦…ğŸ¦‰ğŸ¦‡ğŸºğŸ—ğŸ´ğŸ¦„ğŸğŸ›ğŸ¦‹ğŸŒğŸğŸœğŸ¦ŸğŸ¦—ğŸ•·ï¸ğŸ•¸ï¸ğŸ¦‚ğŸ¢ğŸğŸ¦ğŸ¦–ğŸ¦•ğŸ™ğŸ¦‘ğŸ¦ğŸ¦ğŸ¦€ğŸ¡ğŸ ğŸŸğŸ¬ğŸ³ğŸ‹ğŸ¦ˆğŸŠğŸ…ğŸ†ğŸ¦“ğŸ¦ğŸ¦§ğŸ˜ğŸ¦›ğŸ¦ğŸªğŸ«ğŸ¦™ğŸ¦’ğŸƒğŸ‚ğŸ„ğŸğŸ–ğŸğŸ‘ğŸ¦ŒğŸ•ğŸ©ğŸ¦®ğŸ•â€ğŸ¦ºğŸˆğŸˆâ€â¬›ğŸ“ğŸ¦ƒğŸ¦šğŸ¦œğŸ¦¢ğŸ¦©ğŸ•Šï¸ğŸ‡ğŸ¦ğŸ¦¨ğŸ¦¡ğŸ¦«ğŸ¦¦ğŸ¦¥ğŸğŸ€ğŸ¿ï¸ğŸ¦”]/g, '') // ë™ë¬¼ ì´ëª¨ì§€ ì œê±°
        .replace(/[ğŸŒ±ğŸŒ²ğŸŒ³ğŸŒ´ğŸŒµğŸŒ¾ğŸŒ¿â˜˜ï¸ğŸ€ğŸğŸ‚ğŸƒğŸ„ğŸ„â€ğŸŸ«ğŸ…ğŸ†ğŸŒ¶ï¸ğŸŒ½ğŸ¥•ğŸ¥¬ğŸ¥’ğŸ¥¦ğŸ§„ğŸ§…ğŸ¥œğŸŒ°ğŸ¥‘ğŸ¥¥ğŸ¥ğŸ¥­ğŸğŸğŸŠğŸ‹ğŸŒğŸ‰ğŸ‡ğŸ“ğŸ«ğŸˆğŸ’ğŸ‘ğŸ¥­ğŸğŸ¥¥ğŸ¥ğŸ…ğŸ†ğŸ¥‘ğŸ¥¦ğŸ¥¬ğŸ¥’ğŸŒ¶ï¸ğŸ§„ğŸ§…ğŸ¥•ğŸ¥œğŸŒ°ğŸ¥‘ğŸ¥¥ğŸ¥ğŸ¥­ğŸğŸğŸŠğŸ‹ğŸŒğŸ‰ğŸ‡ğŸ“ğŸ«ğŸˆğŸ’ğŸ‘ğŸ¥­ğŸğŸ¥¥ğŸ¥ğŸ…ğŸ†ğŸ¥‘ğŸ¥¦ğŸ¥¬ğŸ¥’ğŸŒ¶ï¸ğŸ§„ğŸ§…ğŸ¥•ğŸ¥œğŸŒ°]/g, '') // ì‹ë¬¼ ì´ëª¨ì§€ ì œê±°
        .replace(/[ğŸ”ğŸŸğŸ•ğŸŒ­ğŸ¥ªğŸŒ®ğŸŒ¯ğŸ¥™ğŸ§†ğŸ¥šğŸ³ğŸ§ˆğŸ¥ğŸ§‡ğŸ¥“ğŸ¥©ğŸ—ğŸ–ğŸ¦´ğŸŒ­ğŸ”ğŸŸğŸ•ğŸ¥ªğŸ¥™ğŸ§†ğŸŒ®ğŸŒ¯ğŸ¥—ğŸ¥˜ğŸ¥«ğŸğŸœğŸ²ğŸ›ğŸ£ğŸ±ğŸ¥ŸğŸ¦ªğŸ¤ğŸ™ğŸšğŸ˜ğŸ¥ğŸ¥ ğŸ¥®ğŸ¢ğŸ¡ğŸ§ğŸ¨ğŸ¦ğŸ¥§ğŸ§ğŸ°ğŸ‚ğŸ®ğŸ­ğŸ¬ğŸ«ğŸ¿ğŸ©ğŸªğŸŒ°ğŸ¥œğŸ¯ğŸ¥›ğŸ¼â˜•ğŸ«–ğŸµğŸ§ƒğŸ¥¤ğŸ§‹ğŸ¶ğŸºğŸ»ğŸ¥‚ğŸ·ğŸ¥ƒğŸ¸ğŸ¹ğŸ¾ğŸ¥„ğŸ´ğŸ½ï¸ğŸ¥¡ğŸ¥¢ğŸ§‚]/g, '') // ìŒì‹ ì´ëª¨ì§€ ì œê±°
        .replace(/[âš½ğŸ€ğŸˆâš¾ğŸ¥ğŸ¾ğŸğŸ‰ğŸ¥ğŸ±ğŸª€ğŸ“ğŸ¸ğŸ’ğŸ‘ğŸ¥ğŸğŸ¥…â›³ğŸªğŸ¹ğŸ£ğŸ¤¿ğŸ¥ŠğŸ¥‹ğŸ½ğŸ›¹ğŸ›·â›¸ï¸ğŸ¥ŒğŸ¿â›·ï¸ğŸ‚ğŸª‚ğŸ‹ï¸â€â™€ï¸ğŸ‹ï¸â€â™‚ï¸ğŸ¤¼â€â™€ï¸ğŸ¤¼â€â™‚ï¸ğŸ¤¸â€â™€ï¸ğŸ¤¸â€â™‚ï¸â›¹ï¸â€â™€ï¸â›¹ï¸â€â™‚ï¸ğŸ¤ºğŸ¤¾â€â™€ï¸ğŸ¤¾â€â™‚ï¸ğŸŠâ€â™€ï¸ğŸŠâ€â™‚ï¸ğŸš£â€â™€ï¸ğŸš£â€â™‚ï¸ğŸ§—â€â™€ï¸ğŸ§—â€â™‚ï¸ğŸšµâ€â™€ï¸ğŸšµâ€â™‚ï¸ğŸš´â€â™€ï¸ğŸš´â€â™‚ï¸ğŸ†ğŸ¥‡ğŸ¥ˆğŸ¥‰ğŸ…ğŸ–ï¸ğŸµï¸ğŸ—ï¸ğŸ«ğŸŸï¸ğŸªğŸ¤¹â€â™€ï¸ğŸ¤¹â€â™‚ï¸ğŸ­ğŸ©°ğŸ¨ğŸ¬ğŸ¤ğŸ§ğŸ¼ğŸ¹ğŸ¥ğŸ·ğŸºğŸ¸ğŸª•ğŸ»ğŸ²â™Ÿï¸ğŸ¯ğŸ³ğŸ®ğŸ°ğŸ§©ğŸ¨ğŸ“±ğŸ“²ğŸ’»âŒ¨ï¸ğŸ–¥ï¸ğŸ–¨ï¸ğŸ–±ï¸ğŸ–²ï¸ğŸ’½ğŸ’¾ğŸ’¿ğŸ“€ğŸ“¼ğŸ“·ğŸ“¸ğŸ“¹ğŸ“ºğŸ“»ğŸ“ŸğŸ“ ğŸ”‹ğŸ”ŒğŸ’¡ğŸ”¦ğŸ•¯ï¸ğŸª”ğŸ§¯ğŸ›¢ï¸ğŸ’¸ğŸ’µğŸ’´ğŸ’¶ğŸ’·ğŸª™ğŸ’°ğŸ’³ğŸ’âš–ï¸ğŸªœğŸªğŸ”§ğŸ”¨âš’ï¸ğŸ› ï¸â›ï¸ğŸª›ğŸ”©âš™ï¸ğŸª¤ğŸ§°ğŸ§²ğŸªœğŸªğŸ”§ğŸ”¨âš’ï¸ğŸ› ï¸â›ï¸ğŸª›ğŸ”©âš™ï¸ğŸª¤ğŸ§°ğŸ§²]/g, '') // ìŠ¤í¬ì¸ /ê¸°íƒ€ ì´ëª¨ì§€ ì œê±°
        .replace(/[ğŸš—ğŸš•ğŸš™ğŸšŒğŸšğŸï¸ğŸš“ğŸš‘ğŸš’ğŸšğŸ›»ğŸššğŸš›ğŸšœğŸ›ºğŸš”ğŸšğŸš˜ğŸš–ğŸš¡ğŸš ğŸšŸğŸšƒğŸš‹ğŸšğŸšğŸš„ğŸš…ğŸšˆğŸš‚ğŸš†ğŸš‡ğŸšŠğŸš‰âœˆï¸ğŸ›«ğŸ›¬ğŸ›©ï¸ğŸ’ºğŸ›°ï¸ğŸš€ğŸ›¸ğŸšğŸ›¶â›µğŸš¤ğŸ›¥ï¸ğŸ›³ï¸â›´ï¸ğŸš¢âš“ğŸªâ›½ğŸš§ğŸš¨ğŸš¥ğŸš¦ğŸ›‘ğŸšğŸ—ºï¸ğŸ—¿ğŸ—½ğŸ—¼ğŸ°ğŸ¯ğŸŸï¸ğŸ¡ğŸ¢ğŸ â›²â›±ï¸ğŸ–ï¸ğŸï¸ğŸ”ï¸â›°ï¸ğŸŒ‹ğŸ—»ğŸ•ï¸â›ºğŸ ğŸ¡ğŸ˜ï¸ğŸšï¸ğŸ—ï¸ğŸ­ğŸ¢ğŸ¬ğŸ£ğŸ¤ğŸ¥ğŸ¦ğŸ¨ğŸªğŸ«ğŸ©ğŸ’’ğŸ›ï¸â›ªğŸ•ŒğŸ•ğŸ›•ğŸ•‹â›©ï¸ğŸª”ğŸ‡ğŸ†ğŸ§¨âœ¨ğŸˆğŸ‰ğŸŠğŸ‹ğŸğŸğŸğŸğŸ€ğŸğŸª„ğŸª…ğŸŠğŸ‰ğŸˆâœ¨ğŸ§¨ğŸ†ğŸ‡ğŸª”â›©ï¸ğŸ•‹ğŸ›•ğŸ•ğŸ•Œâ›ªğŸ›ï¸ğŸ’’ğŸ©ğŸ«ğŸªğŸ¨ğŸ¦ğŸ¥ğŸ¤ğŸ£ğŸ¬ğŸ¢ğŸ­ğŸ—ï¸ğŸšï¸ğŸ˜ï¸ğŸ¡ğŸ â›ºğŸ•ï¸ğŸ—»ğŸŒ‹â›°ï¸ğŸ”ï¸ğŸï¸ğŸ–ï¸â›±ï¸â›²ğŸ ğŸ¢ğŸ¡ğŸŸï¸ğŸ¯ğŸ°ğŸ—¼ğŸ—½ğŸ—¿ğŸ—ºï¸ğŸšğŸ›‘ğŸš¦ğŸš¥ğŸš¨ğŸš§â›½ğŸªâš“ğŸš¢â›´ï¸ğŸ›³ï¸ğŸ›¥ï¸ğŸš¤â›µğŸ›¶ğŸšğŸ›¸ğŸš€ğŸ›°ï¸ğŸ’ºğŸ›©ï¸ğŸ›¬ğŸ›«âœˆï¸ğŸšŠğŸš‡ğŸš†ğŸš‚ğŸšˆğŸš…ğŸš„ğŸšğŸšğŸš‹ğŸšƒğŸšŸğŸš ğŸš¡ğŸš–ğŸš˜ğŸšğŸš”ğŸ›ºğŸšœğŸš›ğŸššğŸ›»ğŸšğŸš’ğŸš‘ğŸš“ğŸï¸ğŸšğŸšŒğŸš™ğŸš•ğŸš—]/g, '') // êµí†µ/ê±´ë¬¼ ì´ëª¨ì§€ ì œê±°
        .replace(/[ğŸŒğŸŒğŸŒğŸŒğŸ—ºï¸ğŸ—¾ğŸ§­ğŸ”ï¸â›°ï¸ğŸŒ‹ğŸ—»ğŸ•ï¸â›ºğŸ ğŸ¡ğŸ˜ï¸ğŸšï¸ğŸ—ï¸ğŸ­ğŸ¢ğŸ¬ğŸ£ğŸ¤ğŸ¥ğŸ¦ğŸ¨ğŸªğŸ«ğŸ©ğŸ’’ğŸ›ï¸â›ªğŸ•ŒğŸ•ğŸ›•ğŸ•‹â›©ï¸ğŸª”ğŸ‡ğŸ†ğŸ§¨âœ¨ğŸˆğŸ‰ğŸŠğŸ‹ğŸğŸğŸğŸğŸ€ğŸğŸª„ğŸª…ğŸŠğŸ‰ğŸˆâœ¨ğŸ§¨ğŸ†ğŸ‡ğŸª”â›©ï¸ğŸ•‹ğŸ›•ğŸ•ğŸ•Œâ›ªğŸ›ï¸ğŸ’’ğŸ©ğŸ«ğŸªğŸ¨ğŸ¦ğŸ¥ğŸ¤ğŸ£ğŸ¬ğŸ¢ğŸ­ğŸ—ï¸ğŸšï¸ğŸ˜ï¸ğŸ¡ğŸ â›ºğŸ•ï¸ğŸ—»ğŸŒ‹â›°ï¸ğŸ”ï¸ğŸï¸ğŸ–ï¸â›±ï¸â›²ğŸ ğŸ¢ğŸ¡ğŸŸï¸ğŸ¯ğŸ°ğŸ—¼ğŸ—½ğŸ—¿ğŸ—ºï¸ğŸšğŸ›‘ğŸš¦ğŸš¥ğŸš¨ğŸš§â›½ğŸªâš“ğŸš¢â›´ï¸ğŸ›³ï¸ğŸ›¥ï¸ğŸš¤â›µğŸ›¶ğŸšğŸ›¸ğŸš€ğŸ›°ï¸ğŸ’ºğŸ›©ï¸ğŸ›¬ğŸ›«âœˆï¸ğŸšŠğŸš‡ğŸš†ğŸš‚ğŸšˆğŸš…ğŸš„ğŸšğŸšğŸš‹ğŸšƒğŸšŸğŸš ğŸš¡ğŸš–ğŸš˜ğŸšğŸš”ğŸ›ºğŸšœğŸš›ğŸššğŸ›»ğŸšğŸš’ğŸš‘ğŸš“ğŸï¸ğŸšğŸšŒğŸš™ğŸš•ğŸš—]/g, '') // ì§€ë¦¬/ê±´ë¬¼ ì´ëª¨ì§€ ì œê±°
        .replace(/[ğŸŒğŸŒğŸŒğŸŒğŸ—ºï¸ğŸ—¾ğŸ§­ğŸ”ï¸â›°ï¸ğŸŒ‹ğŸ—»ğŸ•ï¸â›ºğŸ ğŸ¡ğŸ˜ï¸ğŸšï¸ğŸ—ï¸ğŸ­ğŸ¢ğŸ¬ğŸ£ğŸ¤ğŸ¥ğŸ¦ğŸ¨ğŸªğŸ«ğŸ©ğŸ’’ğŸ›ï¸â›ªğŸ•ŒğŸ•ğŸ›•ğŸ•‹â›©ï¸ğŸª”ğŸ‡ğŸ†ğŸ§¨âœ¨ğŸˆğŸ‰ğŸŠğŸ‹ğŸğŸğŸğŸğŸ€ğŸğŸª„ğŸª…ğŸŠğŸ‰ğŸˆâœ¨ğŸ§¨ğŸ†ğŸ‡ğŸª”â›©ï¸ğŸ•‹ğŸ›•ğŸ•ğŸ•Œâ›ªğŸ›ï¸ğŸ’’ğŸ©ğŸ«ğŸªğŸ¨ğŸ¦ğŸ¥ğŸ¤ğŸ£ğŸ¬ğŸ¢ğŸ­ğŸ—ï¸ğŸšï¸ğŸ˜ï¸ğŸ¡ğŸ â›ºğŸ•ï¸ğŸ—»ğŸŒ‹â›°ï¸ğŸ”ï¸ğŸï¸ğŸ–ï¸â›±ï¸â›²ğŸ ğŸ¢ğŸ¡ğŸŸï¸ğŸ¯ğŸ°ğŸ—¼ğŸ—½ğŸ—¿ğŸ—ºï¸ğŸšğŸ›‘ğŸš¦ğŸš¥ğŸš¨ğŸš§â›½ğŸªâš“ğŸš¢â›´ï¸ğŸ›³ï¸ğŸ›¥ï¸ğŸš¤â›µğŸ›¶ğŸšğŸ›¸ğŸš€ğŸ›°ï¸ğŸ’ºğŸ›©ï¸ğŸ›¬ğŸ›«âœˆï¸ğŸšŠğŸš‡ğŸš†ğŸš‚ğŸšˆğŸš…ğŸš„ğŸšğŸšğŸš‹ğŸšƒğŸšŸğŸš ğŸš¡ğŸš–ğŸš˜ğŸšğŸš”ğŸ›ºğŸšœğŸš›ğŸššğŸ›»ğŸšğŸš’ğŸš‘ğŸš“ğŸï¸ğŸšğŸšŒğŸš™ğŸš•ğŸš—]/g, '') // ë” ë§ì€ ì´ëª¨ì§€ ì œê±°
        .replace(/[ğŸŒğŸŒğŸŒğŸŒğŸ—ºï¸ğŸ—¾ğŸ§­ğŸ”ï¸â›°ï¸ğŸŒ‹ğŸ—»ğŸ•ï¸â›ºğŸ ğŸ¡ğŸ˜ï¸ğŸšï¸ğŸ—ï¸ğŸ­ğŸ¢ğŸ¬ğŸ£ğŸ¤ğŸ¥ğŸ¦ğŸ¨ğŸªğŸ«ğŸ©ğŸ’’ğŸ›ï¸â›ªğŸ•ŒğŸ•ğŸ›•ğŸ•‹â›©ï¸ğŸª”ğŸ‡ğŸ†ğŸ§¨âœ¨ğŸˆğŸ‰ğŸŠğŸ‹ğŸğŸğŸğŸğŸ€ğŸğŸª„ğŸª…ğŸŠğŸ‰ğŸˆâœ¨ğŸ§¨ğŸ†ğŸ‡ğŸª”â›©ï¸ğŸ•‹ğŸ›•ğŸ•ğŸ•Œâ›ªğŸ›ï¸ğŸ’’ğŸ©ğŸ«ğŸªğŸ¨ğŸ¦ğŸ¥ğŸ¤ğŸ£ğŸ¬ğŸ¢ğŸ­ğŸ—ï¸ğŸšï¸ğŸ˜ï¸ğŸ¡ğŸ â›ºğŸ•ï¸ğŸ—»ğŸŒ‹â›°ï¸ğŸ”ï¸ğŸï¸ğŸ–ï¸â›±ï¸â›²ğŸ ğŸ¢ğŸ¡ğŸŸï¸ğŸ¯ğŸ°ğŸ—¼ğŸ—½ğŸ—¿ğŸ—ºï¸ğŸšğŸ›‘ğŸš¦ğŸš¥ğŸš¨ğŸš§â›½ğŸªâš“ğŸš¢â›´ï¸ğŸ›³ï¸ğŸ›¥ï¸ğŸš¤â›µğŸ›¶ğŸšğŸ›¸ğŸš€ğŸ›°ï¸ğŸ’ºğŸ›©ï¸ğŸ›¬ğŸ›«âœˆï¸ğŸšŠğŸš‡ğŸš†ğŸš‚ğŸšˆğŸš…ğŸš„ğŸšğŸšğŸš‹ğŸšƒğŸšŸğŸš ğŸš¡ğŸš–ğŸš˜ğŸšğŸš”ğŸ›ºğŸšœğŸš›ğŸššğŸ›»ğŸšğŸš’ğŸš‘ğŸš“ğŸï¸ğŸšğŸšŒğŸš™ğŸš•ğŸš—]/g, ''); // ìµœì¢… ì´ëª¨ì§€ ì œê±°
    
    // 3. ì‹œìŠ¤í…œ ë©”ì‹œì§€ë‚˜ íŠ¹ìˆ˜ íŒ¨í„´ ì œê±° (ê°•í™”ëœ ë²„ì „)
    cleanText = cleanText
        // ê¸°ë³¸ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œê±°
        .replace(/^(ì‹œìŠ¤í…œ|System|ERROR|Error|error|WARNING|Warning|warning|INFO|Info|info|DEBUG|Debug|debug|LOG|Log|log):/g, '')
        .replace(/^\[.*?\]/g, '') // ëŒ€ê´„í˜¸ë¡œ ë‘˜ëŸ¬ì‹¸ì¸ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œê±°
        .replace(/^\{.*?\}/g, '') // ì¤‘ê´„í˜¸ë¡œ ë‘˜ëŸ¬ì‹¸ì¸ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œê±°
        .replace(/^<.*?>/g, '') // êº¾ì‡ ê´„í˜¸ë¡œ ë‘˜ëŸ¬ì‹¸ì¸ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œê±°
        .replace(/^\(.*?\)/g, '') // ê´„í˜¸ë¡œ ë‘˜ëŸ¬ì‹¸ì¸ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œê±°
        
        // HTTP/API ê´€ë ¨ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œê±°
        .replace(/^HTTP.*?OK.*?$/gm, '') // HTTP ì‘ë‹µ ë©”ì‹œì§€ ì œê±°
        .replace(/^INFO:httpx:.*?$/gm, '') // httpx ë¡œê·¸ ì œê±°
        .replace(/^âœ….*?$/gm, '') // ì²´í¬ë§ˆí¬ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œê±°
        .replace(/^ğŸ¤–.*?$/gm, '') // ë¡œë´‡ ì´ëª¨ì§€ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œê±°
        .replace(/^ğŸ”„.*?$/gm, '') // ë¦¬í”„ë ˆì‹œ ì´ëª¨ì§€ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œê±°
        .replace(/^ğŸ”.*?$/gm, '') // ë‹ë³´ê¸° ì´ëª¨ì§€ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œê±°
        .replace(/^ğŸ“Š.*?$/gm, '') // ì°¨íŠ¸ ì´ëª¨ì§€ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œê±°
        
        // AI ì‘ë‹µ ê´€ë ¨ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œê±°
        .replace(/^\[AI_RESPONSE\].*?$/gm, '') // AI ì‘ë‹µ ë¡œê·¸ ì œê±°
        .replace(/^\[SEND_MESSAGE\].*?$/gm, '') // ë©”ì‹œì§€ ì „ì†¡ ë¡œê·¸ ì œê±°
        .replace(/^\[SAVE_MESSAGE\].*?$/gm, '') // ë©”ì‹œì§€ ì €ì¥ ë¡œê·¸ ì œê±°
        .replace(/^OpenAI.*?ì‘ë‹µ.*?$/gm, '') // OpenAI ì‘ë‹µ ë¡œê·¸ ì œê±°
        
        // ëœë“œë§ˆí¬ ê´€ë ¨ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œê±°
        .replace(/^ëœë“œë§ˆí¬.*?í”„ë ˆì„.*?$/gm, '') // ëœë“œë§ˆí¬ ë°°ì¹˜ ë¡œê·¸ ì œê±°
        .replace(/^ğŸ“Š.*?ëœë“œë§ˆí¬.*?$/gm, '') // ëœë“œë§ˆí¬ ì°¨íŠ¸ ë¡œê·¸ ì œê±°
        
        // URL ë° ë„ë©”ì¸ ì œê±°
        .replace(/https?:\/\/[^\s]+/g, '') // HTTP/HTTPS URL ì œê±°
        .replace(/www\.[^\s]+/g, '') // www ë„ë©”ì¸ ì œê±°
        .replace(/[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g, '') // ì¼ë°˜ ë„ë©”ì¸ ì œê±°
        .replace(/\/\/[^\s]+/g, '') // //ë¡œ ì‹œì‘í•˜ëŠ” ê²½ë¡œ ì œê±°
        
        // JSON ê°ì²´ ë° ë”•ì…”ë„ˆë¦¬ ì œê±°
        .replace(/\{[^}]*\}/g, '') // ì¤‘ê´„í˜¸ë¡œ ë‘˜ëŸ¬ì‹¸ì¸ JSON ê°ì²´ ì œê±°
        .replace(/\[[^\]]*\]/g, '') // ëŒ€ê´„í˜¸ë¡œ ë‘˜ëŸ¬ì‹¸ì¸ ë°°ì—´ ì œê±°
        .replace(/"[^"]*":\s*"[^"]*"/g, '') // JSON í‚¤-ê°’ ìŒ ì œê±°
        .replace(/"[^"]*":\s*[^,}\]]+/g, '') // JSON í‚¤-ê°’ ìŒ ì œê±° (ê°’ì´ ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš°)
        
        // ê¸°íƒ€ ì‹œìŠ¤í…œ í‚¤ì›Œë“œ ì œê±°
        .replace(/^[A-Z_]+:/g, '') // ëŒ€ë¬¸ìë¡œ ëœ ì‹œìŠ¤í…œ í‚¤ì›Œë“œ ì œê±°
        .replace(/^[a-z_]+:/g, '') // ì†Œë¬¸ìë¡œ ëœ ì‹œìŠ¤í…œ í‚¤ì›Œë“œ ì œê±°
        .replace(/^[0-9]+\./g, '') // ìˆ«ìë¡œ ì‹œì‘í•˜ëŠ” ë²ˆí˜¸ ì œê±°
        
        // íŠ¹ìˆ˜ ë¬¸ì ë²ˆí˜¸ ì œê±°
        .replace(/^[â‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨â‘©]/g, '') // ì›ë¬¸ì ë²ˆí˜¸ ì œê±°
        .replace(/^[â¶â·â¸â¹âºâ»â¼â½â¾â¿]/g, '') // ì›ë¬¸ì ë²ˆí˜¸ ì œê±°
        .replace(/^[â‘´â‘µâ‘¶â‘·â‘¸â‘¹â‘ºâ‘»â‘¼â‘½]/g, '') // ê´„í˜¸ ìˆ«ì ì œê±°
        .replace(/^[ãˆ ãˆ¡ãˆ¢ãˆ£ãˆ¤ãˆ¥ãˆ¦ãˆ§ãˆ¨ãˆ©]/g, '') // ê´„í˜¸ í•œì ì œê±°
        .replace(/^[ã‰ ã‰¡ã‰¢ã‰£ã‰¤ã‰¥ã‰¦ã‰§ã‰¨ã‰©]/g, '') // ì›ë¬¸ì í•œì ì œê±°
        .replace(/^[ãŠ€ãŠãŠ‚ãŠƒãŠ„ãŠ…ãŠ†ãŠ‡ãŠˆãŠ‰]/g, '') // ì›ë¬¸ì í•œì ì œê±°
        .replace(/^[ãŠãŠ‘ãŠ’ãŠ“ãŠ”ãŠ•ãŠ–ãŠ—ãŠ˜ãŠ™]/g, '') // ì›ë¬¸ì í•œì ì œê±°
        .replace(/^[ãŠšãŠ›ãŠœãŠãŠãŠŸãŠ ãŠ¡ãŠ¢ãŠ£]/g, '') // ì›ë¬¸ì í•œì ì œê±°
        .replace(/^[ãŠ¤ãŠ¥ãŠ¦ãŠ§ãŠ¨ãŠ©ãŠªãŠ«ãŠ¬ãŠ­]/g, '') // ì›ë¬¸ì í•œì ì œê±°
        .replace(/^[ãŠ®ãŠ¯ãŠ°ãŠ±ãŠ²ãŠ³ãŠ´ãŠµãŠ¶ãŠ·]/g, '') // ì›ë¬¸ì í•œì ì œê±°
        .replace(/^[ãŠ¸ãŠ¹ãŠºãŠ»ãŠ¼ãŠ½ãŠ¾ãŠ¿]/g, ''); // ì›ë¬¸ì í•œì ì œê±°
    
    // 4. ë¶ˆí•„ìš”í•œ ê³µë°± ì •ë¦¬
    cleanText = cleanText
        .replace(/\s+/g, ' ') // ì—°ì†ëœ ê³µë°±ì„ í•˜ë‚˜ë¡œ
        .replace(/^\s+|\s+$/g, '') // ì•ë’¤ ê³µë°± ì œê±°
        .replace(/^[,\s]+|[,\s]+$/g, '') // ì•ë’¤ ì‰¼í‘œì™€ ê³µë°± ì œê±°
        .replace(/^[.\s]+|[.\s]+$/g, ''); // ì•ë’¤ ì ê³¼ ê³µë°± ì œê±°
    
    // 5. ë¹ˆ í…ìŠ¤íŠ¸ ì²´í¬
    if (!cleanText || cleanText.trim().length === 0) {
        console.warn('[TTS] ì •ë¦¬ í›„ í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŒ');
        return null;
    }
    
    // 6. ìµœì¢… ê¸¸ì´ ì²´í¬ (ë„ˆë¬´ ê¸´ í…ìŠ¤íŠ¸ëŠ” ìë¥´ê¸°)
    if (cleanText.length > 500) {
        console.warn('[TTS] í…ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ê¹€, ìë¦„:', cleanText.length);
        cleanText = cleanText.substring(0, 500) + '...';
    }
    
    console.log('[TTS] ì •ë¦¬ëœ í…ìŠ¤íŠ¸:', cleanText);
    return cleanText;
}

// í˜¸ê°ë„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ê°œì„ ëœ)
function updateLikability(score) {
    // ê¸°ì¡´ í˜¸ê°ë„ (í˜¸í™˜ì„± ìœ ì§€)
    const likabilityScore = document.getElementById('likability-score');
    const likabilityProgress = document.getElementById('likability-progress');
    
    if (likabilityScore) {
        likabilityScore.innerHTML = `${score}<span>%</span>`;
    }
    
    if (likabilityProgress) {
        const circumference = 2 * Math.PI * 54;
        const offset = circumference - (score / 100) * circumference;
        likabilityProgress.style.strokeDasharray = circumference;
        likabilityProgress.style.strokeDashoffset = offset;
    }
    
    // ìƒˆë¡œìš´ ê°œì„ ëœ í˜¸ê°ë„
    const likabilityScoreEnhanced = document.getElementById('likability-score-enhanced');
    const likabilityProgressEnhanced = document.getElementById('likability-progress-enhanced');
    const likabilityStatus = document.getElementById('likability-status');
    
    if (likabilityScoreEnhanced) {
        likabilityScoreEnhanced.innerHTML = `${score}<span class="score-unit">%</span>`;
    }
    
    if (likabilityProgressEnhanced) {
        const circumference = 314; // 2 * Math.PI * 50
        const offset = circumference - (score / 100) * circumference;
        likabilityProgressEnhanced.style.strokeDashoffset = offset;
    }
    
    if (likabilityStatus) {
        let status = '';
        if (score >= 85) status = 'ë§¤ìš° ë†’ìŒ';
        else if (score >= 70) status = 'ë†’ìŒ';
        else if (score >= 50) status = 'ë³´í†µ';
        else if (score >= 30) status = 'ë‚®ìŒ';
        else status = 'ë§¤ìš° ë‚®ìŒ';
        
        likabilityStatus.textContent = status;
    }
    
    // í˜¸ê°ë„ ìš”ì†Œ ì—…ë°ì´íŠ¸
    updateLikabilityFactors(score);
}

// í˜¸ê°ë„ êµ¬ì„± ìš”ì†Œ ì—…ë°ì´íŠ¸
function updateLikabilityFactors(totalScore) {
    // ì‹œë®¬ë ˆì´ì…˜ëœ ìš”ì†Œë³„ ì ìˆ˜ (ì‹¤ì œë¡œëŠ” ê°œë³„ ë©”íŠ¸ë¦­ì—ì„œ ê³„ì‚°)
    const expressionScore = Math.max(0, totalScore + (Math.random() - 0.5) * 20);
    const voiceScore = Math.max(0, totalScore + (Math.random() - 0.5) * 15);
    const conversationScore = Math.max(0, totalScore + (Math.random() - 0.5) * 10);
    
    const factorExpression = document.getElementById('factor-expression');
    const factorVoice = document.getElementById('factor-voice');
    const factorConversation = document.getElementById('factor-conversation');
    
    if (factorExpression) factorExpression.textContent = `${Math.round(expressionScore)}%`;
    if (factorVoice) factorVoice.textContent = `${Math.round(voiceScore)}%`;
    if (factorConversation) factorConversation.textContent = `${Math.round(conversationScore)}%`;
}

// ì „ì—­ ìŠ¤ì½”í”„ì— í•¨ìˆ˜ë“¤ ë…¸ì¶œ
window.sendMessage = sendMessage;
window.cleanTextForTTS = cleanTextForTTS;
window.updateLikability = updateLikability;
window.updateLikabilityFactors = updateLikabilityFactors;

// getAiResponse í•¨ìˆ˜ ì œê±°ë¨ - ì„œë²„ì—ì„œ ì²˜ë¦¬


// --- ì…ë ¥ ëª¨ë“œ ê´€ë¦¬ ---
// voice-input.jsì—ì„œ í†µí•© ê´€ë¦¬í•˜ë¯€ë¡œ ì œê±°ë¨

 // ì´ˆê¸° ì•ˆë‚´ íŒì—… ë‹«ê¸° ë²„íŠ¼
 const closeGuideBtn = document.getElementById('close-guide-btn');
 if (closeGuideBtn) {
     closeGuideBtn.addEventListener('click', hideInitialGuidePopup);
 }
 
   // ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ (ë‹¨ìˆœí™”)
  chatInput.addEventListener('input', (e) => {
      // ì…ë ¥ í•„ë“œ ë³€ê²½ ê°ì§€ (í•„ìš”ì‹œ ì¶”ê°€ ë¡œì§)
  });

// ì „ì†¡ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
inputBtn.addEventListener('click', () => {
    const hasText = chatInput.value.trim().length > 0;
    if (hasText) {
        sendMessage();
    }
});

// Enter í‚¤ ì´ë²¤íŠ¸
chatInput.addEventListener('keypress', (e) => { 
    if (e.key === 'Enter') sendMessage(); 
});



// --- AI í”¼ë“œë°± ë¶„ì„ ê¸°ëŠ¥ (ìë™ ì‹¤í–‰) ---
async function runAiAnalysis() {
    const summaryDiv = document.getElementById('ai-feedback-summary');
    if (chatHistory.length < 2) {
        summaryDiv.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 8px;">ğŸ¯ ì‹¤ì‹œê°„ ê¿€íŒ!</div>
            <p style="font-size: 13px; line-height: 1.6;">AIì™€ ëŒ€í™”ë¥¼ 2íšŒ ì´ìƒ ë‚˜ëˆ„ë©´<br>ìë™ìœ¼ë¡œ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.</p>
        `;
        return;
    }

    summaryDiv.textContent = 'ë¶„ì„ ì¤‘...';
    
    try {
        // ì„œë²„ì˜ í”¼ë“œë°± ë¶„ì„ API í˜¸ì¶œ
        const response = await fetch(`${window.serverUrl || 'https://dys-phi.vercel.app/api/gke'}/api/feedback`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                chatHistory: chatHistory,
                user_id: userId,
                session_id: currentSessionId
            })
        });

        if (response.ok) {
            const feedback = await response.json();
            updateFeedbackUI(feedback);
        } else {
            throw new Error(`í”¼ë“œë°± ë¶„ì„ ì‹¤íŒ¨: ${response.status}`);
        }

    } catch (error) {
        console.error("Error analyzing conversation:", error);
        summaryDiv.textContent = "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
    }
}

function setCircleProgress(score) {
    const circle = document.getElementById('likability-progress');
    const radius = circle.r.baseVal.value;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference - (score / 100) * circumference;

    circle.style.strokeDasharray = `${circumference} ${circumference}`;
    circle.style.strokeDashoffset = offset;
    
    document.getElementById('likability-score').innerHTML = `${score}<span>%</span>`;
}

function updateFeedbackUI(feedback) {
    setCircleProgress(feedback.likability);
    
    // ëŒ€í™” ì£¼ë„ê¶Œ ì—…ë°ì´íŠ¸ (ì‹¤ì œ ë¶„ì„ ê²°ê³¼ ì‚¬ìš©)
    if (window.ConversationAnalyzer) {
        const initiativeAnalysis = window.ConversationAnalyzer.getDetailedAnalysis();
        document.getElementById('user-initiative-bar').style.width = `${initiativeAnalysis.userInitiativeScore}%`;
        document.getElementById('ai-initiative-bar').style.width = `${100 - initiativeAnalysis.userInitiativeScore}%`;
        document.getElementById('initiative-status').textContent = initiativeAnalysis.status;
        document.getElementById('initiative-status').style.color = initiativeAnalysis.color;
        
        // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ëŒ€í™” ì£¼ë„ê¶Œ ì ìˆ˜ ì—…ë°ì´íŠ¸
        if (window.ComprehensiveScoreCalculator) {
            window.ComprehensiveScoreCalculator.updateConversationScore('initiative', initiativeAnalysis.userInitiativeScore);
        }
    } else {
        // í´ë°±: ì„œë²„ í”¼ë“œë°± ì‚¬ìš©
        document.getElementById('user-initiative-bar').style.width = `${feedback.initiative}%`;
        document.getElementById('ai-initiative-bar').style.width = `${100 - feedback.initiative}%`;
        document.getElementById('initiative-status').textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        document.getElementById('initiative-status').style.color = '#6b7280';
        
        // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ëŒ€í™” ì£¼ë„ê¶Œ ì ìˆ˜ ì—…ë°ì´íŠ¸
        if (window.ComprehensiveScoreCalculator) {
            window.ComprehensiveScoreCalculator.updateConversationScore('initiative', feedback.initiative);
        }
    }
    
    document.getElementById('expression-text').textContent = feedback.expression;
    document.getElementById('tone-score').textContent = `${feedback.tone}%`;
    document.getElementById('gaze-score').textContent = `${feedback.gaze_stability}%`;
    document.getElementById('concentration-score').textContent = `${feedback.concentration}%`;
    document.getElementById('posture-score').textContent = `${feedback.posture}%`;
    document.getElementById('blinking-score').textContent = `${feedback.blinking}%`;
    
    // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ê° ì ìˆ˜ ì—…ë°ì´íŠ¸
    if (window.ComprehensiveScoreCalculator) {
        // ì‹œê°ì  ì ìˆ˜ë“¤
        window.ComprehensiveScoreCalculator.updateVisualScore('expression', feedback.expression_score || 60);
        window.ComprehensiveScoreCalculator.updateVisualScore('gaze_stability', feedback.gaze_stability);
        window.ComprehensiveScoreCalculator.updateVisualScore('posture', feedback.posture);
        window.ComprehensiveScoreCalculator.updateVisualScore('blinking', feedback.blinking);
        
        // ì²­ê°ì  ì ìˆ˜ë“¤
        window.ComprehensiveScoreCalculator.updateAuditoryScore('tone', feedback.tone);
        window.ComprehensiveScoreCalculator.updateAuditoryScore('concentration', feedback.concentration);
    }

    document.getElementById('ai-feedback-summary').textContent = feedback.summary;
}

// --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
closeBtn.addEventListener('click', toggleFeedbackPanel);

feedbackToggleBtn.addEventListener('click', () => {
    toggleFeedbackPanel();
    if (feedbackPanel.classList.contains('visible')) {
        runAiAnalysis();
    }
});

// ê¸°ì¡´ ë§ˆì´í¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ìƒˆë¡œìš´ inputBtnìœ¼ë¡œ ëŒ€ì²´ë¨)

document.querySelectorAll('.suggestion-tags .tag').forEach(tag => {
    tag.addEventListener('click', () => {
        chatInput.value = `"${tag.textContent}"ì— ëŒ€í•´ ì´ì•¼ê¸°í•´ë³¼ê¹Œìš”?`;
        chatInput.focus();
    });
});

 // --- ë¹„ë””ì˜¤ ì¬ìƒ ê´€ë¦¬ ---
 function initializeVideo() {
     const video = document.getElementById('video');
     const videoLoading = document.getElementById('video-loading');
     
     // ë¹„ë””ì˜¤ íŒŒì¼ ê²½ë¡œ ì„¤ì • (ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€)
     const timestamp = new Date().getTime();
     const videoPath = `${window.serverUrl || 'https://dys-phi.vercel.app/api/gke'}/dys_studio/video/woman1_cafe.mp4?t=${timestamp}`;
     
     console.log('ğŸ¬ [VIDEO] ë¹„ë””ì˜¤ ì´ˆê¸°í™” ì‹œì‘:', videoPath);
     
     // ë¡œë”© í™”ë©´ í‘œì‹œ
     videoLoading.classList.remove('hidden');
    
    // ë¹„ë””ì˜¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    video.addEventListener('loadstart', () => {
        console.log('ğŸ¬ [VIDEO] ë¹„ë””ì˜¤ ë¡œë”© ì‹œì‘');
    });
    
         video.addEventListener('canplay', () => {
         console.log('âœ… [VIDEO] ë¹„ë””ì˜¤ ì¬ìƒ ì¤€ë¹„ ì™„ë£Œ');
         // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
         videoLoading.classList.add('hidden');
         // ìë™ ì¬ìƒ ì‹œë„ (ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ì—ë§Œ ì„±ê³µ)
         video.play().catch(error => {
             console.log('â„¹ï¸ [VIDEO] ìë™ ì¬ìƒ ëŒ€ê¸° ì¤‘ (ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í•„ìš”)');
             // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ì‹œ ì¬ìƒ ì‹œì‘ì„ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
             const startPlayback = () => {
                 video.play().then(() => {
                     console.log('âœ… [VIDEO] ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ ì¬ìƒ ì‹œì‘');
                     // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
                     document.removeEventListener('click', startPlayback);
                     document.removeEventListener('keydown', startPlayback);
                 }).catch(err => {
                     console.error('âŒ [VIDEO] ì¬ìƒ ì‹¤íŒ¨:', err);
                 });
             };
             document.addEventListener('click', startPlayback, { once: true });
             document.addEventListener('keydown', startPlayback, { once: true });
         });
     });
     
     video.addEventListener('loadeddata', () => {
         console.log('âœ… [VIDEO] ë¹„ë””ì˜¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
     });
    
    video.addEventListener('ended', () => {
        console.log('ğŸ”„ [VIDEO] ë¹„ë””ì˜¤ ì¬ìƒ ì™„ë£Œ, ë°˜ë³µ ì¬ìƒ');
        // loop ì†ì„±ì´ ìˆì§€ë§Œ í™•ì‹¤íˆ í•˜ê¸° ìœ„í•´ ë‹¤ì‹œ ì¬ìƒ
        video.currentTime = 0;
        video.play().catch(error => {
            console.error('âŒ [VIDEO] ë°˜ë³µ ì¬ìƒ ì‹¤íŒ¨:', error);
        });
    });
    
    video.addEventListener('error', (error) => {
        console.error('âŒ [VIDEO] ë¹„ë””ì˜¤ ë¡œë”© ì˜¤ë¥˜:', error);
        console.error('âŒ [VIDEO] ë¹„ë””ì˜¤ ì˜¤ë¥˜ ì½”ë“œ:', video.error?.code);
        console.error('âŒ [VIDEO] ë¹„ë””ì˜¤ ì˜¤ë¥˜ ë©”ì‹œì§€:', video.error?.message);
        console.error('âŒ [VIDEO] ë¹„ë””ì˜¤ ì†ŒìŠ¤:', video.src);
        videoLoading.innerHTML = `
            <div style="text-align: center;">
                <p style="color: #e74c3c; margin-bottom: 8px;">ë¹„ë””ì˜¤ ë¡œë”© ì‹¤íŒ¨</p>
                <p style="color: #666; font-size: 12px; margin-bottom: 8px;">ì˜¤ë¥˜ ì½”ë“œ: ${video.error?.code || 'unknown'}</p>
                <button onclick="initializeVideo()" style="padding: 8px 16px; background: var(--brand2); color: white; border: none; border-radius: 8px; cursor: pointer;">ë‹¤ì‹œ ì‹œë„</button>
            </div>
        `;
    });
    
         // ë¹„ë””ì˜¤ ì†ŒìŠ¤ ì„¤ì • (ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€)
     const cacheBuster = new Date().getTime();
     video.src = `${videoPath}?t=${cacheBuster}`;
     video.load();
}

// --- MongoDB ì„¸ì…˜ ê´€ë¦¬ ---
async function createSession() {
    try {
        const sessionName = personaName ? `${personaName}ì™€ì˜ ë°ì´íŠ¸` : 'ìƒˆë¡œìš´ ë°ì´íŠ¸';
        const response = await fetch(`${window.serverUrl || 'https://dys-phi.vercel.app/api/gke'}/api/chat/sessions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_name: sessionName,
                user_id: userId,
                email: email,
                persona_name: personaName,
                persona_age: personaAge,
                persona_mbti: personaMbti,
                persona_job: personaJob,
                persona_personality: personaPersonality,
                persona_image: personaImage
            })
        });

        if (response.ok) {
            const result = await response.json();
            currentSessionId = result.session_id;
            console.log('âœ… [CHAT] ì„¸ì…˜ ìƒì„± ì„±ê³µ:', currentSessionId);
            return true;
        } else {
            console.error('âŒ [CHAT] ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨:', response.status);
            return false;
        }
    } catch (error) {
        console.error('âŒ [CHAT] ì„¸ì…˜ ìƒì„± ì˜¤ë¥˜:', error);
        return false;
    }
}

// saveMessageToMongoDB í•¨ìˆ˜ ì œê±°ë¨ - ì„œë²„ì—ì„œ í†µí•© ì²˜ë¦¬

   // --- ì¹´ë©”ë¼ ê²½ê³  í•¨ìˆ˜ë“¤ ---
function showCameraWarning() {
    console.log('[CAMERA] ì¹´ë©”ë¼ ê²½ê³  í‘œì‹œ');
    const warning = document.getElementById('camera-warning');
    if (warning) {
        warning.classList.remove('hidden');
    }
}

function hideCameraWarning() {
    console.log('[CAMERA] ì¹´ë©”ë¼ ê²½ê³  ìˆ¨ê¹€');
    const warning = document.getElementById('camera-warning');
    if (warning) {
        warning.classList.add('hidden');
    }
}

function showCameraToast() {
    console.log('[CAMERA] ì¹´ë©”ë¼ í† ìŠ¤íŠ¸ ê²½ê³  í‘œì‹œ');
    const toast = document.getElementById('camera-toast');
    if (toast) {
        toast.classList.remove('hidden');
    }
}

function hideCameraToast() {
    console.log('[CAMERA] ì¹´ë©”ë¼ í† ìŠ¤íŠ¸ ê²½ê³  ìˆ¨ê¹€');
    const toast = document.getElementById('camera-toast');
    if (toast) {
        toast.classList.add('hidden');
    }
}

// --- ì¹´ë©”ë¼ ìƒíƒœ í™•ì¸ í•¨ìˆ˜ ---
  async function checkCameraStatus() {
      try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          // ì¹´ë©”ë¼ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ë©´ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
          stream.getTracks().forEach(track => track.stop());
          hideCameraWarning();
          hideCameraToast();
          return true;
      } catch (err) {
          console.error("ì¹´ë©”ë¼ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:", err);
          // í† ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ (ë” ê¹”ë”í•¨)
          showCameraToast();
          return false;
      }
  }

// --- ì¹´ë©”ë¼ ë° ìŒì„± ê¶Œí•œ ìš”ì²­ í•¨ìˆ˜ ---
async function requestCameraAndAudioPermissions() {
    console.log('ğŸ¤ [PERMISSIONS] ì¹´ë©”ë¼ ë° ìŒì„± ê¶Œí•œ ìš”ì²­ ì‹œì‘');
    
    try {
        // ì¹´ë©”ë¼ì™€ ìŒì„± ê¶Œí•œì„ ë™ì‹œì— ìš”ì²­
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: true, 
            audio: true 
        });
        
        console.log('âœ… [PERMISSIONS] ì¹´ë©”ë¼ ë° ìŒì„± ê¶Œí•œ íšë“ ì„±ê³µ');
        
        // ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
        stream.getTracks().forEach(track => {
            track.stop();
            console.log(`ğŸ›‘ [PERMISSIONS] ${track.kind} íŠ¸ë™ ì •ë¦¬ ì™„ë£Œ`);
        });
        
        // ê¶Œí•œ ìƒíƒœ ì €ì¥
        sessionStorage.setItem('permissionsGranted', 'true');
        
        // ê²½ê³  ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        hideCameraWarning();
        hideCameraToast();
        
        return true;
        
    } catch (err) {
        console.error('âŒ [PERMISSIONS] ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨:', err);
        
        // ê¶Œí•œ ê±°ë¶€ ìƒíƒœ ì €ì¥
        sessionStorage.setItem('permissionsGranted', 'false');
        
        // ì—ëŸ¬ íƒ€ì…ì— ë”°ë¥¸ ì²˜ë¦¬
        if (err.name === 'NotAllowedError') {
            console.warn('âš ï¸ [PERMISSIONS] ì‚¬ìš©ìê°€ ê¶Œí•œì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤');
            showPermissionDeniedMessage();
        } else if (err.name === 'NotFoundError') {
            console.warn('âš ï¸ [PERMISSIONS] ì¹´ë©”ë¼ ë˜ëŠ” ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            showDeviceNotFoundMessage();
        } else {
            console.warn('âš ï¸ [PERMISSIONS] ê¸°íƒ€ ê¶Œí•œ ì˜¤ë¥˜:', err.name);
            showCameraToast();
        }
        
        return false;
    }
}

// --- ê¶Œí•œ ê±°ë¶€ ë©”ì‹œì§€ í‘œì‹œ ---
function showPermissionDeniedMessage() {
    const message = document.createElement('div');
    message.id = 'permission-denied-message';
    message.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    `;
    
    message.innerHTML = `
        <div style="font-size: 24px; margin-bottom: 15px;">ğŸ¤</div>
        <h3 style="margin: 0 0 10px; color: #ff6b6b;">ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
        <p style="margin: 0 0 15px; line-height: 1.5;">
            ë°ì´íŠ¸ ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•´<br>
            <strong>ì¹´ë©”ë¼ì™€ ë§ˆì´í¬ ê¶Œí•œ</strong>ì´ í•„ìš”í•©ë‹ˆë‹¤.
        </p>
        <p style="margin: 0 0 20px; font-size: 14px; opacity: 0.8;">
            ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.
        </p>
        <button onclick="retryPermissions()" style="
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        ">ë‹¤ì‹œ ì‹œë„</button>
        <button onclick="closePermissionMessage()" style="
            background: #666;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
        ">ë‚˜ì¤‘ì—</button>
    `;
    
    document.body.appendChild(message);
}

// --- ë””ë°”ì´ìŠ¤ ì—†ìŒ ë©”ì‹œì§€ í‘œì‹œ ---
function showDeviceNotFoundMessage() {
    const message = document.createElement('div');
    message.id = 'device-not-found-message';
    message.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    `;
    
    message.innerHTML = `
        <div style="font-size: 24px; margin-bottom: 15px;">ğŸ“¹</div>
        <h3 style="margin: 0 0 10px; color: #ff6b6b;">ë””ë°”ì´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
        <p style="margin: 0 0 15px; line-height: 1.5;">
            ì¹´ë©”ë¼ ë˜ëŠ” ë§ˆì´í¬ê°€<br>
            ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
        </p>
        <p style="margin: 0 0 20px; font-size: 14px; opacity: 0.8;">
            ë””ë°”ì´ìŠ¤ë¥¼ ì—°ê²°í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
        </p>
        <button onclick="retryPermissions()" style="
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        ">ë‹¤ì‹œ ì‹œë„</button>
        <button onclick="closePermissionMessage()" style="
            background: #666;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
        ">ë‚˜ì¤‘ì—</button>
    `;
    
    document.body.appendChild(message);
}

// --- ê¶Œí•œ ì¬ì‹œë„ í•¨ìˆ˜ ---
async function retryPermissions() {
    console.log('ğŸ”„ [PERMISSIONS] ê¶Œí•œ ì¬ì‹œë„ ì‹œì‘');
    
    // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
    closePermissionMessage();
    
    // ì ì‹œ ëŒ€ê¸° í›„ ê¶Œí•œ ì¬ìš”ì²­
    setTimeout(async () => {
        const success = await requestCameraAndAudioPermissions();
        if (success) {
            console.log('âœ… [PERMISSIONS] ê¶Œí•œ ì¬ì‹œë„ ì„±ê³µ');
        }
    }, 500);
}

// --- ê¶Œí•œ ë©”ì‹œì§€ ë‹«ê¸° í•¨ìˆ˜ ---
function closePermissionMessage() {
    const permissionMessage = document.getElementById('permission-denied-message');
    const deviceMessage = document.getElementById('device-not-found-message');
    
    if (permissionMessage) {
        permissionMessage.remove();
    }
    if (deviceMessage) {
        deviceMessage.remove();
    }
}

// --- ê¶Œí•œ ìƒíƒœ í™•ì¸ í•¨ìˆ˜ ---
async function checkPermissionStatus() {
    try {
        // ê¶Œí•œ ìƒíƒœ í™•ì¸
        const permissions = await navigator.permissions.query({ name: 'camera' });
        const audioPermissions = await navigator.permissions.query({ name: 'microphone' });
        
        console.log('ğŸ” [PERMISSIONS] ê¶Œí•œ ìƒíƒœ í™•ì¸:', {
            camera: permissions.state,
            microphone: audioPermissions.state
        });
        
        return {
            camera: permissions.state,
            microphone: audioPermissions.state,
            allGranted: permissions.state === 'granted' && audioPermissions.state === 'granted'
        };
    } catch (err) {
        console.warn('âš ï¸ [PERMISSIONS] ê¶Œí•œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', err);
        return {
            camera: 'unknown',
            microphone: 'unknown',
            allGranted: false
        };
    }
}
 
 // --- ì•± ì´ˆê¸°í™” ---
 async function initializeApp() {
     // MongoDB ì„¸ì…˜ ìƒì„±
     const sessionCreated = await createSession();
     if (!sessionCreated) {
         console.error('âŒ [CHAT] ì„¸ì…˜ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
     }
     
     // ê¶Œí•œ ìƒíƒœ í™•ì¸ ë° í•„ìš”ì‹œ ìš”ì²­
     console.log('ğŸ¤ [APP] ê¶Œí•œ ìƒíƒœ í™•ì¸ ì‹œì‘');
     const permissionStatus = await checkPermissionStatus();
     
     if (permissionStatus.allGranted) {
         console.log('âœ… [APP] ì´ë¯¸ ëª¨ë“  ê¶Œí•œì´ í—ˆìš©ë¨');
         sessionStorage.setItem('permissionsGranted', 'true');
     } else {
         console.log('ğŸ”„ [APP] ê¶Œí•œ ìš”ì²­ í•„ìš”:', permissionStatus);
         const permissionsGranted = await requestCameraAndAudioPermissions();
         
         if (permissionsGranted) {
             console.log('âœ… [APP] ê¶Œí•œ íšë“ ì™„ë£Œ - ì•± ì´ˆê¸°í™” ê³„ì†');
         } else {
             console.warn('âš ï¸ [APP] ê¶Œí•œ íšë“ ì‹¤íŒ¨ - ì œí•œëœ ê¸°ëŠ¥ìœ¼ë¡œ ê³„ì†');
         }
     }
     
     // ì¹´ë©”ë¼ ìƒíƒœ í™•ì¸ (ê¶Œí•œ ìš”ì²­ í›„)
     await checkCameraStatus();
     
     // ë¹„ë””ì˜¤ ì´ˆê¸°í™”
     initializeVideo();
     
     // ì¹´ë©”ë¼ ë¶„ì„ê¸° ì‹œì‘
     if (typeof scheduleAnalyzerStart === 'function') {
         console.log('[ANALYZER] ì¹´ë©”ë¼ ë¶„ì„ê¸° ì‹œì‘');
         scheduleAnalyzerStart();
     } else {
         console.warn('[ANALYZER] scheduleAnalyzerStart í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
     }
     
     // Persona ì •ë³´ ì¹´ë“œ ì¶”ê°€
     addPersonaCard();
     
          // ì´ˆê¸° ì•ˆë‚´ íŒì—… í‘œì‹œ
      showInitialGuidePopup();
     
     // WebSocket ì—°ê²°
     const userData = getUserData();
     if (userData?.token && typeof connectWS === 'function') {
         connectWS(userData.token);
         
         // WebSocket ì—°ê²° í›„ ì›Œì»¤ ì´ˆê¸°í™”
         setTimeout(() => {
             if (typeof setupLandmarkWorker === 'function') {
                 console.log('[WORKER] ëœë“œë§ˆí¬ ì›Œì»¤ ì´ˆê¸°í™” ì‹œì‘');
                 
                 // ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ê°€ì ¸ì˜¤ê¸°
                 const videoElement = document.getElementById('video');
                 if (videoElement) {
                     setupLandmarkWorker(
                         videoElement,
                         onLandmarkFrame,
                         () => window.suggestedHz || 10
                     );
                     console.log('[WORKER] ëœë“œë§ˆí¬ ì›Œì»¤ ì´ˆê¸°í™” ì™„ë£Œ');
                 } else {
                     console.error('[WORKER] ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                 }
             } else {
                 console.warn('[WORKER] setupLandmarkWorker í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
             }
         }, 1000); // 1ì´ˆ í›„ ì›Œì»¤ ì´ˆê¸°í™”
     }
    
         // ì•¡ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
     const recalibrateBtn = document.getElementById('recalibrate-btn');
     if (recalibrateBtn) {
         recalibrateBtn.addEventListener('click', async () => {
             try {
                 // ì¹´ë©”ë¼ ê¶Œí•œ í™•ì¸
                 await navigator.mediaDevices.getUserMedia({ video: true });
                 // ì¹´ë©”ë¼ ê²½ê³  ìˆ¨ê¸°ê¸°
                 hideCameraWarning();
                 // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ íŒì—… ë‹¤ì‹œ í‘œì‹œ
                 const calibrationOverlay = document.getElementById('calibration-overlay');
                 const mainContent = document.getElementById('main-content');
                 if (calibrationOverlay) calibrationOverlay.classList.remove('hidden');
                 if (mainContent) mainContent.classList.remove('visible');
             } catch (err) {
                 console.error("ì¹´ë©”ë¼ ê¶Œí•œ ì‹¤íŒ¨:", err);
                 showCameraWarning();
             }
         });
     }
    
    const endSessionBtn = document.getElementById('end-session-btn');
    if (endSessionBtn) {
        endSessionBtn.addEventListener('click', () => {
            // í™•ì¸ íŒì—… í‘œì‹œ
            showConfirmDialog();
        });
    }
    
    // í™•ì¸ íŒì—… ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const cancelEndBtn = document.getElementById('cancel-end-btn');
    if (cancelEndBtn) {
        cancelEndBtn.addEventListener('click', () => {
            hideConfirmDialog();
        });
    }
    
    const confirmEndBtn = document.getElementById('confirm-end-btn');
    if (confirmEndBtn) {
        confirmEndBtn.addEventListener('click', async () => {
        // ë°ì´íŠ¸ ì„¸ì…˜ ì¢…ë£Œ - ì¦‰ì‹œ í˜ì´ì§€ ì´ë™
        hideConfirmDialog();
        
        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        const endBtn = document.getElementById('confirm-end-btn');
        const originalText = endBtn.textContent;
        endBtn.textContent = 'ì¢…ë£Œ ì¤‘...';
        endBtn.disabled = true;
        
        try {
            // ì¹´ë©”ë¼ ë¶„ì„ê¸° ì •ë¦¬
            if (window.cameraAnalyzer) {
                console.log('ğŸ§¹ [ANALYZER] ì¹´ë©”ë¼ ë¶„ì„ê¸° ì •ë¦¬ ì‹œì‘');
                window.cameraAnalyzer.cleanup();
                window.cameraAnalyzer = null;
            }
            
            // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬
            sessionStorage.removeItem('currentSessionId');
            sessionStorage.removeItem('userData');
            console.log('ğŸ§¹ [SESSION] ì„¸ì…˜ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ');
            // ìµœì¢… í”¼ë“œë°± ë°ì´í„° ìˆ˜ì§‘
            const finalFeedback = {
                likability: parseInt(document.getElementById('likability-score').textContent) || 0,
                initiative: parseInt(document.getElementById('user-initiative-bar').style.width) || 0,
                tone: parseInt(document.getElementById('tone-score').textContent) || 0,
                concentration: parseInt(document.getElementById('concentration-score').textContent) || 0,
                gaze_stability: parseInt(document.getElementById('gaze-score').textContent) || 0,
                blinking: parseInt(document.getElementById('blinking-score').textContent) || 0,
                posture: parseInt(document.getElementById('posture-score').textContent) || 0,
                expression: document.getElementById('expression-text').textContent || 'ë¶„ì„ ì—†ìŒ',
                total_score: parseInt(document.getElementById('total-score').textContent) || 0,
                summary: document.getElementById('ai-feedback-summary').textContent || 'ë¶„ì„ ì—†ìŒ'
            };
            
            // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const userData = getUserData();
            if (!userData) {
                throw new Error('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            
            const externalUrl = 'https://dys-phi.vercel.app/persona';
 			
 			// ë°±ì—”ë“œ API í˜¸ì¶œ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì²˜ë¦¬, ì‘ë‹µ ëŒ€ê¸°í•˜ì§€ ì•ŠìŒ)
 			fetch(`${serverUrl}/api/session/end`, {
 				method: 'POST',
 				headers: {
 					'Content-Type': 'application/json',
 					'Authorization': `Bearer ${userData.token || ''}`
 				},
 				body: JSON.stringify({
 					session_id: currentSessionId,
 					user_id: userData.user_id,
 					email: userData.email,
 					token: userData.token,
 					end_reason: 'user_request',
 					final_feedback: finalFeedback
 				})
 			}).then(response => {
 				if (response.ok) {
 					console.log('âœ… [SESSION] ë°±ê·¸ë¼ìš´ë“œ ì„¸ì…˜ ì¢…ë£Œ ì„±ê³µ');
 				} else {
 					console.warn('âš ï¸ [SESSION] ë°±ê·¸ë¼ìš´ë“œ ì„¸ì…˜ ì¢…ë£Œ ì‹¤íŒ¨:', response.status);
 				}
 			}).catch(error => {
 				console.warn('âš ï¸ [SESSION] ë°±ê·¸ë¼ìš´ë“œ ì„¸ì…˜ ì¢…ë£Œ ì˜¤ë¥˜:', error);
 			});
 			
 			// ì¦‰ì‹œ ì™¸ë¶€ í˜ì´ì§€ë¡œ ì´ë™ (íˆìŠ¤í† ë¦¬ì— ë‚¨ê¸°ì§€ ì•ŠìŒ)
 			console.log('ğŸš€ [SESSION] ì¦‰ì‹œ í˜ì´ì§€ ì´ë™:', externalUrl);
 			window.location.replace(externalUrl);
 			
 		} catch (error) {
 			console.error('âŒ [SESSION] ì„¸ì…˜ ì¢…ë£Œ ì¤€ë¹„ ì‹¤íŒ¨:', error);
 			
 			// ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ì™¸ë¶€ í˜ì´ì§€ë¡œ ì´ë™
 			window.location.replace('https://dys-phi.vercel.app/persona');
 		} finally {
 			// ë²„íŠ¼ ìƒíƒœ ë³µì› (í˜ì´ì§€ ì´ë™ ì „ì— ì‹¤í–‰ë  ìˆ˜ ìˆìŒ)
 			setTimeout(() => {
 				const endBtn = document.getElementById('confirm-end-btn');
 				if (endBtn) {
 					endBtn.textContent = 'ì˜ˆ';
 					endBtn.disabled = false;
 				}
 			}, 100);
 		}
 	    });
    
    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
        console.log('ğŸ§¹ [CLEANUP] í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬ ì‹œì‘');
        cleanupGlobalVariables();
    });
    
    // í˜ì´ì§€ ìˆ¨ê¹€ ì‹œ ì •ë¦¬
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            console.log('ğŸ§¹ [CLEANUP] í˜ì´ì§€ ìˆ¨ê¹€ ì‹œ ì •ë¦¬');
            cleanupGlobalVariables();
        }
    });
}

// --- ì „ì—­ ë³€ìˆ˜ ì •ë¦¬ í•¨ìˆ˜ ---
function cleanupGlobalVariables() {
    // ì›Œì»¤ ê´€ë¦¬ ì‹œìŠ¤í…œ ì •ë¦¬
    if (typeof cleanupWorker === 'function') {
        cleanupWorker();
    }
    

    
    // ë¶„ì„ê¸° ì •ë¦¬
    if (window.analyzerClient) {
        try {
            window.analyzerClient.cleanup();
            window.analyzerClient = null;
        } catch (e) {
            console.warn('[CLEANUP] ë¶„ì„ê¸° ì •ë¦¬ ì‹¤íŒ¨:', e);
        }
    }
    
    // TTS ê´€ë¦¬ì ì •ë¦¬
    if (window.ttsManager) {
        try {
            window.ttsManager.cleanup();
            window.ttsManager = null;
        } catch (e) {
            console.warn('[CLEANUP] TTS ì •ë¦¬ ì‹¤íŒ¨:', e);
        }
    }
    
    // UI ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸ ì •ë¦¬
    if (window.__UI_UPDATE_TIMER__) {
        clearTimeout(window.__UI_UPDATE_TIMER__);
        window.__UI_UPDATE_TIMER__ = null;
    }
    
    // ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„ ì •ë¦¬
    if (window.__PUMP_ANIMATION_ID__) {
        cancelAnimationFrame(window.__PUMP_ANIMATION_ID__);
        window.__PUMP_ANIMATION_ID__ = null;
    }
    
    // ëœë“œë§ˆí¬ íŒí”„ ì¤‘ì§€
    __lmPumpStop = true;
    
    console.log('[CLEANUP] ì „ì—­ ë³€ìˆ˜ ì •ë¦¬ ì™„ë£Œ');
}

// WebSocket ì—°ê²°ì€ initializeApp()ì—ì„œ ì²˜ë¦¬ë¨

// ì „ì—­ ìŠ¤ì½”í”„ì— ê¶Œí•œ ê´€ë ¨ í•¨ìˆ˜ ë…¸ì¶œ
window.requestCameraAndAudioPermissions = requestCameraAndAudioPermissions;
window.retryPermissions = retryPermissions;
window.closePermissionMessage = closePermissionMessage;
window.checkPermissionStatus = checkPermissionStatus;
}

// ê¹œë¹¡ì„ í†µê³„ ê´€ë¦¬ (mediapipe-direct.jsì—ì„œ ì²˜ë¦¬ë¨)
// blinkHistory, lastBlinkTime ë“±ì€ mediapipe-direct.jsì—ì„œ ê´€ë¦¬ë©ë‹ˆë‹¤.

// ë¯¸ì†Œ í†µê³„ ê´€ë¦¬ (ê°œì„ ëœ ë²„ì „)
let smileHistory = []; // ë¯¸ì†Œ íˆìŠ¤í† ë¦¬ (ì•ˆì •í™”ìš©)
let personalBaseSmile = 50; // ê°œì¸ë³„ ê¸°ì¤€ ë¯¸ì†Œ ê°•ë„ (ë™ì  ê³„ì‚°)
const SMILE_HISTORY_SIZE = 20; // ìµœê·¼ 20ê°œ ë¯¸ì†Œ ê°’ìœ¼ë¡œ ê¸°ì¤€ ê³„ì‚°
const SMILE_SMOOTHING_WINDOW = 5000; // 5ì´ˆ ìœˆë„ìš°ë¡œ ë¯¸ì†Œ ì•ˆì •í™”

// ìì„¸ í†µê³„ ê´€ë¦¬ (ì•ˆì •í™”ìš©)
let postureHistory = []; // ìì„¸ íˆìŠ¤í† ë¦¬ (ì•ˆì •í™”ìš©)
let smoothedPostureScore = 60; // ì•ˆì •í™”ëœ ìì„¸ ì ìˆ˜
const POSTURE_HISTORY_SIZE = 15; // ìµœê·¼ 15ê°œ ìì„¸ ê°’ìœ¼ë¡œ ì•ˆì •í™”
const POSTURE_SMOOTHING_WINDOW = 8000; // 8ì´ˆ ìœˆë„ìš°ë¡œ ìì„¸ ì•ˆì •í™”
const POSTURE_CHANGE_THRESHOLD = 15; // ê¸‰ê²©í•œ ë³€í™” ì„ê³„ê°’ (15ì  ì´ìƒ ë³€í™” ì‹œ ì œí•œ)

// ì›Œì»¤ë¡œë¶€í„° ë°›ì€ ëœë“œë§ˆí¬ë¥¼ ë°°ì¹˜ì— ì ì¬ (ê°œì„ ëœ ë²„ì „)
function onLandmarkFrame(lmBuffer, ear) {
  console.log('[LANDMARK] ëœë“œë§ˆí¬ ì²˜ë¦¬ ì‹œì‘:', { ear });
  
  // Float32Arrayë¥¼ Uint8Arrayë¡œ ë³€í™˜
  const b = new Uint8Array(lmBuffer);
  let s = "";
  for (let i = 0; i < b.length; i++) s += String.fromCharCode(b[i]);
  const base64 = btoa(s);

  const now = Date.now();

  // ë¯¸ì†Œ íˆìŠ¤í† ë¦¬ëŠ” updateCameraMetricsì—ì„œ ì²˜ë¦¬ë¨ (metrics ê°ì²´ê°€ ìˆì„ ë•Œ)

  // ìì„¸ íˆìŠ¤í† ë¦¬ëŠ” updateCameraMetricsì—ì„œ ì²˜ë¦¬ë¨ (metrics ê°ì²´ê°€ ìˆì„ ë•Œ)

  // ëœë“œë§ˆí¬ ë°°ì¹˜ì— ì¶”ê°€ (WebSocket ì „ì†¡ìš©)
  if (!window.lmBatch) {
    // lmBatchê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
    window.lmBatch = [];
    console.log('[LANDMARK] lmBatch ì´ˆê¸°í™”ë¨');
  }
  
  window.lmBatch.push({
    t: now,
    model: "facemesh-468",
    mode: "full",
    lm: base64,
    ear
  });
  
  console.log('[LANDMARK] ë°°ì¹˜ì— ì¶”ê°€ë¨:', window.lmBatch.length, 'ê°œ í”„ë ˆì„');
}

// ê¹œë¹¡ì„ ê³„ì‚° í•¨ìˆ˜ë“¤ì€ mediapipe-direct.jsì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
// calculateShortBlinkRate, calculateBlinkRate ë“±ì€ mediapipe-direct.jsì—ì„œ ê´€ë¦¬ë©ë‹ˆë‹¤.

// --- íŒì—… ê´€ë¦¬ì ëª¨ë“ˆì—ì„œ ì²˜ë¦¬ë¨ ---
// íŒì—… ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ js/popup-manager.jsì—ì„œ ê´€ë¦¬ë©ë‹ˆë‹¤.

// --- ì‹œì„  ì•ˆì •ì„± ìƒì„¸ ì •ë³´ íŒì—… í•¨ìˆ˜ë“¤ ---
function showGazeDetails() {
    const popup = document.getElementById('gaze-details-popup');
    if (popup) {
        popup.classList.add('active');
        updateGazePopupContent();
    }
}

function closeGazeDetails() {
    const popup = document.getElementById('gaze-details-popup');
    if (popup) {
        popup.classList.remove('active');
    }
}

function updateGazePopupContent() {
    if (!currentGazeData) {
        document.getElementById('gaze-main-value').textContent = 'ë°ì´í„° ì—†ìŒ';
        document.getElementById('gaze-stability-value').textContent = '0%';
        document.getElementById('gaze-landmarks').innerHTML = '<div class="no-data">ì‹œì„  ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        document.getElementById('gaze-criteria-text').innerHTML = 'ì‹œì„  ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        document.getElementById('gaze-explanation-text').innerHTML = 'ì‹œì„  ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        return;
    }
    
    // ì£¼ìš” ì •ë³´ ì—…ë°ì´íŠ¸
    const isFocused = currentGazeData.isFocused;
    document.getElementById('gaze-main-value').textContent = isFocused ? 'ì§‘ì¤‘ ì¤‘' : 'ë¶„ì‚°ë¨';
    document.getElementById('gaze-stability-value').textContent = `${currentGazeData.score}%`;
    
    // ëœë“œë§ˆí¬ ì •ë³´ ì—…ë°ì´íŠ¸
    updateGazeLandmarksInfo();
    
    // í‰ê°€ ê¸°ì¤€ ì—…ë°ì´íŠ¸
    updateGazeCriteriaInfo();
    
    // ì ìˆ˜ ê³„ì‚° ê·¼ê±° ì—…ë°ì´íŠ¸
    updateGazeExplanationInfo();
}

function updateGazeLandmarksInfo() {
    const landmarksDiv = document.getElementById('gaze-landmarks');
    
    // ì‹œì„  ë¶„ì„ì—ë§Œ ì‚¬ìš©ë˜ëŠ” MediaPipe FaceMesh ëœë“œë§ˆí¬ ì •ë³´
    const landmarkInfo = [
        { name: 'ì™¼ìª½ ëˆˆ ìœ¤ê³½', value: '16ê°œ', description: 'ì™¼ìª½ ëˆˆì˜ ìœ¤ê³½ì„ ì„ êµ¬ì„±í•˜ëŠ” ëœë“œë§ˆí¬' },
        { name: 'ì˜¤ë¥¸ìª½ ëˆˆ ìœ¤ê³½', value: '16ê°œ', description: 'ì˜¤ë¥¸ìª½ ëˆˆì˜ ìœ¤ê³½ì„ ì„ êµ¬ì„±í•˜ëŠ” ëœë“œë§ˆí¬' },
        { name: 'ì™¼ìª½ ëˆˆì¹', value: '10ê°œ', description: 'ì™¼ìª½ ëˆˆì¹ì˜ ìœ¤ê³½ì„ ì„ êµ¬ì„±í•˜ëŠ” ëœë“œë§ˆí¬' },
        { name: 'ì˜¤ë¥¸ìª½ ëˆˆì¹', value: '10ê°œ', description: 'ì˜¤ë¥¸ìª½ ëˆˆì¹ì˜ ìœ¤ê³½ì„ ì„ êµ¬ì„±í•˜ëŠ” ëœë“œë§ˆí¬' },
        { name: 'ëˆˆë™ì ì¤‘ì‹¬', value: '2ê°œ', description: 'ì™¼ìª½/ì˜¤ë¥¸ìª½ ëˆˆë™ìì˜ ì¤‘ì‹¬ì ' },
        { name: 'ì‹œì„  ì¶”ì ìš©', value: '54ê°œ', description: 'ì‹œì„  ë°©í–¥ê³¼ ì•ˆì •ì„± ë¶„ì„ì— ì‚¬ìš©ë˜ëŠ” ì´ ëœë“œë§ˆí¬' }
    ];
    
    let html = '';
    landmarkInfo.forEach(item => {
        html += `
            <div class="landmark-item">
                <div class="landmark-name">${item.name}</div>
                <div class="landmark-value">${item.value}</div>
                <div class="landmark-description">${item.description}</div>
            </div>
        `;
    });
    
    landmarksDiv.innerHTML = html;
}

function updateGazeCriteriaInfo() {
    const criteriaDiv = document.getElementById('gaze-criteria-text');
    
    const criteria = `
        <div class="criteria-section">
            <h4>ğŸ¯ ì‹œì„  ì•ˆì •ì„± í‰ê°€ ê¸°ì¤€</h4>
            <ul>
                <li><strong>ì í”„ ê±°ë¦¬ (40%)</strong>: ëˆˆë™ì ì¤‘ì‹¬ì ì˜ ê¸‰ê²©í•œ ì´ë™ ê±°ë¦¬</li>
                <li><strong>ì†ë„ (30%)</strong>: ëˆˆë™ì ì´ë™ì˜ í‰ê·  ì†ë„ (í”½ì…€/í”„ë ˆì„)</li>
                <li><strong>ì•ˆì •ì„± (30%)</strong>: ëˆˆë™ìê°€ í•œ ì˜ì—­ì— ë¨¸ë¬´ëŠ” ì •ë„</li>
            </ul>
            
            <h4>ğŸ‘ï¸ ì‹œì„  ë¶„ì„ ë°©ë²•</h4>
            <ul>
                <li><strong>ëˆˆ ìœ¤ê³½ ì¶”ì </strong>: 32ê°œ ëœë“œë§ˆí¬ë¡œ ëˆˆì˜ ìœ„ì¹˜ì™€ í¬ê¸° ì¸¡ì •</li>
                <li><strong>ëˆˆë™ì ì¤‘ì‹¬ ê³„ì‚°</strong>: ëˆˆ ìœ¤ê³½ ë‚´ë¶€ì˜ ì¤‘ì‹¬ì  ì¶”ì •</li>
                <li><strong>ì‹œì„  ë°©í–¥ ë¶„ì„</strong>: ëˆˆë™ì ì¤‘ì‹¬ì˜ í™”ë©´ ë‚´ ìœ„ì¹˜ ë³€í™” ì¶”ì </li>
                <li><strong>ì•ˆì •ì„± íŒë‹¨</strong>: ì¼ì • ì‹œê°„ ë™ì•ˆì˜ ì‹œì„  ë³€í™”ëŸ‰ ê³„ì‚°</li>
            </ul>
            
            <h4>ğŸ“Š ì ìˆ˜ ê¸°ì¤€</h4>
            <ul>
                <li><strong>90-100ì </strong>: ë§¤ìš° ì•ˆì •ì ì¸ ì‹œì„  (ì§‘ì¤‘ë ¥ ìš°ìˆ˜)</li>
                <li><strong>70-89ì </strong>: ì•ˆì •ì ì¸ ì‹œì„  (ì ì ˆí•œ ì§‘ì¤‘)</li>
                <li><strong>50-69ì </strong>: ë³´í†µ ìˆ˜ì¤€ì˜ ì‹œì„  (ì¼ë°˜ì ì¸ ìƒíƒœ)</li>
                <li><strong>30-49ì </strong>: ë¶ˆì•ˆì •í•œ ì‹œì„  (ì§‘ì¤‘ë ¥ ì €í•˜)</li>
                <li><strong>0-29ì </strong>: ë§¤ìš° ë¶ˆì•ˆì •í•œ ì‹œì„  (ì‹¬ê°í•œ ì§‘ì¤‘ë ¥ ë¬¸ì œ)</li>
            </ul>
        </div>
    `;
    
    criteriaDiv.innerHTML = criteria;
}

function updateGazeExplanationInfo() {
    const explanationDiv = document.getElementById('gaze-explanation-text');
    
    if (!currentGazeData) {
        explanationDiv.innerHTML = 'ì‹œì„  ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        return;
    }
    
    const { jumpDistance, velocity, isFocused, score } = currentGazeData;
    
    let explanation = `<div class="explanation-section">`;
    explanation += `<h4>ğŸ“ˆ í˜„ì¬ ë¶„ì„ ê²°ê³¼</h4>`;
    explanation += `<ul>`;
    explanation += `<li><strong>ì‹œì„  ìƒíƒœ</strong>: ${isFocused ? 'ì§‘ì¤‘ ì¤‘' : 'ë¶„ì‚°ë¨'}</li>`;
    explanation += `<li><strong>ì í”„ ê±°ë¦¬</strong>: ${(jumpDistance * 100).toFixed(2)}% (í™”ë©´ ëŒ€ë¹„)</li>`;
    explanation += `<li><strong>ì´ë™ ì†ë„</strong>: ${velocity.toFixed(4)} (í”½ì…€/í”„ë ˆì„)</li>`;
    explanation += `<li><strong>ìµœì¢… ì ìˆ˜</strong>: ${score}ì </li>`;
    explanation += `</ul>`;
    
    // ì ìˆ˜ í•´ì„
    if (score >= 90) {
        explanation += `<p>ğŸ¯ <strong>ë§¤ìš° ìš°ìˆ˜í•œ ì‹œì„  ì•ˆì •ì„±</strong>: ì‹œì„ ì´ ë§¤ìš° ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.</p>`;
    } else if (score >= 70) {
        explanation += `<p>ğŸ¯ <strong>ìš°ìˆ˜í•œ ì‹œì„  ì•ˆì •ì„±</strong>: ì‹œì„ ì´ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.</p>`;
    } else if (score >= 50) {
        explanation += `<p>ğŸ¯ <strong>ë³´í†µ ìˆ˜ì¤€ì˜ ì‹œì„  ì•ˆì •ì„±</strong>: ì‹œì„ ì´ ì–´ëŠ ì •ë„ ì•ˆì •ì ì…ë‹ˆë‹¤.</p>`;
    } else if (score >= 30) {
        explanation += `<p>ğŸ¯ <strong>ê°œì„ ì´ í•„ìš”í•œ ì‹œì„  ì•ˆì •ì„±</strong>: ì‹œì„ ì´ ë‹¤ì†Œ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤.</p>`;
    } else {
        explanation += `<p>ğŸ¯ <strong>ë§¤ìš° ê°œì„ ì´ í•„ìš”í•œ ì‹œì„  ì•ˆì •ì„±</strong>: ì‹œì„ ì´ ë§¤ìš° ë¶ˆì•ˆì •í•©ë‹ˆë‹¤.</p>`;
    }
    
    explanation += `</div>`;
    
    explanationDiv.innerHTML = explanation;
}

// --- ì§‘ì¤‘ë„ ìƒì„¸ ì •ë³´ íŒì—… í•¨ìˆ˜ë“¤ ---
function showConcentrationDetails() {
    const popup = document.getElementById('concentration-details-popup');
    if (popup) {
        popup.classList.add('active');
        updateConcentrationPopupContent();
    }
}

function closeConcentrationDetails() {
    const popup = document.getElementById('concentration-details-popup');
    if (popup) {
        popup.classList.remove('active');
    }
}

function updateConcentrationPopupContent() {
    if (!currentConcentrationData) {
        document.getElementById('concentration-main-value').textContent = 'ë°ì´í„° ì—†ìŒ';
        document.getElementById('concentration-score-value').textContent = '0%';
        document.getElementById('concentration-factors').innerHTML = '<div class="no-data">ì§‘ì¤‘ë„ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        document.getElementById('concentration-criteria-text').innerHTML = 'ì§‘ì¤‘ë„ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        document.getElementById('concentration-explanation-text').innerHTML = 'ì§‘ì¤‘ë„ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        return;
    }
    
    // ì£¼ìš” ì •ë³´ ì—…ë°ì´íŠ¸
    const isFocused = currentConcentrationData.isFocused;
    document.getElementById('concentration-main-value').textContent = isFocused ? 'ì§‘ì¤‘ ì¤‘' : 'ë¶„ì‚°ë¨';
    document.getElementById('concentration-score-value').textContent = `${currentConcentrationData.score}%`;
    
    // ë¶„ì„ ìš”ì†Œ ì—…ë°ì´íŠ¸
    updateConcentrationFactorsInfo();
    
    // í‰ê°€ ê¸°ì¤€ ì—…ë°ì´íŠ¸
    updateConcentrationCriteriaInfo();
    
    // ì ìˆ˜ ê³„ì‚° ê·¼ê±° ì—…ë°ì´íŠ¸
    updateConcentrationExplanationInfo();
}

function updateConcentrationFactorsInfo() {
    const factorsDiv = document.getElementById('concentration-factors');
    
    // ì§‘ì¤‘ë„ ë¶„ì„ì— ì‚¬ìš©ë˜ëŠ” ìš”ì†Œë“¤
    const factorInfo = [
        { name: 'ì‹œì„  ì•ˆì •ì„±', value: '35%', description: 'ì‹œì„ ì´ í•œ ê³³ì— ë¨¸ë¬´ëŠ” ì •ë„' },
        { name: 'ì‹œì„  ì§‘ì¤‘ë„', value: '35%', description: 'ì‹œì„ ì´ í™”ë©´ ì¤‘ì•™ì— ì§‘ì¤‘ë˜ëŠ” ì •ë„' },
        { name: 'í‘œì • ë”°ëœ»í•¨', value: '30%', description: 'ê¸ì •ì ì¸ í‘œì •ìœ¼ë¡œ ì§‘ì¤‘ë ¥ í‘œí˜„' },
        { name: 'ëˆˆë™ì ì¶”ì ', value: 'ì‹¤ì‹œê°„', description: 'ëˆˆë™ì ì›€ì§ì„ìœ¼ë¡œ ì§‘ì¤‘ ìƒíƒœ íŒë‹¨' },
        { name: 'ì‹œì„  ì´íƒˆ ì‹œê°„', value: '2ì´ˆ ì´ë‚´', description: 'ì‹œì„ ì´ í™”ë©´ì„ ë²—ì–´ë‚˜ëŠ” ì‹œê°„' },
        { name: 'ì§‘ì¤‘ ì§€ì†ì„±', value: 'ì—°ì†ì„±', description: 'ì§€ì†ì ì¸ ì§‘ì¤‘ ìƒíƒœ ìœ ì§€' }
    ];
    
    let html = '';
    factorInfo.forEach(item => {
        html += `
            <div class="factor-item">
                <div class="factor-name">${item.name}</div>
                <div class="factor-value">${item.value}</div>
                <div class="factor-description">${item.description}</div>
            </div>
        `;
    });
    
    factorsDiv.innerHTML = html;
}

function updateConcentrationCriteriaInfo() {
    const criteriaDiv = document.getElementById('concentration-criteria-text');
    
    const criteria = `
        <div class="criteria-section">
            <h4>ğŸ¯ ì§‘ì¤‘ë„ í‰ê°€ ê¸°ì¤€</h4>
            <ul>
                <li><strong>ì‹œì„  ì•ˆì •ì„± (35%)</strong>: ì‹œì„ ì´ í•œ ê³³ì— ë¨¸ë¬´ëŠ” ì •ë„</li>
                <li><strong>ì‹œì„  ì§‘ì¤‘ë„ (35%)</strong>: ì‹œì„ ì´ í™”ë©´ ì¤‘ì•™ì— ì§‘ì¤‘ë˜ëŠ” ì •ë„</li>
                <li><strong>í‘œì • ë”°ëœ»í•¨ (30%)</strong>: ê¸ì •ì ì¸ í‘œì •ìœ¼ë¡œ ì§‘ì¤‘ë ¥ í‘œí˜„</li>
            </ul>
            
            <h4>ğŸ§  ì§‘ì¤‘ë„ ë¶„ì„ ë°©ë²•</h4>
            <ul>
                <li><strong>ëˆˆë™ì ì¶”ì </strong>: 32ê°œ ëœë“œë§ˆí¬ë¡œ ëˆˆë™ì ìœ„ì¹˜ ì¶”ì </li>
                <li><strong>ì‹œì„  ë°©í–¥ ë¶„ì„</strong>: í™”ë©´ ì¤‘ì•™ ëŒ€ë¹„ ì‹œì„  ìœ„ì¹˜ ê³„ì‚°</li>
                <li><strong>ì§‘ì¤‘ ì§€ì†ì„±</strong>: ì¼ì • ì‹œê°„ ë™ì•ˆì˜ ì§‘ì¤‘ ìƒíƒœ ìœ ì§€</li>
                <li><strong>ì‹œì„  ì´íƒˆ ê°ì§€</strong>: í™”ë©´ì„ ë²—ì–´ë‚˜ëŠ” ì‹œì„  ê°ì§€</li>
            </ul>
            
            <h4>ğŸ“Š ì ìˆ˜ ê¸°ì¤€</h4>
            <ul>
                <li><strong>90-100ì </strong>: ë§¤ìš° ë†’ì€ ì§‘ì¤‘ë„ (ì™„ë²½í•œ ì§‘ì¤‘)</li>
                <li><strong>70-89ì </strong>: ë†’ì€ ì§‘ì¤‘ë„ (ì¢‹ì€ ì§‘ì¤‘)</li>
                <li><strong>50-69ì </strong>: ë³´í†µ ì§‘ì¤‘ë„ (ì¼ë°˜ì ì¸ ì§‘ì¤‘)</li>
                <li><strong>30-49ì </strong>: ë‚®ì€ ì§‘ì¤‘ë„ (ì§‘ì¤‘ë ¥ ì €í•˜)</li>
                <li><strong>0-29ì </strong>: ë§¤ìš° ë‚®ì€ ì§‘ì¤‘ë„ (ì‹¬ê°í•œ ì§‘ì¤‘ë ¥ ë¬¸ì œ)</li>
            </ul>
        </div>
    `;
    
    criteriaDiv.innerHTML = criteria;
}

function updateConcentrationExplanationInfo() {
    const explanationDiv = document.getElementById('concentration-explanation-text');
    
    if (!currentConcentrationData) {
        explanationDiv.innerHTML = 'ì§‘ì¤‘ë„ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        return;
    }
    
    const { jumpDistance, velocity, isFocused, gazeDirection, score } = currentConcentrationData;
    
    let explanation = `<div class="explanation-section">`;
    explanation += `<h4>ğŸ“ˆ í˜„ì¬ ë¶„ì„ ê²°ê³¼</h4>`;
    explanation += `<ul>`;
    explanation += `<li><strong>ì§‘ì¤‘ ìƒíƒœ</strong>: ${isFocused ? 'ì§‘ì¤‘ ì¤‘' : 'ë¶„ì‚°ë¨'}</li>`;
    explanation += `<li><strong>ì‹œì„  ë°©í–¥</strong>: ${gazeDirection || 'ì¤‘ì•™'}</li>`;
    explanation += `<li><strong>ì í”„ ê±°ë¦¬</strong>: ${(jumpDistance * 100).toFixed(2)}% (í™”ë©´ ëŒ€ë¹„)</li>`;
    explanation += `<li><strong>ì´ë™ ì†ë„</strong>: ${velocity.toFixed(4)} (í”½ì…€/í”„ë ˆì„)</li>`;
    explanation += `<li><strong>ìµœì¢… ì ìˆ˜</strong>: ${score}ì </li>`;
    explanation += `</ul>`;
    
    // ì ìˆ˜ í•´ì„
    if (score >= 90) {
        explanation += `<p>ğŸ¯ <strong>ì™„ë²½í•œ ì§‘ì¤‘ë„</strong>: ì‹œì„ ì´ ë§¤ìš° ì•ˆì •ì ì´ê³  í™”ë©´ì— ì™„ë²½í•˜ê²Œ ì§‘ì¤‘í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>`;
    } else if (score >= 70) {
        explanation += `<p>ğŸ¯ <strong>ìš°ìˆ˜í•œ ì§‘ì¤‘ë„</strong>: ì‹œì„ ì´ ì•ˆì •ì ì´ê³  í™”ë©´ì— ì˜ ì§‘ì¤‘í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>`;
    } else if (score >= 50) {
        explanation += `<p>ğŸ¯ <strong>ë³´í†µ ì§‘ì¤‘ë„</strong>: ì‹œì„ ì´ ì–´ëŠ ì •ë„ ì•ˆì •ì ì´ê³  ì ì ˆíˆ ì§‘ì¤‘í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>`;
    } else if (score >= 30) {
        explanation += `<p>ğŸ¯ <strong>ê°œì„ ì´ í•„ìš”í•œ ì§‘ì¤‘ë„</strong>: ì‹œì„ ì´ ë¶ˆì•ˆì •í•˜ê³  ì§‘ì¤‘ë ¥ì´ ì €í•˜ë˜ê³  ìˆìŠµë‹ˆë‹¤.</p>`;
    } else {
        explanation += `<p>ğŸ¯ <strong>ë§¤ìš° ê°œì„ ì´ í•„ìš”í•œ ì§‘ì¤‘ë„</strong>: ì‹œì„ ì´ ë§¤ìš° ë¶ˆì•ˆì •í•˜ê³  ì‹¬ê°í•œ ì§‘ì¤‘ë ¥ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.</p>`;
    }
    
    explanation += `</div>`;
    
    explanationDiv.innerHTML = explanation;
}

// íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', function(event) {
    const expressionPopup = document.getElementById('expression-details-popup');
    const gazePopup = document.getElementById('gaze-details-popup');
    const concentrationPopup = document.getElementById('concentration-details-popup');
    
    if (expressionPopup && event.target === expressionPopup) {
        closeExpressionDetails();
    }
    
    if (gazePopup && event.target === gazePopup) {
        closeGazeDetails();
    }
    
    if (concentrationPopup && event.target === concentrationPopup) {
        closeConcentrationDetails();
    }
});

// --- ê°œì¸í™”ëœ ê¿€íŒ ìƒì„± ---
function generatePersonalizedTips(metrics) {
  const tips = [];
  
  // ìì„¸ ê´€ë ¨ (ì‹¤ì œ UI ì ìˆ˜ ì‚¬ìš©)
  const postureElement = document.getElementById('posture-score');
  const postureScore = postureElement ? parseInt(postureElement.textContent) : 60;
  
  if (postureScore < 70) {
    if (postureScore < 50) {
      tips.push("ìì„¸ê°€ ë§ì´ ë‚˜ë¹ ì¡Œì–´ìš”. ëª©ì„ ê³§ê²Œ í´ê³  ì–´ê¹¨ë¥¼ ë‚´ë ¤ë³´ì„¸ìš”.");
    } else {
      tips.push("ìì„¸ë¥¼ ì¡°ê¸ˆ ë” ê°œì„ í•´ë³´ì„¸ìš”. ëª©ì„ ê³§ê²Œ í´ê³  ì–´ê¹¨ë¥¼ ë‚´ë ¤ë³´ì„¸ìš”.");
    }
  }
  
  // ì–´ê¹¨ ìì„¸ ê´€ë ¨
  if (metrics?.shoulderAnalysis) {
    const shoulder = metrics.shoulderAnalysis;
    
    // detailsê°€ ìˆëŠ”ì§€ í™•ì¸ í›„ ì ‘ê·¼
    if (shoulder.details && shoulder.details.heightBalance < 70) {
      tips.push("ì–´ê¹¨ ë†’ì´ë¥¼ ë§ì¶° ê· í˜•ì¡íŒ ìì„¸ë¥¼ ìœ ì§€í•˜ì„¸ìš”.");
    }
    
    if (shoulder.details && shoulder.details.slope < 70) {
      tips.push("ì–´ê¹¨ë¥¼ ìˆ˜í‰ìœ¼ë¡œ ë§ì¶° ì‚ë”±í•œ ìì„¸ë¥¼ êµì •í•˜ì„¸ìš”.");
    }
    
    if (shoulder.details && shoulder.details.width < 70) {
      tips.push("ì–´ê¹¨ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í´ê³  ì˜¬ë°”ë¥¸ ìì„¸ë¥¼ ì·¨í•˜ì„¸ìš”.");
    }
    
    if (shoulder.details && shoulder.details.rotation < 70) {
      tips.push("í•œìª½ ì–´ê¹¨ê°€ ì•ìœ¼ë¡œ ë‚˜ì˜¤ì§€ ì•Šë„ë¡ ì£¼ì˜í•˜ì„¸ìš”.");
    }
    
    // detailsê°€ ì—†ìœ¼ë©´ ì „ì²´ ì ìˆ˜ë¡œ íŒë‹¨
    if (!shoulder.details && shoulder.shoulderPostureScore < 70) {
      tips.push("ì–´ê¹¨ ìì„¸ë¥¼ ê°œì„ í•´ë³´ì„¸ìš”.");
    }
  }
  
  // ì‹œì„  ê´€ë ¨ (ì‹¤ì œ UI ì ìˆ˜ ì‚¬ìš©)
  const gazeElement = document.getElementById('gaze-score');
  const gazeScore = gazeElement ? parseInt(gazeElement.textContent) : 60;
  
  if (gazeScore < 60) {
    tips.push("í™”ë©´ ì¤‘ì•™ì„ ì‘ì‹œí•˜ë©° ì§‘ì¤‘í•´ë³´ì„¸ìš”.");
  }
  
  // ê¹œë¹¡ì„ ê´€ë ¨ (ì‹¤ì œ UI ì ìˆ˜ ì‚¬ìš©)
  const blinkElement = document.getElementById('blinking-score');
  const blinkScore = blinkElement ? parseInt(blinkElement.textContent) : 80;
  
  if (blinkScore < 60) {
    tips.push("ìì—°ìŠ¤ëŸ½ê²Œ ê¹œë¹¡ì—¬ ëˆˆì„ ë³´í˜¸í•˜ì„¸ìš”.");
  } else if (blinkScore < 80) {
    tips.push("ê¹œë¹¡ì„ì´ ì¡°ê¸ˆ ë¶€ì¡±í•´ìš”. í¸ì•ˆí•˜ê²Œ ê¹œë¹¡ì—¬ë³´ì„¸ìš”.");
  }
  
  // ë¯¸ì†Œ ê´€ë ¨ (ê°œì¸ë³„ ê¸°ì¤€ ì ìš©)
  if (metrics?.smileIntensity !== undefined && metrics?.personalBaseSmile !== undefined) {
    const smileRatio = metrics.smileIntensity / metrics.personalBaseSmile;
    
    if (smileRatio < 0.7) {
      tips.push("ğŸ˜Š í‘œì •ì´ í‰ì†Œë³´ë‹¤ ë§ì´ ë”±ë”±í•´ ë³´ì—¬ìš”. ì…ê¼¬ë¦¬ë¥¼ ì‚´ì§ ì˜¬ë ¤ë³´ì„¸ìš”!");
    } else if (smileRatio < 0.9) {
      tips.push("ğŸ˜Š í‘œì •ì´ í‰ì†Œë³´ë‹¤ ì¡°ê¸ˆ ë”±ë”±í•´ ë³´ì—¬ìš”. ìì—°ìŠ¤ëŸ¬ìš´ ë¯¸ì†Œë¥¼ ì—°ìŠµí•´ë³´ì„¸ìš”!");
    } else if (smileRatio > 1.3) {
      tips.push("ğŸ˜Š í‘œì •ì´ í‰ì†Œë³´ë‹¤ ë§ì´ ë°ì•„ ë³´ì—¬ìš”. ë„ˆë¬´ ê³¼í•˜ì§€ ì•Šê²Œ ìì—°ìŠ¤ëŸ½ê²Œ ìœ ì§€í•´ë³´ì„¸ìš”!");
    }
  } else if (metrics?.smileIntensity < 30) {
    // ê°œì¸ë³„ ê¸°ì¤€ì´ ì—†ì„ ë•Œ ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
    tips.push("í¸ì•ˆí•œ ë¯¸ì†Œë¡œ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.");
  }
  
  // ê¸°ë³¸ ê¿€íŒ (ì¡°ê±´ì— ë§ì§€ ì•Šì„ ë•Œ)
  if (tips.length === 0) {
    tips.push("í›Œë¥­í•œ ìì„¸ì…ë‹ˆë‹¤! ê³„ì† ìœ ì§€í•´ë³´ì„¸ìš”.");
  }
  
  return tips.slice(0, 3); // ìµœëŒ€ 3ê°œê¹Œì§€ë§Œ í‘œì‹œ
}

// --- ëœë“œë§ˆí¬ ë°°ì¹˜ ì²˜ë¦¬ (ì œê±°ë¨) ---

</script>
</body>
</html>