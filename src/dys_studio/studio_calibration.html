<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ë°ì—°ì†Œ Â· Love Glass UI (í”¼ë“œë°± ê³ ë„í™”)</title>
    <link rel="stylesheet" href="styles/studio_calibration.css?v=20241223-24">
<!-- MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<!-- ê¸°ë³¸ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì„¤ì • ëª¨ë“ˆ -->
<script src="js/default-calibration.js?v=20241223"></script>
<!-- ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ -->
<script src="js/calibration.js?v=20241222"></script>
<!-- ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ (ê°œë°œìš©) -->
<script src="js/performance-monitor.js?v=20241222"></script>
<!-- MediaPipe ì§ì ‘ ëª¨ë“ˆ -->
<script src="js/mediapipe-direct.js?v=20241223"></script>
<!-- ì¹´ë©”ë¼ ë¶„ì„ê¸° ëª¨ë“ˆ -->
<script src="js/camera-analyzer.js?v=20241222-2"></script>
    <!-- ìŒì„± ì…ë ¥ ëª¨ë“ˆ -->
    <script src="js/voice-input.js?v=20241222-2"></script>
    <!-- TTS ê´€ë¦¬ ëª¨ë“ˆ -->
    <script src="js/tts-manager.js?v=20241223-2"></script>
    <!-- TTS ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ -->
    <script src="js/tts-utils.js?v=20241226-1"></script>
    <!-- íŒì—… ê´€ë¦¬ ëª¨ë“ˆ -->
    <script src="js/popup-manager.js?v=20241223-2"></script>
    <!-- ëŒ€í™” ì£¼ë„ê¶Œ ë¶„ì„ ëª¨ë“ˆ -->
    <script src="js/conversation-analyzer.js?v=20241223"></script>
    <!-- ì¢…í•© ì ìˆ˜ ê³„ì‚° ëª¨ë“ˆ -->
    <script src="js/comprehensive-score-calculator.js?v=20241223"></script>
    <!-- íŒì—… ë¡œë” ëª¨ë“ˆ -->
    <script src="js/popup-loader.js?v=20241226-1"></script>
    <!-- UI ìœ í‹¸ë¦¬í‹° ëª¨ë“ˆ -->
    <script src="js/ui-utils.js?v=20241226-1"></script>
</head>
<body>



<!-- íŒì—… ì»¨í…Œì´ë„ˆë“¤ -->
<div id="calibration-popup-container"></div>
<div id="initial-guide-popup-container"></div>
<div id="confirm-popup-container"></div>
<div id="camera-warning-popup-container"></div>
 
 <!-- ìƒë‹¨ í—¤ë” -->
 <header class="top-header">
   <div class="logo">
     <div class="logo-icon">ğŸ¬</div>
     <span>ë°ì´íŠ¸ ì¥ì†Œ</span>
   </div>
   <div class="user-info">
     <div class="action-buttons">
       <button id="recalibrate-btn" class="action-btn">ìì„¸ ë‹¤ì‹œ ì¸¡ì •í•˜ê¸°</button>
       <button id="end-session-btn" class="action-btn primary">ë°ì´íŠ¸ ëë‚´ê¸°</button>
     </div>
   </div>
 </header>

<div class="main-content" id="main-content">

  <div id="feedbackPanel" class="feedback-panel">
      <div class="card">
        <header>
          <span>ğŸ’¡ AI ì¢…í•© í”¼ë“œë°±</span>
          <button id="closeBtn" class="close-btn">&times;</button>
        </header>
        <section class="body">
          <!-- í˜¸ê°ë„ ì„¹ì…˜ (ê°œì„ ëœ ë©”ì¸) -->
          <div class="likability-section-enhanced">
            <div class="likability-header">
              <h3 class="likability-main-title">ğŸ’ í˜¸ê°ë„</h3>
              <div class="likability-subtitle">AIê°€ ëŠë¼ëŠ” ë‹¹ì‹ ì˜ ë§¤ë ¥</div>
            </div>
            <div class="likability-content">
              <div class="likability-circle-enhanced">
                <svg viewBox="0 0 120 120">
                  <defs>
                    <linearGradient id="likability-gradient-enhanced" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" stop-color="#667eea" />
                      <stop offset="50%" stop-color="#764ba2" />
                      <stop offset="100%" stop-color="#f093fb" />
                    </linearGradient>
                    <filter id="glow">
                      <fegaussianblur stdDeviation="3" result="coloredBlur"/>
                      <femerge> 
                        <femergenode in="coloredBlur"/>
                        <femergenode in="SourceGraphic"/>
                      </femerge>
                    </filter>
                  </defs>
                  <circle class="circle-bg-enhanced" cx="60" cy="60" r="50" stroke="rgba(255,255,255,0.1)" stroke-width="8" fill="none"/>
                  <circle id="likability-progress-enhanced" class="circle-progress-enhanced" cx="60" cy="60" r="50" stroke="url(#likability-gradient-enhanced)" stroke-width="8" fill="none" stroke-linecap="round" filter="url(#glow)" transform="rotate(-90 60 60)"/>
                </svg>
                <div class="likability-inner">
                  <div id="likability-score-enhanced" class="likability-score-enhanced">-<span class="score-unit">%</span></div>
                  <div class="likability-status" id="likability-status">ì¸¡ì • ì¤‘</div>
                </div>
              </div>
              <div class="likability-factors">
                <div class="factor-item">
                  <span class="factor-icon">ğŸ˜Š</span>
                  <span class="factor-text">í‘œì •</span>
                  <span class="factor-score" id="factor-expression">-</span>
                </div>
                <div class="factor-item">
                  <span class="factor-icon">ğŸµ</span>
                  <span class="factor-text">ìŒì„±</span>
                  <span class="factor-score" id="factor-voice">-</span>
                </div>
                <div class="factor-item">
                  <span class="factor-icon">ğŸ’¬</span>
                  <span class="factor-text">ëŒ€í™”</span>
                  <span class="factor-score" id="factor-conversation">-</span>
                </div>
              </div>
            </div>
          </div>

          <!-- ëŒ€í™” í’ˆì§ˆ ì„¹ì…˜ -->
          <div class="feedback-section">
            <h3 class="section-title">ğŸ’¬ ëŒ€í™” í’ˆì§ˆ</h3>
            <div class="metrics-grid">
              <div class="metric-card" onclick="showInitiativeDetails()" style="cursor: pointer;">
                <div class="metric-icon">ğŸ­</div>
                <div class="metric-content">
                  <div class="metric-title">ëŒ€í™” ì£¼ë„ê¶Œ</div>
                  <div class="initiative-container">
                    <div class="initiative-labels">
                      <span class="user-label">ë‚˜</span>
                      <span class="ai-label">AI</span>
                    </div>
                    <div class="initiative-bar">
                      <div id="user-initiative-bar" class="user-bar" style="width: 50%;"></div>
                      <div id="ai-initiative-bar" class="ai-bar" style="width: 50%;"></div>
                    </div>
                    <div id="initiative-status" class="initiative-status">ê· í˜•ì </div>
                  </div>
                </div>
              </div>
              
              <div class="metric-card" onclick="showExpressionDetails()" style="cursor: pointer;">
                <div class="metric-icon">ğŸ˜Š</div>
                <div class="metric-content">
                  <div class="metric-title">í‘œì •</div>
                  <div id="expression-score" class="metric-value">-%</div>
                  <div id="expression-status" class="metric-status" style="font-size: 10px; color: #6b7280; margin-top: 2px;">ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
                </div>
              </div>
              
              <div class="metric-card">
                <div class="metric-icon">ğŸ—£ï¸</div>
                <div class="metric-content">
                  <div class="metric-title">ë§íˆ¬</div>
                  <div id="tone-score" class="metric-value">-%</div>
                </div>
              </div>
            </div>
          </div>

          <!-- ì‹ ì²´ ì–¸ì–´ ì„¹ì…˜ -->
          <div class="feedback-section">
            <h3 class="section-title">ğŸ¯ ì‹ ì²´ ì–¸ì–´</h3>
            <div class="metrics-grid">
              <div class="metric-card" onclick="showGazeDetails()" style="cursor: pointer;">
                <div class="metric-icon">ğŸ‘ï¸</div>
                <div class="metric-content">
                  <div class="metric-title">ì‹œì„  ì•ˆì •ì„±</div>
                  <div id="gaze-score" class="metric-value">-%</div>
                  <div id="gaze-status" class="metric-status" style="font-size: 10px; color: #6b7280; margin-top: 2px;">ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
                </div>
              </div>
              
              <div class="metric-card" onclick="showConcentrationDetails()" style="cursor: pointer;">
                <div class="metric-icon">ğŸ¯</div>
                <div class="metric-content">
                  <div class="metric-title">ì§‘ì¤‘ë„</div>
                  <div id="concentration-score" class="metric-value">-%</div>
                  <div id="concentration-status" class="metric-status" style="font-size: 10px; color: #6b7280; margin-top: 2px;">ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
                </div>
              </div>
              
              <div class="metric-card" onclick="showPostureDetails()" style="cursor: pointer;">
                <div class="metric-icon">âœ¨</div>
                <div class="metric-content">
                  <div class="metric-title">ìì„¸</div>
                  <div id="posture-score" class="metric-value">-%</div>
                  <div id="posture-status" class="metric-status" style="font-size: 10px; color: #6b7280; margin-top: 2px;">ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
                </div>
              </div>
              
              <div class="metric-card" onclick="showBlinkingDetails()" style="cursor: pointer;">
                <div class="metric-icon">ğŸ˜‰</div>
                <div class="metric-content">
                  <div class="metric-title">ê¹œë¹¡ì„</div>
                  <div id="blinking-score" class="metric-value">-%</div>
                  <div id="blinking-status" class="metric-status" style="font-size: 10px; color: #6b7280; margin-top: 2px;">ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
                </div>
              </div>
            </div>
          </div>

          <!-- ì¢…í•© ì ìˆ˜ ì„¹ì…˜ -->
          <div class="total-score-section">
            <div class="total-score-card" onclick="showComprehensiveScoreDetails()" style="cursor: pointer;">
              <div class="total-score-icon">ğŸ†</div>
              <div class="total-score-content">
                <div class="total-score-title">ì¢…í•© ì ìˆ˜</div>
                <div id="total-score" class="total-score-value">-%</div>
                <div class="total-score-subtitle">ì‹œê° 55% + ì²­ê° 38% + ëŒ€í™” 7%</div>
              </div>
            </div>
          </div>
          
          <!-- AI í”¼ë“œë°± ì„¹ì…˜ -->
          <div id="ai-feedback-summary" class="ai-feedback-section">
            <div class="ai-feedback-header">
              <span class="ai-feedback-icon">ğŸ¯</span>
              <span class="ai-feedback-title">ì‹¤ì‹œê°„ ê¿€íŒ!</span>
            </div>
            <ol class="ai-feedback-list">
                <li>ìƒëŒ€ë°©ì˜ ë§ì— ê¸ì •ì ìœ¼ë¡œ ë°˜ì‘í•´ë³´ì„¸ìš”.</li>
                <li>ëŒ€í™”ê°€ ëŠê¸°ì§€ ì•Šê²Œ ì§ˆë¬¸ì„ ë˜ì ¸ë³´ì„¸ìš”.</li>
                <li>ìì‹ ê° ìˆëŠ” ëª©ì†Œë¦¬ë¡œ ë§í•˜ëŠ” ê²ƒì„ ìŠì§€ ë§ˆì„¸ìš”!</li>
            </ol>
          </div>
        </section>
      </div>
    </div>

    <!-- ê¹œë¹¡ì„ ìƒì„¸ ì •ë³´ íŒì—… -->
    <div id="blinking-popup-container"></div>

    <button id="feedbackToggleBtn" class="feedback-toggle-btn">í”¼ë“œë°±</button>

    <!-- ëŒ€í™” ì£¼ë„ê¶Œ ìƒì„¸ ì •ë³´ íŒì—… -->
    <div id="initiative-popup-container"></div>

    <!-- í‘œì • ìƒì„¸ ì •ë³´ íŒì—… -->
    <div id="expression-popup-container"></div>

 
    <!-- ì‹œì„  ì•ˆì •ì„± ìƒì„¸ ì •ë³´ íŒì—… -->
    <div id="gaze-popup-container"></div>

    <!-- ì§‘ì¤‘ë„ ìƒì„¸ ì •ë³´ íŒì—… -->
    <div id="concentration-popup-container"></div>

    <!-- ìì„¸ ìƒì„¸ ì •ë³´ íŒì—… -->
    <div id="posture-popup-container"></div>

         <div class="card video-container">
       <header>â¤ï¸ ë°ì´íŠ¸ ì¤‘</header>
               <div class="video-wrapper">
           <div id="video-loading" class="video-loading">
             <div class="loading-spinner"></div>
             <p>ë¹„ë””ì˜¤ ë¡œë”© ì¤‘...</p>
           </div>
           <video id="video" poster="https://placehold.co/1280x720/e0e8ff/ffffff?text=Video+Stream" playsinline loop></video>
        </div>
       <section class="body">
         <div class="suggestion-container">
             <h4>ì´ëŸ° ì£¼ì œë¡œ ë¬¼ì–´ë³´ì„¸ìš”</h4>
             <div class="suggestion-tags">
                 <button class="tag">ìµœê·¼ì— ë³¸ ì˜í™”</button>
                 <button class="tag">ì£¼ë§ ê³„íš</button>
                 <button class="tag">ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ìŒì‹</button>
                 <button class="tag">ìš”ì¦˜ ì¦ê²¨ë“£ëŠ” ë…¸ë˜</button>
             </div>
         </div>
       </section>
     </div>

     <div class="card">
       <header>ğŸ’¬ ëŒ€í™” ì¤‘</header>
       <div class="chat-log" id="chatLog"></div>
                      <div class="chat-input">
           <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
           <button id="inputBtn" class="input-btn" title="ë©”ì‹œì§€ ì „ì†¡">
                               <img src="" alt="ì „ì†¡" id="inputIcon">
           </button>
         </div>
    </div>
</div>

<script>
// --- ì„œë²„/ì—”ë“œí¬ì¸íŠ¸ ì„¤ì • (Vercel í”„ë¡ì‹œ ì‚¬ìš©) ---
const serverUrl = window.__API_BASE__ || "https://dys-phi.vercel.app/api/gke";
const apiEndpoints = {
  chat: `${serverUrl}/api/chat`,
  feedback: `${serverUrl}/api/feedback`,
  calibration: `${serverUrl}/api/calibration`,
  user_check: `${serverUrl}/api/user/check`,
  frame: `${serverUrl}/api/frame`,          // í”„ë ˆì„ ì—…ë¡œë“œ
  landmarks: `${serverUrl}/api/landmarks`,
};
// ê°œë°œ í™˜ê²½ì—ì„œëŠ” í•­ìƒ WS í”„ë¡œí† ì½œ ì‚¬ìš© (HTTP ê¸°ë°˜)
const wsProto = "ws";

// WebSocket ì„¤ì • - ì„œë²„ì—ì„œ ë™ì ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
let wsEndpoints = {};

async function initializeWebSocketConfig() {
  try {
    console.log('[WEBSOCKET] ì„œë²„ì—ì„œ WebSocket ì„¤ì • ê°€ì ¸ì˜¤ëŠ” ì¤‘...');
    const wsConfigResponse = await fetch(`${serverUrl}/api/websocket/config`);
    
    if (wsConfigResponse.ok) {
      const wsConfig = await wsConfigResponse.json();
      const wsProtocol = wsConfig.protocol || 'wss';
      const wsHost = `${wsConfig.host}:${wsConfig.port}`;
      
      wsEndpoints = {
        landmarks: `${wsProtocol}://${wsHost}/ws/landmarks`,
      };
      
      console.log('[WEBSOCKET] âœ… ì„œë²„ì—ì„œ WebSocket ì„¤ì • ë¡œë“œ ì™„ë£Œ:', wsConfig);
      console.log('[WEBSOCKET] ì‚¬ìš©í•  WebSocket URL:', wsEndpoints.landmarks);
      return true;
    } else {
      throw new Error(`WebSocket config fetch failed: ${wsConfigResponse.status}`);
    }
  } catch (error) {
    console.warn('[WEBSOCKET] âš ï¸ ì„œë²„ WebSocket ì„¤ì • ë¡œë“œ ì‹¤íŒ¨, fallback ì‚¬ìš©:', error);
    
    // Fallback ë¡œì§
    const isGKE = location.hostname.includes('vercel.app') || location.hostname.includes('dys-phi');
    const isDev = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    
    let wsHost, wsProtocol;
    
    if (isGKE) {
      // í”„ë¡œë•ì…˜ í™˜ê²½ - í™˜ê²½ë³€ìˆ˜ë‚˜ ë™ì  ì„¤ì • ì‚¬ìš©
      wsHost = window.__WS_HOST__ || '34.64.136.237'; // í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì • ê°€ëŠ¥
      wsProtocol = 'wss';
    } else if (isDev) {
      // ê°œë°œ í™˜ê²½
      wsHost = location.hostname;
      wsProtocol = 'ws';
    } else {
      // ê¸°íƒ€ í™˜ê²½
      wsHost = location.hostname;
      wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';
    }
    
    wsEndpoints = {
      landmarks: `${wsProtocol}://${wsHost}:8001/ws/landmarks`,
    };
    
    console.log('[WEBSOCKET] Fallback WebSocket ì„œë²„ ì‚¬ìš©:', `${wsProtocol}://${wsHost}:8001`);
    console.log('[WEBSOCKET] í™˜ê²½ ê°ì§€:', { isGKE, isDev, wsHost, wsProtocol });
    return false;
  }
}

// WebSocket ì„¤ì • ì´ˆê¸°í™”ë¥¼ ì¦‰ì‹œ ì‹¤í–‰
initializeWebSocketConfig().then(success => {
  console.log('[WEBSOCKET] WebSocket ì„¤ì • ì´ˆê¸°í™” ì™„ë£Œ:', success ? 'ì„œë²„ ì„¤ì • ì‚¬ìš©' : 'Fallback ì„¤ì • ì‚¬ìš©');
}).catch(error => {
  console.error('[WEBSOCKET] WebSocket ì„¤ì • ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
});

// ì „ì—­ ìŠ¤ì½”í”„ì— ë…¸ì¶œí•˜ì—¬ ëª¨ë“ˆì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
window.serverUrl = serverUrl;
window.wsEndpoints = wsEndpoints;
window.apiEndpoints = apiEndpoints;

// ì´ë¯¸ì§€ ê²½ë¡œ ë™ì  ì„¤ì •
document.addEventListener('DOMContentLoaded', function() {
    const cameraIcon = document.getElementById('cameraIcon');
    const inputIcon = document.getElementById('inputIcon');
    
    if (cameraIcon) {
        cameraIcon.src = `${window.serverUrl}/dys_studio/img/icon/camera.webp`;
    }
    
    if (inputIcon) {
        inputIcon.src = `${window.serverUrl}/dys_studio/img/icon/enter_icon.webp`;
    }
});

// --- ëœë“œë§ˆí¬ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ ---
let suggestedHz = 10; // ì›Œì»¤ì—ì„œ ì‚¬ìš©í•  FPS

// --- ë³´ì•ˆ ê°•í™”: URL íŒŒë¼ë¯¸í„°ë¥¼ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•˜ê³  URL ì •ë¦¬ ---
function secureUserData() {
    // URLì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
const urlParams = new URLSearchParams(window.location.search);
    const userData = {
        user_id: urlParams.get('user_id'),
        email: urlParams.get('email'),
        token: urlParams.get('token'),
        persona_name: urlParams.get('persona_name'),
        persona_age: urlParams.get('persona_age'),
        persona_mbti: urlParams.get('persona_mbti'),
        persona_job: urlParams.get('persona_job'),
        persona_personality: urlParams.get('persona_personality'),
        persona_image: urlParams.get('persona_image')
    };

    // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì•ˆì „í•˜ê²Œ ì €ì¥
    sessionStorage.setItem('userData', JSON.stringify(userData));

    // URLì—ì„œ ë¯¼ê°í•œ ì •ë³´ ì œê±° (íˆìŠ¤í† ë¦¬ ë³€ê²½ ì—†ì´)
    const cleanUrl = new URL(window.location.href);
    cleanUrl.search = '';
    window.history.replaceState({}, document.title, cleanUrl.pathname);
}

// --- ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ---
function getUserData() {
    const userDataStr = sessionStorage.getItem('userData');
    if (!userDataStr) {
        console.error('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return null;
    }
    return JSON.parse(userDataStr);
}

// --- ì „ì—­ ë³€ìˆ˜ë¡œ ì‚¬ìš©ì ì •ë³´ ì„¤ì • ---
let userId, email, token, personaName, personaAge, personaMbti, personaJob, personaPersonality, personaImage;

// ì „ì—­ ìŠ¤ì½”í”„ì— ë…¸ì¶œí•˜ì—¬ ëª¨ë“ˆì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
window.userId = userId;
window.email = email;
window.token = token;
window.personaName = personaName;
window.personaAge = personaAge;
window.personaMbti = personaMbti;
window.personaJob = personaJob;
window.personaPersonality = personaPersonality;
window.personaImage = personaImage;

// --- ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™” ---
function initializeUserData() {
    const userData = getUserData();
    if (userData) {
        userId = userData.user_id;
        email = userData.email;
        token = userData.token;
        personaName = userData.persona_name;
        personaAge = userData.persona_age;
        personaMbti = userData.persona_mbti;
        personaJob = userData.persona_job;
        personaPersonality = userData.persona_personality;
        personaImage = userData.persona_image;
        
        // ì „ì—­ ìŠ¤ì½”í”„ì— ì—…ë°ì´íŠ¸
        window.userId = userId;
        window.email = email;
        window.token = token;
        window.personaName = personaName;
        window.personaAge = personaAge;
        window.personaMbti = personaMbti;
        window.personaJob = personaJob;
        window.personaPersonality = personaPersonality;
        window.personaImage = personaImage;
        
        console.log('âœ… ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™” ì™„ë£Œ');
        return true;
    } else {
        console.error('âŒ ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return false;
    }
}

// --- í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œ ì‚¬ìš©ì ì •ë³´ ë³µêµ¬ ---
function restoreUserDataOnRefresh() {
    // URLì— íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('user_id')) {
        secureUserData();
        
        // ì—ëŸ¬ íŒŒë¼ë¯¸í„° ì²´í¬ ë° ì²˜ë¦¬
        const error = urlParams.get('error');
        if (error) {
            handlePageError(error);
            return false; // ì—ëŸ¬ê°€ ìˆìœ¼ë©´ ì´ˆê¸°í™” ì¤‘ë‹¨
        }
        
        // ì„¸ì…˜ ì¢…ë£Œ ì„±ê³µ íŒŒë¼ë¯¸í„° ì²´í¬ ë° ì²˜ë¦¬
        const sessionEnded = urlParams.get('session_ended');
        if (sessionEnded === 'true') {
            handleSessionEnded();
        }
        
        // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ê±´ë„ˆë›°ê¸° íŒŒë¼ë¯¸í„° ì²´í¬
        const skipCalibration = urlParams.get('skip_calibration');
        if (skipCalibration === 'true') {
            // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ê±´ë„ˆë›°ê¸° í”Œë˜ê·¸ë¥¼ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            sessionStorage.setItem('skipCalibration', 'true');
        }
        
        return true;
    }
    
    // URLì— íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë³µêµ¬ ì‹œë„
    const userData = getUserData();
    if (userData) {
        initializeUserData();
        return true;
    }
    
    return false;
}

// --- í˜ì´ì§€ ì—ëŸ¬ ì²˜ë¦¬ ---
function handlePageError(error) {
    console.error('âŒ í˜ì´ì§€ ì—ëŸ¬ ë°œìƒ:', error);
    
    let errorMessage = '';
    let errorTitle = '';
    
    switch (error) {
        case 'session_end_failed':
            errorTitle = 'ì„¸ì…˜ ì¢…ë£Œ ì‹¤íŒ¨';
            errorMessage = 'ë°ì´íŠ¸ ì„¸ì…˜ì„ ì¢…ë£Œí•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            break;
        case 'user_not_found':
            errorTitle = 'ì‚¬ìš©ì ì •ë³´ ì—†ìŒ';
            errorMessage = 'ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
            break;
        default:
            errorTitle = 'ì˜¤ë¥˜ ë°œìƒ';
            errorMessage = 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.';
    }
    
    // ì—ëŸ¬ íŒì—… í‘œì‹œ
    showErrorPopup(errorTitle, errorMessage);
}

// --- ì—ëŸ¬ íŒì—… í‘œì‹œ ---
function showErrorPopup(title, message) {
    // ê¸°ì¡´ ì—ëŸ¬ íŒì—…ì´ ìˆìœ¼ë©´ ì œê±°
    const existingError = document.getElementById('error-popup');
    if (existingError) {
        existingError.remove();
    }
    
    // ì—ëŸ¬ íŒì—… ìƒì„±
    const errorPopup = document.createElement('div');
    errorPopup.id = 'error-popup';
    errorPopup.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 5000;
        display: flex;
        justify-content: center;
        align-items: center;
    `;
    
    errorPopup.innerHTML = `
        <div style="
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        ">
            <div style="
                width: 60px;
                height: 60px;
                background: #ef4444;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 20px;
                font-size: 24px;
                color: white;
            ">âš ï¸</div>
            <h3 style="margin: 0 0 16px; color: #1f2937; font-size: 20px;">${title}</h3>
            <p style="margin: 0 0 24px; color: #6b7280; line-height: 1.5;">${message}</p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button onclick="retrySession()" style="
                    padding: 12px 24px;
                    background: #6c7cff;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                ">ë‹¤ì‹œ ì‹œë„</button>
                <button onclick="goToHome()" style="
                    padding: 12px 24px;
                    background: #e5e7eb;
                    color: #374151;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                ">í™ˆìœ¼ë¡œ</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(errorPopup);
}

// --- ë‹¤ì‹œ ì‹œë„ í•¨ìˆ˜ ---
function retrySession() {
    const errorPopup = document.getElementById('error-popup');
    if (errorPopup) {
        errorPopup.remove();
    }
    
    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    window.location.reload();
}

// --- í™ˆìœ¼ë¡œ ì´ë™ í•¨ìˆ˜ ---
function goToHome() {
    // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬
    sessionStorage.clear();
    
    // í™ˆí˜ì´ì§€ë¡œ ì´ë™ (ì‹¤ì œ í™ˆí˜ì´ì§€ URLë¡œ ë³€ê²½ í•„ìš”)
    window.location.href = '/';
}

// --- ì„¸ì…˜ ì¢…ë£Œ ì„±ê³µ ì²˜ë¦¬ ---
function handleSessionEnded() {
    console.log('âœ… ì„¸ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    
    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
    showSuccessMessage();
    
    // URLì—ì„œ session_ended íŒŒë¼ë¯¸í„° ì œê±°
    const url = new URL(window.location.href);
    url.searchParams.delete('session_ended');
    url.searchParams.delete('session_id');
    window.history.replaceState({}, document.title, url.toString());
}

// --- ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ ---
function showSuccessMessage() {
    // ê¸°ì¡´ ì„±ê³µ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì œê±°
    const existingSuccess = document.getElementById('success-message');
    if (existingSuccess) {
        existingSuccess.remove();
    }
    
    // ì„±ê³µ ë©”ì‹œì§€ ìƒì„±
    const successMessage = document.createElement('div');
    successMessage.id = 'success-message';
    successMessage.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        z-index: 4000;
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideInRight 0.3s ease-out;
        max-width: 300px;
    `;
    
    successMessage.innerHTML = `
        <div style="font-size: 20px;">âœ…</div>
        <div>
            <div style="font-weight: 600; margin-bottom: 4px;">ë°ì´íŠ¸ ì™„ë£Œ!</div>
            <div style="font-size: 14px; opacity: 0.9;">ì„¸ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</div>
        </div>
        <button onclick="closeSuccessMessage()" style="
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.7;
            padding: 4px;
            border-radius: 4px;
        ">Ã—</button>
    `;
    
    document.body.appendChild(successMessage);
    
    // 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¸°ê¸°
    setTimeout(() => {
        closeSuccessMessage();
    }, 5000);
}

// --- ì„±ê³µ ë©”ì‹œì§€ ë‹«ê¸° ---
function closeSuccessMessage() {
    const successMessage = document.getElementById('success-message');
    if (successMessage) {
        successMessage.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
            successMessage.remove();
        }, 300);
    }
}

// --- ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ ì¶”ê°€ ---
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

// --- ëª¨ë“ˆ ë¡œë”© ìœ í‹¸ë¦¬í‹° ---
/**
 * ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆì´ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
 * @param {number} timeout - íƒ€ì„ì•„ì›ƒ (ms)
 * @returns {Promise<void>}
 */
async function waitForCalibrationModule(timeout = 5000) {
    const startTime = Date.now();
    
    while (typeof window.CalibrationModule === 'undefined') {
        if (Date.now() - startTime > timeout) {
            console.error('[CALIBRATION] ëª¨ë“ˆ ë¡œë”© íƒ€ì„ì•„ì›ƒ');
            throw new Error('ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ë¡œë”© ì‹¤íŒ¨');
        }
        // 10msë§ˆë‹¤ ì²´í¬ (non-blocking)
        await new Promise(resolve => setTimeout(resolve, 10));
    }
}

// --- ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ë¡œì§ (ë³„ë„ íŒŒì¼ë¡œ ë¶„ë¦¬ë¨) ---
document.addEventListener('DOMContentLoaded', async () => {
    // íŒì—… ë¡œë“œ
    await loadAllPopups();
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë“  ë©”íŠ¸ë¦­ ì´ˆê¸°í™”
    setTimeout(() => {
        resetAllMetrics();
    }, 100);
    
    // ì‚¬ìš©ì ë°ì´í„° ë³´ì•ˆ ì²˜ë¦¬ ë° ì´ˆê¸°í™”
    const userDataRestored = restoreUserDataOnRefresh();
    if (!userDataRestored) {
        console.error('ì‚¬ìš©ì ì •ë³´ë¥¼ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë‹¤ì‹œ ë¡œë“œí•´ì£¼ì„¸ìš”.');
        // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ í‘œì‹œ
        alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ì „ í˜ì´ì§€ë¡œ ëŒì•„ê°€ì„œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        window.history.back();
        return;
    }
    
    // ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™” (ì´ ë¶€ë¶„ì´ ëˆ„ë½ë˜ì–´ ìˆì—ˆìŒ)
    const userDataInitialized = initializeUserData();
    if (!userDataInitialized) {
        console.error('ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        alert('ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        window.location.reload();
        return;
    }
    
    // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ë¡œë”© ëŒ€ê¸° ë° ì´ˆê¸°í™”
    await waitForCalibrationModule();
    console.log('[CALIBRATION] ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ - ì´ˆê¸°í™” ì‹œì‘');
    
    // ì‚¬ìš©ì ì •ë³´ê°€ ì´ˆê¸°í™”ëœ í›„ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™”
    if (window.CalibrationModule && typeof window.CalibrationModule.initializeCalibration === 'function') {
        console.log('[CALIBRATION] ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™” ì™„ë£Œ - ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™” ì‹œì‘');
        
        // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™” (ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • í¬í•¨)
        if (typeof window.initializeCalibrationModule === 'function') {
            window.initializeCalibrationModule();
        }
        
        // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ìƒíƒœ í™•ì¸ ë° ì´ˆê¸°í™”
        window.CalibrationModule.initializeCalibration();
        
        // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™” ì™„ë£Œ - ì‚¬ìš©ì ì„ íƒ ëŒ€ê¸°
        console.log('[APP] ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™” ì™„ë£Œ - ì‚¬ìš©ì ì„ íƒ ëŒ€ê¸° ì¤‘');
        // ì‚¬ìš©ìê°€ "ê±´ë„ˆë›°ê¸°"ë¥¼ ëˆ„ë¥´ê±°ë‚˜ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ì„ ì™„ë£Œí•œ í›„ì—ë§Œ ì•± ì‹œì‘ë¨
        
        // ì•± ì‹œì‘ í”Œë˜ê·¸ ê°ì§€
        const checkAppStart = () => {
            if (window.__readyToStartApp) {
                console.log('[APP] ì‚¬ìš©ì ì„ íƒ ê°ì§€ - ì•± ì‹œì‘');
                initializeApp();
            } else {
                setTimeout(checkAppStart, 100); // 100msë§ˆë‹¤ í™•ì¸
            }
        };
        checkAppStart();
    } else {
        console.error('[CALIBRATION] ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™” í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆì´ ì—†ì–´ë„ ì‚¬ìš©ì ì„ íƒì„ ê¸°ë‹¤ë¦¼
        console.log('[APP] ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì—†ìŒ - ì‚¬ìš©ì ì„ íƒ ëŒ€ê¸° ì¤‘');
    }
    
    // ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìƒì„± (ê°œë°œ ëª¨ë“œì—ì„œë§Œ)
    if (window.PerformanceMonitor && window.location.hostname === 'localhost') {
        window.PerformanceMonitor.generateReport();
    }
    
    // ìŒì„± ì…ë ¥ ê´€ë¦¬ì ì´ˆê¸°í™” (ì§€ì—° ì‹¤í–‰)
    setTimeout(() => {
        if (window.VoiceInputManager) {
            window.voiceManager = new VoiceInputManager();
            console.log('[VOICE] ìŒì„± ì…ë ¥ ê´€ë¦¬ì ì´ˆê¸°í™” ì™„ë£Œ');
        } else {
            console.warn('[VOICE] VoiceInputManagerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // TTS ê´€ë¦¬ì ì´ˆê¸°í™”
        if (window.TTSManager) {
            window.ttsManager = new TTSManager();
            console.log('[TTS] TTS ê´€ë¦¬ì ì´ˆê¸°í™” ì™„ë£Œ');
        } else {
            console.warn('[TTS] TTSManagerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
    }, 500);
});


// --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
const feedbackPanel = document.getElementById('feedbackPanel');
const feedbackToggleBtn = document.getElementById('feedbackToggleBtn');
const closeBtn = document.getElementById('closeBtn');
const chatLog = document.getElementById('chatLog');
const chatInput = document.getElementById('chatInput');
const inputBtn = document.getElementById('inputBtn');
const inputIcon = document.getElementById('inputIcon');

// --- ì¹´ë©”ë¼ ë¶„ì„ê¸° (ë³„ë„ íŒŒì¼ë¡œ ë¶„ë¦¬ë¨) ---
// js/camera-analyzer.jsì—ì„œ CameraAnalyzer í´ë˜ìŠ¤ì™€ ê´€ë ¨ í•¨ìˆ˜ë“¤ì´ ë¡œë“œë¨

// ëª¨ë“  ë©”íŠ¸ë¦­ ì´ˆê¸°í™” í•¨ìˆ˜
function resetAllMetrics() {
  console.log('[UI] ğŸ”„ ëª¨ë“  ë©”íŠ¸ë¦­ ì´ˆê¸°í™” ì‹œì‘');
  
  // DOM ìš”ì†Œë“¤ ì´ˆê¸°í™”
  const elements = {
    posture: document.getElementById('posture-score'),
    gaze: document.getElementById('gaze-score'),
    concentration: document.getElementById('concentration-score'),
    blink: document.getElementById('blinking-score'),
    expression: document.getElementById('expression-score'),
    total: document.getElementById('total-score')
  };
  
  // ì ìˆ˜ ì´ˆê¸°í™”
  Object.values(elements).forEach(element => {
    if (element) {
      element.textContent = '0%';
      element.style.color = '#6b7280'; // íšŒìƒ‰ìœ¼ë¡œ ë³€ê²½
    }
  });
  
  // ìƒíƒœ í‘œì‹œ ì´ˆê¸°í™”
  const statusElements = {
    expression: document.getElementById('expression-status'),
    gaze: document.getElementById('gaze-status'),
    concentration: document.getElementById('concentration-status'),
    posture: document.getElementById('posture-status'),
    blinking: document.getElementById('blinking-status')
  };
  
  Object.values(statusElements).forEach(element => {
    if (element) {
      element.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
      element.style.color = '#6b7280';
    }
  });
  
  // ì „ì—­ ë°ì´í„° ì´ˆê¸°í™” (now managed by popup-manager.js)
  if (window.PopupManager) {
      window.PopupManager.currentExpressionData = null;
      window.PopupManager.currentGazeData = null;
      window.PopupManager.currentConcentrationData = null;
      window.PopupManager.currentPostureData = null;
      window.PopupManager.currentBlinkingData = null;
  }
  
  // í‘œì • ë¶„ì„ ë°ì´í„° ì´ˆê¸°í™” (ì´ˆê¸°ì—ëŠ” ì ìˆ˜ ë¯¸í‘œì‹œ)
  lastExpressionScore = null;
  lastExpressionText = '-';
  lastExpressionUpdate = 0;
  
  // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸° ì´ˆê¸°í™”
  if (window.ComprehensiveScoreCalculator) {
      window.ComprehensiveScoreCalculator.resetAllScores();
  }
  
  // ëŒ€í™” ì£¼ë„ê¶Œ ë¶„ì„ê¸° ì´ˆê¸°í™”
  if (window.ConversationAnalyzer) {
      window.ConversationAnalyzer.chatHistory = [];
      window.ConversationAnalyzer.analyzeConversation();
  }
  
  console.log('[UI] âœ… ëª¨ë“  ë©”íŠ¸ë¦­ ì´ˆê¸°í™” ì™„ë£Œ');
}

function updateCameraMetrics(metrics) {
  // ìŠ¤ë¡œí‹€ë§: 500msë§ˆë‹¤ í•œ ë²ˆì”©ë§Œ ì—…ë°ì´íŠ¸
  const now = Date.now();
  if (window.__lastUIUpdate__ && (now - window.__lastUIUpdate__) < 500) {
    return; // ë„ˆë¬´ ë¹ ë¥¸ ì—…ë°ì´íŠ¸ ë°©ì§€
  }
  window.__lastUIUpdate__ = now;
  
  // ì¹´ë©”ë¼ ì—°ê²° ìƒíƒœ í™•ì¸
  const isCameraConnected = metrics && Object.keys(metrics).length > 0;
  if (!isCameraConnected) {
    console.log('[UI] âš ï¸ ì¹´ë©”ë¼ ë°ì´í„° ì—†ìŒ - UI ì´ˆê¸°í™”');
    resetAllMetrics();
    return;
  }
  
  // metrics: {scores:{attention, stability, blink, posture}, labels:{expression}}
      const isWorkerMode = metrics?._isWorkerMode || false;
    const isMediaPipeDirect = metrics?._source === 'mediapipe-direct';
    const dataSource = isMediaPipeDirect ? 'MEDIAPIPE' : (isWorkerMode ? 'WORKER' : 'HTTP');
  console.log(`[UI] ğŸ–¥ï¸ updateCameraMetrics í˜¸ì¶œë¨ (${dataSource}):`, {
    hasNeckAnalysis: !!metrics?.neckAnalysis,
    hasShoulderAnalysis: !!metrics?.shoulderAnalysis,
    hasGazeAnalysis: !!metrics?.gazeAnalysis,
    ear: metrics?.ear,
    smileIntensity: metrics?.smileIntensity,
    neckScore: metrics?.neckAnalysis?.postureScore,
    shoulderScore: metrics?.shoulderAnalysis?.shoulderPostureScore,
    gazeScore: metrics?.gazeAnalysis?.stabilityScore,
    timestamp: new Date().toISOString()
  });
  
      try {
      // DOM ìš”ì†Œ ì¡´ì¬ í™•ì¸
      const postureElement = document.getElementById('posture-score');
      const gazeElement = document.getElementById('gaze-score');
      const concentrationElement = document.getElementById('concentration-score');
      const blinkElement = document.getElementById('blinking-score');
      const expressionElement = document.getElementById('expression-score');
      
      console.log('[UI] ğŸ” DOM ìš”ì†Œ í™•ì¸:', {
        postureElement: !!postureElement,
        gazeElement: !!gazeElement,
        concentrationElement: !!concentrationElement,
        blinkElement: !!blinkElement,
        expressionElement: !!expressionElement
      });
      
      if (!postureElement || !gazeElement || !concentrationElement || !blinkElement || !expressionElement) {
        console.warn('[UI] âš ï¸ í•„ìš”í•œ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
    
    // ì–¼êµ´ ì¸ì‹ ìƒíƒœ í™•ì¸ (ì™„í™”)
    const cameraBlocked = metrics?.coaching_message === 'ì¹´ë©”ë¼ê°€ ë³´ì´ì§€ ì•Šì•„ì„œ í”¼ë“œë°±ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    const noFace = metrics?.status === 'no-face';
    const isFaceDetected = !(cameraBlocked || noFace);
    
    console.log('[UI] ğŸ‘¤ ì–¼êµ´ ì¸ì‹ ìƒíƒœ:', {
      cameraBlocked,
      noFace,
      isFaceDetected,
      coaching_message: metrics?.coaching_message,
      status: metrics?.status
    });
    
    if (!isFaceDetected) {
      console.log('[UI] âš ï¸ ì–¼êµ´ì´ ê°ì§€ë˜ì§€ ì•ŠìŒ - UI ì´ˆê¸°í™”');
      postureElement.textContent = '-';
      gazeElement.textContent = '-';
      concentrationElement.textContent = '-';
      blinkElement.textContent = '-';
      expressionElement.textContent = '-';
      
      // ì¹´ë©”ë¼ ìœ„ì¹˜/ì •ë³´ ë¶€ì¡± ê²½ê³  í‘œì‹œ
      showCameraWarningInline();
      
      // ìƒíƒœ í‘œì‹œë„ ì´ˆê¸°í™”
      const expressionStatusElement = document.getElementById('expression-status');
      const gazeStatusElement = document.getElementById('gaze-status');
      const concentrationStatusElement = document.getElementById('concentration-status');
      
      if (expressionStatusElement) {
        expressionStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        expressionStatusElement.style.color = '#6b7280';
      }
      if (gazeStatusElement) {
        gazeStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        gazeStatusElement.style.color = '#6b7280';
      }
      if (concentrationStatusElement) {
        concentrationStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        concentrationStatusElement.style.color = '#6b7280';
      }
      
      // ì „ì—­ ë°ì´í„°ë„ ì´ˆê¸°í™”
      currentExpressionData = null;
      currentGazeData = null;
      currentConcentrationData = null;
      
      // í‘œì • ë¶„ì„ ë°ì´í„° ì´ˆê¸°í™”
      lastExpressionScore = null;
      lastExpressionText = '-';
      lastExpressionUpdate = 0;
      
      return;
    } else {
      // ì–¼êµ´ì´ ê°ì§€ë˜ë©´ ì¹´ë©”ë¼ ê²½ê³  ìˆ¨ê¸°ê¸°
      hideCameraWarningInline();
    }
    
    // ìì„¸ ì ìˆ˜ (ì´ˆê¸°ì—ëŠ” ì ìˆ˜ ë¯¸í‘œì‹œ)
    let postureScore = null;
    
    // í†µì¼ëœ ë¶„ì„ ë°ì´í„° êµ¬ì¡° ì²˜ë¦¬
    if (metrics?.neckAnalysis && metrics?.shoulderAnalysis) {
        console.log('[UI] ë¶„ì„ ë°ì´í„° ë°œê²¬:', {
            neckAnalysis: metrics.neckAnalysis,
            shoulderAnalysis: metrics.shoulderAnalysis
        });
        
        const neckScore = metrics.neckAnalysis.postureScore || 0;
        const shoulderScore = metrics.shoulderAnalysis.shoulderPostureScore || 0;
        const shoulderTilt = Math.abs(metrics.shoulderAnalysis.shoulderTilt || 0);
        const forwardHeadRatio = metrics.neckAnalysis.forwardHeadRatio || 0.05;
        
        // í†µì¼ëœ ìì„¸ ì ìˆ˜ ê³„ì‚° ë¡œì§ (ê¸°ë³¸ ì ìˆ˜ 70ì ë¶€í„° ì‹œì‘)
        postureScore = 70; // ê¸°ë³¸ ì ìˆ˜ ì„¤ì •
        
        // ì–´ê¹¨ ê¸°ìš¸ê¸° í˜ë„í‹°
        if (shoulderTilt > 20) postureScore -= 8;
        else if (shoulderTilt > 8) postureScore -= 4;
        else postureScore += 8;
        
        // ê±°ë¶ëª© í˜ë„í‹°
        if (forwardHeadRatio > 0.08) postureScore -= 8;
        else if (forwardHeadRatio > 0.035) postureScore -= 4;
        else postureScore += 8;
        
        // ëª©ìì„¸ ë³´ë„ˆìŠ¤/í˜ë„í‹°
        if (neckScore > 70) postureScore += 5;
        else if (neckScore < 40) postureScore -= 3;
        
        // ì–´ê¹¨ìì„¸ ë³´ë„ˆìŠ¤/í˜ë„í‹°
        if (shoulderScore > 70) postureScore += 3;
        else if (shoulderScore < 40) postureScore -= 2;
        
        // ì •ë©´ ìì„¸ ë³´ë„ˆìŠ¤
        if (shoulderTilt <= 8 && forwardHeadRatio <= 0.035) postureScore += 15;
        else if (shoulderTilt <= 12 && forwardHeadRatio <= 0.05) postureScore += 10;
        else if (shoulderTilt <= 15 && forwardHeadRatio <= 0.06) postureScore += 5;
        
        console.log('[UI] ìì„¸ ì ìˆ˜ ê³„ì‚°:', { neckScore, shoulderScore, shoulderTilt, forwardHeadRatio, postureScore });
    } else if (metrics?.neckScore !== undefined && metrics?.shoulderScore !== undefined) {
        // ì›Œì»¤ ë°ì´í„° êµ¬ì¡° (ì§ì ‘ ì ìˆ˜)
        const neckScore = metrics.neckScore || 0;
        const shoulderScore = metrics.shoulderScore || 0;
        postureScore = Math.round((neckScore + shoulderScore) / 2);
        console.log('[UI] ì›Œì»¤ ë°ì´í„° ìì„¸ ì ìˆ˜ ê³„ì‚°:', { neckScore, shoulderScore, postureScore });
    } else if (metrics?.neckAnalysis) {
        postureScore = metrics.neckAnalysis.postureScore ?? null;
        console.log('[UI] ëª© ë¶„ì„ë§Œ ì‚¬ìš©:', postureScore);
    } else if (metrics?.scores?.posture != null) {
        postureScore = Math.round(metrics.scores.posture);
        console.log('[UI] scores.posture ì‚¬ìš©:', postureScore);
    } else {
        postureScore = null;
        console.log('[UI] ë¶„ì„ ë°ì´í„° ì—†ìŒ, ì ìˆ˜ ë¯¸í‘œì‹œ');
    }
    
    if (postureScore == null) {
      postureElement.textContent = '-';
    } else {
      postureScore = Math.min(100, Math.max(0, Math.round(postureScore)));
      postureElement.textContent = `${postureScore}%`;
    }
    
    // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ìì„¸ ì ìˆ˜ ì—…ë°ì´íŠ¸
    if (window.ComprehensiveScoreCalculator && postureScore != null) {
      window.ComprehensiveScoreCalculator.updateVisualScore('posture', postureScore);
    }
    
    // ìì„¸ ë¶„ì„ ë°ì´í„° ì €ì¥ (íŒì—…ìš©)
    if (metrics?.neckAnalysis || metrics?.shoulderAnalysis) {
      currentPostureData = {
        neckAnalysis: metrics.neckAnalysis,
        shoulderAnalysis: metrics.shoulderAnalysis,
        score: postureScore,
        timestamp: Date.now()
      };
      console.log('[UI] ìì„¸ ë°ì´í„° ì €ì¥:', currentPostureData);
    } else {
      console.warn('[UI] âš ï¸ ìì„¸ ë¶„ì„ ë°ì´í„° ì—†ìŒ:', { 
        hasNeckAnalysis: !!metrics?.neckAnalysis,
        hasShoulderAnalysis: !!metrics?.shoulderAnalysis 
      });
    }
    
    // ìì„¸ ë¶„ì„ ìƒíƒœ ì—…ë°ì´íŠ¸
    const postureStatusElement = document.getElementById('posture-status');
    if (postureStatusElement) {
      if (postureScore >= 80) {
        postureStatusElement.textContent = 'ìš°ìˆ˜';
        postureStatusElement.style.color = '#10b981';
      } else if (postureScore >= 60) {
        postureStatusElement.textContent = 'ì–‘í˜¸';
        postureStatusElement.style.color = '#3b82f6';
      } else if (postureScore >= 40) {
        postureStatusElement.textContent = 'ë³´í†µ';
        postureStatusElement.style.color = '#f59e0b';
      } else {
        postureStatusElement.textContent = 'ê°œì„  í•„ìš”';
        postureStatusElement.style.color = '#ef4444';
      }
    }
    
    console.log(`[UI] ğŸ’ª ìì„¸ ì ìˆ˜ ì—…ë°ì´íŠ¸ (${dataSource}):`, { 
      rawScore: postureScore, 
      isWorkerMode,
      timestamp: new Date().toISOString()
    });
    
    if (metrics?.gazeAnalysis) {
      const stabilityScore = metrics.gazeAnalysis.stabilityScore;
      if (stabilityScore != null) {
        gazeElement.textContent = `${stabilityScore}%`;
        
        // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ì‹œì„  ì•ˆì •ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸
        if (window.ComprehensiveScoreCalculator) {
          window.ComprehensiveScoreCalculator.updateVisualScore('gaze_stability', stabilityScore);
        }
      } else {
        gazeElement.textContent = '-';
      }
    } else if (metrics?.scores?.stability != null) {
      const stabilityScore = Math.round(metrics.scores.stability);
      gazeElement.textContent = `${stabilityScore}%`;
      
      // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ì‹œì„  ì•ˆì •ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸
      if (window.ComprehensiveScoreCalculator) {
        window.ComprehensiveScoreCalculator.updateVisualScore('gaze_stability', stabilityScore);
      }
    } else {
      gazeElement.textContent = '-';
    }
    
    // ì§‘ì¤‘ë„ ì ìˆ˜ (í†µì¼ëœ ë°ì´í„° êµ¬ì¡° ì²˜ë¦¬)
    let concentrationScore = null; // ê¸°ë³¸ê°’ ì œê±°
    
    if (metrics?.gazeAnalysis) {
      // í†µì¼ëœ ë¶„ì„ ë°ì´í„° êµ¬ì¡°
      const stabilityScore = metrics.gazeAnalysis.stabilityScore || null;
      const isFocused = metrics.gazeAnalysis.isFocused || false;
      const gazeDirection = metrics.gazeAnalysis.gazeDirection || 'center';
      const jumpDistance = metrics.gazeAnalysis.jumpDistance || 0.03;
      const velocity = metrics.gazeAnalysis.velocity || 0.02;
      
      // MediaPipe ì§‘ì¤‘ë„ ì ìˆ˜ ê³„ì‚° ë¡œì§ (ë” ê´€ëŒ€í•œ ê¸°ì¤€)
      concentrationScore = 70; // ê¸°ë³¸ê°’ì„ ë†’ì„
      
      // ì í”„ ê±°ë¦¬ í˜ë„í‹° (ë” ê´€ëŒ€í•œ ê¸°ì¤€)
      if (jumpDistance > 0.15) concentrationScore -= 30;
      else if (jumpDistance > 0.12) concentrationScore -= 20;
      else if (jumpDistance > 0.08) concentrationScore -= 15;
      else if (jumpDistance > 0.05) concentrationScore -= 10;
      else concentrationScore += 10; // ì¢‹ì€ ì í”„ ê±°ë¦¬ ë³´ë„ˆìŠ¤
      
      // ì†ë„ í˜ë„í‹° (ë” ê´€ëŒ€í•œ ê¸°ì¤€)
      if (velocity > 0.1) concentrationScore -= 20;
      else if (velocity > 0.08) concentrationScore -= 15;
      else if (velocity > 0.05) concentrationScore -= 10;
      else concentrationScore += 5; // ì¢‹ì€ ì†ë„ ë³´ë„ˆìŠ¤
      
      // ì‹œì„  ë°©í–¥ ë³´ë„ˆìŠ¤/í˜ë„í‹°
      if (gazeDirection === 'center') concentrationScore += 15;
      else if (gazeDirection === 'mid') concentrationScore += 5;
      else concentrationScore -= 10;
      
      // ì§‘ì¤‘ ìƒíƒœ ë³´ë„ˆìŠ¤
      if (isFocused) concentrationScore += 10;
      
      // ì•ˆì •ì„± ì ìˆ˜ê°€ ìˆìœ¼ë©´ í‰ê·  ê³„ì‚°, ì—†ìœ¼ë©´ ê³„ì‚°ëœ ì ìˆ˜ë§Œ ì‚¬ìš©
      if (stabilityScore != null) {
        concentrationScore = Math.round((concentrationScore + stabilityScore) / 2);
      } else {
        concentrationScore = Math.round(concentrationScore);
      }
      
      console.log('[UI] MediaPipe ì§‘ì¤‘ë„ ì ìˆ˜ ê³„ì‚°:', { stabilityScore, isFocused, gazeDirection, jumpDistance, velocity, concentrationScore });
    } else if (metrics?.gazeScore !== undefined) {
      // ì›Œì»¤ ë°ì´í„° êµ¬ì¡° (ì§ì ‘ ì ìˆ˜)
      concentrationScore = metrics.gazeScore;
      
      console.log('[UI] ì›Œì»¤ ë°ì´í„° ì§‘ì¤‘ë„ ì ìˆ˜ ê³„ì‚°:', { gazeScore: metrics.gazeScore, concentrationScore });
    } else if (metrics?.scores?.attention != null) {
      concentrationScore = Math.round(metrics.scores.attention);
    }
    
    if (concentrationScore != null) {
      concentrationScore = Math.min(100, Math.max(0, Math.round(concentrationScore)));
      concentrationElement.textContent = `${concentrationScore}%`;
      updateScoreColor(concentrationElement, concentrationScore);
    } else {
      concentrationElement.textContent = '-';
    }
    
    // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ì§‘ì¤‘ë„ ì ìˆ˜ ì—…ë°ì´íŠ¸
    if (window.ComprehensiveScoreCalculator && concentrationScore != null) {
      window.ComprehensiveScoreCalculator.updateAuditoryScore('concentration', concentrationScore);
    }
    
    // ì§‘ì¤‘ë„ ë¶„ì„ ë°ì´í„° ì €ì¥ (íŒì—…ìš©)
    if (metrics?.gazeAnalysis) {
      currentConcentrationData = {
        ...metrics.gazeAnalysis,
        score: concentrationScore,
        timestamp: Date.now()
      };
      console.log('[UI] ì§‘ì¤‘ë„ ë°ì´í„° ì €ì¥:', currentConcentrationData);
    } else {
      console.warn('[UI] âš ï¸ ì§‘ì¤‘ë„ ë¶„ì„ ë°ì´í„°(gazeAnalysis) ì—†ìŒ:', metrics);
    }
    
    // ì§‘ì¤‘ë„ ë¶„ì„ ìƒíƒœ ì—…ë°ì´íŠ¸
    const concentrationStatusElement = document.getElementById('concentration-status');
    if (concentrationStatusElement) {
      if (metrics?.gazeAnalysis && concentrationScore != null) {
        const isFocused = metrics.gazeAnalysis.isFocused;
        concentrationStatusElement.textContent = isFocused ? 'ì§‘ì¤‘ ì¤‘' : 'ë¶„ì‚°ë¨';
        concentrationStatusElement.style.color = isFocused ? '#10b981' : '#f59e0b';
      } else {
        concentrationStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        concentrationStatusElement.style.color = '#6b7280';
      }
    }
    
    console.log(`[UI] ì§‘ì¤‘ë„ ì ìˆ˜ ì—…ë°ì´íŠ¸ (${dataSource}):`, concentrationScore);
    
    // ì‹œì„  ì•ˆì •ì„± ì ìˆ˜ (ì›Œì»¤ ë°ì´í„°ì™€ HTTP ë¶„ì„ ë°ì´í„° ëª¨ë‘ ì§€ì›)
    let gazeScore = null; // ê¸°ë³¸ê°’ ì œê±°
    
    if (metrics?.gazeAnalysis) {
      // HTTP ë¶„ì„ ë°ì´í„° êµ¬ì¡°
      const stabilityScore = metrics.gazeAnalysis.stabilityScore || null;
      const jumpDistance = metrics.gazeAnalysis.jumpDistance || 0.03;
      const velocity = metrics.gazeAnalysis.velocity || 0.02;
      
      // ê¸°ì¡´ ê¸°ì¤€: ì í”„ ê±°ë¦¬ 40%, ì†ë„ 30%, í™ì±„ ì†ë„ 20%, í™ì±„ ë¶€ë“œëŸ¬ì›€ 10%
      let jumpScore = 100;
      if (jumpDistance > 0.10) jumpScore = 0;
      else if (jumpDistance > 0.08) jumpScore = 30;
      else if (jumpDistance > 0.06) jumpScore = 60;
      else if (jumpDistance > 0.04) jumpScore = 80;
      else if (jumpDistance > 0.02) jumpScore = 90;
      
      let velocityScore = 100;
      if (velocity > 0.08) velocityScore = 0;
      else if (velocity > 0.06) velocityScore = 40;
      else if (velocity > 0.04) velocityScore = 70;
      else if (velocity > 0.02) velocityScore = 90;
      
      // ê°€ì¤‘ í‰ê·  ê³„ì‚°
      gazeScore = (jumpScore * 0.4) + (velocityScore * 0.3) + (stabilityScore * 0.3);
      
      console.log('[UI] HTTP ë¶„ì„ ì‹œì„  ì•ˆì •ì„± ì ìˆ˜ ê³„ì‚°:', { stabilityScore, jumpDistance, velocity, gazeScore });
    } else if (metrics?.gazeScore !== undefined) {
      // ì›Œì»¤ ë°ì´í„° êµ¬ì¡° (ì§ì ‘ ì ìˆ˜)
      gazeScore = metrics.gazeScore;
      
      console.log('[UI] ì›Œì»¤ ë°ì´í„° ì‹œì„  ì•ˆì •ì„± ì ìˆ˜ ê³„ì‚°:', { gazeScore: metrics.gazeScore });
    } else if (metrics?.scores?.stability != null) {
      gazeScore = Math.round(metrics.scores.stability);
    }
    
    if (gazeScore != null) {
      gazeScore = Math.min(100, Math.max(0, Math.round(gazeScore)));
      gazeElement.textContent = `${gazeScore}%`;
      updateScoreColor(gazeElement, gazeScore);
    } else {
      gazeElement.textContent = '-';
    }
    
    // ì‹œì„  ë¶„ì„ ë°ì´í„° ì €ì¥ (íŒì—…ìš©)
    if (metrics?.gazeAnalysis) {
      currentGazeData = {
        ...metrics.gazeAnalysis,
        score: gazeScore,
        timestamp: Date.now()
      };
      console.log('[UI] ì‹œì„  ì•ˆì •ì„± ë°ì´í„° ì €ì¥:', currentGazeData);
    } else {
      console.warn('[UI] âš ï¸ ì‹œì„  ì•ˆì •ì„± ë°ì´í„°(gazeAnalysis) ì—†ìŒ:', metrics);
    }
    
    // ì‹œì„  ë¶„ì„ ìƒíƒœ ì—…ë°ì´íŠ¸
    const gazeStatusElement = document.getElementById('gaze-status');
    if (gazeStatusElement) {
      if (metrics?.gazeAnalysis && gazeScore != null) {
        const isFocused = metrics.gazeAnalysis.isFocused;
        gazeStatusElement.textContent = isFocused ? 'ì§‘ì¤‘ ì¤‘' : 'ë¶„ì‚°ë¨';
        gazeStatusElement.style.color = isFocused ? '#10b981' : '#f59e0b';
      } else {
        gazeStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        gazeStatusElement.style.color = '#6b7280';
      }
    }
    
    console.log(`[UI] ì‹œì„  ì•ˆì •ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸ (${dataSource}):`, gazeScore);
    
    // ê¹œë¹¡ì„ ì ìˆ˜ (MediaPipe earResult ê¸°ë°˜)
    let blinkScore = null; // ê¸°ë³¸ê°’ ì œê±°
    
    if (metrics?.earResult?.blinkStatus) {
      // MediaPipeì—ì„œ ë°›ì€ blinkStatus ì‚¬ìš©
      const blinkStatus = metrics.earResult.blinkStatus;
      
      if (blinkStatus === 'closed') {
        blinkScore = 0; // ëˆˆì„ ê°ê³  ìˆìŒ
      } else if (blinkStatus === 'blinking') {
        blinkScore = 60; // ê¹œë¹¡ì´ëŠ” ì¤‘
      } else if (blinkStatus === 'open') {
        blinkScore = 100; // ëˆˆì„ ëœ¨ê³  ìˆìŒ
      }
      
      console.log('[UI] MediaPipe ê¹œë¹¡ì„ ìƒíƒœ:', { blinkStatus, blinkScore });
    } else if (metrics?.ear !== undefined) {
      // ê°œì¸ë³„ ê¸°ì¤€ EAR ì‚¬ìš© (ì›Œì»¤ì—ì„œ ê³„ì‚°ëœ ê°’)
      const ear = metrics.ear;
      const personalBaseEAR = metrics.personalBaseEAR || 0.22; // ê°œì¸ë³„ ê¸°ì¤€
      
      // ê°œì¸ ê¸°ì¤€ ëŒ€ë¹„ ì°¨ì´ ê³„ì‚° (ë¹„ìœ¨ë¡œ ê³„ì‚°)
      const earRatio = ear / personalBaseEAR;
      
      // ë¹„ìœ¨ ê¸°ë°˜ ì ìˆ˜ ê³„ì‚° (ë” ì •í™•í•œ ê°œì¸ë³„ í‰ê°€)
      if (earRatio < 0.7) blinkScore = 0;      // ê¸°ì¤€ì˜ 70% ë¯¸ë§Œ (ë§¤ìš° ë‚˜ì¨)
      else if (earRatio < 0.8) blinkScore = 30; // ê¸°ì¤€ì˜ 80% ë¯¸ë§Œ (ë‚˜ì¨)
      else if (earRatio < 0.9) blinkScore = 60; // ê¸°ì¤€ì˜ 90% ë¯¸ë§Œ (ë³´í†µ)
      else if (earRatio < 1.1) blinkScore = 100; // ê¸°ì¤€ì˜ 90-110% (ì¢‹ìŒ)
      else if (earRatio < 1.2) blinkScore = 80;  // ê¸°ì¤€ì˜ 110-120% (ì•½ê°„ ë‚˜ì¨)
      else blinkScore = 60;                       // ê¸°ì¤€ì˜ 120% ì´ìƒ (ë‚˜ì¨)
    } else if (metrics?.blinkRate !== undefined) {
      // ë¶„ë‹¹ ê¹œë¹¡ì„ ìˆ˜ ê¸°ë°˜ (ê¸°ì¡´ ê¸°ì¤€: 6~35íšŒ/ë¶„ ì •ìƒ)
      if (metrics.blinkRate < 4) blinkScore = 30;
      else if (metrics.blinkRate < 6) blinkScore = 70;
      else if (metrics.blinkRate >= 6 && metrics.blinkRate <= 35) blinkScore = 100;
      else if (metrics.blinkRate <= 40) blinkScore = 70;
      else blinkScore = 55;
    } else if (metrics?.scores?.blink != null) {
      blinkScore = Math.round(metrics.scores.blink);
    } else {
      // ë¶„ì„ ë°ì´í„°ê°€ ì—†ì„ ë•Œ nullë¡œ ì„¤ì •
      blinkScore = null;
      console.log('[UI] ê¹œë¹¡ì„ ë¶„ì„ ë°ì´í„° ì—†ìŒ, ì ìˆ˜ ë¯¸í‘œì‹œ');
    }
    
    if (blinkScore != null) {
      blinkScore = Math.min(100, Math.max(0, Math.round(blinkScore)));
      blinkElement.textContent = `${blinkScore}%`;
      updateScoreColor(blinkElement, blinkScore);
    } else {
      blinkElement.textContent = '-';
    }
    
    // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ê¹œë¹¡ì„ ì ìˆ˜ ì—…ë°ì´íŠ¸
    if (window.ComprehensiveScoreCalculator && blinkScore != null) {
      window.ComprehensiveScoreCalculator.updateVisualScore('blinking', blinkScore);
    }
    
    // ê¹œë¹¡ì„ ë¶„ì„ ë°ì´í„° ì €ì¥ (íŒì—…ìš©)
    if (metrics?.earResult) {
      currentBlinkingData = {
        earResult: metrics.earResult,
        score: blinkScore,
        timestamp: Date.now()
      };
      console.log('[UI] ê¹œë¹¡ì„ ë°ì´í„° ì €ì¥:', currentBlinkingData);
    } else {
      console.warn('[UI] âš ï¸ earResult ë°ì´í„° ì—†ìŒ:', metrics);
    }
    
    // ê¹œë¹¡ì„ ë¶„ì„ ìƒíƒœ ì—…ë°ì´íŠ¸
    const blinkingStatusElement = document.getElementById('blinking-status');
    if (blinkingStatusElement) {
      if (metrics?.earResult?.blinkStatus && blinkScore != null) {
        const blinkStatus = metrics.earResult.blinkStatus;
        if (blinkStatus === 'open') {
          blinkingStatusElement.textContent = 'ëˆˆ ëœ¸';
          blinkingStatusElement.style.color = '#10b981';
        } else if (blinkStatus === 'blinking') {
          blinkingStatusElement.textContent = 'ê¹œë¹¡ì„';
          blinkingStatusElement.style.color = '#f59e0b';
        } else if (blinkStatus === 'closed') {
          blinkingStatusElement.textContent = 'ëˆˆ ê°ìŒ';
          blinkingStatusElement.style.color = '#ef4444';
        }
      } else {
        blinkingStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        blinkingStatusElement.style.color = '#6b7280';
      }
    }
    
    console.log(`[UI] ê¹œë¹¡ì„ ì ìˆ˜ ì—…ë°ì´íŠ¸ (${dataSource}):`, blinkScore);
    
    // í‘œì • ë¶„ì„ ê²°ê³¼ ì²˜ë¦¬ (PyTorch ëª¨ë¸ ê¸°ë°˜)
    let expressionScore = lastExpressionScore; // ì´ì „ ê°’ ìœ ì§€
    let expressionText = lastExpressionText; // ì´ì „ ê°’ ìœ ì§€
    const currentTime = Date.now();
    
    if (metrics?.expressionAnalysis?.success) {
      // PyTorch ëª¨ë¸ ë¶„ì„ ê²°ê³¼ ì‚¬ìš©
      const expressionResult = metrics.expressionAnalysis;
      const scoreResult = expressionResult.score;
      
      if (scoreResult && typeof scoreResult.score === 'number') {
        // 2ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜ ì‹ ë¢°ë„ê°€ ë†’ì„ ë•Œë§Œ ì—…ë°ì´íŠ¸
        if (currentTime - lastExpressionUpdate > EXPRESSION_UPDATE_INTERVAL || 
            expressionResult.confidence > 0.6) {
          expressionScore = scoreResult.score;
          expressionText = scoreResult.label || 'ì¤‘ë¦½ì ';
          lastExpressionScore = expressionScore;
          lastExpressionText = expressionText;
          lastExpressionUpdate = currentTime;
        }
        
        // í‘œì • ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (íŒì—…ìš©)
        currentExpressionData = {
          expression: expressionResult.expression,
          confidence: expressionResult.confidence,
          probabilities: expressionResult.probabilities,
          score: scoreResult,
          timestamp: Date.now()
        };
        console.log('[UI] í‘œì • ë°ì´í„° ì €ì¥:', currentExpressionData);
        
        console.log('[UI] ğŸ­ PyTorch í‘œì • ë¶„ì„ ê²°ê³¼:', {
          expression: expressionResult.expression,
          confidence: expressionResult.confidence,
          score: expressionScore,
          label: expressionText,
          base_score: scoreResult.base_score,
          confidence_bonus: scoreResult.confidence_bonus
        });
      }
    } else if (metrics?.smileIntensity !== undefined) {
      // ê¸°ì¡´ MediaPipe ë¯¸ì†Œ ë¶„ì„ ì‚¬ìš© (ë°±ì—…)
      const smileIntensity = metrics.smileIntensity;
      const personalBaseSmile = metrics.personalBaseSmile || 30;
      
      // ê°œì¸ë³„ ê¸°ì¤€ ëŒ€ë¹„ ìƒëŒ€ì  í‰ê°€
      const smileRatio = smileIntensity / personalBaseSmile;
      
      // ì ìˆ˜ ê³„ì‚°
      if (smileRatio > 1.3) {
        expressionScore = 90;
        expressionText = 'ë§¤ìš° ë”°ëœ»í•¨';
      } else if (smileRatio > 1.1) {
        expressionScore = 80;
        expressionText = 'ë”°ëœ»í•¨';
      } else if (smileRatio > 0.9) {
        expressionScore = 70;
        expressionText = 'ê¸ì •ì ';
      } else if (smileRatio > 0.7) {
        expressionScore = 60;
        expressionText = 'ì¤‘ë¦½ì ';
      } else {
        expressionScore = 40;
        expressionText = 'ê°œì„  í•„ìš”';
      }
      
      console.log('[UI] MediaPipe ë¯¸ì†Œ ë¶„ì„ ê²°ê³¼:', {
        smileIntensity,
        smileRatio,
        expressionScore,
        expressionText
      });
    } else if (metrics?.labels?.expression) {
      expressionText = metrics.labels.expression;
      expressionScore = 60; // ê¸°ë³¸ê°’
    }
    
    // í‘œì • ì ìˆ˜ ì—…ë°ì´íŠ¸
    const expressionScoreElement = document.getElementById('expression-score');
    if (expressionScoreElement) {
      expressionScoreElement.textContent = `${expressionScore}%`;
      updateScoreColor(expressionScoreElement, expressionScore);
      
      // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— í‘œì • ì ìˆ˜ ì—…ë°ì´íŠ¸
      if (window.ComprehensiveScoreCalculator) {
        window.ComprehensiveScoreCalculator.updateVisualScore('expression', expressionScore);
      }
    }
    
    // í‘œì • ë¶„ì„ ìƒíƒœ ì—…ë°ì´íŠ¸ (í‰ê°€ ë¼ë²¨ í‘œì‹œ)
    const expressionStatusElement = document.getElementById('expression-status');
    if (expressionStatusElement) {
      if (metrics?.expressionAnalysis?.success) {
        const scoreResult = metrics.expressionAnalysis.score;
        if (scoreResult && scoreResult.label) {
          expressionStatusElement.textContent = scoreResult.label;
          // ë¼ë²¨ì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
          if (scoreResult.label.includes('ê¸ì •ì ')) {
            expressionStatusElement.style.color = '#10b981'; // ì´ˆë¡ìƒ‰
          } else if (scoreResult.label.includes('ì¤‘ë¦½ì ')) {
            expressionStatusElement.style.color = '#f59e0b'; // ì£¼í™©ìƒ‰
          } else {
            expressionStatusElement.style.color = '#ef4444'; // ë¹¨ê°„ìƒ‰
          }
        } else {
          expressionStatusElement.textContent = 'ë¶„ì„ ì¤‘';
          expressionStatusElement.style.color = '#6b7280';
        }
      } else {
        expressionStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        expressionStatusElement.style.color = '#6b7280';
      }
    }
    
    console.log(`[UI] í‘œì • ì ìˆ˜ ì—…ë°ì´íŠ¸ (${dataSource}):`, { expressionScore, expressionText });
    
    // ì ìˆ˜ ìƒ‰ìƒ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ui-utils.jsë¡œ ì´ë™ë¨)
    
    // ê°œì¸í™”ëœ ê¿€íŒ ì—…ë°ì´íŠ¸
    const tips = generatePersonalizedTips(metrics);
    const tipsContainer = document.getElementById('ai-feedback-summary');
    if (tipsContainer && tips.length > 0) {
      tipsContainer.innerHTML = `
        <div style="font-weight: 700; margin-bottom: 8px; color: #1a1a1a; font-size: 14px;">ğŸ¯ ì‹¤ì‹œê°„ ê¿€íŒ!</div>
        <ol style="padding-left: 20px; margin: 0; font-size: 13px; line-height: 1.7; color: #2d2d2d; font-weight: 500;">
          ${tips.map(tip => `<li>${tip}</li>`).join('')}
        </ol>
      `;
    }
    
  } catch (e) {
    console.warn('[ANALYZER] UI update error', e);
  }
}







// mapFrameResultToMetrics í•¨ìˆ˜ (ui-utils.jsë¡œ ì´ë™ë¨)

// scheduleAnalyzerStart í•¨ìˆ˜ëŠ” js/camera-analyzer.jsì—ì„œ ì œê³µë¨

// --- AI APIëŠ” ì„œë²„ì—ì„œ ì²˜ë¦¬ë¨ (OpenAI GPT-4o-mini ì‚¬ìš©) ---

// íŒì—… ì œì–´ í•¨ìˆ˜ë“¤ (ui-utils.jsë¡œ ì´ë™ë¨)

// --- ì±„íŒ… ê´€ë ¨ ë³€ìˆ˜ ---
let chatHistory = [];
let currentSessionId = null; // MongoDB ì„¸ì…˜ ID

// í”¼ë“œë°± íŒ¨ë„ ì œì–´ í•¨ìˆ˜ (ui-utils.jsë¡œ ì´ë™ë¨)

// --- ì±„íŒ… ê¸°ëŠ¥ ---
function addPersonaCard() {
    if (!personaName) return;
    
    const personaCard = document.createElement('div');
    personaCard.className = 'persona-card';
    
    // ì„±ë³„ì— ë”°ë¥¸ í´ë˜ìŠ¤ ì¶”ê°€ (ì´ë¯¸ì§€ íŒŒì¼ëª…ìœ¼ë¡œ íŒë‹¨)
    const imageFileName = personaImage ? personaImage.split('/').pop() : '';
    if (imageFileName.includes('woman') || imageFileName.includes('female')) {
        personaCard.classList.add('female');
    } else if (imageFileName.includes('man') || imageFileName.includes('male')) {
        personaCard.classList.add('male');
    }
    
    const personalityArray = personaPersonality ? personaPersonality.split(',') : [];
    
    // ì´ë¯¸ì§€ ê²½ë¡œ ìˆ˜ì •
            const imagePath = personaImage ? `${window.serverUrl || 'https://dys-phi.vercel.app/api/gke'}/dys_studio/img/persona/${personaImage.split('/').pop()}` : '/img/default-avatar.png';
    
    personaCard.innerHTML = `
        <div class="persona-header">
            <img src="${imagePath}" alt="${personaName}" class="persona-avatar">
            <div class="persona-info">
                <h4>${personaName}</h4>
                <p>${personaAge}ì„¸ Â· ${personaJob}</p>
            </div>
        </div>
        <div class="persona-details">
            <span class="persona-tag">${personaMbti}</span>
            ${personalityArray.map(trait => `<span class="persona-tag">${trait.trim()}</span>`).join('')}
        </div>
    `;
    
    chatLog.appendChild(personaCard);
    chatLog.scrollTop = chatLog.scrollHeight;
}

function addBubble(text, role) {
    const bubble = document.createElement('div');
    bubble.className = `bubble ${role}`;
    bubble.innerHTML = text;
    chatLog.appendChild(bubble);
    chatLog.scrollTop = chatLog.scrollHeight;
}

function showTypingIndicator() {
    const typingBubble = document.createElement('div');
    typingBubble.className = 'bubble typing';
    typingBubble.innerHTML = '<span></span><span></span><span></span>';
    chatLog.appendChild(typingBubble);
    chatLog.scrollTop = chatLog.scrollHeight;
}

function removeTypingIndicator() {
    const typingBubble = chatLog.querySelector('.typing');
    if (typingBubble) chatLog.removeChild(typingBubble);
}

   async function sendMessage() {
    const text = chatInput.value.trim();
    if(!text) return;
  
    // ì¤‘ë³µ ì „ì†¡ ë°©ì§€
    if (window._sendingMessage) {
        console.log('[CHAT] ì´ë¯¸ ë©”ì‹œì§€ ì „ì†¡ ì¤‘, ì¤‘ë³µ ë°©ì§€');
        return;
    }
    window._sendingMessage = true;
  
    try {
        addBubble(text, 'me');
        chatHistory.push({ role: "user", content: text });
        
        // ëŒ€í™” ì£¼ë„ê¶Œ ë¶„ì„ ì—…ë°ì´íŠ¸
        if (window.ConversationAnalyzer) {
            window.ConversationAnalyzer.addMessage("user", text);
        }
        
        chatInput.value = '';
        chatInput.focus();
        showTypingIndicator();
      
        // ì„œë²„ APIë¡œ ë©”ì‹œì§€ ì „ì†¡ (MongoDB ì €ì¥ + AI ì‘ë‹µ ìƒì„±)
        const apiBase = (window.serverUrl && window.serverUrl.replace(/\/$/, '')) || 'https://dys-phi.vercel.app';
        const response = await fetch(`${apiBase}/api/gke/api/chat/sessions/${currentSessionId}/messages`.replace('/api/gke/api', '/api/gke'), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                content: text,
                role: 'user',
                user_id: userId,
                email: email
            })
        });

        if (response.ok) {
            const result = await response.json();
            console.log('âœ… [CHAT] ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ:', result);
            
            removeTypingIndicator();
            
            // AI ì‘ë‹µì´ ìˆìœ¼ë©´ í‘œì‹œ
            if (result.ai_response) {
                addBubble(result.ai_response, 'ai');
                chatHistory.push({ role: "assistant", content: result.ai_response });
                
                // AI ì‘ë‹µë„ ëŒ€í™” ì£¼ë„ê¶Œ ë¶„ì„ì— ì¶”ê°€
                if (window.ConversationAnalyzer) {
                    window.ConversationAnalyzer.addMessage("assistant", result.ai_response);
                }
                
                // TTSë¡œ AI ì‘ë‹µ ì½ì–´ì£¼ê¸° (ëŒ€í™” ë‚´ìš©ë§Œ ì •ë¦¬)
                if (window.ttsManager && window.ttsManager.isEnabled) {
                    setTimeout(() => {
                        speakAIResponse(result.ai_response);
                    }, 500); // 0.5ì´ˆ í›„ ìŒì„± ì¬ìƒ (ì±„íŒ… ë²„ë¸” ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„)
                }
            }
        } else {
            throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
        }
        
    } catch (error) {
        console.error('[CHAT] ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
        removeTypingIndicator();
        const errorMessage = "ì£„ì†¡í•´ìš”, ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
        addBubble(errorMessage, 'ai');
        chatHistory.push({ role: "assistant", content: errorMessage });
    } finally {
        window._sendingMessage = false;
    }
}



// í˜¸ê°ë„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ê°œì„ ëœ)
function updateLikability(score) {
    // ê¸°ì¡´ í˜¸ê°ë„ (í˜¸í™˜ì„± ìœ ì§€)
    const likabilityScore = document.getElementById('likability-score');
    const likabilityProgress = document.getElementById('likability-progress');
    
    if (likabilityScore) {
        likabilityScore.innerHTML = `${score}<span>%</span>`;
    }
    
    if (likabilityProgress) {
        const circumference = 2 * Math.PI * 54;
        const offset = circumference - (score / 100) * circumference;
        likabilityProgress.style.strokeDasharray = circumference;
        likabilityProgress.style.strokeDashoffset = offset;
    }
    
    // ìƒˆë¡œìš´ ê°œì„ ëœ í˜¸ê°ë„
    const likabilityScoreEnhanced = document.getElementById('likability-score-enhanced');
    const likabilityProgressEnhanced = document.getElementById('likability-progress-enhanced');
    const likabilityStatus = document.getElementById('likability-status');
    
    if (likabilityScoreEnhanced) {
        likabilityScoreEnhanced.innerHTML = `${score}<span class="score-unit">%</span>`;
    }
    
    if (likabilityProgressEnhanced) {
        const circumference = 314; // 2 * Math.PI * 50
        const offset = circumference - (score / 100) * circumference;
        likabilityProgressEnhanced.style.strokeDashoffset = offset;
    }
    
    if (likabilityStatus) {
        let status = '';
        if (score >= 85) status = 'ë§¤ìš° ë†’ìŒ';
        else if (score >= 70) status = 'ë†’ìŒ';
        else if (score >= 50) status = 'ë³´í†µ';
        else if (score >= 30) status = 'ë‚®ìŒ';
        else status = 'ë§¤ìš° ë‚®ìŒ';
        
        likabilityStatus.textContent = status;
    }
    
    // í˜¸ê°ë„ ìš”ì†Œ ì—…ë°ì´íŠ¸
    updateLikabilityFactors(score);
}

// í˜¸ê°ë„ êµ¬ì„± ìš”ì†Œ ì—…ë°ì´íŠ¸
function updateLikabilityFactors(totalScore) {
    // ì‹œë®¬ë ˆì´ì…˜ëœ ìš”ì†Œë³„ ì ìˆ˜ (ì‹¤ì œë¡œëŠ” ê°œë³„ ë©”íŠ¸ë¦­ì—ì„œ ê³„ì‚°)
    const expressionScore = Math.max(0, totalScore + (Math.random() - 0.5) * 20);
    const voiceScore = Math.max(0, totalScore + (Math.random() - 0.5) * 15);
    const conversationScore = Math.max(0, totalScore + (Math.random() - 0.5) * 10);
    
    const factorExpression = document.getElementById('factor-expression');
    const factorVoice = document.getElementById('factor-voice');
    const factorConversation = document.getElementById('factor-conversation');
    
    if (factorExpression) factorExpression.textContent = `${Math.round(expressionScore)}%`;
    if (factorVoice) factorVoice.textContent = `${Math.round(voiceScore)}%`;
    if (factorConversation) factorConversation.textContent = `${Math.round(conversationScore)}%`;
}

// ì „ì—­ ìŠ¤ì½”í”„ì— í•¨ìˆ˜ë“¤ ë…¸ì¶œ
window.sendMessage = sendMessage;

window.updateLikability = updateLikability;
window.updateLikabilityFactors = updateLikabilityFactors;

// getAiResponse í•¨ìˆ˜ ì œê±°ë¨ - ì„œë²„ì—ì„œ ì²˜ë¦¬


// --- ì…ë ¥ ëª¨ë“œ ê´€ë¦¬ ---
// voice-input.jsì—ì„œ í†µí•© ê´€ë¦¬í•˜ë¯€ë¡œ ì œê±°ë¨

 // ì´ˆê¸° ì•ˆë‚´ íŒì—… ë‹«ê¸° ë²„íŠ¼
 const closeGuideBtn = document.getElementById('close-guide-btn');
 if (closeGuideBtn) {
     closeGuideBtn.addEventListener('click', hideInitialGuidePopup);
 }
 
   // ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ (ë‹¨ìˆœí™”)
  chatInput.addEventListener('input', (e) => {
      // ì…ë ¥ í•„ë“œ ë³€ê²½ ê°ì§€ (í•„ìš”ì‹œ ì¶”ê°€ ë¡œì§)
  });

// ì „ì†¡ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
inputBtn.addEventListener('click', () => {
    const hasText = chatInput.value.trim().length > 0;
    if (hasText) {
        sendMessage();
    }
});

// Enter í‚¤ ì´ë²¤íŠ¸
chatInput.addEventListener('keypress', (e) => { 
    if (e.key === 'Enter') sendMessage(); 
});



// --- AI í”¼ë“œë°± ë¶„ì„ ê¸°ëŠ¥ (ìë™ ì‹¤í–‰) ---
async function runAiAnalysis() {
    const summaryDiv = document.getElementById('ai-feedback-summary');
    if (chatHistory.length < 2) {
        summaryDiv.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 8px;">ğŸ¯ ì‹¤ì‹œê°„ ê¿€íŒ!</div>
            <p style="font-size: 13px; line-height: 1.6;">AIì™€ ëŒ€í™”ë¥¼ 2íšŒ ì´ìƒ ë‚˜ëˆ„ë©´<br>ìë™ìœ¼ë¡œ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.</p>
        `;
        return;
    }

    summaryDiv.textContent = 'ë¶„ì„ ì¤‘...';
    
    try {
        // ì„œë²„ì˜ í”¼ë“œë°± ë¶„ì„ API í˜¸ì¶œ
        const response = await fetch(`${window.serverUrl || 'https://dys-phi.vercel.app/api/gke'}/api/feedback`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                chatHistory: chatHistory,
                user_id: userId,
                session_id: currentSessionId
            })
        });

        if (response.ok) {
            const feedback = await response.json();
            updateFeedbackUI(feedback);
        } else {
            throw new Error(`í”¼ë“œë°± ë¶„ì„ ì‹¤íŒ¨: ${response.status}`);
        }

    } catch (error) {
        console.error("Error analyzing conversation:", error);
        summaryDiv.textContent = "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
    }
}

function setCircleProgress(score) {
    const circle = document.getElementById('likability-progress');
    const radius = circle.r.baseVal.value;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference - (score / 100) * circumference;

    circle.style.strokeDasharray = `${circumference} ${circumference}`;
    circle.style.strokeDashoffset = offset;
    
    document.getElementById('likability-score').innerHTML = `${score}<span>%</span>`;
}

function updateFeedbackUI(feedback) {
    setCircleProgress(feedback.likability);
    
    // ëŒ€í™” ì£¼ë„ê¶Œ ì—…ë°ì´íŠ¸ (ì‹¤ì œ ë¶„ì„ ê²°ê³¼ ì‚¬ìš©)
    if (window.ConversationAnalyzer) {
        const initiativeAnalysis = window.ConversationAnalyzer.getDetailedAnalysis();
        document.getElementById('user-initiative-bar').style.width = `${initiativeAnalysis.userInitiativeScore}%`;
        document.getElementById('ai-initiative-bar').style.width = `${100 - initiativeAnalysis.userInitiativeScore}%`;
        document.getElementById('initiative-status').textContent = initiativeAnalysis.status;
        document.getElementById('initiative-status').style.color = initiativeAnalysis.color;
        
        // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ëŒ€í™” ì£¼ë„ê¶Œ ì ìˆ˜ ì—…ë°ì´íŠ¸
        if (window.ComprehensiveScoreCalculator) {
            window.ComprehensiveScoreCalculator.updateConversationScore('initiative', initiativeAnalysis.userInitiativeScore);
        }
    } else {
        // í´ë°±: ì„œë²„ í”¼ë“œë°± ì‚¬ìš©
        document.getElementById('user-initiative-bar').style.width = `${feedback.initiative}%`;
        document.getElementById('ai-initiative-bar').style.width = `${100 - feedback.initiative}%`;
        document.getElementById('initiative-status').textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        document.getElementById('initiative-status').style.color = '#6b7280';
        
        // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ëŒ€í™” ì£¼ë„ê¶Œ ì ìˆ˜ ì—…ë°ì´íŠ¸
        if (window.ComprehensiveScoreCalculator) {
            window.ComprehensiveScoreCalculator.updateConversationScore('initiative', feedback.initiative);
        }
    }
    
    document.getElementById('expression-text').textContent = feedback.expression;
    document.getElementById('tone-score').textContent = `${feedback.tone}%`;
    document.getElementById('gaze-score').textContent = `${feedback.gaze_stability}%`;
    document.getElementById('concentration-score').textContent = `${feedback.concentration}%`;
    document.getElementById('posture-score').textContent = `${feedback.posture}%`;
    document.getElementById('blinking-score').textContent = `${feedback.blinking}%`;
    
    // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ê° ì ìˆ˜ ì—…ë°ì´íŠ¸
    if (window.ComprehensiveScoreCalculator) {
        // ì‹œê°ì  ì ìˆ˜ë“¤
        window.ComprehensiveScoreCalculator.updateVisualScore('expression', feedback.expression_score || 60);
        window.ComprehensiveScoreCalculator.updateVisualScore('gaze_stability', feedback.gaze_stability);
        window.ComprehensiveScoreCalculator.updateVisualScore('posture', feedback.posture);
        window.ComprehensiveScoreCalculator.updateVisualScore('blinking', feedback.blinking);
        
        // ì²­ê°ì  ì ìˆ˜ë“¤
        window.ComprehensiveScoreCalculator.updateAuditoryScore('tone', feedback.tone);
        window.ComprehensiveScoreCalculator.updateAuditoryScore('concentration', feedback.concentration);
    }

    document.getElementById('ai-feedback-summary').textContent = feedback.summary;
}

// --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
closeBtn.addEventListener('click', toggleFeedbackPanel);

feedbackToggleBtn.addEventListener('click', () => {
    toggleFeedbackPanel();
    if (feedbackPanel.classList.contains('visible')) {
        runAiAnalysis();
    }
});

// ê¸°ì¡´ ë§ˆì´í¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ìƒˆë¡œìš´ inputBtnìœ¼ë¡œ ëŒ€ì²´ë¨)

document.querySelectorAll('.suggestion-tags .tag').forEach(tag => {
    tag.addEventListener('click', () => {
        chatInput.value = `"${tag.textContent}"ì— ëŒ€í•´ ì´ì•¼ê¸°í•´ë³¼ê¹Œìš”?`;
        chatInput.focus();
    });
});

 // --- ë¹„ë””ì˜¤ ì¬ìƒ ê´€ë¦¬ ---
 function initializeVideo() {
     const video = document.getElementById('video');
     const videoLoading = document.getElementById('video-loading');
     
     // ë¹„ë””ì˜¤ íŒŒì¼ ê²½ë¡œ ì„¤ì • (ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€)
     const timestamp = new Date().getTime();
     const videoPath = `${window.serverUrl || 'https://dys-phi.vercel.app/api/gke'}/dys_studio/video/woman1_cafe.mp4?t=${timestamp}`;
     
     console.log('ğŸ¬ [VIDEO] ë¹„ë””ì˜¤ ì´ˆê¸°í™” ì‹œì‘:', videoPath);
     
     // ë¡œë”© í™”ë©´ í‘œì‹œ
     videoLoading.classList.remove('hidden');
    
    // ë¹„ë””ì˜¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    video.addEventListener('loadstart', () => {
        console.log('ğŸ¬ [VIDEO] ë¹„ë””ì˜¤ ë¡œë”© ì‹œì‘');
    });
    
         video.addEventListener('canplay', () => {
         console.log('âœ… [VIDEO] ë¹„ë””ì˜¤ ì¬ìƒ ì¤€ë¹„ ì™„ë£Œ');
         // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
         videoLoading.classList.add('hidden');
         // ìë™ ì¬ìƒ ì‹œë„ (ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ì—ë§Œ ì„±ê³µ)
         video.play().catch(error => {
             console.log('â„¹ï¸ [VIDEO] ìë™ ì¬ìƒ ëŒ€ê¸° ì¤‘ (ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í•„ìš”)');
             // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ì‹œ ì¬ìƒ ì‹œì‘ì„ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
             const startPlayback = () => {
                 video.play().then(() => {
                     console.log('âœ… [VIDEO] ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ ì¬ìƒ ì‹œì‘');
                     // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
                     document.removeEventListener('click', startPlayback);
                     document.removeEventListener('keydown', startPlayback);
                 }).catch(err => {
                     console.error('âŒ [VIDEO] ì¬ìƒ ì‹¤íŒ¨:', err);
                 });
             };
             document.addEventListener('click', startPlayback, { once: true });
             document.addEventListener('keydown', startPlayback, { once: true });
         });
     });
     
     video.addEventListener('loadeddata', () => {
         console.log('âœ… [VIDEO] ë¹„ë””ì˜¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
     });
    
    video.addEventListener('ended', () => {
        console.log('ğŸ”„ [VIDEO] ë¹„ë””ì˜¤ ì¬ìƒ ì™„ë£Œ, ë°˜ë³µ ì¬ìƒ');
        // loop ì†ì„±ì´ ìˆì§€ë§Œ í™•ì‹¤íˆ í•˜ê¸° ìœ„í•´ ë‹¤ì‹œ ì¬ìƒ
        video.currentTime = 0;
        video.play().catch(error => {
            console.error('âŒ [VIDEO] ë°˜ë³µ ì¬ìƒ ì‹¤íŒ¨:', error);
        });
    });
    
    video.addEventListener('error', (error) => {
        console.error('âŒ [VIDEO] ë¹„ë””ì˜¤ ë¡œë”© ì˜¤ë¥˜:', error);
        console.error('âŒ [VIDEO] ë¹„ë””ì˜¤ ì˜¤ë¥˜ ì½”ë“œ:', video.error?.code);
        console.error('âŒ [VIDEO] ë¹„ë””ì˜¤ ì˜¤ë¥˜ ë©”ì‹œì§€:', video.error?.message);
        console.error('âŒ [VIDEO] ë¹„ë””ì˜¤ ì†ŒìŠ¤:', video.src);
        videoLoading.innerHTML = `
            <div style="text-align: center;">
                <p style="color: #e74c3c; margin-bottom: 8px;">ë¹„ë””ì˜¤ ë¡œë”© ì‹¤íŒ¨</p>
                <p style="color: #666; font-size: 12px; margin-bottom: 8px;">ì˜¤ë¥˜ ì½”ë“œ: ${video.error?.code || 'unknown'}</p>
                <button onclick="initializeVideo()" style="padding: 8px 16px; background: var(--brand2); color: white; border: none; border-radius: 8px; cursor: pointer;">ë‹¤ì‹œ ì‹œë„</button>
            </div>
        `;
    });
    
         // ë¹„ë””ì˜¤ ì†ŒìŠ¤ ì„¤ì • (ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€)
     const cacheBuster = new Date().getTime();
     video.src = `${videoPath}?t=${cacheBuster}`;
     video.load();
}

// --- MongoDB ì„¸ì…˜ ê´€ë¦¬ ---
async function createSession() {
    try {
        const sessionName = personaName ? `${personaName}ì™€ì˜ ë°ì´íŠ¸` : 'ìƒˆë¡œìš´ ë°ì´íŠ¸';
        const response = await fetch(`${window.serverUrl || 'https://dys-phi.vercel.app/api/gke'}/api/chat/sessions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_name: sessionName,
                user_id: userId,
                email: email,
                persona_name: personaName,
                persona_age: personaAge,
                persona_mbti: personaMbti,
                persona_job: personaJob,
                persona_personality: personaPersonality,
                persona_image: personaImage
            })
        });

        if (response.ok) {
            const result = await response.json();
            currentSessionId = result.session_id;
            console.log('âœ… [CHAT] ì„¸ì…˜ ìƒì„± ì„±ê³µ:', currentSessionId);
            return true;
        } else {
            console.error('âŒ [CHAT] ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨:', response.status);
            return false;
        }
    } catch (error) {
        console.error('âŒ [CHAT] ì„¸ì…˜ ìƒì„± ì˜¤ë¥˜:', error);
        return false;
    }
}

// saveMessageToMongoDB í•¨ìˆ˜ ì œê±°ë¨ - ì„œë²„ì—ì„œ í†µí•© ì²˜ë¦¬

   // --- ì¹´ë©”ë¼ ê²½ê³  í•¨ìˆ˜ë“¤ ---
function showCameraWarning() {
    console.log('[CAMERA] ì¹´ë©”ë¼ ê²½ê³  í‘œì‹œ');
    const warning = document.getElementById('camera-warning');
    if (warning) {
        warning.classList.remove('hidden');
    }
}

function hideCameraWarning() {
    console.log('[CAMERA] ì¹´ë©”ë¼ ê²½ê³  ìˆ¨ê¹€');
    const warning = document.getElementById('camera-warning');
    if (warning) {
        warning.classList.add('hidden');
    }
}

function showCameraToast() {
    console.log('[CAMERA] ì¹´ë©”ë¼ í† ìŠ¤íŠ¸ ê²½ê³  í‘œì‹œ');
    const toast = document.getElementById('camera-toast');
    if (toast) {
        toast.classList.remove('hidden');
    }
}

function hideCameraToast() {
    console.log('[CAMERA] ì¹´ë©”ë¼ í† ìŠ¤íŠ¸ ê²½ê³  ìˆ¨ê¹€');
    const toast = document.getElementById('camera-toast');
    if (toast) {
        toast.classList.add('hidden');
    }
}

// --- ì¹´ë©”ë¼ ìƒíƒœ í™•ì¸ í•¨ìˆ˜ ---
  async function checkCameraStatus() {
      try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          // ì¹´ë©”ë¼ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ë©´ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
          stream.getTracks().forEach(track => track.stop());
          hideCameraWarning();
          hideCameraToast();
          return true;
      } catch (err) {
          console.error("ì¹´ë©”ë¼ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:", err);
          // í† ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ (ë” ê¹”ë”í•¨)
          showCameraToast();
          return false;
      }
  }

// --- ì¹´ë©”ë¼ ë° ìŒì„± ê¶Œí•œ ìš”ì²­ í•¨ìˆ˜ ---
async function requestCameraAndAudioPermissions() {
    console.log('ğŸ¤ [PERMISSIONS] ì¹´ë©”ë¼ ë° ìŒì„± ê¶Œí•œ ìš”ì²­ ì‹œì‘');
    
    try {
        // ì¹´ë©”ë¼ì™€ ìŒì„± ê¶Œí•œì„ ë™ì‹œì— ìš”ì²­
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: true, 
            audio: true 
        });
        
        console.log('âœ… [PERMISSIONS] ì¹´ë©”ë¼ ë° ìŒì„± ê¶Œí•œ íšë“ ì„±ê³µ');
        
        // ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
        stream.getTracks().forEach(track => {
            track.stop();
            console.log(`ğŸ›‘ [PERMISSIONS] ${track.kind} íŠ¸ë™ ì •ë¦¬ ì™„ë£Œ`);
        });
        
        // ê¶Œí•œ ìƒíƒœ ì €ì¥
        sessionStorage.setItem('permissionsGranted', 'true');
        
        // ê²½ê³  ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        hideCameraWarning();
        hideCameraToast();
        
        return true;
        
    } catch (err) {
        console.error('âŒ [PERMISSIONS] ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨:', err);
        
        // ê¶Œí•œ ê±°ë¶€ ìƒíƒœ ì €ì¥
        sessionStorage.setItem('permissionsGranted', 'false');
        
        // ì—ëŸ¬ íƒ€ì…ì— ë”°ë¥¸ ì²˜ë¦¬
        if (err.name === 'NotAllowedError') {
            console.warn('âš ï¸ [PERMISSIONS] ì‚¬ìš©ìê°€ ê¶Œí•œì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤');
            showPermissionDeniedMessage();
        } else if (err.name === 'NotFoundError') {
            console.warn('âš ï¸ [PERMISSIONS] ì¹´ë©”ë¼ ë˜ëŠ” ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            showDeviceNotFoundMessage();
        } else {
            console.warn('âš ï¸ [PERMISSIONS] ê¸°íƒ€ ê¶Œí•œ ì˜¤ë¥˜:', err.name);
            showCameraToast();
        }
        
        return false;
    }
}

// --- ê¶Œí•œ ê±°ë¶€ ë©”ì‹œì§€ í‘œì‹œ ---
function showPermissionDeniedMessage() {
    const message = document.createElement('div');
    message.id = 'permission-denied-message';
    message.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    `;
    
    message.innerHTML = `
        <div style="font-size: 24px; margin-bottom: 15px;">ğŸ¤</div>
        <h3 style="margin: 0 0 10px; color: #ff6b6b;">ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
        <p style="margin: 0 0 15px; line-height: 1.5;">
            ë°ì´íŠ¸ ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•´<br>
            <strong>ì¹´ë©”ë¼ì™€ ë§ˆì´í¬ ê¶Œí•œ</strong>ì´ í•„ìš”í•©ë‹ˆë‹¤.
        </p>
        <p style="margin: 0 0 20px; font-size: 14px; opacity: 0.8;">
            ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.
        </p>
        <button onclick="retryPermissions()" style="
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        ">ë‹¤ì‹œ ì‹œë„</button>
        <button onclick="closePermissionMessage()" style="
            background: #666;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
        ">ë‚˜ì¤‘ì—</button>
    `;
    
    document.body.appendChild(message);
}

// --- ë””ë°”ì´ìŠ¤ ì—†ìŒ ë©”ì‹œì§€ í‘œì‹œ ---
function showDeviceNotFoundMessage() {
    const message = document.createElement('div');
    message.id = 'device-not-found-message';
    message.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    `;
    
    message.innerHTML = `
        <div style="font-size: 24px; margin-bottom: 15px;">ğŸ“¹</div>
        <h3 style="margin: 0 0 10px; color: #ff6b6b;">ë””ë°”ì´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
        <p style="margin: 0 0 15px; line-height: 1.5;">
            ì¹´ë©”ë¼ ë˜ëŠ” ë§ˆì´í¬ê°€<br>
            ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
        </p>
        <p style="margin: 0 0 20px; font-size: 14px; opacity: 0.8;">
            ë””ë°”ì´ìŠ¤ë¥¼ ì—°ê²°í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
        </p>
        <button onclick="retryPermissions()" style="
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        ">ë‹¤ì‹œ ì‹œë„</button>
        <button onclick="closePermissionMessage()" style="
            background: #666;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
        ">ë‚˜ì¤‘ì—</button>
    `;
    
    document.body.appendChild(message);
}

// --- ê¶Œí•œ ì¬ì‹œë„ í•¨ìˆ˜ ---
async function retryPermissions() {
    console.log('ğŸ”„ [PERMISSIONS] ê¶Œí•œ ì¬ì‹œë„ ì‹œì‘');
    
    // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
    closePermissionMessage();
    
    // ì ì‹œ ëŒ€ê¸° í›„ ê¶Œí•œ ì¬ìš”ì²­
    setTimeout(async () => {
        const success = await requestCameraAndAudioPermissions();
        if (success) {
            console.log('âœ… [PERMISSIONS] ê¶Œí•œ ì¬ì‹œë„ ì„±ê³µ');
        }
    }, 500);
}

// --- ê¶Œí•œ ë©”ì‹œì§€ ë‹«ê¸° í•¨ìˆ˜ ---
function closePermissionMessage() {
    const permissionMessage = document.getElementById('permission-denied-message');
    const deviceMessage = document.getElementById('device-not-found-message');
    
    if (permissionMessage) {
        permissionMessage.remove();
    }
    if (deviceMessage) {
        deviceMessage.remove();
    }
}

// --- ê¶Œí•œ ìƒíƒœ í™•ì¸ í•¨ìˆ˜ ---
async function checkPermissionStatus() {
    try {
        // ê¶Œí•œ ìƒíƒœ í™•ì¸
        const permissions = await navigator.permissions.query({ name: 'camera' });
        const audioPermissions = await navigator.permissions.query({ name: 'microphone' });
        
        console.log('ğŸ” [PERMISSIONS] ê¶Œí•œ ìƒíƒœ í™•ì¸:', {
            camera: permissions.state,
            microphone: audioPermissions.state
        });
        
        return {
            camera: permissions.state,
            microphone: audioPermissions.state,
            allGranted: permissions.state === 'granted' && audioPermissions.state === 'granted'
        };
    } catch (err) {
        console.warn('âš ï¸ [PERMISSIONS] ê¶Œí•œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', err);
        return {
            camera: 'unknown',
            microphone: 'unknown',
            allGranted: false
        };
    }
}
 
 // --- ì•± ì´ˆê¸°í™” ---
 async function initializeApp() {
     // MongoDB ì„¸ì…˜ ìƒì„±
     const sessionCreated = await createSession();
     if (!sessionCreated) {
         console.error('âŒ [CHAT] ì„¸ì…˜ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
     }
     
     // ê¶Œí•œ ìƒíƒœ í™•ì¸ ë° í•„ìš”ì‹œ ìš”ì²­
     console.log('ğŸ¤ [APP] ê¶Œí•œ ìƒíƒœ í™•ì¸ ì‹œì‘');
     const permissionStatus = await checkPermissionStatus();
     
     if (permissionStatus.allGranted) {
         console.log('âœ… [APP] ì´ë¯¸ ëª¨ë“  ê¶Œí•œì´ í—ˆìš©ë¨');
         sessionStorage.setItem('permissionsGranted', 'true');
     } else {
         console.log('ğŸ”„ [APP] ê¶Œí•œ ìš”ì²­ í•„ìš”:', permissionStatus);
         const permissionsGranted = await requestCameraAndAudioPermissions();
         
         if (permissionsGranted) {
             console.log('âœ… [APP] ê¶Œí•œ íšë“ ì™„ë£Œ - ì•± ì´ˆê¸°í™” ê³„ì†');
         } else {
             console.warn('âš ï¸ [APP] ê¶Œí•œ íšë“ ì‹¤íŒ¨ - ì œí•œëœ ê¸°ëŠ¥ìœ¼ë¡œ ê³„ì†');
         }
     }
     
     // ì¹´ë©”ë¼ ìƒíƒœ í™•ì¸ (ê¶Œí•œ ìš”ì²­ í›„)
     await checkCameraStatus();
     
     // ë¹„ë””ì˜¤ ì´ˆê¸°í™”
     initializeVideo();
     
     // ì¹´ë©”ë¼ ë¶„ì„ê¸° ì‹œì‘
     if (typeof scheduleAnalyzerStart === 'function') {
         console.log('[ANALYZER] ì¹´ë©”ë¼ ë¶„ì„ê¸° ì‹œì‘');
         scheduleAnalyzerStart();
     } else {
         console.warn('[ANALYZER] scheduleAnalyzerStart í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
     }
     
     // Persona ì •ë³´ ì¹´ë“œ ì¶”ê°€
     addPersonaCard();
     
          // ì´ˆê¸° ì•ˆë‚´ íŒì—… í‘œì‹œ
      showInitialGuidePopup();
     
     // WebSocket ì—°ê²°
     const userData = getUserData();
     if (userData?.token && typeof connectWS === 'function') {
         connectWS(userData.token);
         
         // WebSocket ì—°ê²° í›„ ì›Œì»¤ ì´ˆê¸°í™”
         setTimeout(() => {
             if (typeof setupLandmarkWorker === 'function') {
                 console.log('[WORKER] ëœë“œë§ˆí¬ ì›Œì»¤ ì´ˆê¸°í™” ì‹œì‘');
                 
                 // ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ê°€ì ¸ì˜¤ê¸°
                 const videoElement = document.getElementById('video');
                 if (videoElement) {
                     setupLandmarkWorker(
                         videoElement,
                         onLandmarkFrame,
                         () => window.suggestedHz || 10
                     );
                     console.log('[WORKER] ëœë“œë§ˆí¬ ì›Œì»¤ ì´ˆê¸°í™” ì™„ë£Œ');
                 } else {
                     console.error('[WORKER] ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                 }
             } else {
                 console.warn('[WORKER] setupLandmarkWorker í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
             }
         }, 1000); // 1ì´ˆ í›„ ì›Œì»¤ ì´ˆê¸°í™”
     }
    
         // ì•¡ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
     const recalibrateBtn = document.getElementById('recalibrate-btn');
     if (recalibrateBtn) {
         recalibrateBtn.addEventListener('click', async () => {
             try {
                 // ì¹´ë©”ë¼ ê¶Œí•œ í™•ì¸
                 await navigator.mediaDevices.getUserMedia({ video: true });
                 // ì¹´ë©”ë¼ ê²½ê³  ìˆ¨ê¸°ê¸°
                 hideCameraWarning();
                 // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ íŒì—… ë‹¤ì‹œ í‘œì‹œ
                 const calibrationOverlay = document.getElementById('calibration-overlay');
                 const mainContent = document.getElementById('main-content');
                 if (calibrationOverlay) calibrationOverlay.classList.remove('hidden');
                 if (mainContent) mainContent.classList.remove('visible');
             } catch (err) {
                 console.error("ì¹´ë©”ë¼ ê¶Œí•œ ì‹¤íŒ¨:", err);
                 showCameraWarning();
             }
         });
     }
    
    const endSessionBtn = document.getElementById('end-session-btn');
    if (endSessionBtn) {
        endSessionBtn.addEventListener('click', () => {
            // í™•ì¸ íŒì—… í‘œì‹œ
            showConfirmDialog();
        });
    }
    
    // í™•ì¸ íŒì—… ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const cancelEndBtn = document.getElementById('cancel-end-btn');
    if (cancelEndBtn) {
        cancelEndBtn.addEventListener('click', () => {
            hideConfirmDialog();
        });
    }
    
    const confirmEndBtn = document.getElementById('confirm-end-btn');
    if (confirmEndBtn) {
        confirmEndBtn.addEventListener('click', async () => {
        // ë°ì´íŠ¸ ì„¸ì…˜ ì¢…ë£Œ - ì¦‰ì‹œ í˜ì´ì§€ ì´ë™
        hideConfirmDialog();
        
        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        const endBtn = document.getElementById('confirm-end-btn');
        const originalText = endBtn.textContent;
        endBtn.textContent = 'ì¢…ë£Œ ì¤‘...';
        endBtn.disabled = true;
        
        try {
            // ì¹´ë©”ë¼ ë¶„ì„ê¸° ì •ë¦¬
            if (window.cameraAnalyzer) {
                console.log('ğŸ§¹ [ANALYZER] ì¹´ë©”ë¼ ë¶„ì„ê¸° ì •ë¦¬ ì‹œì‘');
                window.cameraAnalyzer.cleanup();
                window.cameraAnalyzer = null;
            }
            
            // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬
            sessionStorage.removeItem('currentSessionId');
            sessionStorage.removeItem('userData');
            console.log('ğŸ§¹ [SESSION] ì„¸ì…˜ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ');
            // ìµœì¢… í”¼ë“œë°± ë°ì´í„° ìˆ˜ì§‘
            const finalFeedback = {
                likability: parseInt(document.getElementById('likability-score').textContent) || 0,
                initiative: parseInt(document.getElementById('user-initiative-bar').style.width) || 0,
                tone: parseInt(document.getElementById('tone-score').textContent) || 0,
                concentration: parseInt(document.getElementById('concentration-score').textContent) || 0,
                gaze_stability: parseInt(document.getElementById('gaze-score').textContent) || 0,
                blinking: parseInt(document.getElementById('blinking-score').textContent) || 0,
                posture: parseInt(document.getElementById('posture-score').textContent) || 0,
                expression: document.getElementById('expression-text').textContent || 'ë¶„ì„ ì—†ìŒ',
                total_score: parseInt(document.getElementById('total-score').textContent) || 0,
                summary: document.getElementById('ai-feedback-summary').textContent || 'ë¶„ì„ ì—†ìŒ'
            };
            
            // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const userData = getUserData();
            if (!userData) {
                throw new Error('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            
            const externalUrl = 'https://dys-phi.vercel.app/persona';
 			
 			// ë°±ì—”ë“œ API í˜¸ì¶œ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì²˜ë¦¬, ì‘ë‹µ ëŒ€ê¸°í•˜ì§€ ì•ŠìŒ)
 			fetch(`${serverUrl}/api/session/end`, {
 				method: 'POST',
 				headers: {
 					'Content-Type': 'application/json',
 					'Authorization': `Bearer ${userData.token || ''}`
 				},
 				body: JSON.stringify({
 					session_id: currentSessionId,
 					user_id: userData.user_id,
 					email: userData.email,
 					token: userData.token,
 					end_reason: 'user_request',
 					final_feedback: finalFeedback
 				})
 			}).then(response => {
 				if (response.ok) {
 					console.log('âœ… [SESSION] ë°±ê·¸ë¼ìš´ë“œ ì„¸ì…˜ ì¢…ë£Œ ì„±ê³µ');
 				} else {
 					console.warn('âš ï¸ [SESSION] ë°±ê·¸ë¼ìš´ë“œ ì„¸ì…˜ ì¢…ë£Œ ì‹¤íŒ¨:', response.status);
 				}
 			}).catch(error => {
 				console.warn('âš ï¸ [SESSION] ë°±ê·¸ë¼ìš´ë“œ ì„¸ì…˜ ì¢…ë£Œ ì˜¤ë¥˜:', error);
 			});
 			
 			// ì¦‰ì‹œ ì™¸ë¶€ í˜ì´ì§€ë¡œ ì´ë™ (íˆìŠ¤í† ë¦¬ì— ë‚¨ê¸°ì§€ ì•ŠìŒ)
 			console.log('ğŸš€ [SESSION] ì¦‰ì‹œ í˜ì´ì§€ ì´ë™:', externalUrl);
 			window.location.replace(externalUrl);
 			
 		} catch (error) {
 			console.error('âŒ [SESSION] ì„¸ì…˜ ì¢…ë£Œ ì¤€ë¹„ ì‹¤íŒ¨:', error);
 			
 			// ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ì™¸ë¶€ í˜ì´ì§€ë¡œ ì´ë™
 			window.location.replace('https://dys-phi.vercel.app/persona');
 		} finally {
 			// ë²„íŠ¼ ìƒíƒœ ë³µì› (í˜ì´ì§€ ì´ë™ ì „ì— ì‹¤í–‰ë  ìˆ˜ ìˆìŒ)
 			setTimeout(() => {
 				const endBtn = document.getElementById('confirm-end-btn');
 				if (endBtn) {
 					endBtn.textContent = 'ì˜ˆ';
 					endBtn.disabled = false;
 				}
 			}, 100);
 		}
 	    });
    
    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
        console.log('ğŸ§¹ [CLEANUP] í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬ ì‹œì‘');
        cleanupGlobalVariables();
    });
    
    // í˜ì´ì§€ ìˆ¨ê¹€ ì‹œ ì •ë¦¬
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            console.log('ğŸ§¹ [CLEANUP] í˜ì´ì§€ ìˆ¨ê¹€ ì‹œ ì •ë¦¬');
            cleanupGlobalVariables();
        }
    });
}

// --- ì „ì—­ ë³€ìˆ˜ ì •ë¦¬ í•¨ìˆ˜ ---
function cleanupGlobalVariables() {
    // ì›Œì»¤ ê´€ë¦¬ ì‹œìŠ¤í…œ ì •ë¦¬
    if (typeof cleanupWorker === 'function') {
        cleanupWorker();
    }
    

    
    // ë¶„ì„ê¸° ì •ë¦¬
    if (window.analyzerClient) {
        try {
            window.analyzerClient.cleanup();
            window.analyzerClient = null;
        } catch (e) {
            console.warn('[CLEANUP] ë¶„ì„ê¸° ì •ë¦¬ ì‹¤íŒ¨:', e);
        }
    }
    
    // TTS ê´€ë¦¬ì ì •ë¦¬
    cleanupTTSManager();
    
    // UI ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸ ì •ë¦¬
    if (window.__UI_UPDATE_TIMER__) {
        clearTimeout(window.__UI_UPDATE_TIMER__);
        window.__UI_UPDATE_TIMER__ = null;
    }
    
    // ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„ ì •ë¦¬
    if (window.__PUMP_ANIMATION_ID__) {
        cancelAnimationFrame(window.__PUMP_ANIMATION_ID__);
        window.__PUMP_ANIMATION_ID__ = null;
    }
    
    // ëœë“œë§ˆí¬ íŒí”„ ì¤‘ì§€
    __lmPumpStop = true;
    
    console.log('[CLEANUP] ì „ì—­ ë³€ìˆ˜ ì •ë¦¬ ì™„ë£Œ');
}

// WebSocket ì—°ê²°ì€ initializeApp()ì—ì„œ ì²˜ë¦¬ë¨

// ì „ì—­ ìŠ¤ì½”í”„ì— ê¶Œí•œ ê´€ë ¨ í•¨ìˆ˜ ë…¸ì¶œ
window.requestCameraAndAudioPermissions = requestCameraAndAudioPermissions;
window.retryPermissions = retryPermissions;
window.closePermissionMessage = closePermissionMessage;
window.checkPermissionStatus = checkPermissionStatus;
}

// ê¹œë¹¡ì„ í†µê³„ ê´€ë¦¬ (mediapipe-direct.jsì—ì„œ ì²˜ë¦¬ë¨)
// blinkHistory, lastBlinkTime ë“±ì€ mediapipe-direct.jsì—ì„œ ê´€ë¦¬ë©ë‹ˆë‹¤.

// ë¯¸ì†Œ í†µê³„ ê´€ë¦¬ (ê°œì„ ëœ ë²„ì „)
let smileHistory = []; // ë¯¸ì†Œ íˆìŠ¤í† ë¦¬ (ì•ˆì •í™”ìš©)
let personalBaseSmile = 50; // ê°œì¸ë³„ ê¸°ì¤€ ë¯¸ì†Œ ê°•ë„ (ë™ì  ê³„ì‚°)
const SMILE_HISTORY_SIZE = 20; // ìµœê·¼ 20ê°œ ë¯¸ì†Œ ê°’ìœ¼ë¡œ ê¸°ì¤€ ê³„ì‚°
const SMILE_SMOOTHING_WINDOW = 5000; // 5ì´ˆ ìœˆë„ìš°ë¡œ ë¯¸ì†Œ ì•ˆì •í™”

// ìì„¸ í†µê³„ ê´€ë¦¬ (ì•ˆì •í™”ìš©)
let postureHistory = []; // ìì„¸ íˆìŠ¤í† ë¦¬ (ì•ˆì •í™”ìš©)
let smoothedPostureScore = 60; // ì•ˆì •í™”ëœ ìì„¸ ì ìˆ˜
const POSTURE_HISTORY_SIZE = 15; // ìµœê·¼ 15ê°œ ìì„¸ ê°’ìœ¼ë¡œ ì•ˆì •í™”
const POSTURE_SMOOTHING_WINDOW = 8000; // 8ì´ˆ ìœˆë„ìš°ë¡œ ìì„¸ ì•ˆì •í™”
const POSTURE_CHANGE_THRESHOLD = 15; // ê¸‰ê²©í•œ ë³€í™” ì„ê³„ê°’ (15ì  ì´ìƒ ë³€í™” ì‹œ ì œí•œ)

// ì›Œì»¤ë¡œë¶€í„° ë°›ì€ ëœë“œë§ˆí¬ë¥¼ ë°°ì¹˜ì— ì ì¬ (ê°œì„ ëœ ë²„ì „)
function onLandmarkFrame(lmBuffer, ear) {
  console.log('[LANDMARK] ëœë“œë§ˆí¬ ì²˜ë¦¬ ì‹œì‘:', { ear });
  
  // Float32Arrayë¥¼ Uint8Arrayë¡œ ë³€í™˜
  const b = new Uint8Array(lmBuffer);
  let s = "";
  for (let i = 0; i < b.length; i++) s += String.fromCharCode(b[i]);
  const base64 = btoa(s);

  const now = Date.now();

  // ë¯¸ì†Œ íˆìŠ¤í† ë¦¬ëŠ” updateCameraMetricsì—ì„œ ì²˜ë¦¬ë¨ (metrics ê°ì²´ê°€ ìˆì„ ë•Œ)

  // ìì„¸ íˆìŠ¤í† ë¦¬ëŠ” updateCameraMetricsì—ì„œ ì²˜ë¦¬ë¨ (metrics ê°ì²´ê°€ ìˆì„ ë•Œ)

  // ëœë“œë§ˆí¬ ë°°ì¹˜ì— ì¶”ê°€ (WebSocket ì „ì†¡ìš©)
  if (!window.lmBatch) {
    // lmBatchê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
    window.lmBatch = [];
    console.log('[LANDMARK] lmBatch ì´ˆê¸°í™”ë¨');
  }
  
  window.lmBatch.push({
    t: now,
    model: "facemesh-468",
    mode: "full",
    lm: base64,
    ear
  });
  
  console.log('[LANDMARK] ë°°ì¹˜ì— ì¶”ê°€ë¨:', window.lmBatch.length, 'ê°œ í”„ë ˆì„');
}

// ê¹œë¹¡ì„ ê³„ì‚° í•¨ìˆ˜ë“¤ì€ mediapipe-direct.jsì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
// calculateShortBlinkRate, calculateBlinkRate ë“±ì€ mediapipe-direct.jsì—ì„œ ê´€ë¦¬ë©ë‹ˆë‹¤.

// --- íŒì—… ê´€ë¦¬ì ëª¨ë“ˆì—ì„œ ì²˜ë¦¬ë¨ ---
// íŒì—… ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ js/popup-manager.jsì—ì„œ ê´€ë¦¬ë©ë‹ˆë‹¤.

// --- ì‹œì„  ì•ˆì •ì„± ìƒì„¸ ì •ë³´ íŒì—… í•¨ìˆ˜ë“¤ ---
function showGazeDetails() {
    const popup = document.getElementById('gaze-details-popup');
    if (popup) {
        popup.classList.add('active');
        updateGazePopupContent();
    }
}

function closeGazeDetails() {
    const popup = document.getElementById('gaze-details-popup');
    if (popup) {
        popup.classList.remove('active');
    }
}

function updateGazePopupContent() {
    if (!currentGazeData) {
        document.getElementById('gaze-main-value').textContent = 'ë°ì´í„° ì—†ìŒ';
        document.getElementById('gaze-stability-value').textContent = '0%';
        document.getElementById('gaze-landmarks').innerHTML = '<div class="no-data">ì‹œì„  ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        document.getElementById('gaze-criteria-text').innerHTML = 'ì‹œì„  ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        document.getElementById('gaze-explanation-text').innerHTML = 'ì‹œì„  ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        return;
    }
    
    // ì£¼ìš” ì •ë³´ ì—…ë°ì´íŠ¸
    const isFocused = currentGazeData.isFocused;
    document.getElementById('gaze-main-value').textContent = isFocused ? 'ì§‘ì¤‘ ì¤‘' : 'ë¶„ì‚°ë¨';
    document.getElementById('gaze-stability-value').textContent = `${currentGazeData.score}%`;
    
    // ëœë“œë§ˆí¬ ì •ë³´ ì—…ë°ì´íŠ¸
    updateGazeLandmarksInfo();
    
    // í‰ê°€ ê¸°ì¤€ ì—…ë°ì´íŠ¸
    updateGazeCriteriaInfo();
    
    // ì ìˆ˜ ê³„ì‚° ê·¼ê±° ì—…ë°ì´íŠ¸
    updateGazeExplanationInfo();
}

function updateGazeLandmarksInfo() {
    const landmarksDiv = document.getElementById('gaze-landmarks');
    
    // ì‹œì„  ë¶„ì„ì—ë§Œ ì‚¬ìš©ë˜ëŠ” MediaPipe FaceMesh ëœë“œë§ˆí¬ ì •ë³´
    const landmarkInfo = [
        { name: 'ì™¼ìª½ ëˆˆ ìœ¤ê³½', value: '16ê°œ', description: 'ì™¼ìª½ ëˆˆì˜ ìœ¤ê³½ì„ ì„ êµ¬ì„±í•˜ëŠ” ëœë“œë§ˆí¬' },
        { name: 'ì˜¤ë¥¸ìª½ ëˆˆ ìœ¤ê³½', value: '16ê°œ', description: 'ì˜¤ë¥¸ìª½ ëˆˆì˜ ìœ¤ê³½ì„ ì„ êµ¬ì„±í•˜ëŠ” ëœë“œë§ˆí¬' },
        { name: 'ì™¼ìª½ ëˆˆì¹', value: '10ê°œ', description: 'ì™¼ìª½ ëˆˆì¹ì˜ ìœ¤ê³½ì„ ì„ êµ¬ì„±í•˜ëŠ” ëœë“œë§ˆí¬' },
        { name: 'ì˜¤ë¥¸ìª½ ëˆˆì¹', value: '10ê°œ', description: 'ì˜¤ë¥¸ìª½ ëˆˆì¹ì˜ ìœ¤ê³½ì„ ì„ êµ¬ì„±í•˜ëŠ” ëœë“œë§ˆí¬' },
        { name: 'ëˆˆë™ì ì¤‘ì‹¬', value: '2ê°œ', description: 'ì™¼ìª½/ì˜¤ë¥¸ìª½ ëˆˆë™ìì˜ ì¤‘ì‹¬ì ' },
        { name: 'ì‹œì„  ì¶”ì ìš©', value: '54ê°œ', description: 'ì‹œì„  ë°©í–¥ê³¼ ì•ˆì •ì„± ë¶„ì„ì— ì‚¬ìš©ë˜ëŠ” ì´ ëœë“œë§ˆí¬' }
    ];
    
    let html = '';
    landmarkInfo.forEach(item => {
        html += `
            <div class="landmark-item">
                <div class="landmark-name">${item.name}</div>
                <div class="landmark-value">${item.value}</div>
                <div class="landmark-description">${item.description}</div>
            </div>
        `;
    });
    
    landmarksDiv.innerHTML = html;
}

function updateGazeCriteriaInfo() {
    const criteriaDiv = document.getElementById('gaze-criteria-text');
    
    const criteria = `
        <div class="criteria-section">
            <h4>ğŸ¯ ì‹œì„  ì•ˆì •ì„± í‰ê°€ ê¸°ì¤€</h4>
            <ul>
                <li><strong>ì í”„ ê±°ë¦¬ (40%)</strong>: ëˆˆë™ì ì¤‘ì‹¬ì ì˜ ê¸‰ê²©í•œ ì´ë™ ê±°ë¦¬</li>
                <li><strong>ì†ë„ (30%)</strong>: ëˆˆë™ì ì´ë™ì˜ í‰ê·  ì†ë„ (í”½ì…€/í”„ë ˆì„)</li>
                <li><strong>ì•ˆì •ì„± (30%)</strong>: ëˆˆë™ìê°€ í•œ ì˜ì—­ì— ë¨¸ë¬´ëŠ” ì •ë„</li>
            </ul>
            
            <h4>ğŸ‘ï¸ ì‹œì„  ë¶„ì„ ë°©ë²•</h4>
            <ul>
                <li><strong>ëˆˆ ìœ¤ê³½ ì¶”ì </strong>: 32ê°œ ëœë“œë§ˆí¬ë¡œ ëˆˆì˜ ìœ„ì¹˜ì™€ í¬ê¸° ì¸¡ì •</li>
                <li><strong>ëˆˆë™ì ì¤‘ì‹¬ ê³„ì‚°</strong>: ëˆˆ ìœ¤ê³½ ë‚´ë¶€ì˜ ì¤‘ì‹¬ì  ì¶”ì •</li>
                <li><strong>ì‹œì„  ë°©í–¥ ë¶„ì„</strong>: ëˆˆë™ì ì¤‘ì‹¬ì˜ í™”ë©´ ë‚´ ìœ„ì¹˜ ë³€í™” ì¶”ì </li>
                <li><strong>ì•ˆì •ì„± íŒë‹¨</strong>: ì¼ì • ì‹œê°„ ë™ì•ˆì˜ ì‹œì„  ë³€í™”ëŸ‰ ê³„ì‚°</li>
            </ul>
            
            <h4>ğŸ“Š ì ìˆ˜ ê¸°ì¤€</h4>
            <ul>
                <li><strong>90-100ì </strong>: ë§¤ìš° ì•ˆì •ì ì¸ ì‹œì„  (ì§‘ì¤‘ë ¥ ìš°ìˆ˜)</li>
                <li><strong>70-89ì </strong>: ì•ˆì •ì ì¸ ì‹œì„  (ì ì ˆí•œ ì§‘ì¤‘)</li>
                <li><strong>50-69ì </strong>: ë³´í†µ ìˆ˜ì¤€ì˜ ì‹œì„  (ì¼ë°˜ì ì¸ ìƒíƒœ)</li>
                <li><strong>30-49ì </strong>: ë¶ˆì•ˆì •í•œ ì‹œì„  (ì§‘ì¤‘ë ¥ ì €í•˜)</li>
                <li><strong>0-29ì </strong>: ë§¤ìš° ë¶ˆì•ˆì •í•œ ì‹œì„  (ì‹¬ê°í•œ ì§‘ì¤‘ë ¥ ë¬¸ì œ)</li>
            </ul>
        </div>
    `;
    
    criteriaDiv.innerHTML = criteria;
}

function updateGazeExplanationInfo() {
    const explanationDiv = document.getElementById('gaze-explanation-text');
    
    if (!currentGazeData) {
        explanationDiv.innerHTML = 'ì‹œì„  ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        return;
    }
    
    const { jumpDistance, velocity, isFocused, score } = currentGazeData;
    
    let explanation = `<div class="explanation-section">`;
    explanation += `<h4>ğŸ“ˆ í˜„ì¬ ë¶„ì„ ê²°ê³¼</h4>`;
    explanation += `<ul>`;
    explanation += `<li><strong>ì‹œì„  ìƒíƒœ</strong>: ${isFocused ? 'ì§‘ì¤‘ ì¤‘' : 'ë¶„ì‚°ë¨'}</li>`;
    explanation += `<li><strong>ì í”„ ê±°ë¦¬</strong>: ${(jumpDistance * 100).toFixed(2)}% (í™”ë©´ ëŒ€ë¹„)</li>`;
    explanation += `<li><strong>ì´ë™ ì†ë„</strong>: ${velocity.toFixed(4)} (í”½ì…€/í”„ë ˆì„)</li>`;
    explanation += `<li><strong>ìµœì¢… ì ìˆ˜</strong>: ${score}ì </li>`;
    explanation += `</ul>`;
    
    // ì ìˆ˜ í•´ì„
    if (score >= 90) {
        explanation += `<p>ğŸ¯ <strong>ë§¤ìš° ìš°ìˆ˜í•œ ì‹œì„  ì•ˆì •ì„±</strong>: ì‹œì„ ì´ ë§¤ìš° ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.</p>`;
    } else if (score >= 70) {
        explanation += `<p>ğŸ¯ <strong>ìš°ìˆ˜í•œ ì‹œì„  ì•ˆì •ì„±</strong>: ì‹œì„ ì´ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.</p>`;
    } else if (score >= 50) {
        explanation += `<p>ğŸ¯ <strong>ë³´í†µ ìˆ˜ì¤€ì˜ ì‹œì„  ì•ˆì •ì„±</strong>: ì‹œì„ ì´ ì–´ëŠ ì •ë„ ì•ˆì •ì ì…ë‹ˆë‹¤.</p>`;
    } else if (score >= 30) {
        explanation += `<p>ğŸ¯ <strong>ê°œì„ ì´ í•„ìš”í•œ ì‹œì„  ì•ˆì •ì„±</strong>: ì‹œì„ ì´ ë‹¤ì†Œ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤.</p>`;
    } else {
        explanation += `<p>ğŸ¯ <strong>ë§¤ìš° ê°œì„ ì´ í•„ìš”í•œ ì‹œì„  ì•ˆì •ì„±</strong>: ì‹œì„ ì´ ë§¤ìš° ë¶ˆì•ˆì •í•©ë‹ˆë‹¤.</p>`;
    }
    
    explanation += `</div>`;
    
    explanationDiv.innerHTML = explanation;
}

// --- ì§‘ì¤‘ë„ ìƒì„¸ ì •ë³´ íŒì—… í•¨ìˆ˜ë“¤ ---
function showConcentrationDetails() {
    const popup = document.getElementById('concentration-details-popup');
    if (popup) {
        popup.classList.add('active');
        updateConcentrationPopupContent();
    }
}

function closeConcentrationDetails() {
    const popup = document.getElementById('concentration-details-popup');
    if (popup) {
        popup.classList.remove('active');
    }
}

function updateConcentrationPopupContent() {
    if (!currentConcentrationData) {
        document.getElementById('concentration-main-value').textContent = 'ë°ì´í„° ì—†ìŒ';
        document.getElementById('concentration-score-value').textContent = '0%';
        document.getElementById('concentration-factors').innerHTML = '<div class="no-data">ì§‘ì¤‘ë„ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        document.getElementById('concentration-criteria-text').innerHTML = 'ì§‘ì¤‘ë„ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        document.getElementById('concentration-explanation-text').innerHTML = 'ì§‘ì¤‘ë„ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        return;
    }
    
    // ì£¼ìš” ì •ë³´ ì—…ë°ì´íŠ¸
    const isFocused = currentConcentrationData.isFocused;
    document.getElementById('concentration-main-value').textContent = isFocused ? 'ì§‘ì¤‘ ì¤‘' : 'ë¶„ì‚°ë¨';
    document.getElementById('concentration-score-value').textContent = `${currentConcentrationData.score}%`;
    
    // ë¶„ì„ ìš”ì†Œ ì—…ë°ì´íŠ¸
    updateConcentrationFactorsInfo();
    
    // í‰ê°€ ê¸°ì¤€ ì—…ë°ì´íŠ¸
    updateConcentrationCriteriaInfo();
    
    // ì ìˆ˜ ê³„ì‚° ê·¼ê±° ì—…ë°ì´íŠ¸
    updateConcentrationExplanationInfo();
}

function updateConcentrationFactorsInfo() {
    const factorsDiv = document.getElementById('concentration-factors');
    
    // ì§‘ì¤‘ë„ ë¶„ì„ì— ì‚¬ìš©ë˜ëŠ” ìš”ì†Œë“¤
    const factorInfo = [
        { name: 'ì‹œì„  ì•ˆì •ì„±', value: '35%', description: 'ì‹œì„ ì´ í•œ ê³³ì— ë¨¸ë¬´ëŠ” ì •ë„' },
        { name: 'ì‹œì„  ì§‘ì¤‘ë„', value: '35%', description: 'ì‹œì„ ì´ í™”ë©´ ì¤‘ì•™ì— ì§‘ì¤‘ë˜ëŠ” ì •ë„' },
        { name: 'í‘œì • ë”°ëœ»í•¨', value: '30%', description: 'ê¸ì •ì ì¸ í‘œì •ìœ¼ë¡œ ì§‘ì¤‘ë ¥ í‘œí˜„' },
        { name: 'ëˆˆë™ì ì¶”ì ', value: 'ì‹¤ì‹œê°„', description: 'ëˆˆë™ì ì›€ì§ì„ìœ¼ë¡œ ì§‘ì¤‘ ìƒíƒœ íŒë‹¨' },
        { name: 'ì‹œì„  ì´íƒˆ ì‹œê°„', value: '2ì´ˆ ì´ë‚´', description: 'ì‹œì„ ì´ í™”ë©´ì„ ë²—ì–´ë‚˜ëŠ” ì‹œê°„' },
        { name: 'ì§‘ì¤‘ ì§€ì†ì„±', value: 'ì—°ì†ì„±', description: 'ì§€ì†ì ì¸ ì§‘ì¤‘ ìƒíƒœ ìœ ì§€' }
    ];
    
    let html = '';
    factorInfo.forEach(item => {
        html += `
            <div class="factor-item">
                <div class="factor-name">${item.name}</div>
                <div class="factor-value">${item.value}</div>
                <div class="factor-description">${item.description}</div>
            </div>
        `;
    });
    
    factorsDiv.innerHTML = html;
}

function updateConcentrationCriteriaInfo() {
    const criteriaDiv = document.getElementById('concentration-criteria-text');
    
    const criteria = `
        <div class="criteria-section">
            <h4>ğŸ¯ ì§‘ì¤‘ë„ í‰ê°€ ê¸°ì¤€</h4>
            <ul>
                <li><strong>ì‹œì„  ì•ˆì •ì„± (35%)</strong>: ì‹œì„ ì´ í•œ ê³³ì— ë¨¸ë¬´ëŠ” ì •ë„</li>
                <li><strong>ì‹œì„  ì§‘ì¤‘ë„ (35%)</strong>: ì‹œì„ ì´ í™”ë©´ ì¤‘ì•™ì— ì§‘ì¤‘ë˜ëŠ” ì •ë„</li>
                <li><strong>í‘œì • ë”°ëœ»í•¨ (30%)</strong>: ê¸ì •ì ì¸ í‘œì •ìœ¼ë¡œ ì§‘ì¤‘ë ¥ í‘œí˜„</li>
            </ul>
            
            <h4>ğŸ§  ì§‘ì¤‘ë„ ë¶„ì„ ë°©ë²•</h4>
            <ul>
                <li><strong>ëˆˆë™ì ì¶”ì </strong>: 32ê°œ ëœë“œë§ˆí¬ë¡œ ëˆˆë™ì ìœ„ì¹˜ ì¶”ì </li>
                <li><strong>ì‹œì„  ë°©í–¥ ë¶„ì„</strong>: í™”ë©´ ì¤‘ì•™ ëŒ€ë¹„ ì‹œì„  ìœ„ì¹˜ ê³„ì‚°</li>
                <li><strong>ì§‘ì¤‘ ì§€ì†ì„±</strong>: ì¼ì • ì‹œê°„ ë™ì•ˆì˜ ì§‘ì¤‘ ìƒíƒœ ìœ ì§€</li>
                <li><strong>ì‹œì„  ì´íƒˆ ê°ì§€</strong>: í™”ë©´ì„ ë²—ì–´ë‚˜ëŠ” ì‹œì„  ê°ì§€</li>
            </ul>
            
            <h4>ğŸ“Š ì ìˆ˜ ê¸°ì¤€</h4>
            <ul>
                <li><strong>90-100ì </strong>: ë§¤ìš° ë†’ì€ ì§‘ì¤‘ë„ (ì™„ë²½í•œ ì§‘ì¤‘)</li>
                <li><strong>70-89ì </strong>: ë†’ì€ ì§‘ì¤‘ë„ (ì¢‹ì€ ì§‘ì¤‘)</li>
                <li><strong>50-69ì </strong>: ë³´í†µ ì§‘ì¤‘ë„ (ì¼ë°˜ì ì¸ ì§‘ì¤‘)</li>
                <li><strong>30-49ì </strong>: ë‚®ì€ ì§‘ì¤‘ë„ (ì§‘ì¤‘ë ¥ ì €í•˜)</li>
                <li><strong>0-29ì </strong>: ë§¤ìš° ë‚®ì€ ì§‘ì¤‘ë„ (ì‹¬ê°í•œ ì§‘ì¤‘ë ¥ ë¬¸ì œ)</li>
            </ul>
        </div>
    `;
    
    criteriaDiv.innerHTML = criteria;
}

function updateConcentrationExplanationInfo() {
    const explanationDiv = document.getElementById('concentration-explanation-text');
    
    if (!currentConcentrationData) {
        explanationDiv.innerHTML = 'ì§‘ì¤‘ë„ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        return;
    }
    
    const { jumpDistance, velocity, isFocused, gazeDirection, score } = currentConcentrationData;
    
    let explanation = `<div class="explanation-section">`;
    explanation += `<h4>ğŸ“ˆ í˜„ì¬ ë¶„ì„ ê²°ê³¼</h4>`;
    explanation += `<ul>`;
    explanation += `<li><strong>ì§‘ì¤‘ ìƒíƒœ</strong>: ${isFocused ? 'ì§‘ì¤‘ ì¤‘' : 'ë¶„ì‚°ë¨'}</li>`;
    explanation += `<li><strong>ì‹œì„  ë°©í–¥</strong>: ${gazeDirection || 'ì¤‘ì•™'}</li>`;
    explanation += `<li><strong>ì í”„ ê±°ë¦¬</strong>: ${(jumpDistance * 100).toFixed(2)}% (í™”ë©´ ëŒ€ë¹„)</li>`;
    explanation += `<li><strong>ì´ë™ ì†ë„</strong>: ${velocity.toFixed(4)} (í”½ì…€/í”„ë ˆì„)</li>`;
    explanation += `<li><strong>ìµœì¢… ì ìˆ˜</strong>: ${score}ì </li>`;
    explanation += `</ul>`;
    
    // ì ìˆ˜ í•´ì„
    if (score >= 90) {
        explanation += `<p>ğŸ¯ <strong>ì™„ë²½í•œ ì§‘ì¤‘ë„</strong>: ì‹œì„ ì´ ë§¤ìš° ì•ˆì •ì ì´ê³  í™”ë©´ì— ì™„ë²½í•˜ê²Œ ì§‘ì¤‘í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>`;
    } else if (score >= 70) {
        explanation += `<p>ğŸ¯ <strong>ìš°ìˆ˜í•œ ì§‘ì¤‘ë„</strong>: ì‹œì„ ì´ ì•ˆì •ì ì´ê³  í™”ë©´ì— ì˜ ì§‘ì¤‘í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>`;
    } else if (score >= 50) {
        explanation += `<p>ğŸ¯ <strong>ë³´í†µ ì§‘ì¤‘ë„</strong>: ì‹œì„ ì´ ì–´ëŠ ì •ë„ ì•ˆì •ì ì´ê³  ì ì ˆíˆ ì§‘ì¤‘í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>`;
    } else if (score >= 30) {
        explanation += `<p>ğŸ¯ <strong>ê°œì„ ì´ í•„ìš”í•œ ì§‘ì¤‘ë„</strong>: ì‹œì„ ì´ ë¶ˆì•ˆì •í•˜ê³  ì§‘ì¤‘ë ¥ì´ ì €í•˜ë˜ê³  ìˆìŠµë‹ˆë‹¤.</p>`;
    } else {
        explanation += `<p>ğŸ¯ <strong>ë§¤ìš° ê°œì„ ì´ í•„ìš”í•œ ì§‘ì¤‘ë„</strong>: ì‹œì„ ì´ ë§¤ìš° ë¶ˆì•ˆì •í•˜ê³  ì‹¬ê°í•œ ì§‘ì¤‘ë ¥ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.</p>`;
    }
    
    explanation += `</div>`;
    
    explanationDiv.innerHTML = explanation;
}

// íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', function(event) {
    const expressionPopup = document.getElementById('expression-details-popup');
    const gazePopup = document.getElementById('gaze-details-popup');
    const concentrationPopup = document.getElementById('concentration-details-popup');
    
    if (expressionPopup && event.target === expressionPopup) {
        closeExpressionDetails();
    }
    
    if (gazePopup && event.target === gazePopup) {
        closeGazeDetails();
    }
    
    if (concentrationPopup && event.target === concentrationPopup) {
        closeConcentrationDetails();
    }
});

// generatePersonalizedTips í•¨ìˆ˜ (ui-utils.jsë¡œ ì´ë™ë¨)

// --- ëœë“œë§ˆí¬ ë°°ì¹˜ ì²˜ë¦¬ (ì œê±°ë¨) ---

</script>
</body>
</html>