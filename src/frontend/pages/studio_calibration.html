<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ë°ì—°ì†Œ Â· Love Glass UI (í”¼ë“œë°± ê³ ë„í™”)</title>
    <link rel="stylesheet" href="../assets/styles/studio_calibration.css?v=20241223-24">
<!-- MediaPipe ê´€ë ¨ ë¡œë”©/ê²€ì‚¬ ë¡œì§ ì œê±°ë¨ -->
<!-- ê¸°ë³¸ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì„¤ì • ëª¨ë“ˆ -->
<script src="../assets/js/default-calibration.js?v=20241223"></script>
<!-- ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ -->
<script src="../assets/js/calibration.js?v=20241222"></script>
<!-- ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ (ê°œë°œìš©) -->
<script src="../assets/js/performance-monitor.js?v=20241222"></script>
<!-- ê³µí†µ ë©”íŠ¸ë¦­ ìœ í‹¸ë¦¬í‹° -->
    <script src="../assets/js/metrics-utils.js?v=20241226-1"></script>


<!-- MediaPipe ì§ì ‘ ëª¨ë“ˆ ì œê±°ë¨ -->
<!-- ì¹´ë©”ë¼ ë¶„ì„/MediaPipe ë¡œë” ì œê±°ë¨ -->
    <!-- ìŒì„± ì…ë ¥ ëª¨ë“ˆ -->
    <script src="../assets/js/voice-input.js?v=20241222-2"></script>
    <!-- TTS ê´€ë¦¬ ëª¨ë“ˆ -->
    <script src="../assets/js/tts-manager.js?v=20241223-2"></script>
    <!-- TTS ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ -->
    <script src="../assets/js/tts-utils.js?v=20241226-1"></script>
    <!-- íŒì—… ê´€ë¦¬ ëª¨ë“ˆ -->
    <script src="../assets/js/popup-manager.js?v=20241223-2"></script>
    <!-- ëŒ€í™” ì£¼ë„ê¶Œ ë¶„ì„ ëª¨ë“ˆ -->
    <script src="../assets/js/conversation-analyzer.js?v=20241223"></script>
    <!-- ì¢…í•© ì ìˆ˜ ê³„ì‚° ëª¨ë“ˆ -->
    <script src="../assets/js/comprehensive-score-calculator.js?v=20241223"></script>
    <!-- íŒì—… ë¡œë” ëª¨ë“ˆ -->
    <script src="../assets/js/popup-loader.js?v=20241226-1"></script>
    <!-- UI ìœ í‹¸ë¦¬í‹° ëª¨ë“ˆ -->
    <script src="../assets/js/ui-utils.js?v=20241226-1"></script>
    <!-- WS í”„ë¡ì‹œ(Cloud Run) ë² ì´ìŠ¤ ì„¤ì • -->
    <script>
        window.WS_BASE_URL = 'wss://ws-proxy-44060495462.asia-northeast3.run.app';
    </script>
    <!-- ì±„íŒ… ë§¤ë‹ˆì € ëª¨ë“ˆ -->
    <script src="../assets/js/chat-manager.js?v=20241226-1"></script>
    
    <!-- ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ -->
    <script>
        // UI ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ì„ ì „ì—­ ìŠ¤ì½”í”„ì— ë…¸ì¶œ
        window.showInitialGuidePopup = window.showInitialGuidePopup || function() {
            console.log('[UI] ì´ˆê¸° ì•ˆë‚´ íŒì—… í‘œì‹œ (stub)');
        };
        window.showConfirmDialog = window.showConfirmDialog || function() {
            console.log('[UI] í™•ì¸ íŒì—… í‘œì‹œ (stub)');
        };
        window.hideConfirmDialog = window.hideConfirmDialog || function() {
            console.log('[UI] í™•ì¸ íŒì—… ìˆ¨ê¹€ (stub)');
        };
    </script>
</head>
<body>



<!-- íŒì—… ì»¨í…Œì´ë„ˆë“¤ -->
<div id="calibration-popup-container"></div>
<div id="initial-guide-popup-container"></div>
<div id="confirm-popup-container"></div>
<div id="camera-warning-popup-container"></div>

<!-- ìº˜ë¦¬ë¸Œë ˆì´ì…˜ íŒì—…ì€ popup-loader.jsì—ì„œ ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
 
 <!-- ìƒë‹¨ í—¤ë” -->
 <header class="top-header">
   <div class="logo">
     <div class="logo-icon">ğŸ¬</div>
     <span>ë°ì´íŠ¸ ì¥ì†Œ</span>
   </div>
   <div class="user-info">
     <div class="action-buttons">
       <button id="recalibrate-btn" class="action-btn">ìì„¸ ë‹¤ì‹œ ì¸¡ì •í•˜ê¸°</button>
       <button id="end-session-btn" class="action-btn primary">ë°ì´íŠ¸ ëë‚´ê¸°</button>
     </div>
   </div>
 </header>

<div class="main-content" id="main-content">

  <div id="feedbackPanel" class="feedback-panel">
      <div class="card">
        <header>
          <span>ğŸ’¡ AI ì¢…í•© í”¼ë“œë°±</span>
          <button id="closeBtn" class="close-btn">&times;</button>
        </header>
        <section class="body">
          <!-- í˜¸ê°ë„ ì„¹ì…˜ (ê°œì„ ëœ ë©”ì¸) -->
          <div class="likability-section-enhanced">
            <div class="likability-header">
              <h3 class="likability-main-title">ğŸ’ í˜¸ê°ë„</h3>
              <div class="likability-subtitle">AIê°€ ëŠë¼ëŠ” ë‹¹ì‹ ì˜ ë§¤ë ¥</div>
            </div>
            <div class="likability-content">
              <div class="likability-circle-enhanced">
                <svg viewBox="0 0 120 120">
                  <defs>
                    <linearGradient id="likability-gradient-enhanced" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" stop-color="#667eea" />
                      <stop offset="50%" stop-color="#764ba2" />
                      <stop offset="100%" stop-color="#f093fb" />
                    </linearGradient>
                    <filter id="glow">
                      <fegaussianblur stdDeviation="3" result="coloredBlur"/>
                      <femerge> 
                        <femergenode in="coloredBlur"/>
                        <femergenode in="SourceGraphic"/>
                      </femerge>
                    </filter>
                  </defs>
                  <circle class="circle-bg-enhanced" cx="60" cy="60" r="50" stroke="rgba(255,255,255,0.1)" stroke-width="8" fill="none"/>
                  <circle id="likability-progress-enhanced" class="circle-progress-enhanced" cx="60" cy="60" r="50" stroke="url(#likability-gradient-enhanced)" stroke-width="8" fill="none" stroke-linecap="round" filter="url(#glow)" transform="rotate(-90 60 60)"/>
                </svg>
                <div class="likability-inner">
                  <div id="likability-score-enhanced" class="likability-score-enhanced">-<span class="score-unit">%</span></div>
                  <div class="likability-status" id="likability-status">ì¸¡ì • ì¤‘</div>
              </div>
              </div>
              <div class="likability-factors">
                <div class="factor-item">
                  <span class="factor-icon">ğŸ˜Š</span>
                  <span class="factor-text">í‘œì •</span>
                  <span class="factor-score" id="factor-expression">-</span>
                </div>
                <div class="factor-item">
                  <span class="factor-icon">ğŸµ</span>
                  <span class="factor-text">ìŒì„±</span>
                  <span class="factor-score" id="factor-voice">-</span>
                </div>
                <div class="factor-item">
                  <span class="factor-icon">ğŸ’¬</span>
                  <span class="factor-text">ëŒ€í™”</span>
                  <span class="factor-score" id="factor-conversation">-</span>
                </div>
              </div>
            </div>
          </div>

          <!-- ëŒ€í™” í’ˆì§ˆ ì„¹ì…˜ -->
          <div class="feedback-section">
            <h3 class="section-title">ğŸ’¬ ëŒ€í™” í’ˆì§ˆ</h3>
            <div class="metrics-grid">
              <div class="metric-card" onclick="showInitiativeDetails()" style="cursor: pointer;">
                <div class="metric-icon">ğŸ­</div>
                <div class="metric-content">
                  <div class="metric-title">ëŒ€í™” ì£¼ë„ê¶Œ</div>
                  <div class="initiative-container">
                    <div class="initiative-labels">
                      <span class="user-label">ë‚˜</span>
                      <span class="ai-label">AI</span>
                    </div>
                    <div class="initiative-bar">
                      <div id="user-initiative-bar" class="user-bar" style="width: 50%;"></div>
                      <div id="ai-initiative-bar" class="ai-bar" style="width: 50%;"></div>
                    </div>
                    <div id="initiative-status" class="initiative-status">ê· í˜•ì </div>
                  </div>
                </div>
              </div>
              
              <div class="metric-card" onclick="showExpressionDetails()" style="cursor: pointer;">
                <div class="metric-icon">ğŸ˜Š</div>
                <div class="metric-content">
                  <div class="metric-title">í‘œì •</div>
                  <div id="expression-score" class="metric-value">-%</div>
                  <div id="expression-status" class="metric-status" style="font-size: 10px; color: #6b7280; margin-top: 2px;">ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
                </div>
              </div>
              
              <div class="metric-card">
                <div class="metric-icon">ğŸ—£ï¸</div>
                <div class="metric-content">
                  <div class="metric-title">ë§íˆ¬</div>
                  <div id="tone-score" class="metric-value">-%</div>
                </div>
              </div>
            </div>
          </div>

          <!-- ì‹ ì²´ ì–¸ì–´ ì„¹ì…˜ -->
          <div class="feedback-section">
            <h3 class="section-title">ğŸ¯ ì‹ ì²´ ì–¸ì–´</h3>
            <div class="metrics-grid">
              <div class="metric-card" onclick="showGazeDetails()" style="cursor: pointer;">
                <div class="metric-icon">ğŸ‘ï¸</div>
                <div class="metric-content">
                  <div class="metric-title">ì‹œì„  ì•ˆì •ì„±</div>
                  <div id="gaze-score" class="metric-value">-%</div>
                  <div id="gaze-status" class="metric-status" style="font-size: 10px; color: #6b7280; margin-top: 2px;">ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
                </div>
              </div>
              
              <div class="metric-card" onclick="showConcentrationDetails()" style="cursor: pointer;">
                <div class="metric-icon">ğŸ¯</div>
                <div class="metric-content">
                  <div class="metric-title">ì§‘ì¤‘ë„</div>
                  <div id="concentration-score" class="metric-value">-%</div>
                  <div id="concentration-status" class="metric-status" style="font-size: 10px; color: #6b7280; margin-top: 2px;">ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
                </div>
              </div>
              
              <div class="metric-card" onclick="showPostureDetails()" style="cursor: pointer;">
                <div class="metric-icon">âœ¨</div>
                <div class="metric-content">
                  <div class="metric-title">ìì„¸</div>
                  <div id="posture-score" class="metric-value">-%</div>
                  <div id="posture-status" class="metric-status" style="font-size: 10px; color: #6b7280; margin-top: 2px;">ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
                </div>
              </div>
              
              <div class="metric-card" onclick="showBlinkingDetails()" style="cursor: pointer;">
                <div class="metric-icon">ğŸ˜‰</div>
                <div class="metric-content">
                  <div class="metric-title">ê¹œë¹¡ì„</div>
                  <div id="blinking-score" class="metric-value">-%</div>
                  <div id="blinking-status" class="metric-status" style="font-size: 10px; color: #6b7280; margin-top: 2px;">ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
                </div>
              </div>
            </div>
          </div>

          <!-- ì¢…í•© ì ìˆ˜ ì„¹ì…˜ -->
          <div class="total-score-section">
            <div class="total-score-card" onclick="showComprehensiveScoreDetails()" style="cursor: pointer;">
              <div class="total-score-icon">ğŸ†</div>
              <div class="total-score-content">
                <div class="total-score-title">ì¢…í•© ì ìˆ˜</div>
                <div id="total-score" class="total-score-value">-%</div>
                <div class="total-score-subtitle">ì‹œê° 55% + ì²­ê° 38% + ëŒ€í™” 7%</div>
              </div>
            </div>
          </div>
          
          <!-- AI í”¼ë“œë°± ì„¹ì…˜ -->
          <div id="ai-feedback-summary" class="ai-feedback-section">
            <div class="ai-feedback-header">
              <span class="ai-feedback-icon">ğŸ¯</span>
              <span class="ai-feedback-title">ì‹¤ì‹œê°„ ê¿€íŒ!</span>
            </div>
            <ol class="ai-feedback-list">
                <li>ìƒëŒ€ë°©ì˜ ë§ì— ê¸ì •ì ìœ¼ë¡œ ë°˜ì‘í•´ë³´ì„¸ìš”.</li>
                <li>ëŒ€í™”ê°€ ëŠê¸°ì§€ ì•Šê²Œ ì§ˆë¬¸ì„ ë˜ì ¸ë³´ì„¸ìš”.</li>
                <li>ìì‹ ê° ìˆëŠ” ëª©ì†Œë¦¬ë¡œ ë§í•˜ëŠ” ê²ƒì„ ìŠì§€ ë§ˆì„¸ìš”!</li>
            </ol>
          </div>
        </section>
      </div>
    </div>

    <!-- ê¹œë¹¡ì„ ìƒì„¸ ì •ë³´ íŒì—… -->
    <div id="blinking-popup-container"></div>

    <button id="feedbackToggleBtn" class="feedback-toggle-btn">í”¼ë“œë°±</button>

    <!-- ëŒ€í™” ì£¼ë„ê¶Œ ìƒì„¸ ì •ë³´ íŒì—… -->
    <div id="initiative-popup-container"></div>

    <!-- í‘œì • ìƒì„¸ ì •ë³´ íŒì—… -->
    <div id="expression-popup-container"></div>


    <!-- ì‹œì„  ì•ˆì •ì„± ìƒì„¸ ì •ë³´ íŒì—… -->
    <div id="gaze-popup-container"></div>

    <!-- ì§‘ì¤‘ë„ ìƒì„¸ ì •ë³´ íŒì—… -->
    <div id="concentration-popup-container"></div>

    <!-- ìì„¸ ìƒì„¸ ì •ë³´ íŒì—… -->
    <div id="posture-popup-container"></div>

         <div class="card video-container">
       <header>â¤ï¸ ë°ì´íŠ¸ ì¤‘</header>
               <div class="video-wrapper">
           <div id="video-loading" class="video-loading">
             <div class="loading-spinner"></div>
             <p>ë¹„ë””ì˜¤ ë¡œë”© ì¤‘...</p>
           </div>
           <video id="video" poster="https://placehold.co/1280x720/e0e8ff/ffffff?text=Video+Stream" playsinline loop></video>
        </div>
       <section class="body">
         <div class="suggestion-container">
             <h4>ì´ëŸ° ì£¼ì œë¡œ ë¬¼ì–´ë³´ì„¸ìš”</h4>
             <div class="suggestion-tags">
                 <button class="tag">ìµœê·¼ì— ë³¸ ì˜í™”</button>
                 <button class="tag">ì£¼ë§ ê³„íš</button>
                 <button class="tag">ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ìŒì‹</button>
                 <button class="tag">ìš”ì¦˜ ì¦ê²¨ë“£ëŠ” ë…¸ë˜</button>
             </div>
         </div>
       </section>
     </div>

     <div class="card">
       <header>ğŸ’¬ ëŒ€í™” ì¤‘</header>
       <div class="chat-log" id="chatLog"></div>
       <div class="persona-info-section" id="personaInfoSection">
         <!-- Persona ì¹´ë“œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
       </div>
       <div class="chat-input">
           <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
           <button id="inputBtn" class="input-btn" title="ë©”ì‹œì§€ ì „ì†¡">
                               <img src="" alt="ì „ì†¡" id="inputIcon">
           </button>
         </div>
    </div>
</div>

<script>
// --- ì„œë²„/ì—”ë“œí¬ì¸íŠ¸ ì„¤ì • (Vercel í”„ë¡ì‹œ ì‚¬ìš©) ---
const serverUrl = window.__API_BASE__ || "https://dys-phi.vercel.app/api/gke";
const apiEndpoints = {
  chat: `${serverUrl}/api/chat`,
  feedback: `${serverUrl}/api/feedback`,
  calibration: `${serverUrl}/api/calibration`,
  user_check: `${serverUrl}/api/user/check`,
  frame: `${serverUrl}/api/frame`,          // í”„ë ˆì„ ì—…ë¡œë“œ
  landmarks: `${serverUrl}/api/landmarks`,
};
// ì „ì—­ ìŠ¤ì½”í”„ì— ë…¸ì¶œí•˜ì—¬ ëª¨ë“ˆì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • (UI ì „ìš©)
window.serverUrl = serverUrl;
window.apiEndpoints = apiEndpoints;

// ì´ë¯¸ì§€ ê²½ë¡œ ë™ì  ì„¤ì •
document.addEventListener('DOMContentLoaded', function() {
    const cameraIcon = document.getElementById('cameraIcon');
    const inputIcon = document.getElementById('inputIcon');
    
    if (cameraIcon) {
                    cameraIcon.src = `${window.serverUrl}/frontend/assets/images/icon/camera.webp`;
    }
    
    if (inputIcon) {
        inputIcon.src = `${window.serverUrl}/frontend/assets/images/icon/enter_icon.webp`;
    }
});

// ë¶„ì„ íŒŒì´í”„ë¼ì¸ ì œê±°ë¨ (UI ì „ìš©)

// --- ë³´ì•ˆ ê°•í™”: URL íŒŒë¼ë¯¸í„°ë¥¼ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•˜ê³  URL ì •ë¦¬ ---
function secureUserData() {
    // URLì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
const urlParams = new URLSearchParams(window.location.search);
    const userData = {
        user_id: urlParams.get('user_id'),
        email: urlParams.get('email'),
        token: urlParams.get('token'),
        persona_name: urlParams.get('persona_name'),
        persona_age: urlParams.get('persona_age'),
        persona_mbti: urlParams.get('persona_mbti'),
        persona_job: urlParams.get('persona_job'),
        persona_personality: urlParams.get('persona_personality'),
        persona_image: urlParams.get('persona_image')
    };

    // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì•ˆì „í•˜ê²Œ ì €ì¥
    sessionStorage.setItem('userData', JSON.stringify(userData));

    // URLì—ì„œ ë¯¼ê°í•œ ì •ë³´ ì œê±° (íˆìŠ¤í† ë¦¬ ë³€ê²½ ì—†ì´)
    const cleanUrl = new URL(window.location.href);
    cleanUrl.search = '';
    window.history.replaceState({}, document.title, cleanUrl.pathname);
}

// --- ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ---
function getUserData() {
    const userDataStr = sessionStorage.getItem('userData');
    if (!userDataStr) {
        console.error('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return null;
    }
    return JSON.parse(userDataStr);
}

// --- ì „ì—­ ë³€ìˆ˜ë¡œ ì‚¬ìš©ì ì •ë³´ ì„¤ì • ---
let userId, email, token, personaName, personaAge, personaMbti, personaJob, personaPersonality, personaImage;

// ì „ì—­ ìŠ¤ì½”í”„ì— ë…¸ì¶œí•˜ì—¬ ëª¨ë“ˆì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
window.userId = userId;
window.email = email;
window.token = token;
window.personaName = personaName;
window.personaAge = personaAge;
window.personaMbti = personaMbti;
window.personaJob = personaJob;
window.personaPersonality = personaPersonality;
window.personaImage = personaImage;

// --- ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™” ---
function initializeUserData() {
    const userData = getUserData();
    if (userData) {
        userId = userData.user_id;
        email = userData.email;
        token = userData.token;
        personaName = userData.persona_name;
        personaAge = userData.persona_age;
        personaMbti = userData.persona_mbti;
        personaJob = userData.persona_job;
        personaPersonality = userData.persona_personality;
        personaImage = userData.persona_image;
        
        // ì „ì—­ ìŠ¤ì½”í”„ì— ì—…ë°ì´íŠ¸
        window.userId = userId;
        window.email = email;
        window.token = token;
        window.personaName = personaName;
        window.personaAge = personaAge;
        window.personaMbti = personaMbti;
        window.personaJob = personaJob;
        window.personaPersonality = personaPersonality;
        window.personaImage = personaImage;
        
        console.log('âœ… ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™” ì™„ë£Œ');
        return true;
    } else {
        console.error('âŒ ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return false;
    }
}

// --- ê¸°ë³¸ Persona ì •ë³´ ì„¤ì • (ì‚¬ìš©ì ì •ë³´ê°€ ì—†ì„ ë•Œ) ---
function setDefaultPersonaInfo() {
    if (!window.personaName) {
        window.personaName = 'ì´ì„œì•„';
        window.personaAge = '28';
        window.personaMbti = 'ENFP';
        window.personaJob = 'ë§ˆì¼€íŒ… ë‹´ë‹¹ì';
        window.personaPersonality = 'ë°ê³  ì¹œê·¼í•œ';
        window.personaImage = 'woman1.webp';
        
        console.log('âœ… ê¸°ë³¸ Persona ì •ë³´ ì„¤ì • ì™„ë£Œ:', window.personaName);
    }
}

// --- í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œ ì‚¬ìš©ì ì •ë³´ ë³µêµ¬ ---
function restoreUserDataOnRefresh() {
    // URLì— íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('user_id')) {
        secureUserData();
        
        // ì—ëŸ¬ íŒŒë¼ë¯¸í„° ì²´í¬ ë° ì²˜ë¦¬
        const error = urlParams.get('error');
        if (error) {
            handlePageError(error);
            return false; // ì—ëŸ¬ê°€ ìˆìœ¼ë©´ ì´ˆê¸°í™” ì¤‘ë‹¨
        }
        
        // ì„¸ì…˜ ì¢…ë£Œ ì„±ê³µ íŒŒë¼ë¯¸í„° ì²´í¬ ë° ì²˜ë¦¬
        const sessionEnded = urlParams.get('session_ended');
        if (sessionEnded === 'true') {
            handleSessionEnded();
        }
        
        // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ê±´ë„ˆë›°ê¸° íŒŒë¼ë¯¸í„° ì²´í¬
        const skipCalibration = urlParams.get('skip_calibration');
        if (skipCalibration === 'true') {
            // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ê±´ë„ˆë›°ê¸° í”Œë˜ê·¸ë¥¼ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            sessionStorage.setItem('skipCalibration', 'true');
        }
        
        return true;
    }
    
    // URLì— íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë³µêµ¬ ì‹œë„
    const userData = getUserData();
    if (userData) {
        initializeUserData();
        return true;
    }
    
    return false;
}

// --- í˜ì´ì§€ ì—ëŸ¬ ì²˜ë¦¬ ---
function handlePageError(error) {
    console.error('âŒ í˜ì´ì§€ ì—ëŸ¬ ë°œìƒ:', error);
    
    let errorMessage = '';
    let errorTitle = '';
    
    switch (error) {
        case 'session_end_failed':
            errorTitle = 'ì„¸ì…˜ ì¢…ë£Œ ì‹¤íŒ¨';
            errorMessage = 'ë°ì´íŠ¸ ì„¸ì…˜ì„ ì¢…ë£Œí•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            break;
        case 'user_not_found':
            errorTitle = 'ì‚¬ìš©ì ì •ë³´ ì—†ìŒ';
            errorMessage = 'ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
            break;
        default:
            errorTitle = 'ì˜¤ë¥˜ ë°œìƒ';
            errorMessage = 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.';
    }
    
    // ì—ëŸ¬ íŒì—… í‘œì‹œ
    showErrorPopup(errorTitle, errorMessage);
}

// --- ì—ëŸ¬ íŒì—… í‘œì‹œ ---
function showErrorPopup(title, message) {
    // ê¸°ì¡´ ì—ëŸ¬ íŒì—…ì´ ìˆìœ¼ë©´ ì œê±°
    const existingError = document.getElementById('error-popup');
    if (existingError) {
        existingError.remove();
    }
    
    // ì—ëŸ¬ íŒì—… ìƒì„±
    const errorPopup = document.createElement('div');
    errorPopup.id = 'error-popup';
    errorPopup.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 5000;
        display: flex;
        justify-content: center;
        align-items: center;
    `;
    
    errorPopup.innerHTML = `
        <div style="
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        ">
            <div style="
                width: 60px;
                height: 60px;
                background: #ef4444;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 20px;
                font-size: 24px;
                color: white;
            ">âš ï¸</div>
            <h3 style="margin: 0 0 16px; color: #1f2937; font-size: 20px;">${title}</h3>
            <p style="margin: 0 0 24px; color: #6b7280; line-height: 1.5;">${message}</p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button onclick="retrySession()" style="
                    padding: 12px 24px;
                    background: #6c7cff;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                ">ë‹¤ì‹œ ì‹œë„</button>
                <button onclick="goToHome()" style="
                    padding: 12px 24px;
                    background: #e5e7eb;
                    color: #374151;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                ">í™ˆìœ¼ë¡œ</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(errorPopup);
}

// --- ë‹¤ì‹œ ì‹œë„ í•¨ìˆ˜ ---
function retrySession() {
    const errorPopup = document.getElementById('error-popup');
    if (errorPopup) {
        errorPopup.remove();
    }
    
    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    window.location.reload();
}

// --- í™ˆìœ¼ë¡œ ì´ë™ í•¨ìˆ˜ ---
function goToHome() {
    // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬
    sessionStorage.clear();
    
    // í™ˆí˜ì´ì§€ë¡œ ì´ë™ (ì‹¤ì œ í™ˆí˜ì´ì§€ URLë¡œ ë³€ê²½ í•„ìš”)
    window.location.href = '/';
}

// --- ì„¸ì…˜ ì¢…ë£Œ ì„±ê³µ ì²˜ë¦¬ ---
function handleSessionEnded() {
    console.log('âœ… ì„¸ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    
    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
    showSuccessMessage();
    
    // URLì—ì„œ session_ended íŒŒë¼ë¯¸í„° ì œê±°
    const url = new URL(window.location.href);
    url.searchParams.delete('session_ended');
    url.searchParams.delete('session_id');
    window.history.replaceState({}, document.title, url.toString());
}

// --- ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ ---
function showSuccessMessage() {
    // ê¸°ì¡´ ì„±ê³µ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì œê±°
    const existingSuccess = document.getElementById('success-message');
    if (existingSuccess) {
        existingSuccess.remove();
    }
    
    // ì„±ê³µ ë©”ì‹œì§€ ìƒì„±
    const successMessage = document.createElement('div');
    successMessage.id = 'success-message';
    successMessage.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        z-index: 4000;
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideInRight 0.3s ease-out;
        max-width: 300px;
    `;
    
    successMessage.innerHTML = `
        <div style="font-size: 20px;">âœ…</div>
        <div>
            <div style="font-weight: 600; margin-bottom: 4px;">ë°ì´íŠ¸ ì™„ë£Œ!</div>
            <div style="font-size: 14px; opacity: 0.9;">ì„¸ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</div>
        </div>
        <button onclick="closeSuccessMessage()" style="
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.7;
            padding: 4px;
            border-radius: 4px;
        ">Ã—</button>
    `;
    
    document.body.appendChild(successMessage);
    
    // 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¸°ê¸°
    setTimeout(() => {
        closeSuccessMessage();
    }, 5000);
}

// --- ì„±ê³µ ë©”ì‹œì§€ ë‹«ê¸° ---
function closeSuccessMessage() {
    const successMessage = document.getElementById('success-message');
    if (successMessage) {
        successMessage.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
            successMessage.remove();
        }, 300);
    }
}

// --- ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ ì¶”ê°€ ---
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

// --- ëª¨ë“ˆ ë¡œë”© ìœ í‹¸ë¦¬í‹° ---
/**
 * ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆì´ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
 * @param {number} timeout - íƒ€ì„ì•„ì›ƒ (ms)
 * @returns {Promise<void>}
 */
async function waitForCalibrationModule(timeout = 5000) {
    const startTime = Date.now();
    
    while (typeof window.CalibrationModule === 'undefined') {
        if (Date.now() - startTime > timeout) {
            console.error('[CALIBRATION] ëª¨ë“ˆ ë¡œë”© íƒ€ì„ì•„ì›ƒ');
            throw new Error('ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ë¡œë”© ì‹¤íŒ¨');
        }
        // 10msë§ˆë‹¤ ì²´í¬ (non-blocking)
        await new Promise(resolve => setTimeout(resolve, 10));
    }
}

// --- ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ë¡œì§ (ë³„ë„ íŒŒì¼ë¡œ ë¶„ë¦¬ë¨) ---
document.addEventListener('DOMContentLoaded', async () => {
    // íŒì—… ë¡œë“œ
    await loadAllPopups();
    
    // ì±„íŒ… ë§¤ë‹ˆì € ì´ˆê¸°í™”
    if (window.ChatManager) {
        window.chatManager = new window.ChatManager({ chatLog, chatInput, inputBtn });
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë“  ë©”íŠ¸ë¦­ ì´ˆê¸°í™”
    setTimeout(() => {
        resetAllMetrics();
    }, 100);
    
    // ì‚¬ìš©ì ë°ì´í„° ë³´ì•ˆ ì²˜ë¦¬ ë° ì´ˆê¸°í™”
    const userDataRestored = restoreUserDataOnRefresh();
    if (!userDataRestored) {
        console.error('ì‚¬ìš©ì ì •ë³´ë¥¼ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë‹¤ì‹œ ë¡œë“œí•´ì£¼ì„¸ìš”.');
        // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ í‘œì‹œ
        alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ì „ í˜ì´ì§€ë¡œ ëŒì•„ê°€ì„œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        window.history.back();
        return;
    }
    
    // ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™” (ì´ ë¶€ë¶„ì´ ëˆ„ë½ë˜ì–´ ìˆì—ˆìŒ)
    const userDataInitialized = initializeUserData();
    if (!userDataInitialized) {
        console.error('ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        alert('ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        window.location.reload();
        return;
    }
    
    // ê¸°ë³¸ Persona ì •ë³´ ì„¤ì • (ì‚¬ìš©ì ì •ë³´ê°€ ì—†ì„ ë•Œ)
    setDefaultPersonaInfo();
    
    // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ë¡œë”© ëŒ€ê¸° ë° ì´ˆê¸°í™”
    await waitForCalibrationModule();
    console.log('[CALIBRATION] ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ - ì´ˆê¸°í™” ì‹œì‘');
    
    // ì‚¬ìš©ì ì •ë³´ê°€ ì´ˆê¸°í™”ëœ í›„ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™”
    if (window.CalibrationModule && typeof window.CalibrationModule.initializeCalibration === 'function') {
        console.log('[CALIBRATION] ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™” ì™„ë£Œ - ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™” ì‹œì‘');
        
        // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™” (ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • í¬í•¨)
        if (typeof window.initializeCalibrationModule === 'function') {
            window.initializeCalibrationModule();
        }
        
        // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ìƒíƒœ í™•ì¸ ë° ì´ˆê¸°í™”
        window.CalibrationModule.initializeCalibration();
        
        // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™” ì™„ë£Œ - ì‚¬ìš©ì ì„ íƒ ëŒ€ê¸°
        console.log('[APP] ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™” ì™„ë£Œ - ì‚¬ìš©ì ì„ íƒ ëŒ€ê¸° ì¤‘');
        // ì‚¬ìš©ìê°€ "ê±´ë„ˆë›°ê¸°"ë¥¼ ëˆ„ë¥´ê±°ë‚˜ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ì„ ì™„ë£Œí•œ í›„ì—ë§Œ ì•± ì‹œì‘ë¨
        
        // ì•± ì‹œì‘ í”Œë˜ê·¸ ê°ì§€
        const checkAppStart = () => {
            if (window.__readyToStartApp) {
                console.log('[APP] ì‚¬ìš©ì ì„ íƒ ê°ì§€ - ì•± ì‹œì‘');
                initializeApp();
            } else {
                setTimeout(checkAppStart, 100); // 100msë§ˆë‹¤ í™•ì¸
            }
        };
        checkAppStart();
    } else {
        console.error('[CALIBRATION] ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™” í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆì´ ì—†ì–´ë„ ì‚¬ìš©ì ì„ íƒì„ ê¸°ë‹¤ë¦¼
        console.log('[APP] ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì—†ìŒ - ì‚¬ìš©ì ì„ íƒ ëŒ€ê¸° ì¤‘');
    }
    
    // ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìƒì„± (ê°œë°œ ëª¨ë“œì—ì„œë§Œ)
    if (window.PerformanceMonitor && window.location.hostname === 'localhost') {
        window.PerformanceMonitor.generateReport();
    }
    
    // ìŒì„± ì…ë ¥ ê´€ë¦¬ì ì´ˆê¸°í™” (ì§€ì—° ì‹¤í–‰)
    setTimeout(() => {
        if (window.VoiceInputManager) {
            window.voiceManager = new VoiceInputManager();
            console.log('[VOICE] ìŒì„± ì…ë ¥ ê´€ë¦¬ì ì´ˆê¸°í™” ì™„ë£Œ');
        } else {
            console.warn('[VOICE] VoiceInputManagerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // TTS ê´€ë¦¬ì ì´ˆê¸°í™”
        if (window.TTSManager) {
            window.ttsManager = new TTSManager();
            console.log('[TTS] TTS ê´€ë¦¬ì ì´ˆê¸°í™” ì™„ë£Œ');
        } else {
            console.warn('[TTS] TTSManagerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
    }, 500);
});

// --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
const feedbackPanel = document.getElementById('feedbackPanel');
const feedbackToggleBtn = document.getElementById('feedbackToggleBtn');
const closeBtn = document.getElementById('closeBtn');
const chatLog = document.getElementById('chatLog');
const chatInput = document.getElementById('chatInput');
const inputBtn = document.getElementById('inputBtn');
const inputIcon = document.getElementById('inputIcon');

// ëª¨ë“  ë©”íŠ¸ë¦­ ì´ˆê¸°í™” í•¨ìˆ˜
function resetAllMetrics() {
  console.log('[UI] ğŸ”„ ëª¨ë“  ë©”íŠ¸ë¦­ ì´ˆê¸°í™” ì‹œì‘');
  
  // DOM ìš”ì†Œë“¤ ì´ˆê¸°í™”
  const elements = {
    posture: document.getElementById('posture-score'),
    gaze: document.getElementById('gaze-score'),
    concentration: document.getElementById('concentration-score'),
    blink: document.getElementById('blinking-score'),
    expression: document.getElementById('expression-score'),
    total: document.getElementById('total-score')
  };
  
  // ì ìˆ˜ ì´ˆê¸°í™”
  Object.values(elements).forEach(element => {
    if (element) {
      element.textContent = '0%';
      element.style.color = '#6b7280'; // íšŒìƒ‰ìœ¼ë¡œ ë³€ê²½
    }
  });
  
  // ìƒíƒœ í‘œì‹œ ì´ˆê¸°í™”
  const statusElements = {
    expression: document.getElementById('expression-status'),
    gaze: document.getElementById('gaze-status'),
    concentration: document.getElementById('concentration-status'),
    posture: document.getElementById('posture-status'),
    blinking: document.getElementById('blinking-status')
  };
  
  Object.values(statusElements).forEach(element => {
    if (element) {
      element.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
      element.style.color = '#6b7280';
    }
  });
  
  // ì „ì—­ ë°ì´í„° ì´ˆê¸°í™” (UI-only mode)
  if (window.PopupManager) {
      window.PopupManager.currentExpressionData = null;
  }
  
  // í‘œì • ë¶„ì„ ë°ì´í„° ì´ˆê¸°í™” (ì´ˆê¸°ì—ëŠ” ì ìˆ˜ ë¯¸í‘œì‹œ)
  lastExpressionScore = null;
  lastExpressionText = '-';
  lastExpressionUpdate = 0;
  
  // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸° ì´ˆê¸°í™”
  if (window.ComprehensiveScoreCalculator) {
      window.ComprehensiveScoreCalculator.resetAllScores();
  }
  
  // ëŒ€í™” ì£¼ë„ê¶Œ ë¶„ì„ê¸° ì´ˆê¸°í™”
  if (window.ConversationAnalyzer) {
        window.ConversationAnalyzer.chatHistory = window.chatManager ? window.chatManager.chatHistory : [];
      window.ConversationAnalyzer.analyzeConversation();
  }
  
  console.log('[UI] âœ… ëª¨ë“  ë©”íŠ¸ë¦­ ì´ˆê¸°í™” ì™„ë£Œ');
}

function updateCameraMetrics(metrics) {
  // ìŠ¤ë¡œí‹€ë§: 500msë§ˆë‹¤ í•œ ë²ˆì”©ë§Œ ì—…ë°ì´íŠ¸
  const now = Date.now();
  if (window.__lastUIUpdate__ && (now - window.__lastUIUpdate__) < 500) {
    return; // ë„ˆë¬´ ë¹ ë¥¸ ì—…ë°ì´íŠ¸ ë°©ì§€
  }
  window.__lastUIUpdate__ = now;
  
  // ì¹´ë©”ë¼ ì—°ê²° ìƒíƒœ í™•ì¸
  const isCameraConnected = metrics && Object.keys(metrics).length > 0;
  if (!isCameraConnected) {
    console.log('[UI] âš ï¸ ì¹´ë©”ë¼ ë°ì´í„° ì—†ìŒ - UI ì´ˆê¸°í™”');
    resetAllMetrics();
    return;
  }
  
      // metrics: {scores:{attention, stability, blink, posture}, labels:{expression}}
    console.log(`[UI] ğŸ–¥ï¸ updateCameraMetrics í˜¸ì¶œë¨ (UI-only mode):`, {
      timestamp: new Date().toISOString()
    });
  
      try {
      // DOM ìš”ì†Œ ì¡´ì¬ í™•ì¸
      const postureElement = document.getElementById('posture-score');
      const gazeElement = document.getElementById('gaze-score');
      const concentrationElement = document.getElementById('concentration-score');
      const blinkElement = document.getElementById('blinking-score');
      const expressionElement = document.getElementById('expression-score');
      
      console.log('[UI] ğŸ” DOM ìš”ì†Œ í™•ì¸:', {
        postureElement: !!postureElement,
        gazeElement: !!gazeElement,
        concentrationElement: !!concentrationElement,
        blinkElement: !!blinkElement,
        expressionElement: !!expressionElement
      });
      
      if (!postureElement || !gazeElement || !concentrationElement || !blinkElement || !expressionElement) {
        console.warn('[UI] âš ï¸ í•„ìš”í•œ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
    
    // ì–¼êµ´ ì¸ì‹ ìƒíƒœ í™•ì¸ (ì™„í™”)
    const cameraBlocked = metrics?.coaching_message === 'ì¹´ë©”ë¼ê°€ ë³´ì´ì§€ ì•Šì•„ì„œ í”¼ë“œë°±ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    const noFace = metrics?.status === 'no-face';
    const isFaceDetected = !(cameraBlocked || noFace);
    
    console.log('[UI] ğŸ‘¤ ì–¼êµ´ ì¸ì‹ ìƒíƒœ:', {
      cameraBlocked,
      noFace,
      isFaceDetected,
      coaching_message: metrics?.coaching_message,
      status: metrics?.status
    });
    
    if (!isFaceDetected) {
      console.log('[UI] âš ï¸ ì–¼êµ´ì´ ê°ì§€ë˜ì§€ ì•ŠìŒ - UI ì´ˆê¸°í™”');
      postureElement.textContent = '-';
      gazeElement.textContent = '-';
      concentrationElement.textContent = '-';
      blinkElement.textContent = '-';
      expressionElement.textContent = '-';
      
      // ì¹´ë©”ë¼ ìœ„ì¹˜/ì •ë³´ ë¶€ì¡± ê²½ê³  í‘œì‹œ
      showCameraWarningInline();
      
      // ìƒíƒœ í‘œì‹œë„ ì´ˆê¸°í™”
      const expressionStatusElement = document.getElementById('expression-status');
      const gazeStatusElement = document.getElementById('gaze-status');
      const concentrationStatusElement = document.getElementById('concentration-status');
      
      if (expressionStatusElement) {
        expressionStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        expressionStatusElement.style.color = '#6b7280';
      }
      if (gazeStatusElement) {
        gazeStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        gazeStatusElement.style.color = '#6b7280';
      }
      if (concentrationStatusElement) {
        concentrationStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        concentrationStatusElement.style.color = '#6b7280';
      }
      
      // ì „ì—­ ë°ì´í„°ë„ ì´ˆê¸°í™” (UI-only mode)
      currentExpressionData = null;
      
      // í‘œì • ë¶„ì„ ë°ì´í„° ì´ˆê¸°í™”
      lastExpressionScore = null;
      lastExpressionText = '-';
      lastExpressionUpdate = 0;
      
      return;
    } else {
      // ì–¼êµ´ì´ ê°ì§€ë˜ë©´ ì¹´ë©”ë¼ ê²½ê³  ìˆ¨ê¸°ê¸°
      hideCameraWarningInline();
    }
    
    // ìì„¸ ì ìˆ˜ ê³„ì‚° (í†µì¼ëœ scores ê°ì²´ ìš°ì„  ì‚¬ìš©)
    let postureScore = null;
    
    // ìš°ì„ ìˆœìœ„ 1: í†µì¼ëœ scores ê°ì²´ ì‚¬ìš©
    if (metrics?.scores?.posture != null) {
        postureScore = Math.round(metrics.scores.posture);
        console.log('[UI] âœ… scores.posture ì‚¬ìš©:', postureScore);
    } else if (metrics?.neckAnalysis && metrics?.shoulderAnalysis) {
            // UI-only mode: MediaPipe ì§ì ‘ ë¶„ì„ ë°ì´í„° ì²˜ë¦¬ ë¹„í™œì„±í™”
    console.log('[UI] (noop) MediaPipe ì§ì ‘ ë¶„ì„ ë°ì´í„° ì²˜ë¦¬ ë¹„í™œì„±í™”ë¨');
    } else if (metrics?.neckScore !== undefined && metrics?.shoulderScore !== undefined) {
        // ìš°ì„ ìˆœìœ„ 3: ì›Œì»¤ ë°ì´í„° êµ¬ì¡° (ì§ì ‘ ì ìˆ˜)
        const neckScore = metrics.neckScore || 0;
        const shoulderScore = metrics.shoulderScore || 0;
        postureScore = Math.round((neckScore + shoulderScore) / 2);
        console.log('[UI] ì›Œì»¤ ë°ì´í„° ìì„¸ ì ìˆ˜ ê³„ì‚°:', { neckScore, shoulderScore, postureScore });
    } else if (metrics?.neckAnalysis) {
        // ìš°ì„ ìˆœìœ„ 4: ëª© ë¶„ì„ë§Œ ì‚¬ìš©
        postureScore = metrics.neckAnalysis.postureScore ?? null;
        console.log('[UI] ëª© ë¶„ì„ë§Œ ì‚¬ìš©:', postureScore);
    } else {
        postureScore = null;
        console.log('[UI] âš ï¸ ìì„¸ ë¶„ì„ ë°ì´í„° ì—†ìŒ, ì ìˆ˜ ë¯¸í‘œì‹œ');
    }
    
    if (postureScore == null) {
      postureElement.textContent = '-';
    } else {
    postureScore = Math.min(100, Math.max(0, Math.round(postureScore)));
    postureElement.textContent = `${postureScore}%`;
    }
    
    // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ìì„¸ ì ìˆ˜ ì—…ë°ì´íŠ¸
    if (window.ComprehensiveScoreCalculator && postureScore != null) {
      window.ComprehensiveScoreCalculator.updateVisualScore('posture', postureScore);
    }
    
    // ìì„¸ ë¶„ì„ ë°ì´í„° ì €ì¥ (íŒì—…ìš©)
    if (metrics?.neckAnalysis || metrics?.shoulderAnalysis) {
      currentPostureData = {
        neckAnalysis: metrics.neckAnalysis,
        shoulderAnalysis: metrics.shoulderAnalysis,
        score: postureScore,
        timestamp: Date.now()
      };
      // ì „ì—­ ë³€ìˆ˜ë¡œë„ ë…¸ì¶œ (íŒì—…ì—ì„œ ì ‘ê·¼ìš©)
      window.currentPostureData = currentPostureData;
      console.log('[UI] ìì„¸ ë°ì´í„° ì €ì¥:', currentPostureData);
    } else {
      console.warn('[UI] âš ï¸ ìì„¸ ë¶„ì„ ë°ì´í„° ì—†ìŒ:', { 
        hasNeckAnalysis: !!metrics?.neckAnalysis,
        hasShoulderAnalysis: !!metrics?.shoulderAnalysis 
      });
    }
    
    // ìì„¸ ë¶„ì„ ìƒíƒœ ì—…ë°ì´íŠ¸
    const postureStatusElement = document.getElementById('posture-status');
    if (postureStatusElement) {
      if (postureScore != null) {
        if (postureScore >= 85) {
          postureStatusElement.textContent = 'ë§¤ìš° ìš°ìˆ˜';
          postureStatusElement.style.color = '#10b981';
        } else if (postureScore >= 70) {
          postureStatusElement.textContent = 'ìš°ìˆ˜';
          postureStatusElement.style.color = '#10b981';
        } else if (postureScore >= 55) {
          postureStatusElement.textContent = 'ì–‘í˜¸';
          postureStatusElement.style.color = '#3b82f6';
        } else if (postureScore >= 40) {
          postureStatusElement.textContent = 'ë³´í†µ';
          postureStatusElement.style.color = '#f59e0b';
        } else {
          postureStatusElement.textContent = 'ê°œì„  í•„ìš”';
          postureStatusElement.style.color = '#ef4444';
        }
      } else {
        postureStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        postureStatusElement.style.color = '#6b7280';
      }
    }
    
    console.log(`[UI] ğŸ’ª ìì„¸ ì ìˆ˜ ì—…ë°ì´íŠ¸ (UI-only mode):`, { 
      rawScore: postureScore, 
      timestamp: new Date().toISOString()
    });
    
    // ì‹œì„  ì•ˆì •ì„± ì ìˆ˜ ê³„ì‚° (í†µì¼ëœ scores ê°ì²´ ìš°ì„  ì‚¬ìš©)
    let gazeStabilityScore = null;
    
    // ìš°ì„ ìˆœìœ„ 1: í†µì¼ëœ scores ê°ì²´ ì‚¬ìš©
    if (metrics?.scores?.gaze != null) {
        gazeStabilityScore = Math.round(metrics.scores.gaze);
        console.log('[UI] âœ… scores.gaze ì‚¬ìš©:', gazeStabilityScore);
    } else if (metrics?.gazeAnalysis?.stabilityScore != null) {
        // ìš°ì„ ìˆœìœ„ 2: ê¸°ì¡´ gazeAnalysis êµ¬ì¡° ì‚¬ìš©
        gazeStabilityScore = Math.round(metrics.gazeAnalysis.stabilityScore);
        console.log('[UI] gazeAnalysis.stabilityScore ì‚¬ìš©:', gazeStabilityScore);
    } else {
        gazeStabilityScore = null;
        console.log('[UI] âš ï¸ ì‹œì„  ë¶„ì„ ë°ì´í„° ì—†ìŒ, ì ìˆ˜ ë¯¸í‘œì‹œ');
    }
    
    if (gazeStabilityScore != null) {
        gazeElement.textContent = `${gazeStabilityScore}%`;
        updateScoreColor(gazeElement, gazeStabilityScore);
        
        // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ì‹œì„  ì ìˆ˜ ì—…ë°ì´íŠ¸
        if (window.ComprehensiveScoreCalculator) {
            window.ComprehensiveScoreCalculator.updateVisualScore('gaze_stability', gazeStabilityScore);
        }
    } else {
        gazeElement.textContent = '-';
    }
    
    // ì§‘ì¤‘ë„ ì ìˆ˜ ê³„ì‚° (í†µì¼ëœ scores ê°ì²´ ìš°ì„  ì‚¬ìš©)
    let concentrationScore = null;
    
    // ìš°ì„ ìˆœìœ„ 1: í†µì¼ëœ scores ê°ì²´ ì‚¬ìš©
    if (metrics?.scores?.concentration != null) {
        concentrationScore = Math.round(metrics.scores.concentration);
        console.log('[UI] âœ… scores.concentration ì‚¬ìš©:', concentrationScore);
    } else {
        concentrationScore = null;
        console.log('[UI] âš ï¸ ì§‘ì¤‘ë„ ë¶„ì„ ë°ì´í„° ì—†ìŒ, ì ìˆ˜ ë¯¸í‘œì‹œ');
    }
    
    if (concentrationScore != null) {
        concentrationScore = Math.min(100, Math.max(0, Math.round(concentrationScore)));
        concentrationElement.textContent = `${concentrationScore}%`;
        updateScoreColor(concentrationElement, concentrationScore);
        
        // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ì§‘ì¤‘ë„ ì ìˆ˜ ì—…ë°ì´íŠ¸
        if (window.ComprehensiveScoreCalculator) {
            window.ComprehensiveScoreCalculator.updateAuditoryScore('concentration', concentrationScore);
        }
    } else {
        concentrationElement.textContent = '-';
    }
    
    // ì§‘ì¤‘ë„ ë¶„ì„ ë°ì´í„° ì €ì¥ (UI-only mode)
    console.log('[UI] (noop) ì§‘ì¤‘ë„ ë¶„ì„ ë°ì´í„° ì €ì¥ ë¹„í™œì„±í™”ë¨');
    
    // ì§‘ì¤‘ë„ ë¶„ì„ ìƒíƒœ ì—…ë°ì´íŠ¸
    const concentrationStatusElement = document.getElementById('concentration-status');
    if (concentrationStatusElement) {
      if (metrics?.gazeAnalysis && concentrationScore != null) {
        const isFocused = metrics.gazeAnalysis.isFocused;
        const gazeDirection = metrics.gazeAnalysis.gazeDirection;
        
        if (isFocused && gazeDirection === 'center') {
          concentrationStatusElement.textContent = 'ì§‘ì¤‘ ì¤‘';
          concentrationStatusElement.style.color = '#10b981';
        } else if (concentrationScore > 80) {
          concentrationStatusElement.textContent = 'ë§¤ìš° ì§‘ì¤‘';
          concentrationStatusElement.style.color = '#10b981';
        } else if (concentrationScore > 60) {
          concentrationStatusElement.textContent = 'ì§‘ì¤‘';
          concentrationStatusElement.style.color = '#3b82f6';
        } else if (concentrationScore > 40) {
          concentrationStatusElement.textContent = 'ë³´í†µ';
          concentrationStatusElement.style.color = '#f59e0b';
        } else {
          concentrationStatusElement.textContent = 'ë¶„ì‚°ë¨';
          concentrationStatusElement.style.color = '#ef4444';
        }
      } else {
        concentrationStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        concentrationStatusElement.style.color = '#6b7280';
      }
    }
    
    console.log(`[UI] ì§‘ì¤‘ë„ ì ìˆ˜ ì—…ë°ì´íŠ¸ (UI-only mode):`, concentrationScore);
    
    // ì‹œì„  ì•ˆì •ì„± ì ìˆ˜ (ì›Œì»¤ ë°ì´í„°ì™€ HTTP ë¶„ì„ ë°ì´í„° ëª¨ë‘ ì§€ì›)
    // ì´ë¯¸ ìœ„ì—ì„œ ê³„ì‚°ëœ gazeStabilityScore ì‚¬ìš©
    let gazeScore = gazeStabilityScore;
    
    if (gazeScore != null) {
        gazeScore = Math.min(100, Math.max(0, Math.round(gazeScore)));
        gazeElement.textContent = `${gazeScore}%`;
        updateScoreColor(gazeElement, gazeScore);
    } else {
        gazeElement.textContent = '-';
    }
    
    // ì‹œì„  ë¶„ì„ ë°ì´í„° ì €ì¥ (UI-only mode)
    console.log('[UI] (noop) ì‹œì„  ë¶„ì„ ë°ì´í„° ì €ì¥ ë¹„í™œì„±í™”ë¨');
    
    // ì‹œì„  ë¶„ì„ ìƒíƒœ ì—…ë°ì´íŠ¸
    const gazeStatusElement = document.getElementById('gaze-status');
    if (gazeStatusElement) {
      if (metrics?.gazeAnalysis && gazeScore != null) {
        const isFocused = metrics.gazeAnalysis.isFocused;
        const gazeDirection = metrics.gazeAnalysis.gazeDirection;
        const stabilityScore = metrics.gazeAnalysis.stabilityScore;
        
        if (isFocused && gazeDirection === 'center') {
          gazeStatusElement.textContent = 'ì§‘ì¤‘ ì¤‘';
          gazeStatusElement.style.color = '#10b981';
        } else if (stabilityScore > 70) {
          gazeStatusElement.textContent = 'ì•ˆì •ì ';
          gazeStatusElement.style.color = '#3b82f6';
        } else if (stabilityScore > 50) {
          gazeStatusElement.textContent = 'ë³´í†µ';
          gazeStatusElement.style.color = '#f59e0b';
        } else {
          gazeStatusElement.textContent = 'ë¶ˆì•ˆì •';
          gazeStatusElement.style.color = '#ef4444';
        }
      } else {
        gazeStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        gazeStatusElement.style.color = '#6b7280';
      }
    }
    
    console.log(`[UI] ì‹œì„  ì•ˆì •ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸ (UI-only mode):`, gazeScore);
    
    // ê¹œë¹¡ì„ ì ìˆ˜ ê³„ì‚° (í†µì¼ëœ scores ê°ì²´ ìš°ì„  ì‚¬ìš©)
    let blinkScore = null;
    
    // ìš°ì„ ìˆœìœ„ 1: í†µì¼ëœ scores ê°ì²´ ì‚¬ìš©
    if (metrics?.scores?.blink != null) {
        blinkScore = Math.round(metrics.scores.blink);
        console.log('[UI] âœ… scores.blink ì‚¬ìš©:', blinkScore);
    } else {
        blinkScore = null;
        console.log('[UI] âš ï¸ ê¹œë¹¡ì„ ë¶„ì„ ë°ì´í„° ì—†ìŒ, ì ìˆ˜ ë¯¸í‘œì‹œ');
    }
    
    if (blinkScore != null) {
        blinkScore = Math.min(100, Math.max(0, Math.round(blinkScore)));
        blinkElement.textContent = `${blinkScore}%`;
        updateScoreColor(blinkElement, blinkScore);
        
        // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— ê¹œë¹¡ì„ ì ìˆ˜ ì—…ë°ì´íŠ¸
        if (window.ComprehensiveScoreCalculator) {
            window.ComprehensiveScoreCalculator.updateVisualScore('blinking', blinkScore);
        }
    } else {
        blinkElement.textContent = '-';
    }
    
    // ê¹œë¹¡ì„ ë¶„ì„ ë°ì´í„° ì €ì¥ (íŒì—…ìš©)
    if (metrics?.earResult) {
      currentBlinkingData = {
        earResult: metrics.earResult,
        score: blinkScore,
        blinkRatePerMinute: metrics.earResult.blinkRatePerMinute,
        avgBlinkDuration: metrics.earResult.avgBlinkDuration,
        totalBlinkCount: metrics.earResult.totalBlinkCount,
        blinkStatus: metrics.earResult.blinkStatus,
        timestamp: Date.now()
      };
      // ì „ì—­ ë³€ìˆ˜ë¡œë„ ë…¸ì¶œ (íŒì—…ì—ì„œ ì ‘ê·¼ìš©)
      window.currentBlinkingData = currentBlinkingData;
      console.log('[UI] ê¹œë¹¡ì„ ë°ì´í„° ì €ì¥:', currentBlinkingData);
    } else {
      console.warn('[UI] âš ï¸ ê¹œë¹¡ì„ ë¶„ì„ ë°ì´í„°(earResult) ì—†ìŒ:', metrics);
    }
    
    // ê¹œë¹¡ì„ ë¶„ì„ ìƒíƒœ ì—…ë°ì´íŠ¸
    const blinkStatusElement = document.getElementById('blinking-status');
    if (blinkStatusElement) {
      if (metrics?.earResult && blinkScore != null) {
        const blinkStatus = metrics.earResult.blinkStatus;
        const blinkRate = metrics.earResult.blinkRatePerMinute;
        
        if (blinkStatus === 'closed') {
          blinkStatusElement.textContent = 'ëˆˆ ê°ìŒ';
          blinkStatusElement.style.color = '#ef4444';
        } else if (blinkRate > 20) {
          blinkStatusElement.textContent = 'ê³¼ë„í•œ ê¹œë¹¡ì„';
          blinkStatusElement.style.color = '#f59e0b';
        } else if (blinkRate < 8) {
          blinkStatusElement.textContent = 'ë¶€ì¡±í•œ ê¹œë¹¡ì„';
          blinkStatusElement.style.color = '#f59e0b';
        } else {
          blinkStatusElement.textContent = 'ì •ìƒ';
          blinkStatusElement.style.color = '#10b981';
        }
      } else {
        blinkStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        blinkStatusElement.style.color = '#6b7280';
      }
    }
    
    console.log(`[UI] ê¹œë¹¡ì„ ì ìˆ˜ ì—…ë°ì´íŠ¸ (UI-only mode):`, blinkScore);
    
    // í‘œì • ë¶„ì„ ê²°ê³¼ ì²˜ë¦¬ (PyTorch ëª¨ë¸ ê¸°ë°˜)
    let expressionScore = null;
    let expressionText = '-';
    const currentTime = Date.now();
    
    // ì„œë²„ì—ì„œ ì§ì ‘ ë°˜í™˜í•˜ëŠ” í‘œì • ë¶„ì„ ê²°ê³¼ ì²˜ë¦¬
    if (metrics?.success && metrics?.expression && metrics?.score) {
      // ì„œë²„ì—ì„œ ì§ì ‘ ë°˜í™˜í•˜ëŠ” êµ¬ì¡°
      const expressionResult = {
        success: metrics.success,
        expression: metrics.expression,
        confidence: metrics.confidence,
        score: metrics.score
      };
      
      if (expressionResult.score && typeof expressionResult.score.score === 'number') {
        // 2ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜ ì‹ ë¢°ë„ê°€ ë†’ì„ ë•Œë§Œ ì—…ë°ì´íŠ¸
        if (currentTime - lastExpressionUpdate > EXPRESSION_UPDATE_INTERVAL || 
            expressionResult.confidence > 0.6) {
          expressionScore = expressionResult.score.score;
          expressionText = expressionResult.score.label || 'ì¤‘ë¦½ì ';
          lastExpressionScore = expressionScore;
          lastExpressionText = expressionText;
          lastExpressionUpdate = currentTime;
        } else {
          // ì´ì „ ê°’ ìœ ì§€
          expressionScore = lastExpressionScore;
          expressionText = lastExpressionText;
        }
        
        // í‘œì • ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (íŒì—…ìš©)
        currentExpressionData = {
          expression: expressionResult.expression,
          confidence: expressionResult.confidence,
          score: expressionResult.score,
          probabilities: metrics.probabilities || {}, // ì„œë²„ì—ì„œ ì§ì ‘ ë°˜í™˜í•˜ëŠ” probabilities ì‚¬ìš©
          timestamp: Date.now()
        };
        // ì „ì—­ ë³€ìˆ˜ë¡œë„ ë…¸ì¶œ (íŒì—… ë§¤ë‹ˆì €ì—ì„œ ì ‘ê·¼ìš©)
        window.currentExpressionData = currentExpressionData;
        console.log('[UI] í‘œì • ë°ì´í„° ì €ì¥:', currentExpressionData);
        
        console.log('[UI] ğŸ­ ì„œë²„ í‘œì • ë¶„ì„ ê²°ê³¼:', {
          expression: expressionResult.expression,
          confidence: expressionResult.confidence,
          score: expressionScore,
          label: expressionText
        });
      }
    } else if (metrics?.expressionAnalysis?.success) {
      // PyTorch ëª¨ë¸ ë¶„ì„ ê²°ê³¼ ì‚¬ìš©
      const expressionResult = metrics.expressionAnalysis;
      const scoreResult = expressionResult.score;
      
      if (scoreResult && typeof scoreResult.score === 'number') {
        // 2ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜ ì‹ ë¢°ë„ê°€ ë†’ì„ ë•Œë§Œ ì—…ë°ì´íŠ¸
        if (currentTime - lastExpressionUpdate > EXPRESSION_UPDATE_INTERVAL || 
            expressionResult.confidence > 0.6) {
          expressionScore = scoreResult.score;
          expressionText = scoreResult.label || 'ì¤‘ë¦½ì ';
          lastExpressionScore = expressionScore;
          lastExpressionText = expressionText;
          lastExpressionUpdate = currentTime;
        } else {
          // ì´ì „ ê°’ ìœ ì§€
          expressionScore = lastExpressionScore;
          expressionText = lastExpressionText;
        }
        
        // í‘œì • ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (íŒì—…ìš©)
        currentExpressionData = {
          expression: expressionResult.expression,
          confidence: expressionResult.confidence,
          probabilities: expressionResult.probabilities,
          score: scoreResult,
          timestamp: Date.now()
        };
        // ì „ì—­ ë³€ìˆ˜ë¡œë„ ë…¸ì¶œ (íŒì—… ë§¤ë‹ˆì €ì—ì„œ ì ‘ê·¼ìš©)
        window.currentExpressionData = currentExpressionData;
        console.log('[UI] í‘œì • ë°ì´í„° ì €ì¥:', currentExpressionData);
        
        console.log('[UI] ğŸ­ PyTorch í‘œì • ë¶„ì„ ê²°ê³¼:', {
          expression: expressionResult.expression,
          confidence: expressionResult.confidence,
          score: expressionScore,
          label: expressionText,
          base_score: scoreResult.base_score,
          confidence_bonus: scoreResult.confidence_bonus
        });
      }
    } else if (metrics?.smileIntensity !== undefined) {
      // UI-only mode: MediaPipe ë¯¸ì†Œ ë¶„ì„ ë¹„í™œì„±í™”
      console.log('[UI] (noop) MediaPipe ë¯¸ì†Œ ë¶„ì„ ë¹„í™œì„±í™”ë¨');
    } else if (metrics?.labels?.expression) {
      expressionText = metrics.labels.expression;
      // ê¸°ë³¸ê°’ ì œê±° - ì‹¤ì œ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ null ìœ ì§€
      expressionScore = null;
      console.log('[UI] âš ï¸ labels.expressionë§Œ ìˆìŒ, ì ìˆ˜ ë¯¸í‘œì‹œ:', expressionText);
    } else {
      // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ì „ ê°’ ìœ ì§€
      expressionScore = lastExpressionScore;
      expressionText = lastExpressionText;
    }
    
    // í‘œì • ì ìˆ˜ ì—…ë°ì´íŠ¸
    const expressionScoreElement = document.getElementById('expression-score');
    if (expressionScoreElement) {
      if (expressionScore != null) {
      expressionScoreElement.textContent = `${expressionScore}%`;
      updateScoreColor(expressionScoreElement, expressionScore);
      
      // ì¢…í•© ì ìˆ˜ ê³„ì‚°ê¸°ì— í‘œì • ì ìˆ˜ ì—…ë°ì´íŠ¸
      if (window.ComprehensiveScoreCalculator) {
        window.ComprehensiveScoreCalculator.updateVisualScore('expression', expressionScore);
        }
      } else {
        expressionScoreElement.textContent = '-';
        expressionScoreElement.style.color = '#6b7280';
      }
    }
    
    // í‘œì • ë¶„ì„ ìƒíƒœ ì—…ë°ì´íŠ¸ (í‰ê°€ ë¼ë²¨ í‘œì‹œ)
    const expressionStatusElement = document.getElementById('expression-status');
    if (expressionStatusElement) {
      if ((metrics?.success && metrics?.score?.label) || (metrics?.expressionAnalysis?.success && metrics?.expressionAnalysis?.score?.label)) {
        const scoreResult = metrics?.score || metrics?.expressionAnalysis?.score;
        if (scoreResult && scoreResult.label) {
          expressionStatusElement.textContent = scoreResult.label;
          // ë¼ë²¨ì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
          if (scoreResult.label.includes('ê¸ì •ì ')) {
            expressionStatusElement.style.color = '#10b981'; // ì´ˆë¡ìƒ‰
          } else if (scoreResult.label.includes('ì¤‘ë¦½ì ')) {
            expressionStatusElement.style.color = '#f59e0b'; // ì£¼í™©ìƒ‰
          } else {
            expressionStatusElement.style.color = '#ef4444'; // ë¹¨ê°„ìƒ‰
          }
        } else {
          expressionStatusElement.textContent = 'ë¶„ì„ ì¤‘';
          expressionStatusElement.style.color = '#6b7280';
        }
      } else {
        expressionStatusElement.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘';
        expressionStatusElement.style.color = '#6b7280';
      }
    }
    
    console.log(`[UI] í‘œì • ì ìˆ˜ ì—…ë°ì´íŠ¸ (UI-only mode):`, { expressionScore, expressionText });
    
    // ì ìˆ˜ ìƒ‰ìƒ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ui-utils.jsë¡œ ì´ë™ë¨)
    
    // ê°œì¸í™”ëœ ê¿€íŒ ì—…ë°ì´íŠ¸
    const tips = generatePersonalizedTips(metrics);
    const tipsContainer = document.getElementById('ai-feedback-summary');
    if (tipsContainer && tips.length > 0) {
      tipsContainer.innerHTML = `
        <div style="font-weight: 700; margin-bottom: 8px; color: #1a1a1a; font-size: 14px;">ğŸ¯ ì‹¤ì‹œê°„ ê¿€íŒ!</div>
        <ol style="padding-left: 20px; margin: 0; font-size: 13px; line-height: 1.7; color: #2d2d2d; font-weight: 500;">
          ${tips.map(tip => `<li>${tip}</li>`).join('')}
        </ol>
      `;
    }
    
  } catch (e) {
    console.warn('[ANALYZER] UI update error', e);
  }
}

// --- AI í”¼ë“œë°± ë¶„ì„ ê¸°ëŠ¥ (ìë™ ì‹¤í–‰) ---
// ChatManagerë¡œ ì´ë™ë¨ - js/chat-manager.jsì—ì„œ ê´€ë¦¬

// --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
closeBtn.addEventListener('click', toggleFeedbackPanel);

feedbackToggleBtn.addEventListener('click', () => {
    toggleFeedbackPanel();
    if (feedbackPanel.classList.contains('visible')) {
        if (window.chatManager) {
            window.chatManager.runAiAnalysis();
        }
    }
});


document.querySelectorAll('.suggestion-tags .tag').forEach(tag => {
    tag.addEventListener('click', () => {
        chatInput.value = `"${tag.textContent}"ì— ëŒ€í•´ ì´ì•¼ê¸°í•´ë³¼ê¹Œìš”?`;
        chatInput.focus();
    });
});

 // --- ë¹„ë””ì˜¤ ì¬ìƒ ê´€ë¦¬ ---
 function initializeVideo() {
     const video = document.getElementById('video');
     const videoLoading = document.getElementById('video-loading');
     
     // ë¹„ë””ì˜¤ íŒŒì¼ ê²½ë¡œ ì„¤ì • (ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€)
     const timestamp = new Date().getTime();
     const DEFAULT_API_BASE = window.API_BASE_URL || `http://${window.BACKEND_HOST || '34.64.136.237'}:8000`;
     const apiBase = window.serverUrl || DEFAULT_API_BASE;
     const videoPath = `${apiBase}/frontend/video/woman1_cafe.mp4?t=${timestamp}`;
     
     console.log('ğŸ¬ [VIDEO] ë¹„ë””ì˜¤ ì´ˆê¸°í™” ì‹œì‘:', videoPath);
     
     // ë¡œë”© í™”ë©´ í‘œì‹œ
     videoLoading.classList.remove('hidden');
    
    // ë¹„ë””ì˜¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    video.addEventListener('loadstart', () => {
        console.log('ğŸ¬ [VIDEO] ë¹„ë””ì˜¤ ë¡œë”© ì‹œì‘');
    });
    
         video.addEventListener('canplay', () => {
         console.log('âœ… [VIDEO] ë¹„ë””ì˜¤ ì¬ìƒ ì¤€ë¹„ ì™„ë£Œ');
         // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
         videoLoading.classList.add('hidden');
         // ìë™ ì¬ìƒ ì‹œë„ (ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ì—ë§Œ ì„±ê³µ)
         video.play().catch(error => {
             console.log('â„¹ï¸ [VIDEO] ìë™ ì¬ìƒ ëŒ€ê¸° ì¤‘ (ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í•„ìš”)');
             // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ì‹œ ì¬ìƒ ì‹œì‘ì„ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
             const startPlayback = () => {
                 video.play().then(() => {
                     console.log('âœ… [VIDEO] ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ ì¬ìƒ ì‹œì‘');
                     // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
                     document.removeEventListener('click', startPlayback);
                     document.removeEventListener('keydown', startPlayback);
                 }).catch(err => {
                     console.error('âŒ [VIDEO] ì¬ìƒ ì‹¤íŒ¨:', err);
                 });
             };
             document.addEventListener('click', startPlayback, { once: true });
             document.addEventListener('keydown', startPlayback, { once: true });
         });
     });
     
     video.addEventListener('loadeddata', () => {
         console.log('âœ… [VIDEO] ë¹„ë””ì˜¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
     });
    
    video.addEventListener('ended', () => {
        console.log('ğŸ”„ [VIDEO] ë¹„ë””ì˜¤ ì¬ìƒ ì™„ë£Œ, ë°˜ë³µ ì¬ìƒ');
        // loop ì†ì„±ì´ ìˆì§€ë§Œ í™•ì‹¤íˆ í•˜ê¸° ìœ„í•´ ë‹¤ì‹œ ì¬ìƒ
        video.currentTime = 0;
        video.play().catch(error => {
            console.error('âŒ [VIDEO] ë°˜ë³µ ì¬ìƒ ì‹¤íŒ¨:', error);
        });
    });
    
    video.addEventListener('error', (error) => {
        console.error('âŒ [VIDEO] ë¹„ë””ì˜¤ ë¡œë”© ì˜¤ë¥˜:', error);
        console.error('âŒ [VIDEO] ë¹„ë””ì˜¤ ì˜¤ë¥˜ ì½”ë“œ:', video.error?.code);
        console.error('âŒ [VIDEO] ë¹„ë””ì˜¤ ì˜¤ë¥˜ ë©”ì‹œì§€:', video.error?.message);
        console.error('âŒ [VIDEO] ë¹„ë””ì˜¤ ì†ŒìŠ¤:', video.src);
        videoLoading.innerHTML = `
            <div style="text-align: center;">
                <p style="color: #e74c3c; margin-bottom: 8px;">ë¹„ë””ì˜¤ ë¡œë”© ì‹¤íŒ¨</p>
                <p style="color: #666; font-size: 12px; margin-bottom: 8px;">ì˜¤ë¥˜ ì½”ë“œ: ${video.error?.code || 'unknown'}</p>
                <button onclick="initializeVideo()" style="padding: 8px 16px; background: var(--brand2); color: white; border: none; border-radius: 8px; cursor: pointer;">ë‹¤ì‹œ ì‹œë„</button>
            </div>
        `;
    });
    
         // ë¹„ë””ì˜¤ ì†ŒìŠ¤ ì„¤ì • (ì´ë¯¸ videoPathì— íƒ€ì„ìŠ¤íƒ¬í”„ê°€ í¬í•¨ë¨)
     video.src = videoPath;
     video.load();
}


   // --- ì¹´ë©”ë¼ ê²½ê³  í•¨ìˆ˜ë“¤ ---
function showCameraWarning() {
    console.log('[CAMERA] ì¹´ë©”ë¼ ê²½ê³  í‘œì‹œ');
    const warning = document.getElementById('camera-warning');
    if (warning) {
        warning.classList.remove('hidden');
    }
}

function hideCameraWarning() {
    console.log('[CAMERA] ì¹´ë©”ë¼ ê²½ê³  ìˆ¨ê¹€');
    const warning = document.getElementById('camera-warning');
    if (warning) {
        warning.classList.add('hidden');
    }
}

function showCameraToast() {
    console.log('[CAMERA] ì¹´ë©”ë¼ í† ìŠ¤íŠ¸ ê²½ê³  í‘œì‹œ');
    const toast = document.getElementById('camera-toast');
    if (toast) {
        toast.classList.remove('hidden');
    }
}

function hideCameraToast() {
    console.log('[CAMERA] ì¹´ë©”ë¼ í† ìŠ¤íŠ¸ ê²½ê³  ìˆ¨ê¹€');
    const toast = document.getElementById('camera-toast');
    if (toast) {
        toast.classList.add('hidden');
    }
}

   // --- ì¹´ë©”ë¼ ìƒíƒœ í™•ì¸ í•¨ìˆ˜ ---
  async function checkCameraStatus() {
      try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          // ì¹´ë©”ë¼ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ë©´ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
          stream.getTracks().forEach(track => track.stop());
          hideCameraWarning();
          hideCameraToast();
          return true;
      } catch (err) {
          console.error("ì¹´ë©”ë¼ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:", err);
          // í† ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ (ë” ê¹”ë”í•¨)
          showCameraToast();
          return false;
      }
  }

// --- ì¹´ë©”ë¼ ë° ìŒì„± ê¶Œí•œ ìš”ì²­ í•¨ìˆ˜ ---
async function requestCameraAndAudioPermissions() {
    console.log('ğŸ¤ [PERMISSIONS] ì¹´ë©”ë¼ ë° ìŒì„± ê¶Œí•œ ìš”ì²­ ì‹œì‘');
    
    try {
        // ì¹´ë©”ë¼ì™€ ìŒì„± ê¶Œí•œì„ ë™ì‹œì— ìš”ì²­
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: true, 
            audio: true 
        });
        
        console.log('âœ… [PERMISSIONS] ì¹´ë©”ë¼ ë° ìŒì„± ê¶Œí•œ íšë“ ì„±ê³µ');
        
        // ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
        stream.getTracks().forEach(track => {
            track.stop();
            console.log(`ğŸ›‘ [PERMISSIONS] ${track.kind} íŠ¸ë™ ì •ë¦¬ ì™„ë£Œ`);
        });
        
        // ê¶Œí•œ ìƒíƒœ ì €ì¥
        sessionStorage.setItem('permissionsGranted', 'true');
        
        // ê²½ê³  ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        hideCameraWarning();
        hideCameraToast();
        
        return true;
        
    } catch (err) {
        console.error('âŒ [PERMISSIONS] ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨:', err);
        
        // ê¶Œí•œ ê±°ë¶€ ìƒíƒœ ì €ì¥
        sessionStorage.setItem('permissionsGranted', 'false');
        
        // ì—ëŸ¬ íƒ€ì…ì— ë”°ë¥¸ ì²˜ë¦¬
        if (err.name === 'NotAllowedError') {
            console.warn('âš ï¸ [PERMISSIONS] ì‚¬ìš©ìê°€ ê¶Œí•œì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤');
            showPermissionDeniedMessage();
        } else if (err.name === 'NotFoundError') {
            console.warn('âš ï¸ [PERMISSIONS] ì¹´ë©”ë¼ ë˜ëŠ” ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            showDeviceNotFoundMessage();
        } else {
            console.warn('âš ï¸ [PERMISSIONS] ê¸°íƒ€ ê¶Œí•œ ì˜¤ë¥˜:', err.name);
            showCameraToast();
        }
        
        return false;
    }
}

// --- ê¶Œí•œ ê±°ë¶€ ë©”ì‹œì§€ í‘œì‹œ ---
function showPermissionDeniedMessage() {
    const message = document.createElement('div');
    message.id = 'permission-denied-message';
    message.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    `;
    
    message.innerHTML = `
        <div style="font-size: 24px; margin-bottom: 15px;">ğŸ¤</div>
        <h3 style="margin: 0 0 10px; color: #ff6b6b;">ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
        <p style="margin: 0 0 15px; line-height: 1.5;">
            ë°ì´íŠ¸ ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•´<br>
            <strong>ì¹´ë©”ë¼ì™€ ë§ˆì´í¬ ê¶Œí•œ</strong>ì´ í•„ìš”í•©ë‹ˆë‹¤.
        </p>
        <p style="margin: 0 0 20px; font-size: 14px; opacity: 0.8;">
            ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.
        </p>
        <button onclick="retryPermissions()" style="
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        ">ë‹¤ì‹œ ì‹œë„</button>
        <button onclick="closePermissionMessage()" style="
            background: #666;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
        ">ë‚˜ì¤‘ì—</button>
    `;
    
    document.body.appendChild(message);
}

// --- ë””ë°”ì´ìŠ¤ ì—†ìŒ ë©”ì‹œì§€ í‘œì‹œ ---
function showDeviceNotFoundMessage() {
    const message = document.createElement('div');
    message.id = 'device-not-found-message';
    message.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    `;
    
    message.innerHTML = `
        <div style="font-size: 24px; margin-bottom: 15px;">ğŸ“¹</div>
        <h3 style="margin: 0 0 10px; color: #ff6b6b;">ë””ë°”ì´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
        <p style="margin: 0 0 15px; line-height: 1.5;">
            ì¹´ë©”ë¼ ë˜ëŠ” ë§ˆì´í¬ê°€<br>
            ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
        </p>
        <p style="margin: 0 0 20px; font-size: 14px; opacity: 0.8;">
            ë””ë°”ì´ìŠ¤ë¥¼ ì—°ê²°í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
        </p>
        <button onclick="retryPermissions()" style="
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        ">ë‹¤ì‹œ ì‹œë„</button>
        <button onclick="closePermissionMessage()" style="
            background: #666;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
        ">ë‚˜ì¤‘ì—</button>
    `;
    
    document.body.appendChild(message);
}

// --- ê¶Œí•œ ì¬ì‹œë„ í•¨ìˆ˜ ---
async function retryPermissions() {
    console.log('ğŸ”„ [PERMISSIONS] ê¶Œí•œ ì¬ì‹œë„ ì‹œì‘');
    
    // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
    closePermissionMessage();
    
    // ì ì‹œ ëŒ€ê¸° í›„ ê¶Œí•œ ì¬ìš”ì²­
    setTimeout(async () => {
        const success = await requestCameraAndAudioPermissions();
        if (success) {
            console.log('âœ… [PERMISSIONS] ê¶Œí•œ ì¬ì‹œë„ ì„±ê³µ');
        }
    }, 500);
}

// --- ê¶Œí•œ ë©”ì‹œì§€ ë‹«ê¸° í•¨ìˆ˜ ---
function closePermissionMessage() {
    const permissionMessage = document.getElementById('permission-denied-message');
    const deviceMessage = document.getElementById('device-not-found-message');
    
    if (permissionMessage) {
        permissionMessage.remove();
    }
    if (deviceMessage) {
        deviceMessage.remove();
    }
}

// --- ê¶Œí•œ ìƒíƒœ í™•ì¸ í•¨ìˆ˜ ---
async function checkPermissionStatus() {
    try {
        // ê¶Œí•œ ìƒíƒœ í™•ì¸
        const permissions = await navigator.permissions.query({ name: 'camera' });
        const audioPermissions = await navigator.permissions.query({ name: 'microphone' });
        
        console.log('ğŸ” [PERMISSIONS] ê¶Œí•œ ìƒíƒœ í™•ì¸:', {
            camera: permissions.state,
            microphone: audioPermissions.state
        });
        
        return {
            camera: permissions.state,
            microphone: audioPermissions.state,
            allGranted: permissions.state === 'granted' && audioPermissions.state === 'granted'
        };
    } catch (err) {
        console.warn('âš ï¸ [PERMISSIONS] ê¶Œí•œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', err);
        return {
            camera: 'unknown',
            microphone: 'unknown',
            allGranted: false
        };
    }
}
 
 // --- ì•± ì´ˆê¸°í™” ---
 async function initializeApp() {
     // MongoDB ì„¸ì…˜ ìƒì„± (ChatManager ì‚¬ìš©)
     if (window.chatManager) {
         const sessionCreated = await window.chatManager.createSession();
     if (!sessionCreated) {
         console.error('âŒ [CHAT] ì„¸ì…˜ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
         }
     }
     
     // ê¶Œí•œ ìƒíƒœ í™•ì¸ ë° í•„ìš”ì‹œ ìš”ì²­
     console.log('ğŸ¤ [APP] ê¶Œí•œ ìƒíƒœ í™•ì¸ ì‹œì‘');
     const permissionStatus = await checkPermissionStatus();
     
     if (permissionStatus.allGranted) {
         console.log('âœ… [APP] ì´ë¯¸ ëª¨ë“  ê¶Œí•œì´ í—ˆìš©ë¨');
         sessionStorage.setItem('permissionsGranted', 'true');
     } else {
         console.log('ğŸ”„ [APP] ê¶Œí•œ ìš”ì²­ í•„ìš”:', permissionStatus);
         const permissionsGranted = await requestCameraAndAudioPermissions();
         
         if (permissionsGranted) {
             console.log('âœ… [APP] ê¶Œí•œ íšë“ ì™„ë£Œ - ì•± ì´ˆê¸°í™” ê³„ì†');
         } else {
             console.warn('âš ï¸ [APP] ê¶Œí•œ íšë“ ì‹¤íŒ¨ - ì œí•œëœ ê¸°ëŠ¥ìœ¼ë¡œ ê³„ì†');
         }
     }
     
     // ì¹´ë©”ë¼ ìƒíƒœ í™•ì¸ (ê¶Œí•œ ìš”ì²­ í›„)
     await checkCameraStatus();
     
     // ë¹„ë””ì˜¤ ì´ˆê¸°í™”
     initializeVideo();
     
     // ì¹´ë©”ë¼ ë¶„ì„ê¸° ì‹œì‘ (UI-only mode)
     console.log('[ANALYZER] ğŸ” ì¹´ë©”ë¼ ë¶„ì„ê¸° ì‹œì‘ ì¤€ë¹„... (UI-only mode)');
     console.log('[ANALYZER] ğŸ“¦ í•¨ìˆ˜ í™•ì¸:', {
         scheduleAnalyzerStart: typeof scheduleAnalyzerStart,
         CameraAnalyzer: typeof CameraAnalyzer
     });
     
     // UI-only mode: ì¹´ë©”ë¼ ë¶„ì„ê¸° ë¹„í™œì„±í™”
     console.log('[ANALYZER] (noop) ì¹´ë©”ë¼ ë¶„ì„ê¸° ë¹„í™œì„±í™”ë¨ - UI-only mode');
     
     // Persona ì •ë³´ ì¹´ë“œ ì¶”ê°€ (ChatManager ì‚¬ìš©)
     if (window.chatManager) {
         window.chatManager.addPersonaCard();
     }
     
          // ì´ˆê¸° ì•ˆë‚´ íŒì—… í‘œì‹œ
      showInitialGuidePopup();
     
     // ë¶„ì„ìš© WebSocket/ì›Œì»¤ ì—°ê²° ì œê±°ë¨ (UI ì „ìš©)
    
         // ì•¡ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
     const recalibrateBtn = document.getElementById('recalibrate-btn');
     if (recalibrateBtn) {
         recalibrateBtn.addEventListener('click', async () => {
             try {
                 // ì¹´ë©”ë¼ ê¶Œí•œ í™•ì¸
                 await navigator.mediaDevices.getUserMedia({ video: true });
                 // ì¹´ë©”ë¼ ê²½ê³  ìˆ¨ê¸°ê¸°
                 hideCameraWarning();
                 // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ íŒì—… ë‹¤ì‹œ í‘œì‹œ
                 const calibrationOverlay = document.getElementById('calibration-overlay');
                 const mainContent = document.getElementById('main-content');
                 if (calibrationOverlay) calibrationOverlay.classList.remove('hidden');
                 if (mainContent) mainContent.classList.remove('visible');
             } catch (err) {
                 console.error("ì¹´ë©”ë¼ ê¶Œí•œ ì‹¤íŒ¨:", err);
                 showCameraWarning();
             }
         });
     }
    
    const endSessionBtn = document.getElementById('end-session-btn');
    if (endSessionBtn) {
        endSessionBtn.addEventListener('click', () => {
            // í™•ì¸ íŒì—… í‘œì‹œ
            showConfirmDialog();
        });
    }
    
    // í™•ì¸ íŒì—… ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const cancelEndBtn = document.getElementById('cancel-end-btn');
    if (cancelEndBtn) {
        cancelEndBtn.addEventListener('click', () => {
            hideConfirmDialog();
        });
    }
    
    const confirmEndBtn = document.getElementById('confirm-end-btn');
    if (confirmEndBtn) {
        confirmEndBtn.addEventListener('click', async () => {
        // ë°ì´íŠ¸ ì„¸ì…˜ ì¢…ë£Œ - ì¦‰ì‹œ í˜ì´ì§€ ì´ë™
        hideConfirmDialog();
        
        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        const endBtn = document.getElementById('confirm-end-btn');
        const originalText = endBtn.textContent;
        endBtn.textContent = 'ì¢…ë£Œ ì¤‘...';
        endBtn.disabled = true;
        
        try {
            // ì¹´ë©”ë¼ ë¶„ì„ê¸° ì •ë¦¬
            if (window.cameraAnalyzer) {
                console.log('ğŸ§¹ [ANALYZER] ì¹´ë©”ë¼ ë¶„ì„ê¸° ì •ë¦¬ ì‹œì‘');
                window.cameraAnalyzer.cleanup();
                window.cameraAnalyzer = null;
            }
            
            // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬ (ChatManager ì‚¬ìš©)
            if (window.chatManager) {
                window.chatManager.cleanup();
            }
            console.log('ğŸ§¹ [SESSION] ì„¸ì…˜ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ');
            // ìµœì¢… í”¼ë“œë°± ë°ì´í„° ìˆ˜ì§‘
            const finalFeedback = {
                likability: parseInt(document.getElementById('likability-score').textContent) || 0,
                initiative: parseInt(document.getElementById('user-initiative-bar').style.width) || 0,
                tone: parseInt(document.getElementById('tone-score').textContent) || 0,
                concentration: parseInt(document.getElementById('concentration-score').textContent) || 0,
                gaze_stability: parseInt(document.getElementById('gaze-score').textContent) || 0,
                blinking: parseInt(document.getElementById('blinking-score').textContent) || 0,
                posture: parseInt(document.getElementById('posture-score').textContent) || 0,
                expression: document.getElementById('expression-text').textContent || 'ë¶„ì„ ì—†ìŒ',
                total_score: parseInt(document.getElementById('total-score').textContent) || 0,
                summary: document.getElementById('ai-feedback-summary').textContent || 'ë¶„ì„ ì—†ìŒ'
            };
            
            // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const userData = getUserData();
            if (!userData) {
                throw new Error('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            
            const externalUrl = 'https://dys-phi.vercel.app/persona';
 			
 			// ë°±ì—”ë“œ API í˜¸ì¶œ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì²˜ë¦¬, ì‘ë‹µ ëŒ€ê¸°í•˜ì§€ ì•ŠìŒ)
 			fetch(`${serverUrl}/api/session/end`, {
 				method: 'POST',
 				headers: {
 					'Content-Type': 'application/json',
 					'Authorization': `Bearer ${userData.token || ''}`
 				},
 				body: JSON.stringify({
 					                session_id: window.chatManager ? window.chatManager.currentSessionId : null,
 					user_id: userData.user_id,
 					email: userData.email,
 					token: userData.token,
 					end_reason: 'user_request',
 					final_feedback: finalFeedback
 				})
 			}).then(response => {
 				if (response.ok) {
 					console.log('âœ… [SESSION] ë°±ê·¸ë¼ìš´ë“œ ì„¸ì…˜ ì¢…ë£Œ ì„±ê³µ');
 				} else {
 					console.warn('âš ï¸ [SESSION] ë°±ê·¸ë¼ìš´ë“œ ì„¸ì…˜ ì¢…ë£Œ ì‹¤íŒ¨:', response.status);
 				}
 			}).catch(error => {
 				console.warn('âš ï¸ [SESSION] ë°±ê·¸ë¼ìš´ë“œ ì„¸ì…˜ ì¢…ë£Œ ì˜¤ë¥˜:', error);
 			});
 			
 			// ì¦‰ì‹œ ì™¸ë¶€ í˜ì´ì§€ë¡œ ì´ë™ (íˆìŠ¤í† ë¦¬ì— ë‚¨ê¸°ì§€ ì•ŠìŒ)
 			console.log('ğŸš€ [SESSION] ì¦‰ì‹œ í˜ì´ì§€ ì´ë™:', externalUrl);
 			window.location.replace(externalUrl);
 			
 		} catch (error) {
 			console.error('âŒ [SESSION] ì„¸ì…˜ ì¢…ë£Œ ì¤€ë¹„ ì‹¤íŒ¨:', error);
 			
 			// ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ì™¸ë¶€ í˜ì´ì§€ë¡œ ì´ë™
 			window.location.replace('https://dys-phi.vercel.app/persona');
 		} finally {
 			// ë²„íŠ¼ ìƒíƒœ ë³µì› (í˜ì´ì§€ ì´ë™ ì „ì— ì‹¤í–‰ë  ìˆ˜ ìˆìŒ)
 			setTimeout(() => {
 				const endBtn = document.getElementById('confirm-end-btn');
 				if (endBtn) {
 					endBtn.textContent = 'ì˜ˆ';
 					endBtn.disabled = false;
 				}
 			}, 100);
 		}
 	    });
    
    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
        console.log('ğŸ§¹ [CLEANUP] í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬ ì‹œì‘');
        cleanupGlobalVariables();
    });
    
    // í˜ì´ì§€ ìˆ¨ê¹€ ì‹œ ì •ë¦¬
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            console.log('ğŸ§¹ [CLEANUP] í˜ì´ì§€ ìˆ¨ê¹€ ì‹œ ì •ë¦¬');
            cleanupGlobalVariables();
        }
    });
}

// --- ì „ì—­ ë³€ìˆ˜ ì •ë¦¬ í•¨ìˆ˜ ---
function cleanupGlobalVariables() {
    // ì›Œì»¤ ê´€ë¦¬ ì‹œìŠ¤í…œ ì •ë¦¬
    if (typeof cleanupWorker === 'function') {
        cleanupWorker();
    }
    
    
    
    // ë¶„ì„ê¸° ì •ë¦¬
    if (window.analyzerClient) {
        try {
            window.analyzerClient.cleanup();
            window.analyzerClient = null;
        } catch (e) {
            console.warn('[CLEANUP] ë¶„ì„ê¸° ì •ë¦¬ ì‹¤íŒ¨:', e);
        }
    }
    
    // TTS ê´€ë¦¬ì ì •ë¦¬
    cleanupTTSManager();
    
    // UI ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸ ì •ë¦¬
    if (window.__UI_UPDATE_TIMER__) {
        clearTimeout(window.__UI_UPDATE_TIMER__);
        window.__UI_UPDATE_TIMER__ = null;
    }
    
    // ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„ ì •ë¦¬
    if (window.__PUMP_ANIMATION_ID__) {
        cancelAnimationFrame(window.__PUMP_ANIMATION_ID__);
        window.__PUMP_ANIMATION_ID__ = null;
    }
    
    // ëœë“œë§ˆí¬ íŒí”„ ì¤‘ì§€
    __lmPumpStop = true;
    
    console.log('[CLEANUP] ì „ì—­ ë³€ìˆ˜ ì •ë¦¬ ì™„ë£Œ');
}

// WebSocket ì—°ê²°ì€ initializeApp()ì—ì„œ ì²˜ë¦¬ë¨

// ì „ì—­ ìŠ¤ì½”í”„ì— ê¶Œí•œ ê´€ë ¨ í•¨ìˆ˜ ë…¸ì¶œ
window.requestCameraAndAudioPermissions = requestCameraAndAudioPermissions;
window.retryPermissions = retryPermissions;
window.closePermissionMessage = closePermissionMessage;
window.checkPermissionStatus = checkPermissionStatus;
}


// ë¯¸ì†Œ í†µê³„ ê´€ë¦¬ (ê°œì„ ëœ ë²„ì „)
let smileHistory = []; // ë¯¸ì†Œ íˆìŠ¤í† ë¦¬ (ì•ˆì •í™”ìš©)
let personalBaseSmile = 50; // ê°œì¸ë³„ ê¸°ì¤€ ë¯¸ì†Œ ê°•ë„ (ë™ì  ê³„ì‚°)
const SMILE_HISTORY_SIZE = 20; // ìµœê·¼ 20ê°œ ë¯¸ì†Œ ê°’ìœ¼ë¡œ ê¸°ì¤€ ê³„ì‚°
const SMILE_SMOOTHING_WINDOW = 5000; // 5ì´ˆ ìœˆë„ìš°ë¡œ ë¯¸ì†Œ ì•ˆì •í™”

// ìì„¸ í†µê³„ ê´€ë¦¬ (ì•ˆì •í™”ìš©)
let postureHistory = []; // ìì„¸ íˆìŠ¤í† ë¦¬ (ì•ˆì •í™”ìš©)
let smoothedPostureScore = 60; // ì•ˆì •í™”ëœ ìì„¸ ì ìˆ˜
const POSTURE_HISTORY_SIZE = 15; // ìµœê·¼ 15ê°œ ìì„¸ ê°’ìœ¼ë¡œ ì•ˆì •í™”
const POSTURE_SMOOTHING_WINDOW = 8000; // 8ì´ˆ ìœˆë„ìš°ë¡œ ìì„¸ ì•ˆì •í™”
const POSTURE_CHANGE_THRESHOLD = 15; // ê¸‰ê²©í•œ ë³€í™” ì„ê³„ê°’ (15ì  ì´ìƒ ë³€í™” ì‹œ ì œí•œ)

// ì›Œì»¤ë¡œë¶€í„° ë°›ì€ ëœë“œë§ˆí¬ë¥¼ ë°°ì¹˜ì— ì ì¬ (UI-only mode)
function onLandmarkFrame(lmBuffer, ear) {
  // UI-only mode: ëœë“œë§ˆí¬ ì²˜ë¦¬ ë¹„í™œì„±í™”
  console.log('[LANDMARK] (noop) ëœë“œë§ˆí¬ ì²˜ë¦¬ ë¹„í™œì„±í™”ë¨');
}


// --- ì‹œì„  ì•ˆì •ì„± ìƒì„¸ ì •ë³´ íŒì—… í•¨ìˆ˜ë“¤ ---
function showGazeDetails() {
    const popup = document.getElementById('gaze-details-popup');
    if (popup) {
        popup.classList.add('active');
        updateGazePopupContent();
    }
}

function closeGazeDetails() {
    const popup = document.getElementById('gaze-details-popup');
    if (popup) {
        popup.classList.remove('active');
    }
}

function updateGazePopupContent() {
    // UI-only mode: ê¸°ë³¸ ë°ì´í„° í‘œì‹œ
    document.getElementById('gaze-main-value').textContent = 'UI ëª¨ë“œ';
    document.getElementById('gaze-stability-value').textContent = '0%';
    document.getElementById('gaze-landmarks').innerHTML = '<div class="no-data">ì‹œì„  ë¶„ì„ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</div>';
    document.getElementById('gaze-criteria-text').innerHTML = 'ì‹œì„  ë¶„ì„ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.';
    document.getElementById('gaze-explanation-text').innerHTML = 'ì‹œì„  ë¶„ì„ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.';
    
    // ëœë“œë§ˆí¬ ì •ë³´ ì—…ë°ì´íŠ¸
    if (typeof updateGazeLandmarksInfo === 'function') {
        updateGazeLandmarksInfo();
    }
    
    // í‰ê°€ ê¸°ì¤€ ì—…ë°ì´íŠ¸
    if (typeof updateGazeCriteriaInfo === 'function') {
        updateGazeCriteriaInfo();
    }
    
    // ì ìˆ˜ ê³„ì‚° ê·¼ê±° ì—…ë°ì´íŠ¸
    if (typeof updateGazeExplanationInfo === 'function') {
        updateGazeExplanationInfo();
    }
}



// --- ì§‘ì¤‘ë„ ìƒì„¸ ì •ë³´ íŒì—… í•¨ìˆ˜ë“¤ ---
function showConcentrationDetails() {
    const popup = document.getElementById('concentration-details-popup');
    if (popup) {
        popup.classList.add('active');
        updateConcentrationPopupContent();
    }
}

function closeConcentrationDetails() {
    const popup = document.getElementById('concentration-details-popup');
    if (popup) {
        popup.classList.remove('active');
    }
}

function updateConcentrationPopupContent() {
    // UI-only mode: ê¸°ë³¸ ë°ì´í„° í‘œì‹œ
    document.getElementById('concentration-main-value').textContent = 'UI ëª¨ë“œ';
    document.getElementById('concentration-score-value').textContent = '0%';
    document.getElementById('concentration-factors').innerHTML = '<div class="no-data">ì§‘ì¤‘ë„ ë¶„ì„ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</div>';
    document.getElementById('concentration-criteria-text').innerHTML = 'ì§‘ì¤‘ë„ ë¶„ì„ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.';
    document.getElementById('concentration-explanation-text').innerHTML = 'ì§‘ì¤‘ë„ ë¶„ì„ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.';
    
    // ë¶„ì„ ìš”ì†Œ ì—…ë°ì´íŠ¸
    if (typeof updateConcentrationFactorsInfo === 'function') {
        updateConcentrationFactorsInfo();
    }
    
    // í‰ê°€ ê¸°ì¤€ ì—…ë°ì´íŠ¸
    if (typeof updateConcentrationCriteriaInfo === 'function') {
        updateConcentrationCriteriaInfo();
    }
    
    // ì ìˆ˜ ê³„ì‚° ê·¼ê±° ì—…ë°ì´íŠ¸
    if (typeof updateConcentrationExplanationInfo === 'function') {
        updateConcentrationExplanationInfo();
    }
}

// íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', function(event) {
    const expressionPopup = document.getElementById('expression-details-popup');
    const gazePopup = document.getElementById('gaze-details-popup');
    const concentrationPopup = document.getElementById('concentration-details-popup');
    
    if (expressionPopup && event.target === expressionPopup) {
        closeExpressionDetails();
    }
    
    if (gazePopup && event.target === gazePopup) {
        closeGazeDetails();
    }
    
    if (concentrationPopup && event.target === concentrationPopup) {
        closeConcentrationDetails();
    }
});

// ====== ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì´ˆê¸°í™” ======
document.addEventListener('DOMContentLoaded', async function() {
    console.log('ğŸš€ ìŠ¤íŠœë””ì˜¤ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
    
    // ì‚¬ìš©ì ì •ë³´ í™•ì¸ (URL íŒŒë¼ë¯¸í„°ì—ì„œ ì¶”ì¶œ)
    const urlParams = new URLSearchParams(window.location.search);
    window.userId = urlParams.get('user_id') || 'default_user';
    window.email = urlParams.get('email') || 'user@example.com';
    window.token = urlParams.get('token') || 'default_token';
    
    console.log('ğŸ‘¤ ì‚¬ìš©ì ì •ë³´:', {
        userId: window.userId,
        email: window.email,
        token: window.token
    });
    
    // ì„œë²„ URL ì„¤ì •
    window.serverUrl = 'https://dys-phi.vercel.app/api/gke';
    window.apiEndpoints = {
        user_check: `${window.serverUrl}/user/check`,
        user_update: `${window.serverUrl}/user/update-calibration`,
        calibration: `${window.serverUrl}/calibration`,
        calibration_user: `${window.serverUrl}/calibration/user`
    };
    
    console.log('ğŸ”— API ì—”ë“œí¬ì¸íŠ¸ ì„¤ì •:', window.apiEndpoints);
    
    // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™”
    if (window.CalibrationModule && window.CalibrationModule.initializeCalibration) {
        try {
            await window.CalibrationModule.initializeCalibration();
            console.log('âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™” ì™„ë£Œ');
        } catch (error) {
            console.error('âŒ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        }
    } else {
        console.warn('âš ï¸ CalibrationModuleì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
    }
    
    // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ íŒì—… ë¡œë“œ
    if (window.loadCalibrationPopup) {
        try {
            await window.loadCalibrationPopup();
            console.log('âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ íŒì—… ë¡œë“œ ì™„ë£Œ');
            
            // íŒì—… ë¡œë“œ í›„ DOM ìš”ì†Œ ì´ˆê¸°í™”
            if (window.CalibrationModule && window.CalibrationModule.initializeCalibrationModule) {
                try {
                    window.CalibrationModule.initializeCalibrationModule();
                    console.log('âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ DOM ìš”ì†Œ ì´ˆê¸°í™” ì™„ë£Œ');
                } catch (error) {
                    console.error('âŒ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ DOM ìš”ì†Œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                }
            }
        } catch (error) {
            console.error('âŒ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ íŒì—… ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }
    
    // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“ˆ ì´ˆê¸°í™” (DOM ìš”ì†Œ ì„¤ì •) - íŒì—… ë¡œë“œ í›„ë¡œ ì´ë™
    // if (window.CalibrationModule && window.CalibrationModule.initializeCalibrationModule) {
    //     try {
    //         window.CalibrationModule.initializeCalibrationModule();
    //         console.log('âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ DOM ìš”ì†Œ ì´ˆê¸°í™” ì™„ë£Œ');
    //     } catch (error) {
    //         console.error('âŒ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ DOM ìš”ì†Œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    //     }
    // }
    
    // ì•± ì‹œì‘ ì¤€ë¹„ ì™„ë£Œ ì²´í¬
    const checkAppReady = () => {
        if (window.__readyToStartApp) {
            console.log('ğŸ‰ ì•± ì‹œì‘ ì¤€ë¹„ ì™„ë£Œ');
            // ë©”ì¸ ì½˜í…ì¸  í‘œì‹œ
            const mainContent = document.getElementById('main-content');
            if (mainContent) {
                mainContent.classList.add('visible');
            }
            
            // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
            const calibrationOverlay = document.getElementById('calibration-overlay');
            if (calibrationOverlay) {
                calibrationOverlay.classList.add('hidden');
            }
        } else {
            // 100ms í›„ ë‹¤ì‹œ ì²´í¬
            setTimeout(checkAppReady, 100);
        }
    };
    
    // ì•± ì‹œì‘ ì¤€ë¹„ ì²´í¬ ì‹œì‘
    setTimeout(checkAppReady, 500);
});

</script>
</body>
</html>