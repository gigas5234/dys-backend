<!-- 표정 상세 정보 팝업 -->
<div id="expression-details-popup" class="details-popup">
  <div class="details-popup-content">
    <div class="details-popup-header">
      <h3>😊 표정 분석 상세</h3>
      <button class="details-popup-close" onclick="closeExpressionDetails()">×</button>
    </div>
    <div class="details-popup-body">
      <div class="expression-summary">
        <div class="expression-main">
          <div class="expression-label">주요 표정</div>
          <div id="expression-main-value" class="expression-main-value">-</div>
        </div>
        <div class="expression-confidence">
          <div class="expression-label">신뢰도</div>
          <div id="expression-confidence-value" class="expression-confidence-value">-%</div>
        </div>
      </div>
      <div class="expression-breakdown">
        <div class="expression-label">표정별 확률</div>
        <div id="expression-probabilities" class="expression-probabilities">
          <!-- 동적으로 생성됨 -->
        </div>
      </div>
      <div class="expression-explanation">
        <div class="expression-label">점수 계산 근거</div>
        <div id="expression-explanation-text" class="expression-explanation-text">
          표정 분석 데이터가 없습니다.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// 표정 상세 정보 팝업 관련 함수들
function updateExpressionProbabilities() {
    const probabilitiesDiv = document.getElementById('expression-probabilities');
    
    if (!currentExpressionData?.probabilities) {
        probabilitiesDiv.innerHTML = '<div class="no-data">확률 데이터가 없습니다.</div>';
        return;
    }
    
    const probabilities = currentExpressionData.probabilities;
    let html = '';
    
    Object.entries(probabilities).forEach(([expression, probability]) => {
        const koreanName = getExpressionKoreanName(expression);
        const percentage = (probability * 100).toFixed(1);
        const isHighest = probability === Math.max(...Object.values(probabilities));
        
        html += `
            <div class="probability-item ${isHighest ? 'highest' : ''}">
                <div class="probability-label">${koreanName}</div>
                <div class="probability-value">${percentage}%</div>
            </div>
        `;
    });
    
    probabilitiesDiv.innerHTML = html;
}

function getExpressionKoreanName(expression) {
    const koreanNames = {
        'happy': '웃음',
        'sad': '슬픔',
        'angry': '화남',
        'surprised': '놀람',
        'fearful': '두려움',
        'disgusted': '혐오',
        'neutral': '중립',
        'contempt': '경멸'
    };
    return koreanNames[expression] || expression;
}

function generateExpressionExplanation() {
    if (!currentExpressionData) {
        return '표정 분석 데이터가 없습니다.';
    }
    
    const { expression, confidence, score } = currentExpressionData;
    const koreanExpression = getExpressionKoreanName(expression);
    
    let explanation = `<div class="explanation-section">`;
    explanation += `<h4>📈 현재 분석 결과</h4>`;
    explanation += `<ul>`;
    explanation += `<li><strong>감지된 표정</strong>: ${koreanExpression}</li>`;
    explanation += `<li><strong>신뢰도</strong>: ${(confidence * 100).toFixed(1)}%</li>`;
    explanation += `<li><strong>최종 점수</strong>: ${score.score}점</li>`;
    explanation += `<li><strong>평가</strong>: ${score.label}</li>`;
    explanation += `</ul>`;
    
    // 점수 해석
    if (score.score >= 85) {
        explanation += `<p>🎯 <strong>매우 긍정적인 표정</strong>: 대화에 매우 좋은 영향을 주는 표정입니다.</p>`;
    } else if (score.score >= 70) {
        explanation += `<p>🎯 <strong>긍정적인 표정</strong>: 대화에 좋은 영향을 주는 표정입니다.</p>`;
    } else if (score.score >= 50) {
        explanation += `<p>🎯 <strong>중립적인 표정</strong>: 대화에 중립적인 영향을 주는 표정입니다.</p>`;
    } else if (score.score >= 30) {
        explanation += `<p>🎯 <strong>부정적인 표정</strong>: 대화에 부정적인 영향을 줄 수 있는 표정입니다.</p>`;
    } else {
        explanation += `<p>🎯 <strong>매우 부정적인 표정</strong>: 대화에 매우 부정적인 영향을 줄 수 있는 표정입니다.</p>`;
    }
    
    explanation += `</div>`;
    
    return explanation;
}

// 전역 스코프에 함수들 노출
window.updateExpressionProbabilities = updateExpressionProbabilities;
window.getExpressionKoreanName = getExpressionKoreanName;
window.generateExpressionExplanation = generateExpressionExplanation;
</script>
