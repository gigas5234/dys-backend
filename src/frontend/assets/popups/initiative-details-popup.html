<!-- ëŒ€í™” ì£¼ë„ê¶Œ ìƒì„¸ ì •ë³´ íŒì—… -->
<div id="initiative-details-popup" class="details-popup">
  <div class="details-popup-content">
    <div class="details-popup-header">
      <h3>ğŸ­ ëŒ€í™” ì£¼ë„ê¶Œ ë¶„ì„ ìƒì„¸</h3>
      <button class="details-popup-close" onclick="closeInitiativeDetails()">Ã—</button>
    </div>
    <div class="details-popup-body">
      <div class="initiative-summary">
        <div class="initiative-main">
          <div class="initiative-label">ì£¼ë„ê¶Œ ì ìˆ˜</div>
          <div id="initiative-main-value" class="initiative-main-value">50%</div>
        </div>
        <div class="initiative-status">
          <div class="initiative-label">ìƒíƒœ</div>
          <div id="initiative-status-text" class="initiative-status-text">ê· í˜•ì </div>
        </div>
      </div>
      <div class="initiative-visual">
        <div class="initiative-label">ì£¼ë„ê¶Œ ë¶„ë°°</div>
        <div class="initiative-bar-large">
          <div id="initiative-user-bar-large" class="user-bar-large" style="width: 50%;">
            <span class="bar-label">ë‚˜</span>
          </div>
          <div id="initiative-ai-bar-large" class="ai-bar-large" style="width: 50%;">
            <span class="bar-label">AI</span>
          </div>
        </div>
      </div>
      <div class="initiative-breakdown">
        <div class="initiative-label">ìƒì„¸ í†µê³„</div>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-label">ë©”ì‹œì§€ ìˆ˜</div>
            <div class="stat-value">
              <span id="user-message-count" class="user-stat">0</span> : 
              <span id="ai-message-count" class="ai-stat">0</span>
            </div>
          </div>
          <div class="stat-item">
            <div class="stat-label">ë©”ì‹œì§€ ê¸¸ì´</div>
            <div class="stat-value">
              <span id="user-length" class="user-stat">0</span> : 
              <span id="ai-length" class="ai-stat">0</span>
            </div>
          </div>
          <div class="stat-item">
            <div class="stat-label">ì§ˆë¬¸ ìˆ˜</div>
            <div class="stat-value">
              <span id="user-questions" class="user-stat">0</span> : 
              <span id="ai-questions" class="ai-stat">0</span>
            </div>
          </div>
        </div>
      </div>
      <div class="initiative-criteria">
        <div class="initiative-label">í‰ê°€ ê¸°ì¤€</div>
        <div class="criteria-list">
          <div class="criteria-item">
            <span class="criteria-weight">30%</span>
            <span class="criteria-text">ë©”ì‹œì§€ ìˆ˜ ë¹„ìœ¨</span>
          </div>
          <div class="criteria-item">
            <span class="criteria-weight">25%</span>
            <span class="criteria-text">ë©”ì‹œì§€ ê¸¸ì´ ë¹„ìœ¨</span>
          </div>
          <div class="criteria-item">
            <span class="criteria-weight">25%</span>
            <span class="criteria-text">ì§ˆë¬¸ ë¹„ìœ¨</span>
          </div>
          <div class="criteria-item">
            <span class="criteria-weight">20%</span>
            <span class="criteria-text">ëŒ€í™” ì‹œì‘ íŒ¨í„´</span>
          </div>
        </div>
      </div>
      <div class="initiative-explanation">
        <div class="initiative-label">ì£¼ë„ê¶Œ í•´ì„</div>
        <div id="initiative-explanation-text" class="initiative-explanation-text">
          ëŒ€í™” ì£¼ë„ê¶Œì€ ë©”ì‹œì§€ ìˆ˜, ê¸¸ì´, ì§ˆë¬¸ ë¹ˆë„ ë“±ì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ê³„ì‚°ë©ë‹ˆë‹¤.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ëŒ€í™” ì£¼ë„ê¶Œ ìƒì„¸ ì •ë³´ íŒì—… ê´€ë ¨ í•¨ìˆ˜ë“¤
function showInitiativeDetails() {
    const popup = document.getElementById('initiative-details-popup');
    if (popup) {
        popup.classList.add('active');
        updateInitiativePopupContent();
    }
}

function closeInitiativeDetails() {
    const popup = document.getElementById('initiative-details-popup');
    if (popup) {
        popup.classList.remove('active');
    }
}

function updateInitiativePopupContent() {
    if (!window.ConversationAnalyzer) {
        console.warn('[InitiativePopup] ConversationAnalyzer not found');
        return;
    }

    const analysis = window.ConversationAnalyzer.getDetailedAnalysis();
    
    // ë©”ì¸ ê°’ ì—…ë°ì´íŠ¸
    document.getElementById('initiative-main-value').textContent = `${analysis.userInitiativeScore}%`;
    document.getElementById('initiative-status-text').textContent = analysis.status;
    document.getElementById('initiative-status-text').style.color = analysis.color;
    
    // í° ë°” ì—…ë°ì´íŠ¸
    document.getElementById('initiative-user-bar-large').style.width = `${analysis.userInitiativeScore}%`;
    document.getElementById('initiative-ai-bar-large').style.width = `${100 - analysis.userInitiativeScore}%`;
    
    // í†µê³„ ì—…ë°ì´íŠ¸
    document.getElementById('user-message-count').textContent = analysis.stats.userMessageCount;
    document.getElementById('ai-message-count').textContent = analysis.stats.aiMessageCount;
    document.getElementById('user-length').textContent = analysis.stats.userTotalLength;
    document.getElementById('ai-length').textContent = analysis.stats.aiTotalLength;
    document.getElementById('user-questions').textContent = analysis.stats.userQuestionCount;
    document.getElementById('ai-questions').textContent = analysis.stats.aiQuestionCount;
    
    // ì„¤ëª… ì—…ë°ì´íŠ¸
    const explanationText = generateInitiativeExplanation(analysis);
    document.getElementById('initiative-explanation-text').innerHTML = explanationText;
}

function generateInitiativeExplanation(analysis) {
    const { userInitiativeScore, status, stats } = analysis;
    
    let explanation = `<div class="explanation-section">`;
    explanation += `<h4>ğŸ“ˆ í˜„ì¬ ë¶„ì„ ê²°ê³¼</h4>`;
    explanation += `<ul>`;
    explanation += `<li><strong>ì£¼ë„ê¶Œ ì ìˆ˜</strong>: ${userInitiativeScore}%</li>`;
    explanation += `<li><strong>ìƒíƒœ</strong>: ${status}</li>`;
    explanation += `<li><strong>ë©”ì‹œì§€ ìˆ˜</strong>: ${stats.userMessageCount} : ${stats.aiMessageCount}</li>`;
    explanation += `<li><strong>ë©”ì‹œì§€ ê¸¸ì´</strong>: ${stats.userTotalLength} : ${stats.aiTotalLength}</li>`;
    explanation += `<li><strong>ì§ˆë¬¸ ìˆ˜</strong>: ${stats.userQuestionCount} : ${stats.aiQuestionCount}</li>`;
    explanation += `</ul>`;
    
    // ì£¼ë„ê¶Œ í•´ì„
    if (userInitiativeScore >= 80) {
        explanation += `<p>ğŸ¯ <strong>ë§¤ìš° ì ê·¹ì ì¸ ëŒ€í™”</strong>: ëŒ€í™”ë¥¼ ì£¼ë„ì ìœ¼ë¡œ ì´ëŒê³  ìˆìŠµë‹ˆë‹¤. ìƒëŒ€ë°©ì—ê²Œ ì¶©ë¶„í•œ ê¸°íšŒë¥¼ ì£¼ëŠ” ê²ƒë„ ì¤‘ìš”í•©ë‹ˆë‹¤.</p>`;
    } else if (userInitiativeScore >= 65) {
        explanation += `<p>ğŸ¯ <strong>ì ê·¹ì ì¸ ëŒ€í™”</strong>: ì ì ˆí•œ ìˆ˜ì¤€ìœ¼ë¡œ ëŒ€í™”ë¥¼ ì´ëŒê³  ìˆìŠµë‹ˆë‹¤. ì¢‹ì€ ê· í˜•ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>`;
    } else if (userInitiativeScore >= 45) {
        explanation += `<p>ğŸ¯ <strong>ê· í˜•ì ì¸ ëŒ€í™”</strong>: ìƒëŒ€ë°©ê³¼ ê· í˜•ì¡íŒ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ê³  ìˆìŠµë‹ˆë‹¤. ì ì ˆí•œ ìˆ˜ì¤€ì…ë‹ˆë‹¤.</p>`;
    } else if (userInitiativeScore >= 30) {
        explanation += `<p>ğŸ¯ <strong>ì†Œê·¹ì ì¸ ëŒ€í™”</strong>: ì¡°ê¸ˆ ë” ì ê·¹ì ìœ¼ë¡œ ëŒ€í™”ì— ì°¸ì—¬í•´ë³´ì„¸ìš”. ì§ˆë¬¸ì„ ë˜ì§€ê±°ë‚˜ ê´€ì‹¬ì„ í‘œí˜„í•´ë³´ì„¸ìš”.</p>`;
    } else {
        explanation += `<p>ğŸ¯ <strong>ë§¤ìš° ì†Œê·¹ì ì¸ ëŒ€í™”</strong>: ëŒ€í™”ì— ë” ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í•´ë³´ì„¸ìš”. ì§ˆë¬¸ì„ í•˜ê³  ìì‹ ì˜ ìƒê°ì„ í‘œí˜„í•´ë³´ì„¸ìš”.</p>`;
    }
    
    explanation += `</div>`;
    
    return explanation;
}

// ì „ì—­ ìŠ¤ì½”í”„ì— í•¨ìˆ˜ë“¤ ë…¸ì¶œ
window.showInitiativeDetails = showInitiativeDetails;
window.closeInitiativeDetails = closeInitiativeDetails;
window.updateInitiativePopupContent = updateInitiativePopupContent;
window.generateInitiativeExplanation = generateInitiativeExplanation;
</script>
