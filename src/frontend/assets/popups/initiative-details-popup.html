<!-- 대화 주도권 상세 정보 팝업 -->
<div id="initiative-details-popup" class="details-popup">
  <div class="details-popup-content">
    <div class="details-popup-header">
      <h3>🎭 대화 주도권 분석 상세</h3>
      <button class="details-popup-close" onclick="closeInitiativeDetails()">×</button>
    </div>
    <div class="details-popup-body">
      <div class="initiative-summary">
        <div class="initiative-main">
          <div class="initiative-label">주도권 점수</div>
          <div id="initiative-main-value" class="initiative-main-value">50%</div>
        </div>
        <div class="initiative-status">
          <div class="initiative-label">상태</div>
          <div id="initiative-status-text" class="initiative-status-text">균형적</div>
        </div>
      </div>
      <div class="initiative-visual">
        <div class="initiative-label">주도권 분배</div>
        <div class="initiative-bar-large">
          <div id="initiative-user-bar-large" class="user-bar-large" style="width: 50%;">
            <span class="bar-label">나</span>
          </div>
          <div id="initiative-ai-bar-large" class="ai-bar-large" style="width: 50%;">
            <span class="bar-label">AI</span>
          </div>
        </div>
      </div>
      <div class="initiative-breakdown">
        <div class="initiative-label">상세 통계</div>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-label">메시지 수</div>
            <div class="stat-value">
              <span id="user-message-count" class="user-stat">0</span> : 
              <span id="ai-message-count" class="ai-stat">0</span>
            </div>
          </div>
          <div class="stat-item">
            <div class="stat-label">메시지 길이</div>
            <div class="stat-value">
              <span id="user-length" class="user-stat">0</span> : 
              <span id="ai-length" class="ai-stat">0</span>
            </div>
          </div>
          <div class="stat-item">
            <div class="stat-label">질문 수</div>
            <div class="stat-value">
              <span id="user-questions" class="user-stat">0</span> : 
              <span id="ai-questions" class="ai-stat">0</span>
            </div>
          </div>
        </div>
      </div>
      <div class="initiative-criteria">
        <div class="initiative-label">평가 기준</div>
        <div class="criteria-list">
          <div class="criteria-item">
            <span class="criteria-weight">30%</span>
            <span class="criteria-text">메시지 수 비율</span>
          </div>
          <div class="criteria-item">
            <span class="criteria-weight">25%</span>
            <span class="criteria-text">메시지 길이 비율</span>
          </div>
          <div class="criteria-item">
            <span class="criteria-weight">25%</span>
            <span class="criteria-text">질문 비율</span>
          </div>
          <div class="criteria-item">
            <span class="criteria-weight">20%</span>
            <span class="criteria-text">대화 시작 패턴</span>
          </div>
        </div>
      </div>
      <div class="initiative-explanation">
        <div class="initiative-label">주도권 해석</div>
        <div id="initiative-explanation-text" class="initiative-explanation-text">
          대화 주도권은 메시지 수, 길이, 질문 빈도 등을 종합적으로 분석하여 계산됩니다.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// 대화 주도권 상세 정보 팝업 관련 함수들
function showInitiativeDetails() {
    const popup = document.getElementById('initiative-details-popup');
    if (popup) {
        popup.classList.add('active');
        updateInitiativePopupContent();
    }
}

function closeInitiativeDetails() {
    const popup = document.getElementById('initiative-details-popup');
    if (popup) {
        popup.classList.remove('active');
    }
}

function updateInitiativePopupContent() {
    if (!window.ConversationAnalyzer) {
        console.warn('[InitiativePopup] ConversationAnalyzer not found');
        return;
    }

    const analysis = window.ConversationAnalyzer.getDetailedAnalysis();
    
    // 메인 값 업데이트
    document.getElementById('initiative-main-value').textContent = `${analysis.userInitiativeScore}%`;
    document.getElementById('initiative-status-text').textContent = analysis.status;
    document.getElementById('initiative-status-text').style.color = analysis.color;
    
    // 큰 바 업데이트
    document.getElementById('initiative-user-bar-large').style.width = `${analysis.userInitiativeScore}%`;
    document.getElementById('initiative-ai-bar-large').style.width = `${100 - analysis.userInitiativeScore}%`;
    
    // 통계 업데이트
    document.getElementById('user-message-count').textContent = analysis.stats.userMessageCount;
    document.getElementById('ai-message-count').textContent = analysis.stats.aiMessageCount;
    document.getElementById('user-length').textContent = analysis.stats.userTotalLength;
    document.getElementById('ai-length').textContent = analysis.stats.aiTotalLength;
    document.getElementById('user-questions').textContent = analysis.stats.userQuestionCount;
    document.getElementById('ai-questions').textContent = analysis.stats.aiQuestionCount;
    
    // 설명 업데이트
    const explanationText = generateInitiativeExplanation(analysis);
    document.getElementById('initiative-explanation-text').innerHTML = explanationText;
}

function generateInitiativeExplanation(analysis) {
    const { userInitiativeScore, status, stats } = analysis;
    
    let explanation = `<div class="explanation-section">`;
    explanation += `<h4>📈 현재 분석 결과</h4>`;
    explanation += `<ul>`;
    explanation += `<li><strong>주도권 점수</strong>: ${userInitiativeScore}%</li>`;
    explanation += `<li><strong>상태</strong>: ${status}</li>`;
    explanation += `<li><strong>메시지 수</strong>: ${stats.userMessageCount} : ${stats.aiMessageCount}</li>`;
    explanation += `<li><strong>메시지 길이</strong>: ${stats.userTotalLength} : ${stats.aiTotalLength}</li>`;
    explanation += `<li><strong>질문 수</strong>: ${stats.userQuestionCount} : ${stats.aiQuestionCount}</li>`;
    explanation += `</ul>`;
    
    // 주도권 해석
    if (userInitiativeScore >= 80) {
        explanation += `<p>🎯 <strong>매우 적극적인 대화</strong>: 대화를 주도적으로 이끌고 있습니다. 상대방에게 충분한 기회를 주는 것도 중요합니다.</p>`;
    } else if (userInitiativeScore >= 65) {
        explanation += `<p>🎯 <strong>적극적인 대화</strong>: 적절한 수준으로 대화를 이끌고 있습니다. 좋은 균형을 유지하고 있습니다.</p>`;
    } else if (userInitiativeScore >= 45) {
        explanation += `<p>🎯 <strong>균형적인 대화</strong>: 상대방과 균형잡힌 대화를 나누고 있습니다. 적절한 수준입니다.</p>`;
    } else if (userInitiativeScore >= 30) {
        explanation += `<p>🎯 <strong>소극적인 대화</strong>: 조금 더 적극적으로 대화에 참여해보세요. 질문을 던지거나 관심을 표현해보세요.</p>`;
    } else {
        explanation += `<p>🎯 <strong>매우 소극적인 대화</strong>: 대화에 더 적극적으로 참여해보세요. 질문을 하고 자신의 생각을 표현해보세요.</p>`;
    }
    
    explanation += `</div>`;
    
    return explanation;
}

// 전역 스코프에 함수들 노출
window.showInitiativeDetails = showInitiativeDetails;
window.closeInitiativeDetails = closeInitiativeDetails;
window.updateInitiativePopupContent = updateInitiativePopupContent;
window.generateInitiativeExplanation = generateInitiativeExplanation;
</script>
