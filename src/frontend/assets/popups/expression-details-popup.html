<!-- í‘œì • ìƒì„¸ ì •ë³´ íŒì—… -->
<div id="expression-details-popup" class="details-popup">
  <div class="details-popup-content">
    <div class="details-popup-header">
      <h3>ğŸ˜Š í‘œì • ë¶„ì„ ìƒì„¸</h3>
      <button class="details-popup-close" onclick="closeExpressionDetails()">Ã—</button>
    </div>
    <div class="details-popup-body">
      <div class="expression-summary">
        <div class="expression-main">
          <div class="expression-label">ì£¼ìš” í‘œì •</div>
          <div id="expression-main-value" class="expression-main-value">-</div>
        </div>
        <div class="expression-confidence">
          <div class="expression-label">ì‹ ë¢°ë„</div>
          <div id="expression-confidence-value" class="expression-confidence-value">-%</div>
        </div>
      </div>
      <div class="expression-breakdown">
        <div class="expression-label">í‘œì •ë³„ í™•ë¥ </div>
        <div id="expression-probabilities" class="expression-probabilities">
          <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>
      </div>
      <div class="expression-explanation">
        <div class="expression-label">ì ìˆ˜ ê³„ì‚° ê·¼ê±°</div>
        <div id="expression-explanation-text" class="expression-explanation-text">
          í‘œì • ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// í‘œì • ìƒì„¸ ì •ë³´ íŒì—… ê´€ë ¨ í•¨ìˆ˜ë“¤
function updateExpressionProbabilities() {
    const probabilitiesDiv = document.getElementById('expression-probabilities');
    
    // MediaPipe ë¶„ì„ê¸°ì—ì„œ ì‹¤ì‹œê°„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    let expressionData = window.currentExpressionData;
    
    if (!expressionData && window.mediaPipeAnalyzer && window.mediaPipeAnalyzer.currentMediaPipeScores) {
        const currentScores = window.mediaPipeAnalyzer.currentMediaPipeScores;
        const expressionScore = currentScores.expression || 0;
        
        // ì‹¤ì‹œê°„ í‘œì • ë°ì´í„° ìƒì„±
        expressionData = {
            expression: 'neutral',
            confidence: 0.8,
            score: { score: expressionScore, label: getScoreLabel(expressionScore) },
            probabilities: {
                happy: Math.max(0, (expressionScore - 50) / 50),
                sad: Math.max(0, (100 - expressionScore - 20) / 80),
                angry: Math.max(0, (50 - Math.abs(expressionScore - 50)) / 50),
                surprised: Math.max(0, (70 - Math.abs(expressionScore - 70)) / 70),
                fearful: Math.max(0, (30 - Math.abs(expressionScore - 30)) / 30),
                disgusted: Math.max(0, (40 - Math.abs(expressionScore - 40)) / 40),
                neutral: Math.max(0, (60 - Math.abs(expressionScore - 60)) / 60),
                contempt: Math.max(0, (45 - Math.abs(expressionScore - 45)) / 45)
            },
            isRealTime: true
        };
        
        window.currentExpressionData = expressionData;
        console.log("ğŸ“Š [íŒì—…] ì‹¤ì‹œê°„ í‘œì • ë°ì´í„° ì—…ë°ì´íŠ¸:", expressionData);
    }
    
    if (!expressionData?.probabilities) {
        probabilitiesDiv.innerHTML = '<div class="no-data">ë¶„ì„ ëŒ€ê¸° ì¤‘...</div>';
        return;
    }
    
    const probabilities = expressionData.probabilities;
    let html = '';
    
    Object.entries(probabilities).forEach(([expression, probability]) => {
        const koreanName = getExpressionKoreanName(expression);
        const percentage = (probability * 100).toFixed(1);
        const isHighest = probability === Math.max(...Object.values(probabilities));
        
        html += `
            <div class="probability-item ${isHighest ? 'highest' : ''}">
                <div class="probability-label">${koreanName}</div>
                <div class="probability-value">${percentage}%</div>
            </div>
        `;
    });
    
    probabilitiesDiv.innerHTML = html;
    
    if (expressionData.isRealTime) {
        console.log("âœ… [íŒì—…] ì‹¤ì‹œê°„ í‘œì • í™•ë¥  í‘œì‹œ ì™„ë£Œ");
    }
}

function getExpressionKoreanName(expression) {
    const koreanNames = {
        'happy': 'ì›ƒìŒ',
        'sad': 'ìŠ¬í””',
        'angry': 'í™”ë‚¨',
        'surprised': 'ë†€ëŒ',
        'fearful': 'ë‘ë ¤ì›€',
        'disgusted': 'í˜ì˜¤',
        'neutral': 'ì¤‘ë¦½',
        'contempt': 'ê²½ë©¸'
    };
    return koreanNames[expression] || expression;
}

function generateExpressionExplanation() {
    // MediaPipe ë¶„ì„ê¸°ì—ì„œ ì‹¤ì‹œê°„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    let expressionData = window.currentExpressionData;
    
    if (!expressionData && window.mediaPipeAnalyzer && window.mediaPipeAnalyzer.currentMediaPipeScores) {
        const currentScores = window.mediaPipeAnalyzer.currentMediaPipeScores;
        const expressionScore = currentScores.expression || 0;
        
        expressionData = {
            expression: 'neutral',
            confidence: 0.8,
            score: { score: expressionScore, label: getScoreLabel(expressionScore) },
            isRealTime: true
        };
    }
    
    if (!expressionData) {
        return 'ë¶„ì„ ëŒ€ê¸° ì¤‘...';
    }
    
    const { expression, confidence, score } = expressionData;
    const koreanExpression = getExpressionKoreanName(expression);
    
    let explanation = `<div class="explanation-section">`;
    explanation += `<h4>ğŸ“ˆ í˜„ì¬ ë¶„ì„ ê²°ê³¼</h4>`;
    explanation += `<ul>`;
    explanation += `<li><strong>ê°ì§€ëœ í‘œì •</strong>: ${koreanExpression}</li>`;
    explanation += `<li><strong>ì‹ ë¢°ë„</strong>: ${(confidence * 100).toFixed(1)}%</li>`;
    explanation += `<li><strong>ìµœì¢… ì ìˆ˜</strong>: ${score.score}ì </li>`;
    explanation += `<li><strong>í‰ê°€</strong>: ${score.label}</li>`;
    explanation += `</ul>`;
    
    // ì ìˆ˜ í•´ì„
    if (score.score >= 85) {
        explanation += `<p>ğŸ¯ <strong>ë§¤ìš° ê¸ì •ì ì¸ í‘œì •</strong>: ëŒ€í™”ì— ë§¤ìš° ì¢‹ì€ ì˜í–¥ì„ ì£¼ëŠ” í‘œì •ì…ë‹ˆë‹¤.</p>`;
    } else if (score.score >= 70) {
        explanation += `<p>ğŸ¯ <strong>ê¸ì •ì ì¸ í‘œì •</strong>: ëŒ€í™”ì— ì¢‹ì€ ì˜í–¥ì„ ì£¼ëŠ” í‘œì •ì…ë‹ˆë‹¤.</p>`;
    } else if (score.score >= 50) {
        explanation += `<p>ğŸ¯ <strong>ì¤‘ë¦½ì ì¸ í‘œì •</strong>: ëŒ€í™”ì— ì¤‘ë¦½ì ì¸ ì˜í–¥ì„ ì£¼ëŠ” í‘œì •ì…ë‹ˆë‹¤.</p>`;
    } else if (score.score >= 30) {
        explanation += `<p>ğŸ¯ <strong>ë¶€ì •ì ì¸ í‘œì •</strong>: ëŒ€í™”ì— ë¶€ì •ì ì¸ ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆëŠ” í‘œì •ì…ë‹ˆë‹¤.</p>`;
    } else {
        explanation += `<p>ğŸ¯ <strong>ë§¤ìš° ë¶€ì •ì ì¸ í‘œì •</strong>: ëŒ€í™”ì— ë§¤ìš° ë¶€ì •ì ì¸ ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆëŠ” í‘œì •ì…ë‹ˆë‹¤.</p>`;
    }
    
    if (expressionData.isRealTime) {
        explanation += `<p>ğŸ”„ <strong>ì‹¤ì‹œê°„ ë¶„ì„</strong>: MediaPipe ê¸°ë°˜ ì‹¤ì‹œê°„ í‘œì • ë¶„ì„ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.</p>`;
    }
    
    explanation += `</div>`;
    
    return explanation;
}

// ì „ì—­ ìŠ¤ì½”í”„ì— í•¨ìˆ˜ë“¤ ë…¸ì¶œ
window.updateExpressionProbabilities = updateExpressionProbabilities;
window.getExpressionKoreanName = getExpressionKoreanName;
window.generateExpressionExplanation = generateExpressionExplanation;
</script>
