apiVersion: apps/v1
kind: Deployment
metadata:
  name: dys-deployment
  annotations:
    autopilot.gke.io/disable-pod-autoscaling: "true"
spec:
  # 안정성을 위해 동일한 앱을 1개 실행시킵니다.
  replicas: 1
  strategy:
    type: Recreate
  progressDeadlineSeconds: 600
  selector:
    matchLabels:
      app: dys-backend
  template:
    metadata:
      labels:
        # 이 라벨(app: my-backend)을 보고 service.yaml이 찾아옵니다.
        app: dys-backend
    spec:
      # Autopilot 클러스터에 최적화된 설정
      nodeSelector:
        cloud.google.com/gke-nodepool: default-pool
      tolerations:
      - key: "kubernetes.io/arch"
        operator: "Equal"
        value: "amd64"
        effect: "NoSchedule"
      containers:
      - name: dys-backend-container
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          runAsUser: 1000
          capabilities:
            drop:
            - ALL
        # 💡 중요: CI/CD 파이프라인에서 빌드한 본인의 이미지 주소를 넣어야 합니다.
        image: asia-northeast3-docker.pkg.dev/deyeonso10/dys-backend/dys-backend:dec4234
        ports:
        - containerPort: 8000 # 메인 서버 포트
        - containerPort: 8001 # WebSocket 서버 포트
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "250m"
        # 프로브 완전 비활성화 - 애플리케이션 안정화 후 활성화 예정
        env:
        - name: MONGODB_URI
          valueFrom:
            secretKeyRef:
              name: dys-secrets
              key: mongodb-uri
        - name: DATABASE_NAME
          value: "dys-chatbot"
        - name: ALLOWED_ORIGINS
          value: "*"
        - name: PORT
          value: "8000"
        - name: WEBSOCKET_HOST
          value: "34.64.136.237"  # GKE 외부 IP
        - name: WEBSOCKET_PORT
          value: "8001"
        - name: CORS_ORIGINS
          value: "*,https://dys-phi.vercel.app,https://localhost:3000"
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: dys-secrets
              key: openai-api-key
        - name: SUPABASE_URL
          valueFrom:
            secretKeyRef:
              name: dys-secrets
              key: supabase-url
        - name: SUPABASE_ANON_KEY
          valueFrom:
            secretKeyRef:
              name: dys-secrets
              key: supabase-anon-key
        - name: PINECONE_API_KEY
          valueFrom:
            secretKeyRef:
              name: dys-secrets
              key: pinecone-api-key
        - name: PINECONE_ENVIRONMENT
          value: "gcp-starter"
        - name: PINECONE_HOST
          value: "https://deyeonso-if637zn.svc.aped-4627-b74a.pinecone.io"
        - name: TRANSFORMERS_CACHE
          value: "/tmp/huggingface_cache"