name: Backend CI/CD

# main ë¸Œëœì¹˜ì— pushë  ë•Œë§ˆë‹¤ ì‹¤í–‰
on:
  push:
    branches: [ "main" ]

jobs:
  # 1. ë¹Œë“œ ë° ì´ë¯¸ì§€ í‘¸ì‹œ ì‘ì—… (ê¸°ì¡´ê³¼ ë™ì¼)
  build-and-push-to-gcr:
    runs-on: ubuntu-latest
    steps:
    # 1. GitHubì— ì˜¬ë¼ê°„ ì½”ë“œë¥¼ ì‘ì—… ê³µê°„ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
    - name: Checkout
      uses: actions/checkout@v3

    # 2. GitHub Secretsì— ì €ì¥ëœ í‚¤ë¥¼ ì´ìš©í•´ Google Cloudì— ë¡œê·¸ì¸
    - name: Google Cloud Auth
      uses: 'google-github-actions/auth@v1'
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    # 3. Dockerê°€ Artifact Registryì— ì ‘ì†í•  ìˆ˜ ìˆë„ë¡ ì¸ì¦ ì„¤ì •
    - name: Set up Cloud SDK and Docker
      uses: 'google-github-actions/setup-gcloud@v1'
    - name: Configure Docker
      run: gcloud auth configure-docker asia-northeast3-docker.pkg.dev

    # 4. Dockerfileì„ ì´ìš©í•´ ì´ë¯¸ì§€ ë¹Œë“œ
    # ì €ì¥ì†Œ ì´ë¦„ê³¼ ì´ë¯¸ì§€ ì´ë¦„ì„ 'dys-backend'ë¡œ í†µì¼í–ˆìŠµë‹ˆë‹¤.
    - name: Build Docker Image
      run: |
        docker build -t asia-northeast3-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/dys-backend/dys-backend:${{ github.sha }} .

    # 5. ë¹Œë“œëœ ì´ë¯¸ì§€ë¥¼ Artifact Registryë¡œ Push
    # ìœ„ì™€ ë™ì¼í•˜ê²Œ ì´ë¯¸ì§€ ì´ë¦„ì„ ë§ì¶°ì¤ë‹ˆë‹¤.
    - name: Push Docker Image to Artifact Registry
      run: |
        docker push asia-northeast3-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/dys-backend/dys-backend:${{ github.sha }}

  # 2. GKEì— ë°°í¬í•˜ëŠ” ì‘ì—… (ìƒˆë¡œ ì¶”ê°€ë¨)
  deploy-to-gke:
    # 'build-and-push-to-gcr' ì‘ì—…ì´ ì„±ê³µí•´ì•¼ë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    needs: build-and-push-to-gcr
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Google Cloud Auth
      uses: 'google-github-actions/auth@v1'
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    # kubectlì´ GKE í´ëŸ¬ìŠ¤í„°ì— ì ‘ì†í•˜ë„ë¡ ì¸ì¦ ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    - name: Get GKE Credentials
      run: |
        gcloud container clusters get-credentials dys-cluster --region asia-northeast3

    # ğŸ’¡ í•µì‹¬: deployment.yaml íŒŒì¼ì˜ ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ë°©ê¸ˆ ë¹Œë“œí•œ íƒœê·¸ë¡œ ìë™ êµì²´í•©ë‹ˆë‹¤.
    - name: Update Image Tag in Deployment
      run: |
        sed -i "s|image:.*|image: asia-northeast3-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/dys-backend/dys-backend:${{ github.sha }}|g" deployment.yaml

    # ìˆ˜ì •ëœ deployment.yaml íŒŒì¼ë¡œ GKEì— ë°°í¬í•©ë‹ˆë‹¤.
    - name: Deploy to GKE
      run: |
        kubectl apply -f deployment.yaml
